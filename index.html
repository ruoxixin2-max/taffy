<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AIÊâãÊú∫Ê®°ÊãüÂô®</title>
    <style>
      @font-face {
        font-family: 'CustomFont';
        src: url('https://files.catbox.moe/c7a1xyp0k8k2en2d.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          'SF Pro Text',
          'PingFang SC',
          'Hiragino Sans GB',
          'Microsoft YaHei',
          sans-serif;
        background: #1a1a1a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden;
        letter-spacing: -0.015em;
        color: #1d1d1f;
      }
      .phone {
        width: 375px;
        height: 812px;
        background: #000;
        border-radius: 44px;
        overflow: hidden;
        position: relative;
        box-shadow:
          0 0 0 3px #444,
          0 0 0 5px #222,
          0 0 80px rgba(100, 100, 255, 0.15),
          0 30px 80px rgba(0, 0, 0, 0.6);
      }
      .notch {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 126px;
        height: 34px;
        background: #000;
        border-radius: 0 0 18px 18px;
        z-index: 1000;
      }
      .notch::before {
        content: '';
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 6px;
        background: #1a1a1a;
        border-radius: 3px;
      }
      .status-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 44px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 28px;
        z-index: 999;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
      }
      .status-bar.dark {
        color: #000;
      }
      .status-bar .time {
        font-size: 15px;
        font-weight: 700;
      }
      .status-bar .icons {
        display: flex;
        gap: 5px;
        align-items: center;
        font-size: 11px;
      }
      .home-indicator {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 134px;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        z-index: 999;
      }
      .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transition:
          transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94),
          opacity 0.35s ease;
      }
      .screen.hidden {
        pointer-events: none;
        opacity: 0;
      }

      /* Lock Screen */
      .lock-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
        cursor: pointer;
        user-select: none;
      }
      .lock-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.3) 100%);
      }
      .lock-time-card {
        margin-top: 160px;
        z-index: 1;
        text-align: center;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(20px);
        border-radius: 28px;
        padding: 24px 40px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }
      .lock-time-card .lock-time {
        font-size: 64px;
        font-weight: 200;
        color: #fff;
        letter-spacing: 3px;
      }
      .lock-time-card .lock-date {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.85);
        margin-top: 4px;
        font-weight: 400;
      }
      .lock-shortcuts {
        position: absolute;
        bottom: 40px;
        display: flex;
        gap: 200px;
        z-index: 1;
      }
      .lock-shortcut {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .lock-unlock {
        position: absolute;
        bottom: 100px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 13px;
        animation: pulse 2s infinite;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      .lock-unlock .arrow {
        font-size: 20px;
        animation: bounceUp 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }
      @keyframes bounceUp {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      /* Home Screen */
      .home-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat;
        padding: 54px 0 0;
        z-index: 50;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .home-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.08);
      }
      .home-search {
        position: relative;
        z-index: 1;
        width: calc(100% - 48px);
        margin: 10px 0 20px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 24px;
        padding: 10px 16px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
        text-align: center;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      }
      .home-search svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 2.5;
        fill: none;
      }
      .widget-area {
        position: relative;
        z-index: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 0 20px;
        max-height: 300px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .widget-area::-webkit-scrollbar {
        display: none;
      }
      .widget-card {
        border-radius: 32px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        transition:
          transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
          box-shadow 0.3s;
        cursor: grab;
        border: none;
        color: #fff;
      }
      .widget-card::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 32px;
        padding: 1px;
        background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.05));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }
      .widget-card:active {
        cursor: grabbing;
      }
      .widget-card.dragging {
        opacity: 0.7;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        transform: scale(1.03);
        z-index: 10;
      }
      .widget-card.drag-over {
        border-top: 3px solid #ff8fa3;
      }
      .widget-card .widget-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-size: cover;
        background-position: center;
        z-index: 0;
        border-radius: 18px;
      }
      .widget-card .widget-bg::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        border-radius: 28px;
      }
      .widget-card .widget-content {
        position: relative;
        z-index: 1;
      }
      .widget-card .widget-remove {
        position: absolute;
        top: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(255, 59, 48, 0.85);
        color: #fff;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .widget-card:hover .widget-remove {
        display: flex;
      }
      .widget-card .widget-bg-btn {
        position: absolute;
        bottom: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        font-size: 11px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .widget-card:hover .widget-bg-btn {
        display: flex;
      }
      .add-widget-btn {
        position: relative;
        z-index: 1;
        margin: 8px auto 0;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 2px dashed rgba(255, 255, 255, 0.4);
        border-radius: 14px;
        padding: 7px 18px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
      }
      .add-widget-btn:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      /* App Grid & Dock */
      .home-content {
        flex: 1;
        width: 100%;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
      }
      .app-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px 0;
        padding: 10px 24px;
        width: 100%;
      }
      .app-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .app-icon:active .icon-box {
        transform: scale(0.88);
      }
      .icon-box {
        width: 62px;
        height: 62px;
        border-radius: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.9);
        position: relative;
        border: none;
      }
      .icon-box:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
      }
      .icon-box::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 13px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, transparent 50%);
        pointer-events: none;
      }
      .icon-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .app-name {
        font-size: 10px;
        color: #fff;
        text-align: center;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
      }
      .icon-settings {
        background: linear-gradient(135deg, #8e8e93, #636366);
      }
      .icon-contacts {
        background: linear-gradient(135deg, #5ac8fa, #007aff);
      }
      .icon-moments {
        background: linear-gradient(135deg, #34c759, #30d158);
      }
      .home-dock {
        position: absolute;
        bottom: 24px;
        left: 20px;
        right: 20px;
        z-index: 2;
        padding: 18px 24px;
        display: flex;
        justify-content: space-around;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px);
        border-radius: 36px;
        border: none;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      }
      .home-dock::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 36px;
        padding: 1px;
        background: linear-gradient(180deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        pointer-events: none;
      }
      .dock-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .dock-icon .icon-box {
        width: 52px;
        height: 52px;
        border-radius: 12px;
      }
      .lock-btn-home {
        position: relative;
        z-index: 1;
        margin-top: auto;
        margin-bottom: 10px;
        cursor: pointer;
        opacity: 0.6;
        font-size: 12px;
        color: #fff;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
      }

      /* App Header */
      .app-header {
        height: 88px;
        padding: 44px 16px 0;
        display: flex;
        align-items: center;
        position: relative;
        flex-shrink: 0;
      }
      .app-header .back-btn {
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0,0,0,0.05);
        -webkit-tap-highlight-color: transparent;
        z-index: 1;
        transition: background 0.2s;
      }
      .app-header .back-btn:active {
        background: rgba(0,0,0,0.1);
      }
      .app-header .back-btn span {
        display: none;
      }
      .app-header .back-btn svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2.5;
        fill: none;
      }
      .app-header .header-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 17px;
        font-weight: 600;
      }
      .app-header .header-right {
        position: absolute;
        right: 16px;
        font-size: 22px;
        cursor: pointer;
        z-index: 1;
      }
      .app-header .header-actions {
        position: absolute;
        right: 16px;
        display: flex;
        gap: 14px;
        z-index: 1;
      }
      .app-header .header-actions span {
        font-size: 18px;
        cursor: pointer;
      }

      /* Contacts (Messages) Screen */
      .contacts-screen {
        background: #f2f2f7;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .contacts-screen.active {
        transform: translateX(0);
      }
      .contacts-screen .app-header {
        background: rgba(242, 242, 247, 0.92);
        backdrop-filter: blur(14px);
        border-bottom: 0.5px solid #d1d1d6;
      }
      .contacts-screen .app-header .header-title {
        color: #000;
      }
      .contacts-screen .app-header .back-btn {
        color: #07c160;
      }
      .contacts-screen .app-header .header-actions span {
        color: #07c160;
      }
      .contacts-search {
        margin: 0 16px 8px;
        position: relative;
      }
      .contacts-search input {
        width: 100%;
        background: rgba(118, 118, 128, 0.12);
        border: none;
        border-radius: 10px;
        padding: 8px 12px 8px 32px;
        font-size: 14px;
        outline: none;
        color: #000;
        font-family: inherit;
      }
      .contacts-search::before {
        content: 'üîç';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 13px;
      }
      .contacts-body {
        flex: 1;
        overflow-y: auto;
        background: url('https://i.postimg.cc/HnTsSRfW/IMG-1723.jpg') center/cover no-repeat fixed;
      }
      .contact-item {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        margin: 0 16px 10px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        cursor: pointer;
        gap: 14px;
        transition: transform 0.15s, background 0.15s;
        border: 1px solid rgba(255,255,255,0.4);
        box-shadow: 0 2px 8px rgba(0,0,0,0.02);
      }
      .contact-item:active {
        transform: scale(0.98);
        background: rgba(255, 255, 255, 0.9);
      }
      .contact-item:active {
        background: rgba(220, 220, 220, 0.88);
      }
      .contact-item.pinned {
        background: rgba(245, 245, 234, 0.9);
      }
      .contact-avatar {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        font-weight: bold;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .contact-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .contact-avatar .online-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #34c759;
        border: 2px solid #fff;
      }
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      .contact-name {
        font-size: 16px;
        color: #000;
        font-weight: 500;
      }
      .contact-name .pin-icon {
        font-size: 11px;
        color: #ff9500;
        margin-left: 3px;
      }
      .contact-name .mute-icon {
        font-size: 11px;
        color: #999;
        margin-left: 3px;
      }
      .contact-preview {
        font-size: 13px;
        color: #8e8e93;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .contact-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        flex-shrink: 0;
      }
      .contact-time {
        font-size: 11px;
        color: #8e8e93;
      }
      .unread-badge {
        background: #ff3b30;
        color: #fff;
        font-size: 10px;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
      }
      .empty-contacts {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        text-align: center;
        gap: 12px;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      }
      .empty-contacts .empty-icon {
        font-size: 48px;
        opacity: 0.7;
      }

      /* New Contact Screen */
      .new-contact-screen {
        background: #f2f2f7;
        display: flex;
        flex-direction: column;
        z-index: 70;
        transform: translateX(100%);
      }
      .new-contact-screen.active {
        transform: translateX(0);
      }
      .new-contact-screen .app-header {
        background: #f2f2f7;
        border-bottom: 0.5px solid #c6c6c8;
      }
      .new-contact-screen .app-header .header-title {
        color: #000;
      }
      .new-contact-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
      }
      .avatar-picker {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        gap: 12px;
      }
      .avatar-preview {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        color: #fff;
        font-weight: bold;
        overflow: hidden;
        cursor: pointer;
        position: relative;
      }
      .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .avatar-preview .avatar-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-size: 11px;
        text-align: center;
        padding: 2px 0;
        font-weight: normal;
      }
      .color-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .color-dot {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition:
          border-color 0.2s,
          transform 0.15s;
      }
      .color-dot.selected {
        border-color: #007aff;
        transform: scale(1.15);
      }
      .form-section {
        margin-bottom: 20px;
      }
      .form-section-title {
        font-size: 13px;
        color: #86868b;
        text-transform: uppercase;
        padding: 0 16px 8px;
        letter-spacing: 0.5px;
      }
      .form-card {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .form-item {
        padding: 12px 16px;
        border-bottom: 0.5px solid #e5e5ea;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .form-item:last-child {
        border-bottom: none;
      }
      .form-item label {
        font-size: 15px;
        color: #000;
      }
      .form-item input,
      .form-item textarea {
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        width: 100%;
        font-family: inherit;
      }
      .form-item textarea {
        resize: none;
        min-height: 60px;
      }
      .form-item input:focus,
      .form-item textarea:focus {
        border-color: #007aff;
        background: #fff;
      }
      .form-item .hint {
        font-size: 12px;
        color: #86868b;
        line-height: 1.4;
      }
      .create-btn {
        display: block;
        width: 100%;
        padding: 14px;
        background: #07c160;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 16px;
      }
      .create-btn:active {
        background: #06a855;
      }
      .import-btn {
        display: block;
        width: 100%;
        padding: 14px;
        background: #5856d6;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 10px;
      }
      .import-btn:active {
        background: #4a48c4;
      }
      .chat-screen {
        background: #ededed;
        display: flex;
        flex-direction: column;
        z-index: 65;
        transform: translateX(100%);
      }
      .chat-screen.active {
        transform: translateX(0);
      }
      .chat-screen .app-header {
        background: rgba(237, 237, 237, 0.92);
        backdrop-filter: blur(12px);
        border-bottom: 0.5px solid #d6d6d6;
      }
      .chat-screen .app-header .header-title {
        color: #000;
        cursor: pointer;
      }
      .chat-screen .app-header .back-btn {
        color: #07c160;
      }
      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px 14px;
        background: #ededed;
        scroll-behavior: smooth;
      }
      .chat-container::-webkit-scrollbar {
        width: 3px;
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 2px;
      }
      .message-row {
        display: flex;
        margin-bottom: 14px;
        align-items: flex-start;
      }
      .message-row.user {
        flex-direction: row-reverse;
      }
      .msg-avatar {
        width: 36px;
        height: 36px;
        border-radius: 4px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #fff;
        font-weight: bold;
        overflow: hidden;
      }
      .msg-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
      }
      .message-row.ai .msg-avatar {
        margin-right: 8px;
      }
      .message-row.user .msg-avatar {
        background: #e891a8;
        margin-left: 8px;
      }
      .bubble {
        max-width: 72%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.5;
        word-break: break-word;
        position: relative;
        white-space: pre-wrap;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .message-row.ai .bubble {
        background: #fff;
        color: #1d1d1f;
        border-top-left-radius: 4px;
      }
      .message-row.ai .bubble::before { display: none; }
      .message-row.user .bubble {
        background: #007aff;
        color: #fff;
        border-top-right-radius: 4px;
      }
      .message-row.user .bubble::after { display: none; }
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 0;
      }
      .typing-indicator span {
        width: 6px;
        height: 6px;
        background: #999;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes typingBounce {
        0%,
        80%,
        100% {
          transform: scale(0.6);
          opacity: 0.4;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .input-bar {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 10px 16px 20px;
        display: flex;
        align-items: flex-end;
        gap: 10px;
        border-top: none;
        flex-shrink: 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
      }
      .input-bar textarea {
        flex: 1;
        border: none;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 15px;
        line-height: 1.4;
        resize: none;
        outline: none;
        max-height: 100px;
        min-height: 40px;
        font-family: inherit;
        background: #f2f2f7;
        transition: background 0.2s;
      }
      .input-bar textarea:focus {
        background: #fff;
        box-shadow: 0 0 0 2px rgba(0,122,255,0.2);
      }
      .input-bar textarea:focus {
        border-color: #07c160;
      }
      .send-btn {
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 20px;
        padding: 0 20px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        flex-shrink: 0;
        height: 40px;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        transition: transform 0.15s, box-shadow 0.15s;
      }
      .send-btn:hover {
        transform: scale(1.03);
        box-shadow: 0 3px 10px rgba(255, 143, 163, 0.4);
      }
      .send-btn:active {
        transform: scale(0.97);
      }
      .send-btn:disabled {
        background: linear-gradient(135deg, #d4b0b8, #c4a0aa);
        cursor: not-allowed;
        box-shadow: none;
      }
      .generate-btn {
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 18px;
        padding: 8px 20px;
        font-size: 13px;
        cursor: pointer;
        margin: 8px auto;
        display: block;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        transition:
          background 0.2s,
          transform 0.15s;
      }
      .generate-btn:hover {
        background: #005ec4;
      }
      .generate-btn:active {
        transform: scale(0.95);
      }
      .generate-btn:disabled {
        background: #a0c4e8;
        cursor: not-allowed;
      }
      .generate-row {
        text-align: center;
        margin: 6px 0 10px;
      }
      /* Transfer & Red Packet */
      .msg-transfer {
        background: #fff;
        border-radius: 4px;
        padding: 0;
        width: 230px;
        overflow: hidden;
        cursor: pointer;
      }
      .msg-transfer .transfer-body {
        padding: 12px 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .msg-transfer .transfer-icon {
        font-size: 28px;
        flex-shrink: 0;
      }
      .msg-transfer .transfer-info {
        flex: 1;
      }
      .msg-transfer .transfer-amount {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }
      .msg-transfer .transfer-note {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .msg-transfer .transfer-footer {
        background: #f7f7f7;
        padding: 6px 14px;
        font-size: 11px;
        color: #999;
        border-top: 0.5px solid #e5e5ea;
      }
      .msg-redpacket {
        background: #fa9d3b;
        border-radius: 8px;
        padding: 0;
        width: 230px;
        overflow: hidden;
        cursor: pointer;
        color: #fff;
        position: relative;
      }
      .msg-redpacket .rp-body {
        padding: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
        min-height: 70px;
      }
      .msg-redpacket .rp-icon {
        font-size: 36px;
        flex-shrink: 0;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      .msg-redpacket .rp-info {
        flex: 1;
      }
      .msg-redpacket .rp-greeting {
        font-size: 15px;
        font-weight: 500;
        line-height: 1.4;
      }
      .msg-redpacket .rp-amount {
        font-size: 11px;
        opacity: 0.8;
        margin-top: 4px;
      }
      .msg-redpacket .rp-footer {
        background: rgba(0, 0, 0, 0.1);
        padding: 5px 14px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
      }
      .msg-redpacket.opened {
        background: #c8a070;
      }
      .msg-redpacket.opened .rp-icon {
        opacity: 0.5;
      }
      /* Extra buttons in input bar */
      .input-extras {
        display: flex;
        gap: 6px;
        padding: 6px 10px;
        background: rgba(240, 240, 240, 0.95);
        backdrop-filter: blur(8px);
        border-top: 0.5px solid #d6d6d6;
        flex-shrink: 0;
      }
      .extra-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(221, 221, 221, 0.6);
        border-radius: 16px;
        padding: 5px 14px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #555;
        transition: all 0.15s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .extra-btn:hover {
        background: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .extra-btn:active {
        background: #f0f0f0;
        transform: scale(0.96);
      }
      /* Transfer/RP modal */
      .trp-modal .trp-amount-input {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 14px;
        font-size: 24px;
        font-weight: 600;
        text-align: center;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
      }
      .trp-modal .trp-amount-input:focus {
        border-color: #007aff;
        background: #fff;
      }
      .trp-modal .trp-note-input {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
        margin-top: 10px;
      }
      .trp-modal .trp-note-input:focus {
        border-color: #007aff;
        background: #fff;
      }
      .trp-modal .trp-preview {
        text-align: center;
        margin: 12px 0 4px;
        font-size: 13px;
        color: #999;
      }
      .trp-send-btn {
        display: block;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 14px;
        color: #fff;
      }
      .trp-send-btn.transfer {
        background: #07c160;
      }
      .trp-send-btn.transfer:active {
        background: #06a855;
      }
      .trp-send-btn.redpacket {
        background: #fa9d3b;
      }
      .trp-send-btn.redpacket:active {
        background: #e88e30;
      }
      .system-msg {
        text-align: center;
        color: #999;
        font-size: 11px;
        margin: 10px 0;
      }
      .weibo-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .weibo-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .weibo-screen.active {
        transform: translateX(0);
      }
      .weibo-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .weibo-screen .app-header .header-title {
        color: #e6162d;
        font-weight: 700;
      }
      .weibo-screen .app-header .back-btn {
        color: #e6162d;
      }
      .weibo-screen .app-header .header-actions span {
        color: #e6162d;
      }
      .weibo-tabs {
        display: flex;
        background: transparent;
        border-bottom: none;
        flex-shrink: 0;
        padding: 0 16px;
        gap: 16px;
      }
      .weibo-tab {
        text-align: center;
        padding: 8px 16px;
        font-size: 15px;
        color: #666;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        border-radius: 20px;
      }
      .weibo-tab.active {
        color: #fff;
        font-weight: 600;
        background: #e6162d;
        box-shadow: 0 4px 12px rgba(230, 22, 45, 0.3);
      }
      .weibo-body {
        flex: 1;
        overflow-y: auto;
        padding-top: 16px;
      }
      .weibo-post {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        margin: 0 16px 16px;
        border-radius: 24px;
        padding: 16px 20px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.04);
        border: 1px solid rgba(255,255,255,0.5);
      }
      .weibo-post-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .weibo-post-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
        font-size: 16px;
        overflow: hidden;
      }
      .weibo-post-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .weibo-post-user {
        flex: 1;
      }
      .weibo-post-name {
        font-size: 15px;
        font-weight: 500;
        color: #333;
      }
      .weibo-post-time {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .weibo-post-content {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
        margin-bottom: 10px;
      }
      .weibo-post-content .hashtag {
        color: #e6162d;
      }
      .weibo-post-actions {
        display: flex;
        justify-content: space-around;
        padding-top: 12px;
        border-top: 1px solid rgba(0,0,0,0.05);
      }
      .weibo-action {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        color: #999;
        cursor: pointer;
        padding: 4px 8px;
      }
      .weibo-action:hover {
        color: #e6162d;
      }
      .weibo-action.liked {
        color: #e6162d;
      }
      .weibo-compose {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #eee;
        padding: 10px 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 10;
        transform: translateY(100%);
        transition: transform 0.3s;
      }
      .weibo-compose.open {
        transform: translateY(0);
      }
      .weibo-compose textarea {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        font-size: 14px;
        resize: none;
        min-height: 80px;
        outline: none;
        font-family: inherit;
      }
      .weibo-compose textarea:focus {
        border-color: #e6162d;
      }
      .weibo-compose-bar {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .weibo-compose-bar .cancel-btn {
        background: #f5f5f5;
        color: #666;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
      }
      .weibo-compose-bar .post-btn {
        background: #e6162d;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 20px;
        font-size: 14px;
        cursor: pointer;
      }
      .weibo-compose-bar .post-btn:disabled {
        background: #f5a0a8;
        cursor: not-allowed;
      }
      .weibo-refresh-bar {
        display: flex;
        justify-content: center;
        padding: 10px;
        background: transparent;
        flex-shrink: 0;
      }
      .weibo-refresh-btn {
        background: #e6162d;
        color: #fff;
        border: none;
        border-radius: 20px;
        padding: 8px 24px;
        font-size: 13px;
        cursor: pointer;
      }
      .weibo-refresh-btn:disabled {
        background: #f5a0a8;
        cursor: not-allowed;
      }
      .weibo-refresh-btn:hover:not(:disabled) {
        background: #c9122a;
      }
      .settings-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .settings-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(242, 242, 247, 0.6);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .settings-screen.active {
        transform: translateX(0);
      }
      .settings-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .settings-screen .app-header .header-title {
        color: #000;
      }
      .settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
        padding-bottom: 40px;
      }
      .settings-section {
        margin-bottom: 28px;
      }
      .settings-section-title {
        font-size: 13px;
        color: #86868b;
        text-transform: uppercase;
        padding: 0 16px 8px;
        letter-spacing: 0.5px;
      }
      .settings-card {
        background: transparent;
        border-radius: 0;
        overflow: visible;
      }
      .settings-item {
        padding: 16px 20px;
        margin-bottom: 16px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.04);
        border: 1px solid rgba(255,255,255,0.6);
      }
      .settings-item label {
        font-size: 15px;
        color: #000;
      }
      .settings-item input,
      .settings-item select {
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        width: 100%;
        font-family: inherit;
      }
      .settings-item input:focus,
      .settings-item select:focus {
        border-color: #007aff;
        background: #fff;
      }
      .settings-item .hint {
        font-size: 12px;
        color: #86868b;
        line-height: 1.4;
      }
      .save-btn {
        display: block;
        width: 100%;
        padding: 16px;
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 16px;
        box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
        transition: transform 0.15s, box-shadow 0.15s;
      }
      .save-btn:active {
        transform: scale(0.98);
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
      }
      .save-btn:active {
        background: #005ec4;
      }
      .toast {
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 24px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 500;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
      }
      @media (max-height: 700px) {
        .phone {
          height: 95vh;
          border-radius: 30px;
        }
      }
      @media (max-width: 400px) {
        .phone {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
          box-shadow: none;
        }
      }
      /* Modal overlay */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 300;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal-box {
        background: #fff;
        border-radius: 14px;
        width: 300px;
        max-height: 500px;
        overflow-y: auto;
        padding: 20px;
      }
      .modal-box h3 {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 16px;
        text-align: center;
      }
      .modal-box .form-item {
        padding: 8px 0;
        border-bottom: none;
      }
      .modal-box .modal-btns {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      .modal-box .modal-btns button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        cursor: pointer;
      }
      .modal-box .modal-btns .btn-cancel {
        background: #f2f2f7;
        color: #333;
      }
      .modal-box .modal-btns .btn-save {
        background: #07c160;
        color: #fff;
      }
      /* Message context menu */
      .msg-context-menu {
        position: absolute;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        z-index: 400;
        min-width: 120px;
        overflow: hidden;
        animation: menuFadeIn 0.15s ease;
      }
      @keyframes menuFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .msg-context-menu .ctx-item {
        padding: 11px 16px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 0.5px solid #f0f0f0;
      }
      .msg-context-menu .ctx-item:last-child {
        border-bottom: none;
      }
      .msg-context-menu .ctx-item:active {
        background: #f2f2f7;
      }
      .msg-context-menu .ctx-item.danger {
        color: #ff3b30;
      }
      .msg-context-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 399;
      }
      /* Edit message modal */
      .edit-msg-modal .edit-msg-textarea {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
        resize: none;
        min-height: 80px;
      }
      .edit-msg-modal .edit-msg-textarea:focus {
        border-color: #007aff;
        background: #fff;
      }
      /* Notification popup */
      .notif-popup {
        position: absolute;
        top: 50px;
        left: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 14px;
        padding: 12px 14px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        z-index: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        animation: notifSlide 0.35s ease;
      }
      @keyframes notifSlide {
        from {
          transform: translateY(-80px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .notif-popup.hiding {
        animation: notifSlideOut 0.3s ease forwards;
      }
      @keyframes notifSlideOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-80px);
          opacity: 0;
        }
      }
      .notif-avatar {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
        font-size: 16px;
        flex-shrink: 0;
        overflow: hidden;
      }
      .notif-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .notif-body {
        flex: 1;
        min-width: 0;
      }
      .notif-title {
        font-size: 14px;
        font-weight: 600;
        color: #000;
      }
      .notif-text {
        font-size: 13px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
      }
      .notif-app {
        font-size: 11px;
        color: #999;
        margin-top: 1px;
      }
      /* Contact list extras */
      .contact-item .pin-icon {
        font-size: 12px;
        color: #ff9500;
        margin-left: 4px;
      }
      .contact-item .mute-icon {
        font-size: 12px;
        color: #999;
        margin-left: 4px;
      }
      .contact-item.pinned {
        background: rgba(245, 245, 234, 0.88);
      }
      /* Contact context menu */
      .contact-ctx-menu {
        position: absolute;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        z-index: 400;
        min-width: 140px;
        overflow: hidden;
        animation: menuFadeIn 0.15s ease;
      }
      .contact-ctx-menu .ctx-item {
        padding: 11px 16px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 0.5px solid #f0f0f0;
      }
      .contact-ctx-menu .ctx-item:last-child {
        border-bottom: none;
      }
      .contact-ctx-menu .ctx-item:active {
        background: #f2f2f7;
      }
      .contact-ctx-menu .ctx-item.danger {
        color: #ff3b30;
      }
      /* Chat bg picker in edit modal */
      .bg-options {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .bg-option {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: border-color 0.2s;
        background-size: cover;
        background-position: center;
      }
      .bg-option.selected {
        border-color: #07c160;
      }
      .bg-option.custom-bg {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f2f2f7;
        font-size: 18px;
      }

      /* ======= WIDGETS ======= */
      .widget-area {
        position: relative;
        z-index: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        padding: 0 4px;
        max-height: 420px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .widget-area::-webkit-scrollbar {
        display: none;
      }
      .widget-card {
        border-radius: 20px;
        padding: 14px 16px;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(16px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        transition:
          transform 0.15s,
          box-shadow 0.2s;
        cursor: grab;
      }
      .widget-card:active {
        cursor: grabbing;
      }
      .widget-card.dragging {
        opacity: 0.7;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        transform: scale(1.03);
        z-index: 10;
      }
      .widget-card.drag-over {
        border-top: 3px solid #ff8fa3;
      }
      .widget-card .widget-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-size: cover;
        background-position: center;
        z-index: 0;
        border-radius: 20px;
      }
      .widget-card .widget-bg::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.45);
        border-radius: 20px;
      }
      .widget-card .widget-content {
        position: relative;
        z-index: 1;
      }
      .widget-card .widget-remove {
        position: absolute;
        top: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(255, 59, 48, 0.85);
        color: #fff;
        font-size: 13px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        line-height: 1;
      }
      .widget-card:hover .widget-remove,
      .widget-card .widget-remove.visible {
        display: flex;
      }
      .widget-card .widget-bg-btn {
        position: absolute;
        bottom: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        font-size: 11px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .widget-card:hover .widget-bg-btn {
        display: flex;
      }

      /* Widget: Cute Clock */
      .w-clock {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .w-clock .clock-face {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #f8bbd0);
        border: 3px solid #f48fb1;
        position: relative;
        box-shadow: 0 2px 8px rgba(244, 143, 177, 0.3);
      }
      .w-clock .clock-center {
        position: absolute;
        width: 6px;
        height: 6px;
        background: #e91e63;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3;
      }
      .w-clock .clock-hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform-origin: bottom center;
        border-radius: 2px;
      }
      .w-clock .hand-hour {
        width: 3px;
        height: 20px;
        background: #e91e63;
      }
      .w-clock .hand-minute {
        width: 2px;
        height: 26px;
        background: #f06292;
      }
      .w-clock .hand-second {
        width: 1px;
        height: 28px;
        background: #f48fb1;
      }
      .w-clock .clock-info {
        flex: 1;
      }
      .w-clock .clock-digital {
        font-size: 28px;
        font-weight: 700;
        color: #e91e63;
      }
      .w-clock .clock-label {
        font-size: 12px;
        color: #f48fb1;
        margin-top: 2px;
      }

      /* Widget: Calendar */
      .w-calendar {
        text-align: center;
      }
      .w-calendar .cal-month {
        font-size: 14px;
        font-weight: 600;
        color: #7c4dff;
        margin-bottom: 8px;
      }
      .w-calendar .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        font-size: 11px;
      }
      .w-calendar .cal-day-name {
        color: #b39ddb;
        font-weight: 600;
        padding: 2px 0;
      }
      .w-calendar .cal-day {
        padding: 3px 0;
        border-radius: 50%;
        color: #555;
      }
      .w-calendar .cal-day.today {
        background: linear-gradient(135deg, #e040fb, #7c4dff);
        color: #fff;
        font-weight: 700;
      }
      .w-calendar .cal-day.empty {
        visibility: hidden;
      }

      /* Widget: Mood */
      .w-mood {
        text-align: center;
        padding: 4px 0;
      }
      .w-mood .mood-title {
        font-size: 12px;
        color: #aaa;
        font-weight: 500;
        margin-bottom: 10px;
        letter-spacing: 1px;
      }
      .w-mood .mood-options {
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .w-mood .mood-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        border: 2px solid transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #fff;
        font-weight: 600;
        opacity: 0.5;
      }
      .w-mood .mood-dot:hover {
        transform: scale(1.15);
        opacity: 0.8;
      }
      .w-mood .mood-dot.selected {
        opacity: 1;
        transform: scale(1.2);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        border-color: rgba(255, 255, 255, 0.6);
      }
      .w-mood .mood-result {
        font-size: 13px;
        color: #888;
        margin-top: 10px;
        font-weight: 500;
      }

      /* Widget: Memo */
      .w-memo .memo-title {
        font-size: 13px;
        font-weight: 600;
        color: #00897b;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .w-memo textarea {
        width: 100%;
        min-height: 50px;
        border: none;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 13px;
        font-family: inherit;
        resize: none;
        outline: none;
        color: #333;
      }

      /* Widget: Pet */
      .w-pet {
        text-align: center;
      }
      .w-pet .pet-display {
        font-size: 48px;
        animation: petBounce 2s infinite;
      }
      @keyframes petBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-6px);
        }
      }
      .w-pet .pet-name {
        font-size: 13px;
        font-weight: 600;
        color: #ff7043;
        margin-top: 4px;
      }
      .w-pet .pet-status {
        font-size: 11px;
        color: #ffab91;
        margin-top: 2px;
      }
      .w-pet .pet-actions {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }
      .w-pet .pet-btn {
        background: linear-gradient(135deg, #ffccbc, #ff8a65);
        border: none;
        border-radius: 14px;
        padding: 4px 12px;
        font-size: 11px;
        cursor: pointer;
        color: #fff;
      }

      /* Widget: Countdown */
      .w-countdown {
        text-align: center;
      }
      .w-countdown .cd-title {
        font-size: 13px;
        color: #ec407a;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .w-countdown .cd-number {
        font-size: 36px;
        font-weight: 800;
        background: linear-gradient(135deg, #ec407a, #ab47bc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .w-countdown .cd-unit {
        font-size: 12px;
        color: #f48fb1;
      }
      .w-countdown .cd-date {
        font-size: 11px;
        color: #ce93d8;
        margin-top: 4px;
      }

      /* Widget: Weather */
      .w-weather {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .w-weather .weather-icon {
        font-size: 40px;
      }
      .w-weather .weather-info {
        flex: 1;
      }
      .w-weather .weather-temp {
        font-size: 28px;
        font-weight: 700;
        color: #29b6f6;
      }
      .w-weather .weather-desc {
        font-size: 12px;
        color: #81d4fa;
      }
      .w-weather .weather-loc {
        font-size: 11px;
        color: #b3e5fc;
      }

      /* Widget: Photo */
      .w-photo {
        text-align: center;
      }
      .w-photo .photo-frame {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 14px;
        overflow: hidden;
        background: linear-gradient(135deg, #ffe0b2, #ffcc80);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        cursor: pointer;
        position: relative;
        border: 3px solid rgba(255, 183, 77, 0.4);
      }
      .w-photo .photo-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .w-photo .photo-label {
        font-size: 11px;
        color: #ffb74d;
        margin-top: 6px;
      }

      /* Widget: Quote */
      .w-quote {
        text-align: center;
        padding: 8px 0;
      }
      .w-quote .quote-icon {
        font-size: 20px;
        color: #a5d6a7;
      }
      .w-quote .quote-text {
        font-size: 14px;
        color: #4caf50;
        font-style: italic;
        margin: 6px 0;
        line-height: 1.5;
      }
      .w-quote .quote-author {
        font-size: 11px;
        color: #81c784;
      }
      .w-quote .quote-edit-btn {
        margin-top: 6px;
        background: none;
        border: 1px dashed #a5d6a7;
        border-radius: 12px;
        padding: 3px 12px;
        font-size: 11px;
        color: #81c784;
        cursor: pointer;
        transition: all 0.15s;
      }
      .w-quote .quote-edit-btn:hover {
        background: rgba(165, 214, 167, 0.15);
        border-color: #66bb6a;
      }
      .w-quote .quote-edit-area {
        text-align: left;
        margin-top: 8px;
      }
      .w-quote .quote-edit-area textarea,
      .w-quote .quote-edit-area input {
        width: 100%;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 6px 8px;
        font-size: 12px;
        outline: none;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.5);
        margin-bottom: 4px;
      }
      .w-quote .quote-edit-area textarea {
        min-height: 40px;
        resize: none;
      }
      .w-quote .quote-edit-area textarea:focus,
      .w-quote .quote-edit-area input:focus {
        border-color: #66bb6a;
      }
      .w-quote .quote-save-btn {
        background: #66bb6a;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 4px 14px;
        font-size: 11px;
        cursor: pointer;
        margin-top: 4px;
      }

      /* Widget: Todo */
      .w-todo .todo-title {
        font-size: 13px;
        font-weight: 600;
        color: #5c6bc0;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .w-todo .todo-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .w-todo .todo-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #555;
        cursor: pointer;
      }
      .w-todo .todo-item.done {
        text-decoration: line-through;
        color: #bbb;
      }
      .w-todo .todo-item .todo-delete {
        margin-left: auto;
        font-size: 12px;
        color: #ccc;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.15s;
        flex-shrink: 0;
        padding: 0 2px;
      }
      .w-todo .todo-item:hover .todo-delete {
        opacity: 1;
        color: #ff5252;
      }
      .w-todo .todo-check {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid #9fa8da;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
      }
      .w-todo .todo-item.done .todo-check {
        background: #7986cb;
        border-color: #7986cb;
        color: #fff;
      }
      .w-todo .todo-add {
        margin-top: 6px;
        display: flex;
        gap: 4px;
      }
      .w-todo .todo-add input {
        flex: 1;
        border: 1px solid #c5cae9;
        border-radius: 10px;
        padding: 4px 8px;
        font-size: 12px;
        outline: none;
        font-family: inherit;
      }
      .w-todo .todo-add button {
        background: #7986cb;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
      }

      /* Widget: Music */
      .w-music {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .w-music .music-main {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .w-music .music-cover {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ce93d8, #ba68c8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        animation: musicSpin 4s linear infinite;
        box-shadow: 0 2px 8px rgba(186, 104, 200, 0.3);
      }
      .w-music .music-cover.paused {
        animation-play-state: paused;
      }
      @keyframes musicSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .w-music .music-info {
        flex: 1;
      }
      .w-music .music-title {
        font-size: 14px;
        font-weight: 600;
        color: #8e24aa;
      }
      .w-music .music-artist {
        font-size: 11px;
        color: #ce93d8;
      }
      .w-music .music-controls {
        display: flex;
        gap: 10px;
        margin-top: 6px;
      }
      .w-music .music-btn {
        font-size: 16px;
        cursor: pointer;
      }
      .w-music .music-url-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .w-music .music-url-input {
        flex: 1;
        border: 1px solid #e0d0e8;
        border-radius: 8px;
        padding: 5px 8px;
        font-size: 11px;
        outline: none;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.6);
      }
      .w-music .music-url-input:focus {
        border-color: #ba68c8;
      }
      .w-music .music-url-btn {
        background: #ba68c8;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 5px 10px;
        font-size: 11px;
        cursor: pointer;
        white-space: nowrap;
      }
      .w-music .music-progress {
        width: 100%;
        height: 3px;
        background: rgba(186, 104, 200, 0.2);
        border-radius: 2px;
        overflow: hidden;
      }
      .w-music .music-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ce93d8, #ba68c8);
        border-radius: 2px;
        transition: width 0.3s;
      }

      /* Widget: Battery */
      .w-battery {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .w-battery .bat-visual {
        width: 60px;
        height: 28px;
        border: 3px solid #66bb6a;
        border-radius: 6px;
        position: relative;
        overflow: hidden;
      }
      .w-battery .bat-visual::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 12px;
        background: #66bb6a;
        border-radius: 0 2px 2px 0;
      }
      .w-battery .bat-fill {
        height: 100%;
        background: linear-gradient(90deg, #a5d6a7, #66bb6a);
        border-radius: 3px;
        transition: width 0.3s;
      }
      .w-battery .bat-info {
        flex: 1;
      }
      .w-battery .bat-percent {
        font-size: 22px;
        font-weight: 700;
        color: #43a047;
      }
      .w-battery .bat-label {
        font-size: 11px;
        color: #81c784;
      }

      /* Widget: Love Days */
      .w-lovedays {
        text-align: center;
        background: linear-gradient(135deg, rgba(252, 228, 236, 0.6), rgba(248, 187, 208, 0.6));
        border-radius: 20px;
      }
      .w-lovedays .ld-hearts {
        font-size: 20px;
        letter-spacing: 4px;
      }
      .w-lovedays .ld-title {
        font-size: 13px;
        color: #e91e63;
        font-weight: 600;
        margin: 4px 0;
      }
      .w-lovedays .ld-days {
        font-size: 32px;
        font-weight: 800;
        color: #e91e63;
      }
      .w-lovedays .ld-label {
        font-size: 12px;
        color: #f48fb1;
      }
      .w-lovedays .ld-date-info {
        font-size: 11px;
        color: #f8bbd0;
        margin-top: 4px;
      }

      /* Widget Picker Modal */
      .widget-picker-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        max-height: 360px;
        overflow-y: auto;
      }
      .widget-picker-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 12px 6px;
        background: #f9f9f9;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.15s;
        border: 2px solid transparent;
      }
      .widget-picker-item:hover {
        background: #fff0f5;
        border-color: #ffb6c1;
      }
      .widget-picker-item:active {
        transform: scale(0.95);
      }
      .widget-picker-item .wp-icon {
        font-size: 28px;
      }
      .widget-picker-item .wp-name {
        font-size: 11px;
        color: #555;
        text-align: center;
        font-weight: 500;
      }

      /* Home Pages (pagination) */
      .home-pages {
        flex: 1;
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scrollbar-width: none;
        width: 100%;
        position: relative;
        z-index: 1;
      }
      .home-pages::-webkit-scrollbar {
        display: none;
      }
      .home-page {
        min-width: 100%;
        scroll-snap-align: start;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 0 0;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .home-page::-webkit-scrollbar {
        display: none;
      }
      .page-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 8px 0 4px;
        position: relative;
        z-index: 1;
      }
      .page-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.35);
        transition: all 0.25s;
        cursor: pointer;
      }
      .page-dot.active {
        background: #fff;
        transform: scale(1.2);
      }

      /* Add widget button on home */
      .add-widget-btn {
        position: relative;
        z-index: 1;
        margin: 0 auto;
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border: 2px dashed rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        padding: 8px 20px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .add-widget-btn:hover {
        background: rgba(255, 255, 255, 0.65);
        border-color: rgba(255, 255, 255, 0.8);
      }
      .add-widget-btn:active {
        transform: scale(0.96);
      }

      /* Calendar App */
      .calendar-app-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .calendar-app-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(242, 242, 247, 0.7);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .calendar-app-screen.active {
        transform: translateX(0);
      }
      .calendar-app-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .calendar-app-screen .app-header .header-title {
        color: #ff3b30;
      }
      .calendar-app-screen .app-header .back-btn {
        color: #ff3b30;
      }
      .calendar-app-screen .app-header .header-actions span {
        color: #ff3b30;
        font-size: 16px;
        cursor: pointer;
      }
      .cal-app-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }
      .cal-app-month {
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        color: #ff3b30;
        margin-bottom: 12px;
      }
      .cal-app-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255,255,255,0.5);
      }
      .cal-app-grid .cal-hd {
        text-align: center;
        font-size: 12px;
        color: #999;
        font-weight: 600;
        padding: 6px 0;
      }
      .cal-app-grid .cal-cell {
        text-align: center;
        padding: 8px 0;
        font-size: 14px;
        color: #333;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        transition: background 0.15s;
      }
      .cal-app-grid .cal-cell:hover {
        background: #fff0f0;
      }
      .cal-app-grid .cal-cell.today {
        background: #ff3b30;
        color: #fff;
        font-weight: 700;
      }
      .cal-app-grid .cal-cell.empty {
        visibility: hidden;
      }
      .cal-app-grid .cal-cell.has-event::after {
        content: '';
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #ff3b30;
      }
      .cal-app-grid .cal-cell.today.has-event::after {
        background: #fff;
      }
      .cal-app-events {
        margin-top: 16px;
      }
      .cal-app-events .cal-ev-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }
      .cal-ev-item {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 14px 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255,255,255,0.5);
      }
      .cal-ev-icon {
        font-size: 24px;
      }
      .cal-ev-info {
        flex: 1;
      }
      .cal-ev-name {
        font-size: 14px;
        font-weight: 500;
        color: #333;
      }
      .cal-ev-date {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .cal-ev-days {
        font-size: 13px;
        font-weight: 600;
        color: #ff3b30;
        flex-shrink: 0;
      }

      /* Anniversary App */
      .anniversary-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .anniversary-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 245, 247, 0.6);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .anniversary-screen.active {
        transform: translateX(0);
      }
      .anniversary-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .anniversary-screen .app-header .header-title {
        color: #e91e63;
      }
      .anniversary-screen .app-header .back-btn {
        color: #e91e63;
      }
      .anniversary-screen .app-header .header-actions span {
        color: #e91e63;
      }
      .anniv-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }
      .anniv-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 8px 24px rgba(233, 30, 99, 0.08);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.6);
      }
      .anniv-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #e91e63, #ff6090);
      }
      .anniv-card .anniv-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }
      .anniv-card .anniv-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }
      .anniv-card .anniv-days {
        font-size: 36px;
        font-weight: 800;
        background: linear-gradient(135deg, #e91e63, #ff6090);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 8px 0 4px;
      }
      .anniv-card .anniv-label {
        font-size: 13px;
        color: #f48fb1;
      }
      .anniv-card .anniv-date-info {
        font-size: 12px;
        color: #ccc;
        margin-top: 4px;
      }
      .anniv-card .anniv-delete {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 16px;
        cursor: pointer;
        color: #ccc;
        transition: color 0.15s;
      }
      .anniv-card .anniv-delete:hover {
        color: #ff3b30;
      }
      .anniv-empty {
        text-align: center;
        padding: 80px 20px;
        color: #f48fb1;
        font-size: 14px;
      }
      .anniv-empty .anniv-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      /* ======= MUSIC APP ======= */
      .music-app-screen {
        background: linear-gradient(180deg, #1a1a2e, #16213e, #0f3460);
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
        color: #fff;
      }
      .music-app-screen.active { transform: translateX(0); }
      .music-app-screen .app-header { background: transparent; border: none; }
      .music-app-screen .app-header .header-title { color: #fff; }
      .music-app-screen .app-header .back-btn { color: #e94560; }
      .music-app-screen .app-header .header-actions span { color: #e94560; }
      .music-app-body { flex: 1; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 0 20px 30px; }
      .music-album-art { width: 220px; height: 220px; border-radius: 50%; background: linear-gradient(135deg, #e94560, #533483); display: flex; align-items: center; justify-content: center; font-size: 64px; margin: 20px 0; box-shadow: 0 8px 40px rgba(233,69,96,0.3); overflow: hidden; animation: musicAppSpin 8s linear infinite; }
      .music-album-art.paused { animation-play-state: paused; }
      .music-album-art img { width: 100%; height: 100%; object-fit: cover; }
      @keyframes musicAppSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      .music-app-title { font-size: 20px; font-weight: 700; margin-top: 16px; text-align: center; }
      .music-app-artist { font-size: 14px; color: rgba(255,255,255,0.6); margin-top: 4px; }
      .music-app-progress { width: 100%; margin: 20px 0 8px; }
      .music-app-progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; overflow: hidden; cursor: pointer; }
      .music-app-progress-fill { height: 100%; background: linear-gradient(90deg, #e94560, #f5a623); border-radius: 2px; transition: width 0.3s; }
      .music-app-times { display: flex; justify-content: space-between; font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px; }
      .music-app-controls { display: flex; align-items: center; gap: 28px; margin: 16px 0; }
      .music-app-controls .ctrl-btn { font-size: 24px; cursor: pointer; opacity: 0.7; transition: opacity 0.15s; }
      .music-app-controls .ctrl-btn:hover { opacity: 1; }
      .music-app-controls .ctrl-play { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #e94560, #f5a623); display: flex; align-items: center; justify-content: center; font-size: 26px; cursor: pointer; box-shadow: 0 4px 20px rgba(233,69,96,0.4); }
      .music-app-playlist { width: 100%; margin-top: 20px; }
      .music-app-playlist-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
      .music-pl-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(255,255,255,0.06); border-radius: 10px; margin-bottom: 6px; cursor: pointer; transition: background 0.15s; }
      .music-pl-item:hover { background: rgba(255,255,255,0.12); }
      .music-pl-item.active { background: rgba(233,69,96,0.2); border: 1px solid rgba(233,69,96,0.3); }
      .music-pl-item .pl-cover { width: 36px; height: 36px; border-radius: 6px; background: linear-gradient(135deg, #533483, #e94560); display: flex; align-items: center; justify-content: center; font-size: 16px; overflow: hidden; flex-shrink: 0; }
      .music-pl-item .pl-cover img { width: 100%; height: 100%; object-fit: cover; }
      .music-pl-item .pl-info { flex: 1; min-width: 0; }
      .music-pl-item .pl-name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .music-pl-item .pl-artist { font-size: 11px; color: rgba(255,255,255,0.4); }
      .music-pl-item .pl-delete { font-size: 14px; color: rgba(255,255,255,0.3); cursor: pointer; padding: 4px; }
      .music-pl-item .pl-delete:hover { color: #e94560; }
      .music-add-form { width: 100%; background: rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
      .music-add-form input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; padding: 8px 10px; font-size: 13px; color: #fff; outline: none; font-family: inherit; }
      .music-add-form input::placeholder { color: rgba(255,255,255,0.3); }
      .music-add-form input:focus { border-color: #e94560; }
      .music-add-form .music-add-row { display: flex; gap: 6px; }
      .music-add-form .music-add-btn { background: linear-gradient(135deg, #e94560, #f5a623); color: #fff; border: none; border-radius: 8px; padding: 8px 16px; font-size: 13px; cursor: pointer; white-space: nowrap; }

      /* ======= SHOPPING MALL ======= */
      .shop-screen { background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed; display: flex; flex-direction: column; z-index: 60; transform: translateX(100%); }
      .shop-screen::before { content: ''; position: absolute; inset: 0; background: rgba(255, 245, 247, 0.6); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); z-index: -1; }
      .shop-screen.active { transform: translateX(0); }
      .shop-screen .app-header { background: transparent; border-bottom: none; }
      .shop-screen .app-header .header-title { color: #e91e63; }
      .shop-screen .app-header .back-btn { color: #e91e63; }
      .shop-balance { text-align: center; padding: 16px; background: linear-gradient(135deg, #ff6b9d, #e91e63); margin: 12px 16px; border-radius: 16px; color: #fff; box-shadow: 0 4px 16px rgba(233,30,99,0.3); }
      .shop-balance .bal-label { font-size: 12px; opacity: 0.8; }
      .shop-balance .bal-amount { font-size: 32px; font-weight: 800; margin: 4px 0; }
      .shop-balance .bal-recharge { background: rgba(255,255,255,0.25); border: none; border-radius: 20px; padding: 6px 20px; font-size: 12px; color: #fff; cursor: pointer; }
      .shop-body { flex: 1; overflow-y: auto; padding: 0 16px 30px; }
      .shop-section-title { font-size: 15px; font-weight: 600; color: #e91e63; margin: 16px 0 10px; }
      .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
      .shop-item { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 16px 8px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; border: 1px solid rgba(255,255,255,0.6); }
      .shop-item:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
      .shop-item:active { transform: scale(0.96); }
      .shop-item .shop-icon { font-size: 32px; margin-bottom: 6px; }
      .shop-item .shop-name { font-size: 12px; color: #333; font-weight: 500; }
      .shop-item .shop-price { font-size: 11px; color: #e91e63; font-weight: 600; margin-top: 4px; }
      /* Gift message in chat */
      .msg-gift { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; padding: 16px; width: 200px; text-align: center; border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 8px 24px rgba(233,30,99,0.1); }
      .msg-gift .gift-icon { font-size: 48px; margin-bottom: 8px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1)); }
      .msg-gift .gift-text { font-size: 14px; color: #e91e63; font-weight: 600; }
      .msg-gift .gift-note { font-size: 11px; color: #999; margin-top: 6px; }
      /* Image message */
      .msg-image { max-width: 200px; border-radius: 16px; overflow: hidden; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
      .msg-image img { width: 100%; display: block; border-radius: 16px; }
    </style>
  </head>
  <body>
    <div class="phone" id="phone">
      <div class="notch"></div>
      <div class="status-bar" id="statusBar">
        <span class="time" id="statusTime">9:41</span><span class="icons"><span>üì∂</span><span>üîã</span></span>
      </div>
      <div class="home-indicator"></div>
      <div class="toast" id="toast"></div>

      <!-- Auth Screen -->
      <div class="screen" id="authScreen" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:200;">
        <div style="text-align:center;margin-bottom:30px;">
          <div style="font-size:48px;margin-bottom:8px;">üì±</div>
          <div style="font-size:22px;font-weight:700;color:#fff;">AI ÊâãÊú∫Ê®°ÊãüÂô®</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:4px;">ÁôªÂΩï‰ª•ÂêåÊ≠•‰Ω†ÁöÑÊï∞ÊçÆ</div>
        </div>
        <div style="width:280px;background:rgba(255,255,255,0.95);border-radius:16px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
          <div id="authTitle" style="font-size:18px;font-weight:600;text-align:center;margin-bottom:16px;color:#333;">ÁôªÂΩï</div>
          <div id="authError" style="display:none;background:#fff0f0;color:#ff3b30;padding:8px 12px;border-radius:8px;font-size:13px;margin-bottom:12px;text-align:center;"></div>
          <input type="text" id="authUsername" placeholder="Áî®Êà∑Âêç" style="width:100%;border:1px solid #e5e5ea;border-radius:10px;padding:12px 14px;font-size:15px;outline:none;margin-bottom:10px;font-family:inherit;box-sizing:border-box;" />
          <input type="password" id="authPassword" placeholder="ÂØÜÁ†Å" style="width:100%;border:1px solid #e5e5ea;border-radius:10px;padding:12px 14px;font-size:15px;outline:none;margin-bottom:16px;font-family:inherit;box-sizing:border-box;" onkeydown="if(event.key==='Enter')doAuth()" />
          <button id="authBtn" onclick="doAuth()" style="width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:500;cursor:pointer;">ÁôªÂΩï</button>
          <div style="text-align:center;margin-top:14px;">
            <span id="authToggle" style="font-size:13px;color:#667eea;cursor:pointer;" onclick="toggleAuthMode()">Ê≤°ÊúâË¥¶Âè∑ÔºüÊ≥®ÂÜå</span>
          </div>
          <div style="text-align:center;margin-top:10px;">
            <span style="font-size:12px;color:#999;cursor:pointer;" onclick="skipAuth()">Ë∑≥ËøáÁôªÂΩïÔºà‰ªÖÊú¨Âú∞Â≠òÂÇ®Ôºâ</span>
          </div>
        </div>
      </div>

      <div class="screen lock-screen" id="lockScreen">
        <div class="lock-time-card">
          <div class="lock-time" id="lockTime">9:41</div>
          <div class="lock-date" id="lockDate">1Êúà1Êó• ÊòüÊúü‰∏Ä</div>
        </div>
        <div class="lock-unlock">
          <div class="arrow">‚åÉ</div>
          ‰∏äÊªëËß£ÈîÅ
        </div>
      </div>

      <div class="screen home-screen hidden" id="homeScreen">
        <div class="home-search" onclick="showToast('ÊêúÁ¥¢ÂäüËÉΩÂºÄÂèë‰∏≠')">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          ÊêúÁ¥¢
        </div>
        <div class="home-pages" id="homePages">
          <div class="home-page" id="homePage0"></div>
          <div class="home-page" id="homePage1"></div>
        </div>
        <div class="page-dots" id="pageDots">
          <div class="page-dot active" onclick="goToPage(0)"></div>
          <div class="page-dot" onclick="goToPage(1)"></div>
        </div>
        <div
          style="
            position: relative;
            z-index: 1;
            margin-bottom: 60px;
            cursor: pointer;
            opacity: 0.7;
            font-size: 13px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
          "
          onclick="lockPhone()"
        >
          üîí ÈîÅÂ±è
        </div>
      </div>

      <div class="screen contacts-screen" id="contactsScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeContacts()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </div>
          <div class="header-title">‰ø°ÊÅØ</div>
          <div class="header-actions">
            <span onclick="openImportCard()" title="ÂØºÂÖ•ËßíËâ≤Âç°" style="font-size: 20px;">üì•</span
            ><span onclick="openNewContact()" title="Êñ∞Âª∫ËÅîÁ≥ª‰∫∫" style="font-size: 24px;">Ôºã</span>
          </div>
        </div>
        <div class="contacts-body" id="contactsBody"></div>
      </div>

      <div class="screen new-contact-screen" id="newContactScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeNewContact()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title" id="newContactTitle">Êñ∞Âª∫ËÅîÁ≥ª‰∫∫</div>
        </div>
        <div class="new-contact-body">
          <div class="avatar-picker">
            <div class="avatar-preview" id="newAvatarPreview" style="background: #07c160" onclick="pickAvatar('new')">
              ?
              <div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>
            </div>
            <div class="color-options" id="colorOptions"></div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
            <div class="form-card">
              <div class="form-item">
                <label>ÂêçÁß∞</label><input type="text" id="newContactName" placeholder="ËæìÂÖ•ËÅîÁ≥ª‰∫∫ÂêçÁß∞" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">AI ËÆæÂÆö</div>
            <div class="form-card">
              <div class="form-item">
                <label>Á≥ªÁªüÊèêÁ§∫ËØç</label><textarea id="newContactPrompt" placeholder="‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã"></textarea>
                <div class="hint">ÂÆö‰πâËØ•ËÅîÁ≥ª‰∫∫ÁöÑ AI ËßíËâ≤ÂíåË°å‰∏∫ÊñπÂºè</div>
              </div>
            </div>
          </div>
          <button class="create-btn" id="createOrSaveBtn" onclick="createContact()">ÂàõÂª∫ËÅîÁ≥ª‰∫∫</button>
          <button class="import-btn" onclick="openImportCard()">üì• ÂØºÂÖ• PNG ËßíËâ≤Âç°</button>
        </div>
      </div>

      <div class="screen chat-screen" id="chatScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeChat()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </div>
          <div class="header-title" id="chatTitle" onclick="editCurrentContact()">AIÂä©Êâã</div>
          <div class="header-actions"><span onclick="toggleChatMenu()" id="chatMenuBtn" style="font-size:24px;cursor:pointer;">‚ãØ</span></div>
        </div>
        <!-- Chat dropdown menu -->
        <div id="chatDropdownMenu" style="display:none;position:absolute;top:82px;right:12px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.2);z-index:100;min-width:160px;overflow:hidden;animation:menuFadeIn 0.15s ease;">
        </div>
        <div class="chat-container" id="chatContainer"></div>
        <div id="generateRow" class="generate-row" style="display: none">
          <button class="generate-btn" id="generateBtn" onclick="generateReply()">üîÑ ÁîüÊàêÂõûÂ§ç</button>
        </div>
        <div class="input-extras">
          <div class="extra-btn" onclick="openTransferModal()">üí∞ ËΩ¨Ë¥¶</div>
          <div class="extra-btn" onclick="openRedPacketModal()">üßß Á∫¢ÂåÖ</div>
          <div class="extra-btn" onclick="openShopForGift()">üéÅ Á§ºÁâ©</div>
          <div class="extra-btn" onclick="pickChatImage()">üñºÔ∏è ÂõæÁâá</div>
        </div>
        <div class="input-bar">
          <textarea id="userInput" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ‚Ä¶"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">ÂèëÈÄÅ</button>
        </div>
      </div>

      <div class="screen weibo-screen" id="weiboScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeWeibo()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">ÂæÆÂçö</div>
          <div class="header-actions">
            <span onclick="refreshWeibo()" title="AIÂà∑Êñ∞">üîÑ</span
            ><span onclick="toggleWeiboCompose()" title="ÂèëÂæÆÂçö">‚úèÔ∏è</span>
          </div>
        </div>
        <div class="weibo-tabs">
          <div class="weibo-tab active" onclick="switchWeiboTab(this, 'follow')">ÂÖ≥Ê≥®</div>
          <div class="weibo-tab" onclick="switchWeiboTab(this, 'hot')">ÁÉ≠Èó®</div>
          <div class="weibo-tab" onclick="switchWeiboTab(this, 'mine')">ÊàëÁöÑ</div>
        </div>
        <div class="weibo-body" id="weiboBody"></div>
        <div class="weibo-compose" id="weiboCompose">
          <textarea id="weiboInput" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã‚Ä¶"></textarea>
          <div class="weibo-compose-bar">
            <button class="cancel-btn" onclick="toggleWeiboCompose()">ÂèñÊ∂à</button>
            <button class="post-btn" onclick="postWeibo()">ÂèëÂ∏É</button>
          </div>
        </div>
      </div>

      <div class="screen settings-screen" id="settingsScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeSettings()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">ËÆæÁΩÆ</div>
        </div>
        <div class="settings-body">
          <div class="settings-section">
            <div class="settings-section-title">Áî®Êà∑ËÆæÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>Áî®Êà∑ÊòµÁß∞</label><input type="text" id="settingUserName" placeholder="Êàë" />
                <div class="hint">ËÅäÂ§©ÂíåÂæÆÂçö‰∏≠ÊòæÁ§∫ÁöÑÊòµÁß∞</div>
              </div>
              <div class="settings-item">
                <label>Áî®Êà∑Â§¥ÂÉè</label>
                <div style="display: flex; align-items: center; gap: 12px">
                  <div
                    id="userAvatarPreview"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 8px;
                      background: #1989fa;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: #fff;
                      font-weight: bold;
                      font-size: 18px;
                      overflow: hidden;
                      cursor: pointer;
                      flex-shrink: 0;
                    "
                    onclick="pickAvatar('user')"
                  >
                    Êàë
                  </div>
                  <div class="hint">ÁÇπÂáªÂ§¥ÂÉèÊõ¥Êç¢</div>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">‰∫∫ËÆæÈù¢ÂÖ∑</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>ËßíËâ≤‰∫∫ËÆæ (Persona)</label>
                <textarea
                  id="settingPersona"
                  style="
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 13px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    resize: vertical;
                    min-height: 80px;
                  "
                  placeholder="ÊèèËø∞‰Ω†ÊâÆÊºîÁöÑËßíËâ≤Ôºå‰æãÂ¶ÇÔºöÊàëÊòØ‰∏Ä‰∏™18Â≤ÅÁöÑÂ§ßÂ≠¶ÁîüÔºåÊÄßÊ†ºÂºÄÊúóÔºåÂñúÊ¨¢Èü≥‰πêÂíåÊóÖË°å‚Ä¶"
                ></textarea>
                <div class="hint">‰∫∫ËÆæ‰ø°ÊÅØ‰ºö‰Ωú‰∏∫Á≥ªÁªüÊèêÁ§∫ËØçÊ≥®ÂÖ•ÔºåËÆ© AI ‰∫ÜËß£"‰Ω†ÊòØË∞Å"Ôºå‰ªéËÄåÊõ¥Â•ΩÂú∞‰∏é‰Ω†‰∫íÂä®</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">API ÈÖçÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>API Á´ØÁÇπ</label
                ><input
                  type="url"
                  id="settingEndpoint"
                  placeholder="https://morning-rain-6898.ruoxixin2.workers.dev/v1/chat/completions"
                />
                <div class="hint">ÂÖºÂÆπ OpenAI Ê†ºÂºèÁöÑ API Á´ØÁÇπ</div>
              </div>
              <div class="settings-item">
                <label>API KeyÔºàÂèØÈÄâÔºâ</label
                ><input type="password" id="settingApiKey" placeholder="ÁïôÁ©∫Âàô‰ΩøÁî®‰∏≠ËΩ¨ÊúçÂä°Âô®ÂÜÖÁΩÆKey" />
                <div class="hint">Â¶ÇÊûú‰∏≠ËΩ¨ÊúçÂä°Âô®Â∑≤ÂÜÖÁΩÆ API KeyÔºåÊ≠§Â§ÑÂèØÁïôÁ©∫</div>
              </div>
              <div class="settings-item">
                <label>Ê®°Âûã</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input type="text" id="settingModel" placeholder="gpt-4o-mini" style="flex: 1" />
                  <button
                    class="save-btn"
                    style="width: auto; padding: 8px 14px; font-size: 13px; margin: 0; white-space: nowrap"
                    onclick="fetchModels()"
                    id="fetchModelsBtn"
                  >
                    üì° ÊãâÂèñÊ®°Âûã
                  </button>
                </div>
                <select
                  id="modelSelect"
                  style="
                    display: none;
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 14px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    margin-top: 6px;
                  "
                  onchange="selectFetchedModel(this.value)"
                ></select>
                <div class="hint">Â¶Ç gpt-4o-mini„ÄÅgpt-4o„ÄÅclaude-3-sonnet Á≠âÔºõÁÇπÂáª"ÊãâÂèñÊ®°Âûã"ÂèØËá™Âä®Ëé∑ÂèñÂèØÁî®Ê®°ÂûãÂàóË°®</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">ÁîüÊàêÂèÇÊï∞</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>Ê∏©Â∫¶ (Temperature)</label
                ><input type="number" id="settingTemperature" placeholder="0.7" min="0" max="2" step="0.1" />
                <div class="hint">ÊéßÂà∂ÂõûÂ§çÁöÑÈöèÊú∫ÊÄßÔºåËåÉÂõ¥ 0-2</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">üåç ‰∏ñÁïå‰π¶ / Á†¥Áî≤</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>‰∏ñÁïå‰π¶ (Worldbook)</label>
                <textarea
                  id="settingWorldbook"
                  style="
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 13px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    resize: vertical;
                    min-height: 80px;
                  "
                  placeholder="Âú®Ê≠§ËæìÂÖ•‰∏ñÁïåËßÇËÆæÂÆö„ÄÅËÉåÊôØ‰ø°ÊÅØÁ≠âÔºå‰ºö‰Ωú‰∏∫ÂÖ®Â±ÄÁ≥ªÁªüÊèêÁ§∫ËØçÊ≥®ÂÖ•Âà∞ÊâÄÊúâÂØπËØù‰∏≠‚Ä¶"
                ></textarea>
                <div class="hint">‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰ºöÂú®ËÅîÁ≥ª‰∫∫ÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç‰πãÂêéÊ≥®ÂÖ•ÔºåÁî®‰∫éË°•ÂÖÖ‰∏ñÁïåËßÇ„ÄÅËßÑÂàôËÆæÂÆöÁ≠âÂÖ®Â±ÄËÉåÊôØ‰ø°ÊÅØ</div>
              </div>
              <div class="settings-item">
                <label>Á†¥Áî≤ÊèêÁ§∫ËØç (Jailbreak)</label>
                <textarea
                  id="settingJailbreak"
                  style="
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 13px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    resize: vertical;
                    min-height: 80px;
                  "
                  placeholder="Âú®Ê≠§ËæìÂÖ•Á†¥Áî≤/Ë∂äÁã±ÊèêÁ§∫ËØçÔºå‰ºö‰Ωú‰∏∫ÊúÄÂêé‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‚Ä¶"
                ></textarea>
                <div class="hint">
                  Á†¥Áî≤ÊèêÁ§∫ËØç‰ºöÂú®ÊâÄÊúâËÅäÂ§©Ê∂àÊÅØ‰πãÂêé„ÄÅAI ÂõûÂ§ç‰πãÂâç‰Ωú‰∏∫ÊúÄÂêé‰∏ÄÊù° system Ê∂àÊÅØÊ≥®ÂÖ•ÔºåÁî®‰∫éËß£Èô§ AI
                  ÁöÑÈôêÂà∂ÊàñÂº∫ÂåñËßíËâ≤ÊâÆÊºî
                </div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">Â£ÅÁ∫∏ËÆæÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>ÈîÅÂ±èÂ£ÅÁ∫∏</label>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap">
                  <div
                    id="lockWpPreview"
                    style="
                      width: 60px;
                      height: 100px;
                      border-radius: 8px;
                      background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover;
                      border: 2px solid #ddd;
                      flex-shrink: 0;
                    "
                  ></div>
                  <button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0"
                    onclick="pickWallpaper('lock')"
                  >
                    Êõ¥Êç¢</button
                  ><button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0; background: #ff3b30"
                    onclick="resetWallpaper('lock')"
                  >
                    ÊÅ¢Â§çÈªòËÆ§
                  </button>
                </div>
              </div>
              <div class="settings-item">
                <label>‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</label>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap">
                  <div
                    id="homeWpPreview"
                    style="
                      width: 60px;
                      height: 100px;
                      border-radius: 8px;
                      background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover;
                      border: 2px solid #ddd;
                      flex-shrink: 0;
                    "
                  ></div>
                  <button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0"
                    onclick="pickWallpaper('home')"
                  >
                    Êõ¥Êç¢</button
                  ><button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0; background: #ff3b30"
                    onclick="resetWallpaper('home')"
                  >
                    ÊÅ¢Â§çÈªòËÆ§
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button class="save-btn" onclick="saveSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
      </div>

      <div class="control-center" id="controlCenter">
        <div class="control-overlay" onclick="closeControlCenter()"></div>
        <div class="control-panel">
          <div class="control-row">
            <div class="control-tile">
              <div class="tile-icon active">‚úàÔ∏è</div>
              <div class="tile-label">È£ûË°åÊ®°Âºè</div>
              <div class="tile-status">ÂÖ≥</div>
            </div>
            <div class="control-tile">
              <div class="tile-icon active">üì∂</div>
              <div class="tile-label">ËúÇÁ™ùÁΩëÁªú</div>
              <div class="tile-status">ÂºÄ</div>
            </div>
          </div>
          <div class="control-row">
            <div class="control-tile">
              <div class="tile-icon active" style="background: #007aff">üì°</div>
              <div class="tile-label">Wi-Fi</div>
              <div class="tile-status">Â∑≤ËøûÊé•</div>
            </div>
            <div class="control-tile">
              <div class="tile-icon active" style="background: #007aff">üîµ</div>
              <div class="tile-label">ËìùÁâô</div>
              <div class="tile-status">ÂºÄ</div>
            </div>
          </div>
          <div class="control-row" style="gap: 12px">
            <div class="brightness-slider">
              <div class="brightness-fill"></div>
              <div class="brightness-icon">‚òÄÔ∏è</div>
            </div>
            <div class="brightness-slider">
              <div class="brightness-fill" style="height: 40%"></div>
              <div class="brightness-icon">üîä</div>
            </div>
          </div>
          <div class="control-handle"></div>
        </div>
      </div>

      <!-- Calendar App Screen -->
      <div class="screen calendar-app-screen" id="calendarAppScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeCalendarApp()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">üìÖ Êó•ÂéÜ</div>
          <div class="header-actions">
            <span onclick="calendarPrevMonth()">‚óÄ</span><span onclick="calendarNextMonth()">‚ñ∂</span>
          </div>
        </div>
        <div class="cal-app-body" id="calAppBody"></div>
      </div>

      <!-- Anniversary App Screen -->
      <div class="screen anniversary-screen" id="anniversaryScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeAnniversaryApp()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">üíù Á∫™ÂøµÊó•</div>
          <div class="header-actions"><span onclick="openAddAnniversary()">Ôºã</span></div>
        </div>
        <div class="anniv-body" id="annivBody"></div>
      </div>

      <!-- Music App Screen -->
      <div class="screen music-app-screen" id="musicAppScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeMusicApp()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">Èü≥‰πê</div>
          <div class="header-actions"><span onclick="toggleMusicAddForm()" title="Ê∑ªÂä†Ê≠åÊõ≤">Ôºã</span></div>
        </div>
        <div class="music-app-body" id="musicAppBody">
          <div class="music-album-art paused" id="musicAlbumArt">üéµ</div>
          <div class="music-app-title" id="musicAppSongTitle">Êú™Êí≠Êîæ</div>
          <div class="music-app-artist" id="musicAppArtist">-</div>
          <div class="music-app-progress"><div class="music-app-progress-bar" id="musicAppProgressBar" onclick="seekMusic(event)"><div class="music-app-progress-fill" id="musicAppProgressFill"></div></div><div class="music-app-times"><span id="musicAppCurTime">0:00</span><span id="musicAppDurTime">0:00</span></div></div>
          <div class="music-app-controls">
            <div class="ctrl-btn" onclick="musicPrev()">‚èÆÔ∏è</div>
            <div class="ctrl-play" id="musicAppPlayBtn" onclick="musicTogglePlay()">‚ñ∂Ô∏è</div>
            <div class="ctrl-btn" onclick="musicNext()">‚è≠Ô∏è</div>
          </div>
          <div class="music-app-playlist" id="musicAppPlaylist"></div>
          <div class="music-add-form" id="musicAddForm" style="display:none">
            <input type="text" id="musicAddUrl" placeholder="Èü≥È¢ëÈìæÊé• (mp3/ogg/wav URL)">
            <input type="text" id="musicAddName" placeholder="Ê≠åÊõ≤ÂêçÁß∞">
            <input type="text" id="musicAddArtist" placeholder="Ê≠åÊâã (ÈÄâÂ°´)">
            <input type="text" id="musicAddCover" placeholder="Â∞ÅÈù¢ÂõæÁâáÈìæÊé• (ÈÄâÂ°´)">
            <div class="music-add-row"><button class="music-add-btn" onclick="musicAddSong()">Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®</button></div>
          </div>
        </div>
      </div>

      <!-- Shopping Mall Screen -->
      <div class="screen shop-screen" id="shopScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeShop()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">üéÅ Á§ºÁâ©ÂïÜÂüé</div>
        </div>
        <div class="shop-balance">
          <div class="bal-label">ÊàëÁöÑ‰ΩôÈ¢ù</div>
          <div class="bal-amount" id="shopBalanceAmount">1000</div>
          <button class="bal-recharge" onclick="shopRecharge()">ÂÖÖÂÄº</button>
        </div>
        <div class="shop-body" id="shopBody"></div>
      </div>

      <!-- Add/Edit Anniversary Modal -->
      <div class="modal-overlay" id="annivModal">
        <div class="modal-box">
          <h3 id="annivModalTitle">Ê∑ªÂä†Á∫™ÂøµÊó•</h3>
          <div class="form-item">
            <label>Ê†áÈ¢ò</label><input type="text" id="annivTitle" placeholder="Â¶ÇÔºöÂú®‰∏ÄËµ∑ÁöÑÊó•Â≠ê" />
          </div>
          <div class="form-item"><label>Êó•Êúü</label><input type="date" id="annivDate" /></div>
          <div class="form-item">
            <label>ÂõæÊ†á</label
            ><input
              type="text"
              id="annivIcon"
              placeholder="üíù"
              maxlength="4"
              style="font-size: 24px; text-align: center"
            />
          </div>
          <div class="modal-btns">
            <button class="btn-cancel" onclick="closeAnnivModal()">ÂèñÊ∂à</button
            ><button class="btn-save" onclick="saveAnniversary()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Message context menu container -->
      <div id="msgContextMenu" style="display: none"></div>

      <!-- Edit message modal -->
      <div class="modal-overlay" id="editMsgModal">
        <div class="modal-box edit-msg-modal">
          <h3>ÁºñËæëÊ∂àÊÅØ</h3>
          <textarea class="edit-msg-textarea" id="editMsgTextarea"></textarea>
          <div class="modal-btns">
            <button class="btn-cancel" onclick="closeEditMsgModal()">ÂèñÊ∂à</button
            ><button class="btn-save" onclick="saveEditMsg()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Modal for editing contact -->
      <div class="modal-overlay" id="editModal">
        <div class="modal-box">
          <h3>ÁºñËæëËÅîÁ≥ª‰∫∫</h3>
          <div class="avatar-picker">
            <div class="avatar-preview" id="editAvatarPreview" style="background: #07c160" onclick="pickAvatar('edit')">
              ?
              <div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>
            </div>
          </div>
          <div class="form-item"><label>Â§áÊ≥®Âêç</label><input type="text" id="editContactName" /></div>
          <div class="form-item">
            <label>Á≥ªÁªüÊèêÁ§∫ËØç</label><textarea id="editContactPrompt" style="min-height: 60px"></textarea>
          </div>
          <div class="form-item">
            <label>ËÅäÂ§©ËÉåÊôØ</label>
            <div class="bg-options" id="bgOptions"></div>
          </div>
          <div class="modal-btns">
            <button class="btn-cancel" onclick="closeEditModal()">ÂèñÊ∂à</button
            ><button class="btn-save" onclick="saveEditContact()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Notification popup -->
      <div id="notifPopup" style="display: none"></div>

      <!-- Contact context menu -->
      <div id="contactCtxMenu" style="display: none"></div>

      <!-- Transfer modal -->
      <div class="modal-overlay" id="transferModal">
        <div class="modal-box trp-modal">
          <h3>üí∞ ËΩ¨Ë¥¶</h3>
          <input type="number" class="trp-amount-input" id="transferAmount" placeholder="0.00" min="0" step="0.01" />
          <input type="text" class="trp-note-input" id="transferNote" placeholder="Ê∑ªÂä†ËΩ¨Ë¥¶ËØ¥ÊòéÔºàÈÄâÂ°´Ôºâ" />
          <div class="trp-preview" id="transferPreview">ËΩ¨Ë¥¶Áªô <span id="transferTo">ÂØπÊñπ</span></div>
          <button class="trp-send-btn transfer" onclick="sendTransfer()">ËΩ¨Ë¥¶</button>
          <div class="modal-btns" style="margin-top: 8px">
            <button class="btn-cancel" onclick="closeTransferModal()" style="width: 100%">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>

      <!-- Red Packet modal -->
      <div class="modal-overlay" id="redPacketModal">
        <div class="modal-box trp-modal" style="background: #fa9d3b; color: #fff">
          <h3 style="color: #fff">üßß ÂèëÁ∫¢ÂåÖ</h3>
          <input
            type="number"
            class="trp-amount-input"
            id="rpAmount"
            placeholder="0.00"
            min="0"
            step="0.01"
            style="color: #e8520a"
          />
          <input
            type="text"
            class="trp-note-input"
            id="rpGreeting"
            placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©"
            style="text-align: center"
          />
          <button
            class="trp-send-btn redpacket"
            onclick="sendRedPacket()"
            style="background: #e8520a; margin-top: 14px"
          >
            Â°ûËøõÁ∫¢ÂåÖ
          </button>
          <div class="modal-btns" style="margin-top: 8px">
            <button
              class="btn-cancel"
              onclick="closeRedPacketModal()"
              style="width: 100%; background: rgba(255, 255, 255, 0.2); color: #fff"
            >
              ÂèñÊ∂à
            </button>
          </div>
        </div>
      </div>

      <!-- Widget Picker Modal -->
      <div class="modal-overlay" id="widgetPickerModal">
        <div class="modal-box" style="width: 320px; max-height: 520px">
          <h3>‚ú® Ê∑ªÂä†Â∞èÁªÑ‰ª∂</h3>
          <div class="widget-picker-grid" id="widgetPickerGrid"></div>
          <div class="modal-btns" style="margin-top: 12px">
            <button class="btn-cancel" onclick="closeWidgetPicker()" style="width: 100%">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>

      <input type="file" id="chatImageInput" accept="image/*" style="display: none" />
      <input type="file" id="avatarFileInput" accept="image/*" style="display: none" />
      <input type="file" id="pngCardInput" accept=".png" style="display: none" />
      <input type="file" id="chatBgFileInput" accept="image/*" style="display: none" />
      <input type="file" id="widgetBgInput" accept="image/*" style="display: none" />
      <input type="file" id="wallpaperInput" accept="image/*" style="display: none" />
    </div>

    <script>
      const AVATAR_COLORS = [
        '#07c160',
        '#1989fa',
        '#ff9500',
        '#ff3b30',
        '#af52de',
        '#5856d6',
        '#ff2d55',
        '#00c7be',
        '#34c759',
        '#ff6482',
      ];
      let screenStack = ['lock'];
      let currentContactId = null;
      let isStreaming = false;
      let editingContactId = null;
      let avatarPickTarget = null; // 'new' | 'edit' | 'user'
      let newContactAvatarData = null;
      let editContactAvatarData = null;

      const defaultSettings = {
        endpoint: 'https://morning-rain-6898.ruoxixin2.workers.dev/v1/chat/completions',
        apiKey: '',
        model: 'gpt-4o-mini',
        temperature: 0.7,
        userName: 'Êàë',
        userAvatar: '',
        persona: '',
        worldbook: '',
        jailbreak: '',
      };
      function loadSettings() {
        try {
          const s = localStorage.getItem('ai_phone_settings');
          return s ? { ...defaultSettings, ...JSON.parse(s) } : { ...defaultSettings };
        } catch {
          return { ...defaultSettings };
        }
      }
      function storeSettings(s) {
        safeStore('ai_phone_settings', s);
      }
      let settings = loadSettings();

      function loadContacts() {
        try {
          const c = localStorage.getItem('ai_phone_contacts');
          return c ? JSON.parse(c) : [];
        } catch {
          return [];
        }
      }
      function storeContacts(c) {
        safeStore('ai_phone_contacts', c);
      }
      let contacts = loadContacts();
      // Migrate old contacts to add new fields
      contacts.forEach(c => {
        if (c.pinned === undefined) c.pinned = false;
        if (c.muted === undefined) c.muted = false;
        if (c.chatBg === undefined) c.chatBg = '';
      });
      if (contacts.length === 0) {
        contacts.push({
          id: Date.now(),
          name: 'AIÂä©Êâã',
          color: '#07c160',
          systemPrompt: '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã',
          messages: [],
          lastTime: '',
          avatar: '',
          pinned: false,
          muted: false,
          chatBg: '',
        });
      }
      storeContacts(contacts);

      function loadWeiboPosts() {
        try {
          const w = localStorage.getItem('ai_phone_weibo');
          return w ? JSON.parse(w) : [];
        } catch {
          return [];
        }
      }
      function storeWeiboPosts(w) {
        safeStore('ai_phone_weibo', w);
      }
      let weiboPosts = loadWeiboPosts();
      if (weiboPosts.length === 0) {
        weiboPosts = [
          {
            id: 1,
            user: 'AIÁßëÊäÄÂâçÊ≤ø',
            color: '#e6162d',
            time: '10ÂàÜÈíüÂâç',
            content: 'ü§ñ #AIÊñ∞Á™ÅÁ†¥# GPT-5 Âç≥Â∞ÜÂèëÂ∏ÉÔºåÊçÆ‰º†Â∞ÜÊîØÊåÅÂ§öÊ®°ÊÄÅÂÆûÊó∂‰∫§‰∫íÔºÅ',
            likes: 1523,
            comments: 342,
            reposts: 128,
            liked: false,
          },
          {
            id: 2,
            user: 'ÊØèÊó•‰∏ÄË®Ä',
            color: '#ff9500',
            time: '30ÂàÜÈíüÂâç',
            content: 'üí° "‰∏çË¶ÅÁ≠âÂæÖÊú∫‰ºöÔºåËÄåË¶ÅÂàõÈÄ†Êú∫‰ºö„ÄÇ" ‚Äî‚Äî Ëêß‰ºØÁ∫≥\n\nÊó©ÂÆâ ‚òÄÔ∏è',
            likes: 892,
            comments: 67,
            reposts: 45,
            liked: false,
          },
          {
            id: 3,
            user: 'ÁæéÈ£üÊé¢Â∫óÂÆò',
            color: '#07c160',
            time: '1Â∞èÊó∂Ââç',
            content: 'üçú Êé¢Â∫óÊâìÂç°ÔºÅÊµìÈÉÅË±öÈ™®Ê±§Â∫ïÊãâÈù¢Êé®ËçêÊåáÊï∞ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\n\n#ÁæéÈ£üÊé®Ëçê# #Êé¢Â∫óÊâìÂç°#',
            likes: 2341,
            comments: 456,
            reposts: 89,
            liked: false,
          },
          {
            id: 4,
            user: 'Á®ãÂ∫èÁåøÊó•Êä•',
            color: '#5856d6',
            time: '2Â∞èÊó∂Ââç',
            content: 'üë®‚Äçüíª ‰∫ßÂìÅÁªèÁêÜÔºöËøô‰∏™ÈúÄÊ±ÇÂæàÁÆÄÂçï\nÁ®ãÂ∫èÂëòÔºöÈÇ£‰Ω†Êù•ÂÜô\n‰∫ßÂìÅÁªèÁêÜÔºö...\n\n#Á®ãÂ∫èÂëòÊó•Â∏∏#',
            likes: 5678,
            comments: 1023,
            reposts: 567,
            liked: false,
          },
        ];
        storeWeiboPosts(weiboPosts);
      }

      const phone = document.getElementById('phone');
      const lockScreen = document.getElementById('lockScreen');
      const homeScreen = document.getElementById('homeScreen');
      const contactsScreen = document.getElementById('contactsScreen');
      const newContactScreen = document.getElementById('newContactScreen');
      const chatScreen = document.getElementById('chatScreen');
      const settingsScreen = document.getElementById('settingsScreen');
      const weiboScreen = document.getElementById('weiboScreen');
      const controlCenter = document.getElementById('controlCenter');
      const chatContainer = document.getElementById('chatContainer');
      const userInput = document.getElementById('userInput');
      const sendBtn = document.getElementById('sendBtn');
      const toastEl = document.getElementById('toast');
      const contactsBody = document.getElementById('contactsBody');

      const calendarAppScreen = document.getElementById('calendarAppScreen');
      const anniversaryScreen = document.getElementById('anniversaryScreen');

      const musicAppScreen = document.getElementById('musicAppScreen');
      const shopScreen = document.getElementById('shopScreen');

      const allScreens = {
        lock: lockScreen,
        home: homeScreen,
        contacts: contactsScreen,
        newContact: newContactScreen,
        chat: chatScreen,
        settings: settingsScreen,
        weibo: weiboScreen,
        calendarApp: calendarAppScreen,
        anniversary: anniversaryScreen,
        musicApp: musicAppScreen,
        shop: shopScreen,
      };

      function updateTime() {
        const now = new Date();
        const t = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('statusTime').textContent = t;
        document.getElementById('lockTime').textContent = t;
        const days = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
        document.getElementById('lockDate').textContent =
          `${now.getMonth() + 1}Êúà${now.getDate()}Êó• ${days[now.getDay()]}`;
      }
      updateTime();
      setInterval(updateTime, 10000);

      function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 2000);
      }
      function getNowTimeStr() {
        const now = new Date();
        return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      }
      function getActiveScreen() {
        return screenStack[screenStack.length - 1];
      }
      function setStatusBarDark(dark) {
        document.getElementById('statusBar').classList.toggle('dark', dark);
      }
      function esc(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      // Lock
      let lockStartY = 0;
      lockScreen.addEventListener(
        'touchstart',
        e => {
          lockStartY = e.touches[0].clientY;
        },
        { passive: true },
      );
      lockScreen.addEventListener(
        'touchend',
        e => {
          if (lockStartY - e.changedTouches[0].clientY > 60) unlockPhone();
        },
        { passive: true },
      );
      lockScreen.addEventListener('mousedown', e => {
        lockStartY = e.clientY;
      });
      lockScreen.addEventListener('mouseup', e => {
        if (lockStartY - e.clientY > 50) unlockPhone();
      });

      function unlockPhone() {
        lockScreen.style.transform = 'translateY(-100%)';
        lockScreen.style.opacity = '0';
        homeScreen.classList.remove('hidden');
        screenStack = ['home'];
        setTimeout(() => {
          lockScreen.classList.add('hidden');
          lockScreen.style.transform = '';
          lockScreen.style.opacity = '';
        }, 400);
      }
      function lockPhone() {
        screenStack = ['lock'];
        Object.values(allScreens).forEach(s => {
          s.classList.remove('active');
          s.style.transform = '';
        });
        lockScreen.classList.remove('hidden');
        lockScreen.style.transform = '';
        lockScreen.style.opacity = '';
        homeScreen.classList.add('hidden');
        setStatusBarDark(false);
      }

      // Nav
      function pushScreen(name) {
        allScreens[name].classList.add('active');
        allScreens[name].style.transform = '';
        screenStack.push(name);
        setStatusBarDark(name !== 'home');
      }
      function popScreen() {
        if (screenStack.length <= 1) return;
        const name = screenStack.pop();
        allScreens[name].style.transform = '';
        allScreens[name].classList.remove('active');
        setStatusBarDark(getActiveScreen() !== 'home');
      }

      function openContacts() {
        renderContacts();
        pushScreen('contacts');
      }
      function closeContacts() {
        popScreen();
      }
      function openNewContact() {
        editingContactId = null;
        newContactAvatarData = null;
        document.getElementById('newContactTitle').textContent = 'Êñ∞Âª∫ËÅîÁ≥ª‰∫∫';
        document.getElementById('createOrSaveBtn').textContent = 'ÂàõÂª∫ËÅîÁ≥ª‰∫∫';
        document.getElementById('createOrSaveBtn').onclick = createContact;
        selectedColor = AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)];
        document.getElementById('newContactName').value = '';
        document.getElementById('newContactPrompt').value = '';
        renderColorOptions();
        updateAvatarPreview();
        pushScreen('newContact');
      }
      function closeNewContact() {
        popScreen();
      }
      function openChatWith(contactId) {
        currentContactId = contactId;
        const c = contacts.find(x => x.id === contactId);
        if (!c) return;
        document.getElementById('chatTitle').textContent = c.name;
        applyChatBg(c);
        renderChatMessages(c);
        pushScreen('chat');
        updateGenerateButton();
      }
      function applyChatBg(contact) {
        const bg = contact.chatBg || '';
        const container = chatContainer;
        if (!bg) {
          container.style.background = '#ededed';
          container.style.backgroundImage = '';
        } else if (bg.startsWith('data:') || bg.startsWith('http')) {
          container.style.background = `url(${bg}) center/cover no-repeat`;
        } else {
          container.style.background = bg;
          container.style.backgroundImage = '';
        }
      }
      function closeChat() {
        currentContactId = null;
        popScreen();
        renderContacts();
      }
      function openSettings() {
        document.getElementById('settingEndpoint').value = settings.endpoint;
        document.getElementById('settingApiKey').value = settings.apiKey;
        document.getElementById('settingModel').value = settings.model;
        document.getElementById('settingTemperature').value = settings.temperature;
        document.getElementById('settingUserName').value = settings.userName || 'Êàë';
        document.getElementById('settingPersona').value = settings.persona || '';
        document.getElementById('settingWorldbook').value = settings.worldbook || '';
        document.getElementById('settingJailbreak').value = settings.jailbreak || '';
        const uap = document.getElementById('userAvatarPreview');
        if (settings.userAvatar) {
          uap.innerHTML = `<img src="${settings.userAvatar}">`;
        } else {
          uap.textContent = (settings.userName || 'Êàë').charAt(0);
        }
        pushScreen('settings');
      }
      function closeSettings() {
        popScreen();
      }
      function openWeibo() {
        renderWeiboPosts();
        pushScreen('weibo');
      }
      function closeWeibo() {
        document.getElementById('weiboCompose').classList.remove('open');
        weiboComposeOpen = false;
        popScreen();
      }

      // Fetch models from API
      async function fetchModels() {
        const endpoint = document.getElementById('settingEndpoint').value.trim() || defaultSettings.endpoint;
        const apiKey = document.getElementById('settingApiKey').value.trim();
        const btn = document.getElementById('fetchModelsBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ ÊãâÂèñ‰∏≠‚Ä¶';
        try {
          // Build candidate URLs for models endpoint
          const candidateUrls = [];

          // 1. Try replacing /chat/completions with /models
          if (endpoint.includes('/chat/completions')) {
            candidateUrls.push(endpoint.replace('/chat/completions', '/models'));
          }
          // 2. Try replacing /completions with /models
          if (endpoint.includes('/completions')) {
            candidateUrls.push(endpoint.replace('/completions', '/models'));
          }
          // 3. Try extracting base URL and appending /v1/models
          try {
            const url = new URL(endpoint);
            const pathParts = url.pathname.split('/').filter(Boolean);
            // Try /v1/models
            candidateUrls.push(`${url.origin}/v1/models`);
            // Try just /models
            candidateUrls.push(`${url.origin}/models`);
            // If path has a prefix like /api, try /api/v1/models
            if (pathParts.length > 0 && pathParts[0] !== 'v1') {
              candidateUrls.push(`${url.origin}/${pathParts[0]}/v1/models`);
              candidateUrls.push(`${url.origin}/${pathParts[0]}/models`);
            }
          } catch {}

          // Deduplicate
          const uniqueUrls = [...new Set(candidateUrls)];
          console.log('Trying model endpoints:', uniqueUrls);

          let models = [];
          let lastError = '';

          for (const modelsUrl of uniqueUrls) {
            try {
              const fetchHeaders = {};
              if (apiKey) fetchHeaders['Authorization'] = `Bearer ${apiKey}`;
              const response = await fetch(modelsUrl, {
                method: 'GET',
                headers: fetchHeaders,
              });

              if (!response.ok) {
                const text = await response.text();
                try {
                  const errData = JSON.parse(text);
                  lastError = errData.error?.message || `HTTP ${response.status}`;
                } catch {
                  lastError = `HTTP ${response.status}`;
                }
                continue;
              }

              const text = await response.text();
              // Check if response is actually JSON
              if (text.trim().startsWith('<')) {
                lastError = `${modelsUrl} ËøîÂõû‰∫Ü HTML È°µÈù¢ËÄåÈùû JSON`;
                continue;
              }

              const data = JSON.parse(text);
              if (Array.isArray(data.data)) {
                models = data.data
                  .map(m => (typeof m === 'string' ? m : m.id))
                  .filter(Boolean)
                  .sort();
              } else if (Array.isArray(data)) {
                models = data
                  .map(m => (typeof m === 'string' ? m : m.id))
                  .filter(Boolean)
                  .sort();
              } else if (data.object === 'list' && Array.isArray(data.data)) {
                models = data.data
                  .map(m => m.id)
                  .filter(Boolean)
                  .sort();
              }

              if (models.length > 0) {
                console.log(`Found ${models.length} models from ${modelsUrl}`);
                break;
              }
            } catch (e) {
              lastError = e.message;
              continue;
            }
          }

          if (models.length === 0) {
            const detail = uniqueUrls.map(u => `‚Ä¢ ${u}`).join('\n');
            throw new Error((lastError || 'Êú™ÊâæÂà∞ÂèØÁî®Ê®°Âûã') + '\n\nÂ∑≤Â∞ùËØï‰ª•‰∏ãÁ´ØÁÇπ:\n' + detail);
          }

          // Populate select
          const select = document.getElementById('modelSelect');
          const currentModel = document.getElementById('settingModel').value.trim();
          select.innerHTML =
            '<option value="">-- ÈÄâÊã©Ê®°Âûã (' +
            models.length +
            '‰∏™) --</option>' +
            models.map(m => `<option value="${m}" ${m === currentModel ? 'selected' : ''}>${m}</option>`).join('');
          select.style.display = 'block';
          showToast(`‚úÖ Â∑≤ÊãâÂèñ ${models.length} ‰∏™Ê®°Âûã`);
        } catch (err) {
          alert('ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•\n\n' + (err.message || String(err)));
          showToast('‚ö†Ô∏è ÊãâÂèñÂ§±Ë¥•');
          console.error('Fetch models error:', err);
        } finally {
          btn.disabled = false;
          btn.textContent = 'üì° ÊãâÂèñÊ®°Âûã';
        }
      }

      function selectFetchedModel(value) {
        if (value) {
          document.getElementById('settingModel').value = value;
        }
      }

      function saveSettings() {
        settings.endpoint = document.getElementById('settingEndpoint').value.trim() || defaultSettings.endpoint;
        settings.apiKey = document.getElementById('settingApiKey').value.trim();
        settings.model = document.getElementById('settingModel').value.trim() || defaultSettings.model;
        settings.temperature =
          parseFloat(document.getElementById('settingTemperature').value) || defaultSettings.temperature;
        settings.userName = document.getElementById('settingUserName').value.trim() || 'Êàë';
        settings.persona = document.getElementById('settingPersona').value;
        settings.worldbook = document.getElementById('settingWorldbook').value;
        settings.jailbreak = document.getElementById('settingJailbreak').value;
        storeSettings(settings);
        showToast('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
      }

      // Avatar picker
      document.getElementById('avatarFileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function (ev) {
          const dataUrl = await compressImage(ev.target.result, 128);
          if (avatarPickTarget === 'new') {
            newContactAvatarData = dataUrl;
            const p = document.getElementById('newAvatarPreview');
            p.innerHTML = `<img src="${dataUrl}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          } else if (avatarPickTarget === 'edit') {
            editContactAvatarData = dataUrl;
            const p = document.getElementById('editAvatarPreview');
            p.innerHTML = `<img src="${dataUrl}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          } else if (avatarPickTarget === 'user') {
            settings.userAvatar = dataUrl;
            storeSettings(settings);
            const uap = document.getElementById('userAvatarPreview');
            uap.innerHTML = `<img src="${dataUrl}">`;
          }
        };
        reader.readAsDataURL(file);
        this.value = '';
      });
      function pickAvatar(target) {
        avatarPickTarget = target;
        document.getElementById('avatarFileInput').click();
      }

      // Control Center
      let ccStartY = 0,
        ccOpen = false;
      phone.addEventListener('mousedown', e => {
        const rect = phone.getBoundingClientRect();
        if (e.clientY - rect.top < 44 && !ccOpen && getActiveScreen() !== 'lock') ccStartY = e.clientY;
      });
      phone.addEventListener('mousemove', e => {
        if (ccStartY > 0 && e.clientY - ccStartY > 40) {
          openControlCenter();
          ccStartY = 0;
        }
      });
      phone.addEventListener('mouseup', () => {
        ccStartY = 0;
      });
      phone.addEventListener(
        'touchstart',
        e => {
          const rect = phone.getBoundingClientRect();
          if (e.touches[0].clientY - rect.top < 44 && !ccOpen && getActiveScreen() !== 'lock')
            ccStartY = e.touches[0].clientY;
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchmove',
        e => {
          if (ccStartY > 0 && e.touches[0].clientY - ccStartY > 40) {
            openControlCenter();
            ccStartY = 0;
          }
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchend',
        () => {
          ccStartY = 0;
        },
        { passive: true },
      );
      function openControlCenter() {
        controlCenter.classList.add('open');
        ccOpen = true;
      }
      function closeControlCenter() {
        controlCenter.classList.remove('open');
        ccOpen = false;
      }

      // Swipe back
      let swipeStartX = 0,
        swipeStartY = 0,
        swiping = false,
        swipeTarget = null;
      function getSwipeScreen() {
        const s = getActiveScreen();
        return ['contacts', 'newContact', 'chat', 'settings', 'weibo', 'calendarApp', 'anniversary', 'musicApp', 'shop'].includes(s)
          ? allScreens[s]
          : null;
      }
      phone.addEventListener('mousedown', e => {
        const rect = phone.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const screen = getSwipeScreen();
        if (x < 30 && screen) {
          swipeStartX = e.clientX;
          swipeStartY = e.clientY;
          swiping = true;
          swipeTarget = screen;
          e.preventDefault();
        }
      });
      phone.addEventListener('mousemove', e => {
        if (!swiping || !swipeTarget) return;
        const dx = e.clientX - swipeStartX;
        if (dx > 0 && dx > Math.abs(e.clientY - swipeStartY)) {
          swipeTarget.style.transform = `translateX(${Math.min(dx, 375)}px)`;
          swipeTarget.style.transition = 'none';
        }
      });
      phone.addEventListener('mouseup', e => {
        if (!swiping || !swipeTarget) return;
        swiping = false;
        const dx = e.clientX - swipeStartX;
        swipeTarget.style.transition = '';
        if (dx > 120) {
          const s = getActiveScreen();
          if (s === 'chat') closeChat();
          else if (s === 'newContact') closeNewContact();
          else if (s === 'contacts') closeContacts();
          else if (s === 'settings') closeSettings();
          else if (s === 'weibo') closeWeibo();
          else if (s === 'calendarApp') closeCalendarApp();
          else if (s === 'anniversary') closeAnniversaryApp();
          else if (s === 'musicApp') closeMusicApp();
          else if (s === 'shop') closeShop();
        } else {
          swipeTarget.style.transform = 'translateX(0)';
        }
        swipeTarget = null;
      });
      phone.addEventListener(
        'touchstart',
        e => {
          const rect = phone.getBoundingClientRect();
          const x = e.touches[0].clientX - rect.left;
          const screen = getSwipeScreen();
          if (x < 30 && screen) {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
            swiping = true;
            swipeTarget = screen;
          }
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchmove',
        e => {
          if (!swiping || !swipeTarget) return;
          const dx = e.touches[0].clientX - swipeStartX;
          if (dx > 0 && dx > Math.abs(e.touches[0].clientY - swipeStartY)) {
            swipeTarget.style.transform = `translateX(${Math.min(dx, 375)}px)`;
            swipeTarget.style.transition = 'none';
          }
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchend',
        e => {
          if (!swiping || !swipeTarget) return;
          swiping = false;
          const dx = e.changedTouches[0].clientX - swipeStartX;
          swipeTarget.style.transition = '';
          if (dx > 120) {
            const s = getActiveScreen();
            if (s === 'chat') closeChat();
            else if (s === 'newContact') closeNewContact();
            else if (s === 'contacts') closeContacts();
            else if (s === 'settings') closeSettings();
            else if (s === 'weibo') closeWeibo();
          else if (s === 'calendarApp') closeCalendarApp();
          else if (s === 'anniversary') closeAnniversaryApp();
          else if (s === 'musicApp') closeMusicApp();
          else if (s === 'shop') closeShop();
          } else {
            swipeTarget.style.transform = 'translateX(0)';
          }
          swipeTarget = null;
        },
        { passive: true },
      );

      // Contacts
      function renderContactAvatar(c, size) {
        if (c.avatar) return `<img src="${esc(c.avatar)}" style="width:${size}px;height:${size}px;object-fit:cover;">`;
        return c.name.charAt(0).toUpperCase();
      }

      function getSortedContacts() {
        // Pinned contacts first, then by last message time
        return [...contacts].sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });
      }

      function renderContacts() {
        if (contacts.length === 0) {
          contactsBody.innerHTML =
            '<div class="empty-contacts"><div class="empty-icon">üí¨</div><div>ËøòÊ≤°ÊúâËÅîÁ≥ª‰∫∫</div><div>ÁÇπÂáªÂè≥‰∏äËßí Ôºã Êàñ üì• ÂàõÂª∫</div></div>';
          return;
        }
        const sorted = getSortedContacts();
        contactsBody.innerHTML = sorted
          .map(c => {
            const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length - 1] : null;
            const preview = lastMsg
              ? (lastMsg.role === 'user' ? 'Êàë: ' : '') + lastMsg.content.slice(0, 30)
              : 'ÊöÇÊó†Ê∂àÊÅØ';
            const avatarStyle = c.avatar ? '' : `style="background:${c.color}"`;
            const avatarContent = c.avatar ? `<img src="${esc(c.avatar)}">` : c.name.charAt(0).toUpperCase();
            const pinIcon = c.pinned ? '<span class="pin-icon">üìå</span>' : '';
            const muteIcon = c.muted ? '<span class="mute-icon">üîï</span>' : '';
            const pinnedClass = c.pinned ? ' pinned' : '';
            return `<div class="contact-item${pinnedClass}" onclick="openChatWith(${c.id})" oncontextmenu="event.preventDefault();showContactCtxMenu(event,${c.id})"><div class="contact-avatar" ${avatarStyle}>${avatarContent}</div><div class="contact-info"><div class="contact-name">${esc(c.name)}${pinIcon}${muteIcon}</div><div class="contact-preview">${esc(preview)}</div></div><div class="contact-time">${c.lastTime || ''}</div></div>`;
          })
          .join('');
      }

      // Contact context menu (long press / right click on contact)
      function showContactCtxMenu(e, contactId) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === contactId);
        if (!c) return;
        const phoneRect = phone.getBoundingClientRect();
        let x = e.clientX - phoneRect.left;
        let y = e.clientY - phoneRect.top;
        if (x > 220) x = 220;
        if (y > 650) y = 650;
        const menu = document.getElementById('contactCtxMenu');
        const pinText = c.pinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'üìå ÁΩÆÈ°∂';
        const muteText = c.muted ? 'üîî ÂèñÊ∂àÂÖçÊâìÊâ∞' : 'üîï Ê∂àÊÅØÂÖçÊâìÊâ∞';
        menu.innerHTML = `<div class="msg-context-overlay" onclick="closeContactCtxMenu()"></div><div class="contact-ctx-menu" style="left:${x}px;top:${y}px;">
    <div class="ctx-item" onclick="togglePin(${contactId})">${pinText}</div>
    <div class="ctx-item" onclick="toggleMute(${contactId})">${muteText}</div>
    <div class="ctx-item" onclick="editContactFromList(${contactId})">‚úèÔ∏è ‰øÆÊîπÂ§áÊ≥®</div>
    <div class="ctx-item danger" onclick="closeContactCtxMenu();deleteContact(${contactId})">üóëÔ∏è Âà†Èô§</div>
  </div>`;
        menu.style.display = 'block';
      }
      function closeContactCtxMenu() {
        const m = document.getElementById('contactCtxMenu');
        m.style.display = 'none';
        m.innerHTML = '';
      }
      function togglePin(id) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === id);
        if (c) {
          c.pinned = !c.pinned;
          storeContacts(contacts);
          renderContacts();
          showToast(c.pinned ? 'Â∑≤ÁΩÆÈ°∂' : 'Â∑≤ÂèñÊ∂àÁΩÆÈ°∂');
        }
      }
      function toggleMute(id) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === id);
        if (c) {
          c.muted = !c.muted;
          storeContacts(contacts);
          renderContacts();
          showToast(c.muted ? 'Â∑≤ÂºÄÂêØÂÖçÊâìÊâ∞' : 'Â∑≤ÂÖ≥Èó≠ÂÖçÊâìÊâ∞');
        }
      }
      function editContactFromList(id) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === id);
        if (!c) return;
        editingContactId = id;
        editContactAvatarData = c.avatar || null;
        document.getElementById('editContactName').value = c.name;
        document.getElementById('editContactPrompt').value = c.systemPrompt || '';
        const p = document.getElementById('editAvatarPreview');
        if (c.avatar) {
          p.innerHTML = `<img src="${c.avatar}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          p.style.background = 'transparent';
        } else {
          p.style.background = c.color;
          p.innerHTML = c.name.charAt(0).toUpperCase() + '<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
        }
        renderBgOptions(c.chatBg || '');
        document.getElementById('editModal').classList.add('show');
      }

      function deleteContact(id) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§Ôºü')) return;
        contacts = contacts.filter(c => c.id !== id);
        storeContacts(contacts);
        renderContacts();
        showToast('Â∑≤Âà†Èô§');
      }

      let selectedColor = AVATAR_COLORS[0];
      function renderColorOptions() {
        document.getElementById('colorOptions').innerHTML = AVATAR_COLORS.map(
          c =>
            `<div class="color-dot ${c === selectedColor ? 'selected' : ''}" style="background:${c}" onclick="selectColor('${c}')"></div>`,
        ).join('');
      }
      function selectColor(c) {
        selectedColor = c;
        renderColorOptions();
        updateAvatarPreview();
      }
      function updateAvatarPreview() {
        const name = document.getElementById('newContactName').value.trim();
        const p = document.getElementById('newAvatarPreview');
        if (newContactAvatarData) {
          p.innerHTML = `<img src="${newContactAvatarData}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          return;
        }
        p.style.background = selectedColor;
        p.innerHTML = (name ? name.charAt(0).toUpperCase() : '?') + '<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
      }
      document.addEventListener('input', e => {
        if (e.target.id === 'newContactName') updateAvatarPreview();
      });

      function createContact() {
        const name = document.getElementById('newContactName').value.trim();
        if (!name) {
          showToast('‚ö†Ô∏è ËØ∑ËæìÂÖ•ËÅîÁ≥ª‰∫∫ÂêçÁß∞');
          return;
        }
        const prompt = document.getElementById('newContactPrompt').value.trim() || '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã';
        contacts.unshift({
          id: Date.now(),
          name,
          color: selectedColor,
          systemPrompt: prompt,
          messages: [],
          lastTime: '',
          avatar: newContactAvatarData || '',
          pinned: false,
          muted: false,
          chatBg: '',
        });
        storeContacts(contacts);
        closeNewContact();
        renderContacts();
        showToast('‚úÖ ËÅîÁ≥ª‰∫∫Â∑≤ÂàõÂª∫');
      }

      // Edit contact
      let editContactBg = '';
      const BG_PRESETS = [
        { label: 'ÈªòËÆ§', value: '', color: '#ededed' },
        { label: 'Â§ú', value: '#1c1c1e', color: '#1c1c1e' },
        { label: 'Ëìù', value: '#d4e8f7', color: '#d4e8f7' },
        { label: 'Áªø', value: '#d4f0e0', color: '#d4f0e0' },
        { label: 'Á≤â', value: '#f7d4e8', color: '#f7d4e8' },
        { label: 'Á¥´', value: '#e8d4f7', color: '#e8d4f7' },
      ];

      function renderBgOptions(currentBg) {
        editContactBg = currentBg || '';
        const container = document.getElementById('bgOptions');
        container.innerHTML =
          BG_PRESETS.map(
            bg =>
              `<div class="bg-option ${editContactBg === bg.value ? 'selected' : ''}" style="background:${bg.color};" onclick="selectBg('${bg.value}')" title="${bg.label}"></div>`,
          ).join('') +
          `<div class="bg-option custom-bg ${editContactBg && !BG_PRESETS.some(b => b.value === editContactBg) ? 'selected' : ''}" onclick="pickChatBg()" title="Ëá™ÂÆö‰πâÂõæÁâá">üñº</div>`;
      }
      function selectBg(v) {
        editContactBg = v;
        renderBgOptions(v);
      }
      function pickChatBg() {
        document.getElementById('chatBgFileInput').click();
      }
      document.getElementById('chatBgFileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          editContactBg = ev.target.result;
          renderBgOptions(editContactBg);
        };
        reader.readAsDataURL(file);
        this.value = '';
      });

      function editCurrentContact() {
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        if (!c) return;
        editingContactId = currentContactId;
        editContactAvatarData = c.avatar || null;
        document.getElementById('editContactName').value = c.name;
        document.getElementById('editContactPrompt').value = c.systemPrompt || '';
        const p = document.getElementById('editAvatarPreview');
        if (c.avatar) {
          p.innerHTML = `<img src="${c.avatar}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          p.style.background = 'transparent';
        } else {
          p.style.background = c.color;
          p.innerHTML = c.name.charAt(0).toUpperCase() + '<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
        }
        renderBgOptions(c.chatBg || '');
        document.getElementById('editModal').classList.add('show');
      }
      function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
        editingContactId = null;
      }
      function saveEditContact() {
        if (!editingContactId) return;
        const c = contacts.find(x => x.id === editingContactId);
        if (!c) return;
        const newName = document.getElementById('editContactName').value.trim();
        if (newName) c.name = newName;
        c.systemPrompt = document.getElementById('editContactPrompt').value.trim();
        if (editContactAvatarData) c.avatar = editContactAvatarData;
        c.chatBg = editContactBg || '';
        storeContacts(contacts);
        if (currentContactId === editingContactId) {
          document.getElementById('chatTitle').textContent = c.name;
          applyChatBg(c);
        }
        closeEditModal();
        renderContacts();
        showToast('‚úÖ Â∑≤‰øùÂ≠ò');
      }

      // Import PNG character card
      function openImportCard() {
        document.getElementById('pngCardInput').click();
      }
      document.getElementById('pngCardInput').addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;
        this.value = '';
        try {
          const { name, description, personality, scenario, first_mes, system_prompt, avatar } =
            await parsePngCard(file);
          const sysPrompt = [system_prompt, description, personality, scenario].filter(Boolean).join('\n\n');
          const contactName = name || file.name.replace(/\.png$/i, '');
          const newContact = {
            id: Date.now(),
            name: contactName,
            color: AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)],
            systemPrompt: sysPrompt || '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã',
            messages: [],
            lastTime: '',
            avatar: avatar || '',
            pinned: false,
            muted: false,
            chatBg: '',
          };
          if (first_mes) {
            newContact.messages.push({ role: 'assistant', content: first_mes });
            newContact.lastTime = getNowTimeStr();
          }
          contacts.unshift(newContact);
          storeContacts(contacts);
          renderContacts();
          showToast(`‚úÖ Â∑≤ÂØºÂÖ•ËßíËâ≤Ôºö${contactName}`);
        } catch (err) {
          showToast(`‚ö†Ô∏è ÂØºÂÖ•Â§±Ë¥•Ôºö${err.message}`);
        }
      });

      // Compress image to small JPEG data URL
      function compressImage(dataUrl, maxSize = 128) {
        return new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width,
              h = img.height;
            if (w > h) {
              if (w > maxSize) {
                h = (h * maxSize) / w;
                w = maxSize;
              }
            } else {
              if (h > maxSize) {
                w = (w * maxSize) / h;
                h = maxSize;
              }
            }
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = () => resolve(dataUrl);
          img.src = dataUrl;
        });
      }

      // Safe localStorage write with quota handling
      function safeStore(key, value) {
        try {
          localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
        } catch (e) {
          showToast('‚ö†Ô∏è Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåËØ∑Âà†Èô§‰∏Ä‰∫õËÅîÁ≥ª‰∫∫ÊàñÊ∏ÖÁêÜÊï∞ÊçÆ');
          console.error('Storage error:', e);
        }
      }

      // Properly decode base64 to UTF-8 string (fixes garbled text for non-ASCII)
      function b64DecodeUnicode(b64str) {
        const binaryStr = atob(b64str);
        const bytes = new Uint8Array(binaryStr.length);
        for (let i = 0; i < binaryStr.length; i++) {
          bytes[i] = binaryStr.charCodeAt(i);
        }
        return new TextDecoder('utf-8').decode(bytes);
      }

      async function parsePngCard(file) {
        const buf = await file.arrayBuffer();
        const bytes = new Uint8Array(buf);
        // Read PNG chunks to find tEXt or iTXt with chara
        let offset = 8; // skip PNG signature
        let charaData = null;
        const td = new TextDecoder('utf-8'); // utf-8 is ASCII-compatible
        while (offset + 8 <= bytes.length) {
          const len = (bytes[offset] << 24) | (bytes[offset + 1] << 16) | (bytes[offset + 2] << 8) | bytes[offset + 3];
          const type = String.fromCharCode(bytes[offset + 4], bytes[offset + 5], bytes[offset + 6], bytes[offset + 7]);
          const chunkData = offset + 8 + len <= bytes.length ? bytes.slice(offset + 8, offset + 8 + len) : null;
          if (chunkData) {
            if (type === 'tEXt') {
              const nullIdx = chunkData.indexOf(0);
              if (nullIdx !== -1) {
                const keyword = td.decode(chunkData.slice(0, nullIdx));
                if (keyword === 'chara') {
                  const b64 = td.decode(chunkData.slice(nullIdx + 1));
                  try {
                    const jsonStr = b64DecodeUnicode(b64.trim());
                    charaData = JSON.parse(jsonStr);
                  } catch (e) {
                    console.warn('tEXt chara parse failed:', e);
                  }
                }
              }
            } else if (type === 'iTXt') {
              const nullIdx = chunkData.indexOf(0);
              if (nullIdx !== -1) {
                const keyword = td.decode(chunkData.slice(0, nullIdx));
                if (keyword === 'chara') {
                  let pos = nullIdx + 1 + 2;
                  while (pos < chunkData.length && chunkData[pos] !== 0) pos++;
                  pos++;
                  while (pos < chunkData.length && chunkData[pos] !== 0) pos++;
                  pos++;
                  const textBytes = chunkData.slice(pos);
                  const b64 = td.decode(textBytes);
                  try {
                    const jsonStr = b64DecodeUnicode(b64.trim());
                    charaData = JSON.parse(jsonStr);
                  } catch (e) {
                    try {
                      charaData = JSON.parse(td.decode(textBytes));
                    } catch (e2) {
                      console.warn('iTXt chara parse failed:', e, e2);
                    }
                  }
                }
              }
            }
          }
          offset += 12 + len;
          if (type === 'IEND') break;
        }
        if (!charaData) throw new Error('Êú™ÊâæÂà∞ËßíËâ≤Âç°Êï∞ÊçÆÔºàËØ∑Á°ÆËÆ§PNGÊñá‰ª∂ÂåÖÂê´ËßíËâ≤Âç°‰ø°ÊÅØÔºâ');
        const d = charaData.data || charaData;
        // Convert file to compressed data URL for avatar persistence
        const rawDataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        const avatarDataUrl = await compressImage(rawDataUrl, 128);
        return {
          name: d.name || '',
          description: d.description || '',
          personality: d.personality || '',
          scenario: d.scenario || '',
          first_mes: d.first_mes || '',
          system_prompt: d.system_prompt || '',
          avatar: avatarDataUrl,
        };
      }

      // Chat
      let editingMsgIndex = -1;

      function renderChatMessages(contact) {
        chatContainer.innerHTML = `<div class="system-msg">‰∏é ${esc(contact.name)} ÁöÑÂØπËØù</div>`;
        contact.messages.forEach((m, idx) =>
          chatContainer.appendChild(createMessageRow(m.role === 'user' ? 'user' : 'ai', m.content, contact, idx)),
        );
        scrollToBottom();
      }

      function createMessageRow(role, content, contact, msgIndex) {
        const row = document.createElement('div');
        row.className = `message-row ${role}`;
        if (typeof msgIndex === 'number') row.dataset.msgIndex = msgIndex;
        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        if (role === 'ai') {
          if (contact && contact.avatar) {
            avatar.innerHTML = `<img src="${contact.avatar}">`;
          } else {
            avatar.style.background = contact ? contact.color : '#07c160';
            avatar.textContent = contact ? contact.name.charAt(0).toUpperCase() : 'AI';
          }
        } else {
          if (settings.userAvatar) {
            avatar.innerHTML = `<img src="${settings.userAvatar}">`;
          } else {
            avatar.style.background = '#1989fa';
            avatar.textContent = (settings.userName || 'Êàë').charAt(0);
          }
        }
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        if (content === '__typing__') {
          bubble.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        } else if (content.startsWith('__transfer__')) {
          const data = JSON.parse(content.replace('__transfer__', ''));
          bubble.className = 'msg-transfer';
          bubble.innerHTML = `<div class="transfer-body"><div class="transfer-icon">üí∞</div><div class="transfer-info"><div class="transfer-amount">¬•${esc(data.amount)}</div><div class="transfer-note">${esc(data.note)}</div></div></div><div class="transfer-footer">ÂæÆ‰ø°ËΩ¨Ë¥¶</div>`;
        } else if (content.startsWith('__redpacket__')) {
          const data = JSON.parse(content.replace('__redpacket__', ''));
          const opened = data.opened;
          bubble.className = `msg-redpacket${opened ? ' opened' : ''}`;
          bubble.innerHTML = `<div class="rp-body"><div class="rp-icon">üßß</div><div class="rp-info"><div class="rp-greeting">${esc(data.greeting)}</div><div class="rp-amount">¬•${esc(data.amount)}</div></div></div><div class="rp-footer"><span>${opened ? 'Â∑≤È¢ÜÂèñ' : 'Êü•ÁúãÁ∫¢ÂåÖ'}</span><span>ÂæÆ‰ø°Á∫¢ÂåÖ</span></div>`;
          if (!opened && typeof msgIndex === 'number') {
            bubble.onclick = () => openRedPacketMsg(msgIndex);
          }
        } else if (content.startsWith('__image__')) {
          const imgUrl = content.replace('__image__', '');
          bubble.className = 'msg-image';
          bubble.innerHTML = `<img src="${imgUrl}">`;
        } else if (content.startsWith('__gift__')) {
          const data = JSON.parse(content.replace('__gift__', ''));
          bubble.className = 'msg-gift';
          bubble.innerHTML = `<div class="gift-icon">${data.icon}</div><div class="gift-text">ÈÄÅ‰Ω†‰∏Ä‰∏™${esc(data.name)}</div><div class="gift-note">Á§ºÁâ©</div>`;
        } else {
          bubble.textContent = content;
        }

        // Add context menu on right-click and long-press for actual messages
        if (typeof msgIndex === 'number') {
          bubble.addEventListener('contextmenu', e => {
            e.preventDefault();
            showMsgContextMenu(e, msgIndex, role);
          });
          let longPressTimer = null;
          bubble.addEventListener(
            'touchstart',
            e => {
              longPressTimer = setTimeout(() => {
                e.preventDefault();
                const touch = e.touches[0];
                showMsgContextMenu({ clientX: touch.clientX, clientY: touch.clientY }, msgIndex, role);
              }, 500);
            },
            { passive: false },
          );
          bubble.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
          });
          bubble.addEventListener('touchmove', () => {
            clearTimeout(longPressTimer);
          });
        }

        row.appendChild(avatar);
        row.appendChild(bubble);
        return row;
      }

      // Message context menu
      function showMsgContextMenu(e, msgIndex, role) {
        closeMsgContextMenu();
        const phoneRect = phone.getBoundingClientRect();
        let x = e.clientX - phoneRect.left;
        let y = e.clientY - phoneRect.top;
        // Clamp within phone bounds
        if (x > 250) x = 250;
        if (y > 700) y = 700;

        const menu = document.getElementById('msgContextMenu');
        let items = '';
        if (role === 'user') {
          items += `<div class="ctx-item" onclick="editMsg(${msgIndex})">‚úèÔ∏è ÁºñËæë</div>`;
          items += `<div class="ctx-item" onclick="recallMsg(${msgIndex})">‚Ü©Ô∏è Êí§Âõû</div>`;
        }
        items += `<div class="ctx-item" onclick="copyMsg(${msgIndex})">üìã Â§çÂà∂</div>`;
        items += `<div class="ctx-item danger" onclick="deleteMsg(${msgIndex})">üóëÔ∏è Âà†Èô§</div>`;

        menu.innerHTML = `<div class="msg-context-overlay" onclick="closeMsgContextMenu()"></div><div class="msg-context-menu" style="left:${x}px;top:${y}px;">${items}</div>`;
        menu.style.display = 'block';
      }

      function closeMsgContextMenu() {
        const menu = document.getElementById('msgContextMenu');
        menu.style.display = 'none';
        menu.innerHTML = '';
      }

      function deleteMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) {
          showToast('‚ö†Ô∏è Âà†Èô§Â§±Ë¥•ÔºöÊú™ÊâæÂà∞ËÅîÁ≥ª‰∫∫');
          return;
        }
        if (idx < 0 || idx >= contact.messages.length) {
          showToast('‚ö†Ô∏è Âà†Èô§Â§±Ë¥•ÔºöÊ∂àÊÅØ‰∏çÂ≠òÂú®');
          return;
        }
        contact.messages.splice(idx, 1);
        storeContacts(contacts);
        renderChatMessages(contact);
        updateGenerateButton();
        showToast('Â∑≤Âà†Èô§');
      }

      function recallMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || idx < 0 || idx >= contact.messages.length) return;
        if (contact.messages[idx].role !== 'user') {
          showToast('Âè™ËÉΩÊí§ÂõûËá™Â∑±ÁöÑÊ∂àÊÅØ');
          return;
        }
        contact.messages.splice(idx, 1);
        storeContacts(contacts);
        renderChatMessages(contact);
        updateGenerateButton();
        // Add recall system message
        const sysMsg = document.createElement('div');
        sysMsg.className = 'system-msg';
        sysMsg.textContent = '‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
        chatContainer.appendChild(sysMsg);
        scrollToBottom();
        showToast('Â∑≤Êí§Âõû');
      }

      function copyMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || idx < 0 || idx >= contact.messages.length) return;
        const text = contact.messages[idx].content;
        navigator.clipboard
          .writeText(text)
          .then(() => showToast('Â∑≤Â§çÂà∂'))
          .catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showToast('Â∑≤Â§çÂà∂');
          });
      }

      function editMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || idx < 0 || idx >= contact.messages.length) return;
        if (contact.messages[idx].role !== 'user') {
          showToast('Âè™ËÉΩÁºñËæëËá™Â∑±ÁöÑÊ∂àÊÅØ');
          return;
        }
        editingMsgIndex = idx;
        document.getElementById('editMsgTextarea').value = contact.messages[idx].content;
        document.getElementById('editMsgModal').classList.add('show');
      }

      function closeEditMsgModal() {
        document.getElementById('editMsgModal').classList.remove('show');
        editingMsgIndex = -1;
      }

      function saveEditMsg() {
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || editingMsgIndex < 0 || editingMsgIndex >= contact.messages.length) return;
        const newText = document.getElementById('editMsgTextarea').value.trim();
        if (!newText) {
          showToast('Ê∂àÊÅØ‰∏çËÉΩ‰∏∫Á©∫');
          return;
        }
        contact.messages[editingMsgIndex].content = newText;
        storeContacts(contacts);
        renderChatMessages(contact);
        updateGenerateButton();
        closeEditMsgModal();
        showToast('Â∑≤ÁºñËæë');
      }

      function scrollToBottom() {
        requestAnimationFrame(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
      }
      userInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      });
      userInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function updateGenerateButton() {
        if (!currentContactId) {
          hideGenerateBtn();
          return;
        }
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || contact.messages.length === 0) {
          hideGenerateBtn();
          return;
        }
        const lastMsg = contact.messages[contact.messages.length - 1];
        const btn = document.getElementById('generateBtn');
        if (lastMsg.role === 'user') {
          btn.textContent = 'üîÑ ÁîüÊàêÂõûÂ§ç';
        } else {
          btn.textContent = 'üîÑ ÈáçÊñ∞ÁîüÊàê';
        }
        showGenerateBtn();
      }
      function showGenerateBtn() {
        document.getElementById('generateRow').style.display = 'block';
        scrollToBottom();
      }
      function hideGenerateBtn() {
        document.getElementById('generateRow').style.display = 'none';
      }

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isStreaming || !currentContactId) return;
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        chatContainer.appendChild(createMessageRow('user', text, contact));
        contact.messages.push({ role: 'user', content: text });
        contact.lastTime = getNowTimeStr();
        storeContacts(contacts);
        userInput.value = '';
        userInput.style.height = 'auto';
        scrollToBottom();
        updateGenerateButton();
      }

      async function generateReply() {
        if (isStreaming || !currentContactId) return;
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        // If last message is from AI (regenerate mode), remove it first
        if (contact.messages.length > 0 && contact.messages[contact.messages.length - 1].role === 'assistant') {
          contact.messages.pop();
          storeContacts(contacts);
        }
        hideGenerateBtn();
        const typingRow = createMessageRow('ai', '__typing__', contact);
        chatContainer.appendChild(typingRow);
        scrollToBottom();
        isStreaming = true;
        sendBtn.disabled = true;
        document.getElementById('generateBtn').disabled = true;
        try {
          const messages = [];
          if (contact.systemPrompt) messages.push({ role: 'system', content: contact.systemPrompt });
          if (settings.persona && settings.persona.trim())
            messages.push({ role: 'system', content: `[Áî®Êà∑‰∫∫ËÆæ‰ø°ÊÅØ]\n${settings.persona.trim()}` });
          if (settings.worldbook && settings.worldbook.trim())
            messages.push({ role: 'system', content: settings.worldbook.trim() });
          contact.messages.forEach(m => {
            if (m.content.startsWith('__image__')) {
              const imgUrl = m.content.replace('__image__', '');
              messages.push({ role: m.role, content: [{ type: 'image_url', image_url: { url: imgUrl } }, { type: 'text', text: '(Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåËØ∑ÊèèËø∞Âπ∂ÂõûÂ∫î)' }] });
            } else if (m.content.startsWith('__gift__')) {
              const gd = JSON.parse(m.content.replace('__gift__', ''));
              messages.push({ role: m.role, content: `(Áî®Êà∑ÈÄÅ‰∫Ü‰Ω†‰∏Ä‰∏™Á§ºÁâ©Ôºö${gd.name} ${gd.icon})` });
            } else if (!m.content.startsWith('__transfer__') && !m.content.startsWith('__redpacket__')) {
              messages.push({ role: m.role, content: m.content });
            }
          });
          if (settings.jailbreak && settings.jailbreak.trim())
            messages.push({ role: 'system', content: settings.jailbreak.trim() });
          const headers = { 'Content-Type': 'application/json' };
          if (settings.apiKey) headers['Authorization'] = `Bearer ${settings.apiKey}`;
          let response;
          try {
            response = await fetch(settings.endpoint, {
              method: 'POST',
              headers,
              body: JSON.stringify({ model: settings.model, messages, stream: false, temperature: settings.temperature, max_tokens: 4096 }),
            });
          } catch (fetchErr) {
            throw new Error(`Êó†Ê≥ïËøûÊé•Âà∞ API Á´ØÁÇπÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ´ØÁÇπÂú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ„ÄÇ\n\nËØ¶ÊÉÖ: ${fetchErr.message}`);
          }

          const text = await response.text();

          // Check if response is HTML (endpoint returned a web page, not API)
          if (text.trim().startsWith('<!') || text.trim().startsWith('<html')) {
            throw new Error(`API Á´ØÁÇπËøîÂõû‰∫ÜÁΩëÈ°µËÄåÈùû JSON Êï∞ÊçÆ„ÄÇ\n\nËøôÈÄöÂ∏∏ÊÑèÂë≥ÁùÄÔºö\n‚Ä¢ ‰∏≠ËΩ¨ÊúçÂä°Âô®Âú∞ÂùÄÂ∑≤Â§±ÊïàÊàñ‰∏çÊ≠£Á°Æ\n‚Ä¢ Á´ØÁÇπ URL ÊåáÂêë‰∫Ü‰∏Ä‰∏™ÁΩëÈ°µËÄå‰∏çÊòØ API\n\nËØ∑ÂâçÂæÄ„ÄêËÆæÁΩÆ„ÄëÊõ¥Êç¢ API Á´ØÁÇπÂú∞ÂùÄ„ÄÇ`);
          }

          if (!response.ok) {
            let errData = {};
            try { errData = JSON.parse(text); } catch (e) {}
            throw new Error(errData.error?.message || `HTTP ${response.status}: ${text.slice(0, 150)}`);
          }

          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error(`API ËøîÂõû‰∫ÜÊó†Ê≥ïËß£ÊûêÁöÑÊï∞ÊçÆ: ${text.slice(0, 150)}`);
          }

          let fullContent = data.choices?.[0]?.message?.content || '';

          chatContainer.removeChild(typingRow);

          // Guard: don't save empty replies
          if (!fullContent) {
            const aiRow = createMessageRow('ai', '‚ö†Ô∏è AI ËøîÂõû‰∫ÜÁ©∫ÂõûÂ§ç', contact);
            chatContainer.appendChild(aiRow);
            alert(
              'AI ËøîÂõû‰∫ÜÁ©∫ÂõûÂ§ç\n\nÂèØËÉΩÂéüÂõ†Ôºö\n‚Ä¢ API Á´ØÁÇπ‰∏çÊîØÊåÅÊµÅÂºèËæìÂá∫ÔºàstreamÔºâ\n‚Ä¢ Ê®°ÂûãÂêçÁß∞‰∏çÊ≠£Á°Æ\n‚Ä¢ API Key ‰ΩôÈ¢ù‰∏çË∂≥\n\nÂΩìÂâçÈÖçÁΩÆÔºö\n‚Ä¢ Á´ØÁÇπÔºö' +
                settings.endpoint +
                '\n‚Ä¢ Ê®°ÂûãÔºö' +
                settings.model,
            );
          } else {
            // Split AI reply into multiple messages by double newline
            const parts = fullContent.split(/\n\n+/).map(s => s.trim()).filter(Boolean);
            if (parts.length <= 1) {
              // Single message, show directly
              const aiRow = createMessageRow('ai', fullContent, contact, contact.messages.length);
              chatContainer.appendChild(aiRow);
              contact.messages.push({ role: 'assistant', content: fullContent });
            } else {
              // Multiple messages: show first immediately, then rest with typing delays
              const firstRow = createMessageRow('ai', parts[0], contact, contact.messages.length);
              chatContainer.appendChild(firstRow);
              contact.messages.push({ role: 'assistant', content: parts[0] });
              scrollToBottom();
              for (let i = 1; i < parts.length; i++) {
                // Show typing indicator
                const typingRow2 = createMessageRow('ai', '__typing__', contact);
                chatContainer.appendChild(typingRow2);
                scrollToBottom();
                // Wait 600-1200ms per message (longer for longer text)
                const delay = Math.min(600 + parts[i].length * 15, 2500);
                await new Promise(r => setTimeout(r, delay));
                // Replace typing with actual message
                if (typingRow2.parentNode) chatContainer.removeChild(typingRow2);
                const msgIdx = contact.messages.length;
                const row = createMessageRow('ai', parts[i], contact, msgIdx);
                chatContainer.appendChild(row);
                contact.messages.push({ role: 'assistant', content: parts[i] });
                scrollToBottom();
              }
            }
          }
          contact.lastTime = getNowTimeStr();
          storeContacts(contacts);
          renderContacts();
          if (!contact.muted) {
            showNotification(contact, fullContent);
          }
        } catch (err) {
          if (typingRow.parentNode) chatContainer.removeChild(typingRow);
          chatContainer.appendChild(createMessageRow('ai', `‚ö†Ô∏è ${err.message}`, contact));
          scrollToBottom();
          alert(
            'ÁîüÊàêÂõûÂ§çÂ§±Ë¥•\n\n' +
              err.message +
              '\n\nÂΩìÂâçÈÖçÁΩÆÔºö\n‚Ä¢ Á´ØÁÇπÔºö' +
              settings.endpoint +
              '\n‚Ä¢ Ê®°ÂûãÔºö' +
              settings.model,
          );
        } finally {
          isStreaming = false;
          sendBtn.disabled = false;
          document.getElementById('generateBtn').disabled = false;
          userInput.focus();
          updateGenerateButton();
        }
      }

      // AI call helper (non-streaming)
      async function aiCall(systemPrompt, userPrompt) {
        const aiHeaders = { 'Content-Type': 'application/json' };
        if (settings.apiKey) aiHeaders['Authorization'] = `Bearer ${settings.apiKey}`;
        let response;
        try {
          response = await fetch(settings.endpoint, {
            method: 'POST',
            headers: aiHeaders,
            body: JSON.stringify({
              model: settings.model,
              messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt },
              ],
              temperature: settings.temperature,
              max_tokens: 4096,
            }),
          });
        } catch (fetchErr) {
          throw new Error(`Êó†Ê≥ïËøûÊé•Âà∞ API Á´ØÁÇπÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ´ØÁÇπÂú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ„ÄÇ\nËØ¶ÊÉÖ: ${fetchErr.message}`);
        }
        const text = await response.text();
        if (text.trim().startsWith('<!') || text.trim().startsWith('<html')) {
          throw new Error('API Á´ØÁÇπËøîÂõû‰∫ÜÁΩëÈ°µËÄåÈùû JSONÔºåËØ∑ÂâçÂæÄ„ÄêËÆæÁΩÆ„ÄëÊõ¥Êç¢ API Á´ØÁÇπÂú∞ÂùÄ„ÄÇ');
        }
        if (!response.ok) {
          let errData = {};
          try { errData = JSON.parse(text); } catch (e) {}
          throw new Error(errData.error?.message || `HTTP ${response.status}: ${text.slice(0, 150)}`);
        }
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          throw new Error(`API ËøîÂõû‰∫ÜÊó†Ê≥ïËß£ÊûêÁöÑÊï∞ÊçÆ: ${text.slice(0, 150)}`);
        }
        return data.choices?.[0]?.message?.content || '';
      }

      // Weibo
      let currentWeiboTab = 'follow';
      let weiboRefreshing = false;

      function switchWeiboTab(el, tab) {
        document.querySelectorAll('.weibo-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        currentWeiboTab = tab;
        renderWeiboPosts();
      }

      function renderWeiboPosts() {
        const body = document.getElementById('weiboBody');
        let posts = weiboPosts;
        if (currentWeiboTab === 'mine') posts = weiboPosts.filter(p => p.isMine);
        else if (currentWeiboTab === 'hot') posts = [...weiboPosts].sort((a, b) => b.likes - a.likes);
        if (posts.length === 0) {
          body.innerHTML =
            '<div style="text-align:center;padding:60px 20px;color:#999;font-size:14px;">ËøòÊ≤°ÊúâÂæÆÂçöÂÜÖÂÆπ</div>';
          return;
        }
        body.innerHTML = posts
          .map(p => {
            const avatarHtml = p.avatar ? `<img src="${esc(p.avatar)}">` : p.user.charAt(0);
            const avatarStyle = p.avatar ? '' : `style="background:${p.color}"`;
            return `<div class="weibo-post"><div class="weibo-post-header"><div class="weibo-post-avatar" ${avatarStyle}>${avatarHtml}</div><div class="weibo-post-user"><div class="weibo-post-name">${esc(p.user)}</div><div class="weibo-post-time">${p.time}</div></div></div><div class="weibo-post-content">${formatWeiboContent(p.content)}</div><div class="weibo-post-actions"><div class="weibo-action" onclick="repostWeibo(${p.id})">üîÅ ${formatNum(p.reposts)}</div><div class="weibo-action" onclick="commentWeibo(${p.id})">üí¨ ${formatNum(p.comments)}</div><div class="weibo-action ${p.liked ? 'liked' : ''}" onclick="likeWeibo(${p.id})">‚ù§Ô∏è ${formatNum(p.likes)}</div></div></div>`;
          })
          .join('');
      }

      function formatWeiboContent(content) {
        return esc(content).replace(/#([^#]+)#/g, '<span class="hashtag">#$1#</span>');
      }
      function formatNum(n) {
        if (n >= 10000) return (n / 10000).toFixed(1) + '‰∏á';
        if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
        return n;
      }
      function likeWeibo(id) {
        const p = weiboPosts.find(x => x.id === id);
        if (!p) return;
        p.liked = !p.liked;
        p.likes += p.liked ? 1 : -1;
        storeWeiboPosts(weiboPosts);
        renderWeiboPosts();
      }
      function repostWeibo(id) {
        const p = weiboPosts.find(x => x.id === id);
        if (p) {
          p.reposts++;
          storeWeiboPosts(weiboPosts);
          renderWeiboPosts();
          showToast('Â∑≤ËΩ¨Âèë');
        }
      }
      function commentWeibo(id) {
        showToast('ËØÑËÆ∫ÂäüËÉΩÂºÄÂèë‰∏≠');
      }

      let weiboComposeOpen = false;
      function toggleWeiboCompose() {
        weiboComposeOpen = !weiboComposeOpen;
        document.getElementById('weiboCompose').classList.toggle('open', weiboComposeOpen);
        if (weiboComposeOpen) document.getElementById('weiboInput').focus();
      }
      function postWeibo() {
        const content = document.getElementById('weiboInput').value.trim();
        if (!content) {
          showToast('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ');
          return;
        }
        const userName = settings.userName || 'Êàë';
        weiboPosts.unshift({
          id: Date.now(),
          user: userName,
          color: '#1989fa',
          time: 'ÂàöÂàö',
          content,
          likes: 0,
          comments: 0,
          reposts: 0,
          liked: false,
          isMine: true,
          avatar: settings.userAvatar || '',
        });
        storeWeiboPosts(weiboPosts);
        document.getElementById('weiboInput').value = '';
        toggleWeiboCompose();
        renderWeiboPosts();
        showToast('‚úÖ ÂèëÂ∏ÉÊàêÂäü');
      }

      // AI-generated weibo refresh
      async function refreshWeibo() {
        if (weiboRefreshing) return;
        weiboRefreshing = true;
        showToast('üîÑ Ê≠£Âú®ÁîüÊàêÊñ∞ÂæÆÂçö‚Ä¶');
        try {
          // Build character list from contacts
          const charNames = contacts.map(c => c.name);
          const npcNames = ['Êï∞Á†ÅËææ‰∫∫Â∞èK', 'ÊóÖË°åÂçö‰∏ªLuna', 'ÂÅ•Ë∫´ÊïôÁªÉÈòøÂº∫', 'ËØª‰π¶Á¨îËÆ∞Bot', 'Èü≥‰πêÂàÜ‰∫´ÂÆò'];
          const allPosters = [...charNames, ...npcNames.slice(0, 3)];
          const posterList = allPosters.join('„ÄÅ');

          // Build persona context for character-aware weibo generation
          const charContext = contacts.map(c => `${c.name}: ${(c.systemPrompt || '').slice(0, 100)}`).join('\n');

          const prompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÂæÆÂçöÂÜÖÂÆπÁîüÊàêÂô®„ÄÇËØ∑‰∏∫‰ª•‰∏ãËßíËâ≤ÂêÑÁîüÊàê1Êù°ÂæÆÂçöÂä®ÊÄÅÔºåËßíËâ≤ÂàóË°®Ôºö${posterList}„ÄÇ

‰ª•‰∏ãÊòØÊØè‰∏™ËßíËâ≤ÁöÑ‰∫∫ËÆæÁÆÄ‰ªãÔºåËØ∑Á°Æ‰øùÂæÆÂçöÂÜÖÂÆπÁ¨¶ÂêàËßíËâ≤ÊÄßÊ†ºÔºö
${charContext}

Ë¶ÅÊ±ÇÔºö
1. ÊØèÊù°ÂæÆÂçö50-120Â≠óÔºåÈ£éÊ†ºÂêÑÂºÇÔºåË¥¥ÂêàËßíËâ≤Ë∫´‰ªΩ
2. ÈÄÇÂΩì‰ΩøÁî®emojiÂíå#ËØùÈ¢òÊ†áÁ≠æ#
3. ‰ª•JSONÊï∞ÁªÑÊ†ºÂºèËøîÂõûÔºåÊØè‰∏™ÂÖÉÁ¥†ÂåÖÂê´ user(ÂèëÂ∏ÉËÄÖÂêç) Âíå content(ÂÜÖÂÆπ) Â≠óÊÆµ
4. Âè™ËøîÂõûJSONÊï∞ÁªÑÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó`;

          const result = await aiCall('‰Ω†ÊòØ‰∏Ä‰∏™Á§æ‰∫§Â™í‰ΩìÂÜÖÂÆπÁîüÊàêÂô®ÔºåÂè™ËøîÂõûJSONÊ†ºÂºè„ÄÇ', prompt);

          // Parse JSON from response
          let posts;
          const jsonMatch = result.match(/\[[\s\S]*\]/);
          if (jsonMatch) {
            posts = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('AIËøîÂõûÊ†ºÂºèÈîôËØØ');
          }

          const timeLabels = ['ÂàöÂàö', '1ÂàÜÈíüÂâç', '3ÂàÜÈíüÂâç', '5ÂàÜÈíüÂâç', '8ÂàÜÈíüÂâç'];
          posts.forEach((p, i) => {
            const contact = contacts.find(c => c.name === p.user);
            weiboPosts.unshift({
              id: Date.now() + i,
              user: p.user,
              color: contact ? contact.color : AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)],
              time: timeLabels[i] || 'ÂàöÂàö',
              content: p.content,
              likes: Math.floor(Math.random() * 500),
              comments: Math.floor(Math.random() * 100),
              reposts: Math.floor(Math.random() * 50),
              liked: false,
              avatar: contact ? contact.avatar || '' : '',
            });
          });
          storeWeiboPosts(weiboPosts);
          renderWeiboPosts();
          showToast(`‚úÖ Â∑≤Âà∑Êñ∞ ${posts.length} Êù°Êñ∞ÂæÆÂçö`);
        } catch (err) {
          showToast(`‚ö†Ô∏è Âà∑Êñ∞Â§±Ë¥•Ôºö${err.message}`);
        } finally {
          weiboRefreshing = false;
        }
      }

      // Notification popup
      function showNotification(contact, text) {
        const popup = document.getElementById('notifPopup');
        const avatarStyle = contact.avatar ? '' : `style="background:${contact.color}"`;
        const avatarContent = contact.avatar ? `<img src="${contact.avatar}">` : contact.name.charAt(0).toUpperCase();
        popup.innerHTML = `<div class="notif-popup" id="notifBanner" onclick="notifTap(${contact.id})"><div class="notif-avatar" ${avatarStyle}>${avatarContent}</div><div class="notif-body"><div class="notif-app">‰ø°ÊÅØ</div><div class="notif-title">${esc(contact.name)}</div><div class="notif-text">${esc(text.slice(0, 60))}</div></div></div>`;
        popup.style.display = 'block';
        // Auto dismiss after 4s
        clearTimeout(popup._timer);
        popup._timer = setTimeout(() => {
          const banner = document.getElementById('notifBanner');
          if (banner) {
            banner.classList.add('hiding');
            setTimeout(() => {
              popup.style.display = 'none';
              popup.innerHTML = '';
            }, 300);
          }
        }, 4000);
      }
      function notifTap(contactId) {
        const popup = document.getElementById('notifPopup');
        popup.style.display = 'none';
        popup.innerHTML = '';
        clearTimeout(popup._timer);
        // If not already in that chat, navigate
        if (currentContactId !== contactId) {
          if (getActiveScreen() === 'chat') closeChat();
          openChatWith(contactId);
        }
      }

      // Transfer & Red Packet
      function openTransferModal() {
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        document.getElementById('transferTo').textContent = c ? c.name : 'ÂØπÊñπ';
        document.getElementById('transferAmount').value = '';
        document.getElementById('transferNote').value = '';
        document.getElementById('transferModal').classList.add('show');
        setTimeout(() => document.getElementById('transferAmount').focus(), 100);
      }
      function closeTransferModal() {
        document.getElementById('transferModal').classList.remove('show');
      }

      function sendTransfer() {
        const amount = parseFloat(document.getElementById('transferAmount').value);
        if (!amount || amount <= 0) {
          showToast('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
          return;
        }
        const note = document.getElementById('transferNote').value.trim() || 'ËΩ¨Ë¥¶';
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        contact.messages.push({
          role: 'user',
          content: `__transfer__${JSON.stringify({ amount: amount.toFixed(2), note })}`,
        });
        contact.lastTime = getNowTimeStr();
        storeContacts(contacts);
        renderChatMessages(contact);
        closeTransferModal();
        scrollToBottom();
      }

      function openRedPacketModal() {
        if (!currentContactId) return;
        document.getElementById('rpAmount').value = '';
        document.getElementById('rpGreeting').value = '';
        document.getElementById('redPacketModal').classList.add('show');
        setTimeout(() => document.getElementById('rpAmount').focus(), 100);
      }
      function closeRedPacketModal() {
        document.getElementById('redPacketModal').classList.remove('show');
      }

      function sendRedPacket() {
        const amount = parseFloat(document.getElementById('rpAmount').value);
        if (!amount || amount <= 0) {
          showToast('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
          return;
        }
        const greeting = document.getElementById('rpGreeting').value.trim() || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©';
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        const rpId = Date.now();
        contact.messages.push({
          role: 'user',
          content: `__redpacket__${JSON.stringify({ amount: amount.toFixed(2), greeting, id: rpId, opened: false })}`,
        });
        contact.lastTime = getNowTimeStr();
        storeContacts(contacts);
        renderChatMessages(contact);
        closeRedPacketModal();
        scrollToBottom();
      }

      function openRedPacketMsg(msgIndex) {
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || msgIndex < 0 || msgIndex >= contact.messages.length) return;
        const msg = contact.messages[msgIndex];
        if (!msg.content.startsWith('__redpacket__')) return;
        const data = JSON.parse(msg.content.replace('__redpacket__', ''));
        if (data.opened) {
          showToast('Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂèñ');
          return;
        }
        data.opened = true;
        msg.content = `__redpacket__${JSON.stringify(data)}`;
        storeContacts(contacts);
        renderChatMessages(contact);
        showToast(`üßß È¢ÜÂèñ‰∫Ü ¬•${data.amount} Á∫¢ÂåÖ`);
      }

      // ======= WIDGETS =======
      const WIDGET_TYPES = [
        { type: 'clock', name: 'ÂèØÁà±Êó∂Èíü', icon: 'üïê' },
        { type: 'calendar', name: 'Â∞èÊó•ÂéÜ', icon: 'üìÖ' },
        { type: 'mood', name: 'ÂøÉÊÉÖËÆ∞ÂΩï', icon: 'üå∏' },
        { type: 'memo', name: '‰æøÁ≠æ', icon: 'üìù' },
        { type: 'pet', name: 'ÁîµÂ≠êÂÆ†Áâ©', icon: 'üê±' },
        { type: 'lovedays', name: 'ÊÅãÁà±Â§©Êï∞', icon: 'üíù' },
        { type: 'weather', name: 'Â§©Ê∞î', icon: 'üå§Ô∏è' },
        { type: 'photo', name: 'Áõ∏Ê°Ü', icon: 'üì∏' },
        { type: 'quote', name: 'ÊØèÊó•‰∏ÄÂè•', icon: '‚ú®' },
        { type: 'todo', name: 'ÂæÖÂäû‰∫ãÈ°π', icon: 'üéØ' },
        { type: 'music', name: 'Èü≥‰πê', icon: 'üéµ' },
        { type: 'battery', name: 'ÁîµÈáè', icon: 'üîã' },
      ];

      function loadWidgets() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_widgets') || '[]');
        } catch {
          return [];
        }
      }
      function storeWidgets(w) {
        safeStore('ai_phone_widgets', w);
      }
      let widgets = loadWidgets();

      function openWidgetPicker() {
        const grid = document.getElementById('widgetPickerGrid');
        grid.innerHTML = WIDGET_TYPES.map(
          w =>
            `<div class="widget-picker-item" onclick="addWidget('${w.type}')"><div class="wp-icon">${w.icon}</div><div class="wp-name">${w.name}</div></div>`,
        ).join('');
        document.getElementById('widgetPickerModal').classList.add('show');
      }
      function closeWidgetPicker() {
        document.getElementById('widgetPickerModal').classList.remove('show');
      }

      function addWidget(type) {
        const id = Date.now();
        const widget = { id, type, bg: '', data: getDefaultWidgetData(type) };
        widgets.push(widget);
        storeWidgets(widgets);
        renderWidgets();
        closeWidgetPicker();
        showToast('‚úÖ Â∑≤Ê∑ªÂä†Â∞èÁªÑ‰ª∂');
      }

      function removeWidget(id) {
        widgets = widgets.filter(w => w.id !== id);
        storeWidgets(widgets);
        renderWidgets();
      }

      let widgetBgTargetId = null;
      document.getElementById('widgetBgInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file || !widgetBgTargetId) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const w = widgets.find(x => x.id === widgetBgTargetId);
          if (w) {
            w.bg = ev.target.result;
            storeWidgets(widgets);
            renderWidgets();
          }
        };
        reader.readAsDataURL(file);
        this.value = '';
      });

      function pickWidgetBg(id) {
        widgetBgTargetId = id;
        document.getElementById('widgetBgInput').click();
      }

      function getDefaultWidgetData(type) {
        switch (type) {
          case 'mood':
            return { selected: -1, text: '' };
          case 'memo':
            return { text: '' };
          case 'pet':
            return { name: 'Â∞èÂñµ', pet: 'üê±', happiness: 80, hunger: 60 };
          case 'lovedays':
            return { startDate: new Date().toISOString().slice(0, 10), title: 'Âú®‰∏ÄËµ∑' };
          case 'todo':
            return {
              items: [
                { text: 'ÂÆåÊàê‰ªäÂ§©ÁöÑ‰ªªÂä°', done: false },
                { text: 'Âñù8ÊùØÊ∞¥', done: false },
              ],
            };
          case 'photo':
            return { src: '' };
          case 'music':
            return { playing: false, song: 'Â§úÊõ≤', artist: 'Âë®Êù∞‰º¶' };
          default:
            return {};
        }
      }

      const CUTE_QUOTES = [
        { text: '‰ªäÂ§©‰πüË¶ÅÂÖÉÊ∞îÊª°Êª°Âú∞Âä†Ê≤πÈ∏≠ÔºÅ', author: 'Â∞èÁ°ÆÂπ∏' },
        { text: '‰Ω†Á¨ëËµ∑Êù•ÁúüÂ•ΩÁúãÔºåÂÉèÊò•Â§©ÁöÑËä±‰∏ÄÊ†∑üå∏', author: 'ÂøÉËØ≠' },
        { text: 'ÁîüÊ¥ª‰∏çÊ≠¢ÁúºÂâçÁöÑËãü‰∏îÔºåËøòÊúâËØóÂíåËøúÊñπÁöÑÁî∞Èáé', author: 'È´òÊôìÊùæ' },
        { text: 'ÊÑø‰Ω†ÁúºÈáåÊúâÂÖâÔºåÂøÉ‰∏≠ÊúâÁà±üíñ', author: 'Ê∏©Êöñ' },
        { text: 'ÊØè‰∏ÄÂ§©ÈÉΩÊòØÊñ∞ÁöÑÂºÄÂßãÔºåÂæÆÁ¨ëÈù¢ÂØπ‰∏ÄÂàá', author: 'Èò≥ÂÖâ' },
        { text: 'ÂÅö‰∏Ä‰∏™Ê∏©ÊöñÁöÑ‰∫∫Ôºå‰∏çÂçë‰∏ç‰∫¢ÔºåÊ∏ÖÊæàÂñÑËâØ', author: 'ËøúÊñπ' },
        { text: '‰Ω†ÊòØÊàëËßÅËøáÊúÄÂèØÁà±ÁöÑÂ∞èÊúãÂèãÂï¶~', author: 'Â§∏Â§∏' },
        { text: '‰∏ñÁïå‰∏äÊúÄÁæéÂ•ΩÁöÑ‰∫ãÊÉÖÂ∞±ÊòØÊØèÂ§©ÈÜíÊù•ÂèàÊòØÂ¥≠Êñ∞ÁöÑ‰∏ÄÂ§©', author: 'Êô®ÂÖâ' },
      ];

      const WEATHER_DATA = [
        { icon: '‚òÄÔ∏è', temp: '26¬∞', desc: 'Êô¥Êúó', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
        { icon: '‚õÖ', temp: '22¬∞', desc: 'Â§ö‰∫ë', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
        { icon: 'üåßÔ∏è', temp: '18¬∞', desc: 'Â∞èÈõ®', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
        { icon: 'üå∏', temp: '24¬∞', desc: 'Êò•ÂÖâÊòéÂ™ö', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
      ];

      const MOOD_COLORS = ['#66bb6a', '#e91e63', '#42a5f5', '#9575cd', '#ef5350'];
      const MOOD_LABELS = ['ÂºÄÂøÉ', 'Ë∂ÖÁà±', 'Âπ≥Èùô', 'ÂøßÈÉÅ', 'ÁÉ¶Ë∫Å'];

      function renderWidgets() {
        const area = document.getElementById('widgetArea');
        if (widgets.length === 0) {
          area.innerHTML = '';
          return;
        }
        area.innerHTML = widgets
          .map(w => {
            const bgStyle = w.bg ? `<div class="widget-bg" style="background-image:url(${w.bg})"></div>` : '';
            return `<div class="widget-card" id="widget-${w.id}">${bgStyle}<div class="widget-remove" onclick="event.stopPropagation();removeWidget(${w.id})">‚úï</div><div class="widget-bg-btn" onclick="event.stopPropagation();pickWidgetBg(${w.id})">üñº</div><div class="widget-content">${renderWidgetContent(w)}</div></div>`;
          })
          .join('');
        // Start clock updates
        widgets.forEach(w => {
          if (w.type === 'clock') updateClockWidget(w.id);
        });
      }

      function renderWidgetContent(w) {
        switch (w.type) {
          case 'clock':
            return renderClockWidget(w);
          case 'calendar':
            return renderCalendarWidget(w);
          case 'mood':
            return renderMoodWidget(w);
          case 'memo':
            return renderMemoWidget(w);
          case 'pet':
            return renderPetWidget(w);
          case 'lovedays':
            return renderLoveDaysWidget(w);
          case 'weather':
            return renderWeatherWidget(w);
          case 'photo':
            return renderPhotoWidget(w);
          case 'quote':
            return renderQuoteWidget(w);
          case 'todo':
            return renderTodoWidget(w);
          case 'music':
            return renderMusicWidget(w);
          case 'battery':
            return renderBatteryWidget(w);
          default:
            return '';
        }
      }

      function renderClockWidget(w) {
        const now = new Date();
        const h = now.getHours(),
          m = now.getMinutes(),
          s = now.getSeconds();
        const hDeg = (h % 12) * 30 + m * 0.5,
          mDeg = m * 6,
          sDeg = s * 6;
        const days = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
        return `<div class="w-clock"><div class="clock-face"><div class="clock-center"></div><div class="clock-hand hand-hour" style="transform:rotate(${hDeg}deg)"></div><div class="clock-hand hand-minute" style="transform:rotate(${mDeg}deg)"></div><div class="clock-hand hand-second" style="transform:rotate(${sDeg}deg)"></div></div><div class="clock-info"><div class="clock-digital">${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}</div><div class="clock-label">${days[now.getDay()]} ¬∑ ${now.getMonth() + 1}Êúà${now.getDate()}Êó•</div></div></div>`;
      }

      function updateClockWidget(id) {
        const el = document.getElementById(`widget-${id}`);
        if (!el) return;
        const w = widgets.find(x => x.id === id);
        if (!w || w.type !== 'clock') return;
        const content = el.querySelector('.widget-content');
        if (content) content.innerHTML = renderClockWidget(w);
        setTimeout(() => updateClockWidget(id), 1000);
      }

      function renderCalendarWidget() {
        const now = new Date();
        const year = now.getFullYear(),
          month = now.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = now.getDate();
        const dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        let cells = dayNames.map(d => `<div class="cal-day-name">${d}</div>`).join('');
        for (let i = 0; i < firstDay; i++) cells += '<div class="cal-day empty">.</div>';
        for (let d = 1; d <= daysInMonth; d++) cells += `<div class="cal-day ${d === today ? 'today' : ''}">${d}</div>`;
        return `<div class="w-calendar"><div class="cal-month">${year}Âπ¥${month + 1}Êúà</div><div class="cal-grid">${cells}</div></div>`;
      }

      function renderMoodWidget(w) {
        const dots = MOOD_COLORS.map(
          (c, i) =>
            `<div class="mood-dot ${w.data.selected === i ? 'selected' : ''}" style="background:${c}" onclick="event.stopPropagation();selectMood(${w.id},${i})"></div>`,
        ).join('');
        const text = w.data.selected >= 0 ? MOOD_LABELS[w.data.selected] : 'ËÆ∞ÂΩï‰ªäÊó•ÂøÉÊÉÖ';
        return `<div class="w-mood"><div class="mood-title">TODAY'S MOOD</div><div class="mood-options">${dots}</div><div class="mood-result">${text}</div></div>`;
      }
      function selectMood(widgetId, idx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w) return;
        w.data.selected = idx;
        storeWidgets(widgets);
        renderWidgets();
      }

      function renderMemoWidget(w) {
        return `<div class="w-memo"><div class="memo-title">üìù ‰æøÁ≠æ</div><textarea placeholder="ÂÜôÁÇπ‰ªÄ‰πà‚Ä¶" oninput="updateMemo(${w.id},this.value)" onclick="event.stopPropagation()">${esc(w.data.text || '')}</textarea></div>`;
      }
      function updateMemo(id, text) {
        const w = widgets.find(x => x.id === id);
        if (w) {
          w.data.text = text;
          storeWidgets(widgets);
        }
      }

      function renderPetWidget(w) {
        const pets = ['üê±', 'üê∂', 'üê∞', 'üêª', 'üêº', 'ü¶ä', 'üê∏', 'üê•'];
        return `<div class="w-pet"><div class="pet-display">${w.data.pet}</div><div class="pet-name">${esc(w.data.name)}</div><div class="pet-status">ÂøÉÊÉÖ ${'üíñ'.repeat(Math.ceil(w.data.happiness / 20))} ¬∑ È•±ËÖπ ${'üçñ'.repeat(Math.ceil(w.data.hunger / 20))}</div><div class="pet-actions"><div class="pet-btn" onclick="event.stopPropagation();petAction(${w.id},'feed')">üçñ ÂñÇÈ£ü</div><div class="pet-btn" onclick="event.stopPropagation();petAction(${w.id},'play')">üéæ Áé©ËÄç</div><div class="pet-btn" onclick="event.stopPropagation();petAction(${w.id},'change')">üîÑ Êç¢ÂÆ†Áâ©</div></div></div>`;
      }
      function petAction(id, action) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        const pets = ['üê±', 'üê∂', 'üê∞', 'üêª', 'üêº', 'ü¶ä', 'üê∏', 'üê•'];
        const names = ['Â∞èÂñµ', 'Â∞èÊ±™', 'Â∞èÂÖî', 'Â∞èÁÜä', 'Âõ¢Âõ¢', 'Â∞èÁãê', 'Âë±Âë±', 'Â∞èÈ∏°'];
        if (action === 'feed') {
          w.data.hunger = Math.min(100, w.data.hunger + 20);
          showToast('üçñ ÂñÇÈ£üÊàêÂäü~');
        } else if (action === 'play') {
          w.data.happiness = Math.min(100, w.data.happiness + 15);
          w.data.hunger = Math.max(0, w.data.hunger - 10);
          showToast('üéæ Áé©ËÄç‰∏≠~');
        } else if (action === 'change') {
          const idx = (pets.indexOf(w.data.pet) + 1) % pets.length;
          w.data.pet = pets[idx];
          w.data.name = names[idx];
        }
        storeWidgets(widgets);
        renderWidgets();
      }

      function renderLoveDaysWidget(w) {
        const start = new Date(w.data.startDate);
        const now = new Date();
        const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
        return `<div class="w-lovedays"><div class="ld-hearts">üíïüíñüíï</div><div class="ld-title">${esc(w.data.title)}</div><div class="ld-days">${days}</div><div class="ld-label">Â§©</div><div class="ld-date-info">‰ªé ${w.data.startDate} ÂºÄÂßã</div></div>`;
      }

      function renderWeatherWidget() {
        const w = WEATHER_DATA[Math.floor(Math.random() * WEATHER_DATA.length)];
        return `<div class="w-weather"><div class="weather-icon">${w.icon}</div><div class="weather-info"><div class="weather-temp">${w.temp}</div><div class="weather-desc">${w.desc}</div><div class="weather-loc">üìç ${w.loc}</div></div></div>`;
      }

      function renderPhotoWidget(w) {
        const content = w.data.src ? `<img src="${w.data.src}">` : 'üì∑';
        return `<div class="w-photo"><div class="photo-frame" onclick="event.stopPropagation();pickWidgetPhoto(${w.id})">${content}</div><div class="photo-label">ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá</div></div>`;
      }
      function pickWidgetPhoto(id) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            const w = widgets.find(x => x.id === id);
            if (w) {
              w.data.src = ev.target.result;
              storeWidgets(widgets);
              renderWidgets();
            }
          };
          reader.readAsDataURL(file);
        };
        input.click();
      }

      function renderQuoteWidget(w) {
        const defaultQ = CUTE_QUOTES[Math.floor(Date.now() / 86400000) % CUTE_QUOTES.length];
        const text = w.data.customText || defaultQ.text;
        const author = w.data.customAuthor || defaultQ.author;
        const editing = w.data._editing;
        let editArea = '';
        if (editing) {
          editArea = `<div class="quote-edit-area"><textarea placeholder="ËæìÂÖ•Âè•Â≠ê‚Ä¶" id="quoteText-${w.id}" onclick="event.stopPropagation()">${esc(w.data.customText || '')}</textarea><input type="text" placeholder="‰ΩúËÄÖ" id="quoteAuthor-${w.id}" value="${esc(w.data.customAuthor || '')}" onclick="event.stopPropagation()"><button class="quote-save-btn" onclick="event.stopPropagation();saveQuote(${w.id})">‰øùÂ≠ò</button></div>`;
        } else {
          editArea = `<button class="quote-edit-btn" onclick="event.stopPropagation();editQuote(${w.id})">‚úèÔ∏è Ëá™ÂÆö‰πâ</button>`;
        }
        return `<div class="w-quote"><div class="quote-icon">‚ú®</div><div class="quote-text">"${esc(text)}"</div><div class="quote-author">‚Äî‚Äî ${esc(author)}</div>${editArea}</div>`;
      }
      function editQuote(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        w.data._editing = true;
        storeWidgets(widgets);
        renderWidgets();
      }
      function saveQuote(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        const textEl = document.getElementById(`quoteText-${id}`);
        const authorEl = document.getElementById(`quoteAuthor-${id}`);
        w.data.customText = textEl ? textEl.value.trim() : '';
        w.data.customAuthor = authorEl ? authorEl.value.trim() : '';
        w.data._editing = false;
        storeWidgets(widgets);
        renderWidgets();
        showToast('‚úÖ Â∑≤‰øùÂ≠ò');
      }

      function renderTodoWidget(w) {
        const items = (w.data.items || [])
          .map(
            (item, i) =>
              `<div class="todo-item ${item.done ? 'done' : ''}" onclick="event.stopPropagation();toggleTodo(${w.id},${i})"><div class="todo-check">${item.done ? '‚úì' : ''}</div><span>${esc(item.text)}</span><span class="todo-delete" onclick="event.stopPropagation();deleteTodoItem(${w.id},${i})" title="Âà†Èô§">‚úï</span></div>`,
          )
          .join('');
        return `<div class="w-todo"><div class="todo-title">üéØ ÂæÖÂäû‰∫ãÈ°π</div><div class="todo-list">${items}</div><div class="todo-add"><input type="text" placeholder="Ê∑ªÂä†ÂæÖÂäû‚Ä¶" id="todoInput-${w.id}" onclick="event.stopPropagation()" onkeydown="if(event.key==='Enter'){event.stopPropagation();addTodoItem(${w.id})}"><button onclick="event.stopPropagation();addTodoItem(${w.id})">+</button></div></div>`;
      }
      function toggleTodo(widgetId, idx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w || !w.data.items[idx]) return;
        w.data.items[idx].done = !w.data.items[idx].done;
        storeWidgets(widgets);
        renderWidgets();
      }
      function addTodoItem(widgetId) {
        const input = document.getElementById(`todoInput-${widgetId}`);
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;
        const w = widgets.find(x => x.id === widgetId);
        if (!w) return;
        w.data.items.push({ text, done: false });
        storeWidgets(widgets);
        renderWidgets();
      }
      function deleteTodoItem(widgetId, idx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w || !w.data.items[idx]) return;
        w.data.items.splice(idx, 1);
        storeWidgets(widgets);
        renderWidgets();
      }

      // Global audio element for music widget
      let musicAudio = null;
      let musicWidgetId = null;

      function renderMusicWidget(w) {
        const playClass = w.data.playing ? '' : 'paused';
        const playIcon = w.data.playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        const hasUrl = !!w.data.url;
        const urlRow = `<div class="music-url-row"><input type="text" class="music-url-input" placeholder="Á≤òË¥¥Èü≥‰πêURL‚Ä¶" id="musicUrl-${w.id}" value="${esc(w.data.url || '')}" onclick="event.stopPropagation()"><button class="music-url-btn" onclick="event.stopPropagation();setMusicUrl(${w.id})">ÂØºÂÖ•</button></div>`;
        const progressBar = hasUrl
          ? `<div class="music-progress"><div class="music-progress-fill" id="musicProgress-${w.id}" style="width:0%"></div></div>`
          : '';
        return `<div class="w-music"><div class="music-main"><div class="music-cover ${playClass}">üéµ</div><div class="music-info"><div class="music-title">${esc(w.data.song)}</div><div class="music-artist">${esc(w.data.artist)}</div><div class="music-controls"><span class="music-btn" onclick="event.stopPropagation();toggleMusic(${w.id})">${playIcon}</span></div></div></div>${progressBar}${urlRow}</div>`;
      }

      function setMusicUrl(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        const input = document.getElementById(`musicUrl-${id}`);
        if (!input) return;
        const url = input.value.trim();
        if (!url) {
          showToast('ËØ∑ËæìÂÖ•Èü≥‰πêURL');
          return;
        }
        w.data.url = url;
        w.data.playing = false;
        // Try to extract song name from URL
        try {
          const parts = url.split('/').pop().split('?')[0];
          if (parts)
            w.data.song = decodeURIComponent(parts)
              .replace(/\.[^.]+$/, '')
              .slice(0, 20);
        } catch {}
        storeWidgets(widgets);
        // Stop current audio
        if (musicAudio) {
          musicAudio.pause();
          musicAudio = null;
        }
        renderWidgets();
        showToast('‚úÖ Èü≥‰πêÂ∑≤ÂØºÂÖ•');
      }

      function toggleMusic(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        if (w.data.url) {
          if (!musicAudio || musicWidgetId !== id) {
            if (musicAudio) musicAudio.pause();
            musicAudio = new Audio(w.data.url);
            musicWidgetId = id;
            musicAudio.addEventListener('timeupdate', () => {
              const fill = document.getElementById(`musicProgress-${id}`);
              if (fill && musicAudio.duration) {
                fill.style.width = (musicAudio.currentTime / musicAudio.duration) * 100 + '%';
              }
            });
            musicAudio.addEventListener('ended', () => {
              w.data.playing = false;
              storeWidgets(widgets);
              renderWidgets();
            });
            musicAudio.addEventListener('error', () => {
              showToast('‚ö†Ô∏è Èü≥‰πêÂä†ËΩΩÂ§±Ë¥•');
              w.data.playing = false;
              storeWidgets(widgets);
              renderWidgets();
            });
          }
          w.data.playing = !w.data.playing;
          if (w.data.playing)
            musicAudio.play().catch(() => {
              w.data.playing = false;
              showToast('‚ö†Ô∏è Êí≠ÊîæÂ§±Ë¥•');
            });
          else musicAudio.pause();
        } else {
          w.data.playing = !w.data.playing;
        }
        storeWidgets(widgets);
        renderWidgets();
      }

      function renderBatteryWidget() {
        const level = Math.floor(50 + Math.random() * 50);
        return `<div class="w-battery"><div class="bat-visual"><div class="bat-fill" style="width:${level}%"></div></div><div class="bat-info"><div class="bat-percent">${level}%</div><div class="bat-label">‚ö° ÂÖÖÁîµ‰∏≠</div></div></div>`;
      }

      // ======= WIDGET DRAG & DROP =======
      let dragWidgetId = null;
      let dragOverWidgetId = null;

      function initWidgetDrag() {
        const area = document.getElementById('widgetArea');
        area.addEventListener('dragstart', e => {
          const card = e.target.closest('.widget-card');
          if (!card) return;
          dragWidgetId = parseInt(card.id.replace('widget-', ''));
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', dragWidgetId);
        });
        area.addEventListener('dragover', e => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          const card = e.target.closest('.widget-card');
          if (card) {
            const id = parseInt(card.id.replace('widget-', ''));
            if (id !== dragWidgetId) {
              document.querySelectorAll('.widget-card.drag-over').forEach(c => c.classList.remove('drag-over'));
              card.classList.add('drag-over');
              dragOverWidgetId = id;
            }
          }
        });
        area.addEventListener('dragleave', e => {
          const card = e.target.closest('.widget-card');
          if (card) card.classList.remove('drag-over');
        });
        area.addEventListener('drop', e => {
          e.preventDefault();
          document.querySelectorAll('.widget-card.drag-over').forEach(c => c.classList.remove('drag-over'));
          document.querySelectorAll('.widget-card.dragging').forEach(c => c.classList.remove('dragging'));
          if (dragWidgetId !== null && dragOverWidgetId !== null && dragWidgetId !== dragOverWidgetId) {
            const fromIdx = widgets.findIndex(w => w.id === dragWidgetId);
            const toIdx = widgets.findIndex(w => w.id === dragOverWidgetId);
            if (fromIdx !== -1 && toIdx !== -1) {
              const [moved] = widgets.splice(fromIdx, 1);
              widgets.splice(toIdx, 0, moved);
              storeWidgets(widgets);
              renderWidgets();
            }
          }
          dragWidgetId = null;
          dragOverWidgetId = null;
        });
        area.addEventListener('dragend', () => {
          document.querySelectorAll('.widget-card.dragging').forEach(c => c.classList.remove('dragging'));
          document.querySelectorAll('.widget-card.drag-over').forEach(c => c.classList.remove('drag-over'));
          dragWidgetId = null;
          dragOverWidgetId = null;
        });

        // Touch drag support
        let touchDragEl = null,
          touchStartY = 0,
          touchClone = null,
          touchFromIdx = -1;
        area.addEventListener(
          'touchstart',
          e => {
            const card = e.target.closest('.widget-card');
            if (
              !card ||
              e.target.closest(
                '.widget-remove, .widget-bg-btn, .pet-btn, .mood-dot, .todo-item, .todo-add, textarea, input, button',
              )
            )
              return;
            touchDragEl = card;
            touchStartY = e.touches[0].clientY;
            touchFromIdx = widgets.findIndex(w => w.id === parseInt(card.id.replace('widget-', '')));
            card._longPress = setTimeout(() => {
              card.classList.add('dragging');
              showToast('ÊãñÂä®ÊéíÂ∫è‰∏≠‚Ä¶');
            }, 400);
          },
          { passive: true },
        );
        area.addEventListener(
          'touchmove',
          e => {
            if (!touchDragEl) return;
            clearTimeout(touchDragEl._longPress);
            if (!touchDragEl.classList.contains('dragging')) return;
            const touch = e.touches[0];
            const cards = Array.from(area.querySelectorAll('.widget-card'));
            cards.forEach(c => c.classList.remove('drag-over'));
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (el) {
              const overCard = el.closest('.widget-card');
              if (overCard && overCard !== touchDragEl) overCard.classList.add('drag-over');
            }
          },
          { passive: true },
        );
        area.addEventListener(
          'touchend',
          e => {
            if (!touchDragEl) return;
            clearTimeout(touchDragEl._longPress);
            if (touchDragEl.classList.contains('dragging')) {
              const overCard = area.querySelector('.widget-card.drag-over');
              if (overCard) {
                const toIdx = widgets.findIndex(w => w.id === parseInt(overCard.id.replace('widget-', '')));
                if (touchFromIdx !== -1 && toIdx !== -1 && touchFromIdx !== toIdx) {
                  const [moved] = widgets.splice(touchFromIdx, 1);
                  widgets.splice(toIdx, 0, moved);
                  storeWidgets(widgets);
                }
              }
              renderWidgets();
            }
            touchDragEl = null;
            touchFromIdx = -1;
          },
          { passive: true },
        );
      }

      // Override renderWidgets to add draggable
      const _origRenderWidgets = renderWidgets;
      renderWidgets = function () {
        _origRenderWidgets();
        document.querySelectorAll('.widget-card').forEach(card => card.setAttribute('draggable', 'true'));
      };

      // ======= WALLPAPER =======
      const DEFAULT_WALLPAPER = 'https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg';
      function loadWallpapers() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_wallpapers') || '{}');
        } catch {
          return {};
        }
      }
      function storeWallpapers(w) {
        safeStore('ai_phone_wallpapers', w);
      }
      let wallpapers = loadWallpapers();

      function applyWallpapers() {
        const lockBg = wallpapers.lock || DEFAULT_WALLPAPER;
        const homeBg = wallpapers.home || DEFAULT_WALLPAPER;
        lockScreen.style.backgroundImage = `url('${lockBg}')`;
        homeScreen.style.backgroundImage = `url('${homeBg}')`;
        // Update previews if settings is open
        const lp = document.getElementById('lockWpPreview');
        const hp = document.getElementById('homeWpPreview');
        if (lp) lp.style.backgroundImage = `url('${lockBg}')`;
        if (hp) hp.style.backgroundImage = `url('${homeBg}')`;
      }

      let wallpaperPickTarget = null;
      function pickWallpaper(target) {
        wallpaperPickTarget = target;
        document.getElementById('wallpaperInput').click();
      }
      document.getElementById('wallpaperInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          wallpapers[wallpaperPickTarget] = ev.target.result;
          storeWallpapers(wallpapers);
          applyWallpapers();
          showToast('‚úÖ Â£ÅÁ∫∏Â∑≤Êõ¥Êç¢');
        };
        reader.readAsDataURL(file);
        this.value = '';
      });
      function resetWallpaper(target) {
        delete wallpapers[target];
        storeWallpapers(wallpapers);
        applyWallpapers();
        showToast('‚úÖ Â∑≤ÊÅ¢Â§çÈªòËÆ§Â£ÅÁ∫∏');
      }

      // Init
      applyWallpapers();

      // ======= CALENDAR APP =======
      let calViewYear, calViewMonth;
      {
        const now = new Date();
        calViewYear = now.getFullYear();
        calViewMonth = now.getMonth();
      }

      function openCalendarApp() {
        renderCalendarApp();
        pushScreen('calendarApp');
      }
      function closeCalendarApp() {
        popScreen();
      }
      function calendarPrevMonth() {
        calViewMonth--;
        if (calViewMonth < 0) {
          calViewMonth = 11;
          calViewYear--;
        }
        renderCalendarApp();
      }
      function calendarNextMonth() {
        calViewMonth++;
        if (calViewMonth > 11) {
          calViewMonth = 0;
          calViewYear++;
        }
        renderCalendarApp();
      }

      function renderCalendarApp() {
        const body = document.getElementById('calAppBody');
        const now = new Date();
        const year = calViewYear,
          month = calViewMonth;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const isCurrentMonth = year === now.getFullYear() && month === now.getMonth();
        const today = isCurrentMonth ? now.getDate() : -1;
        const dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        const annivs = loadAnniversaries();

        // Check which days have events (anniversaries)
        const eventDays = new Set();
        annivs.forEach(a => {
          const d = new Date(a.date);
          if (d.getFullYear() === year && d.getMonth() === month) eventDays.add(d.getDate());
        });

        let cells = dayNames.map(d => `<div class="cal-hd">${d}</div>`).join('');
        for (let i = 0; i < firstDay; i++) cells += '<div class="cal-cell empty">.</div>';
        for (let d = 1; d <= daysInMonth; d++) {
          const classes = ['cal-cell'];
          if (d === today) classes.push('today');
          if (eventDays.has(d)) classes.push('has-event');
          cells += `<div class="${classes.join(' ')}">${d}</div>`;
        }

        // Events this month
        const monthEvents = annivs
          .filter(a => {
            const d = new Date(a.date);
            return d.getMonth() === month; // Show anniversary month regardless of year
          })
          .map(a => {
            const d = new Date(a.date);
            const diff = Math.floor((now - d) / (1000 * 60 * 60 * 24));
            const label = diff >= 0 ? `${diff} Â§©Ââç` : `${-diff} Â§©Âêé`;
            return `<div class="cal-ev-item"><div class="cal-ev-icon">${a.icon || 'üìÖ'}</div><div class="cal-ev-info"><div class="cal-ev-name">${esc(a.title)}</div><div class="cal-ev-date">${a.date}</div></div><div class="cal-ev-days">${label}</div></div>`;
          })
          .join('');

        body.innerHTML =
          `<div class="cal-app-month">${year}Âπ¥${month + 1}Êúà</div><div class="cal-app-grid">${cells}</div>` +
          (monthEvents
            ? `<div class="cal-app-events"><div class="cal-ev-title">Êú¨ÊúàÁ∫™ÂøµÊó•</div>${monthEvents}</div>`
            : '');
      }

      // ======= ANNIVERSARY APP =======
      function loadAnniversaries() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_anniv') || '[]');
        } catch {
          return [];
        }
      }
      function storeAnniversaries(a) {
        safeStore('ai_phone_anniv', a);
      }
      let anniversaries = loadAnniversaries();
      let editingAnnivId = null;

      function openAnniversaryApp() {
        renderAnniversaries();
        pushScreen('anniversary');
      }
      function closeAnniversaryApp() {
        popScreen();
      }

      function renderAnniversaries() {
        const body = document.getElementById('annivBody');
        const annivs = loadAnniversaries();
        if (annivs.length === 0) {
          body.innerHTML =
            '<div class="anniv-empty"><div class="anniv-empty-icon">üíù</div><div>ËøòÊ≤°ÊúâÁ∫™ÂøµÊó•</div><div>ÁÇπÂáªÂè≥‰∏äËßí Ôºã Ê∑ªÂä†</div></div>';
          return;
        }
        const now = new Date();
        body.innerHTML = annivs
          .map(a => {
            const d = new Date(a.date);
            const diff = Math.abs(Math.floor((now - d) / (1000 * 60 * 60 * 24)));
            const isPast = now >= d;
            const label = isPast ? 'Â§©' : 'Â§©Âêé';
            return `<div class="anniv-card"><div class="anniv-delete" onclick="deleteAnniversary(${a.id})">‚úï</div><div class="anniv-icon">${a.icon || 'üíù'}</div><div class="anniv-title">${esc(a.title)}</div><div class="anniv-days">${diff}</div><div class="anniv-label">${label}</div><div class="anniv-date-info">üìÖ ${a.date}</div></div>`;
          })
          .join('');
      }

      function openAddAnniversary() {
        editingAnnivId = null;
        document.getElementById('annivModalTitle').textContent = 'Ê∑ªÂä†Á∫™ÂøµÊó•';
        document.getElementById('annivTitle').value = '';
        document.getElementById('annivDate').value = new Date().toISOString().slice(0, 10);
        document.getElementById('annivIcon').value = 'üíù';
        document.getElementById('annivModal').classList.add('show');
      }

      function closeAnnivModal() {
        document.getElementById('annivModal').classList.remove('show');
        editingAnnivId = null;
      }

      function saveAnniversary() {
        const title = document.getElementById('annivTitle').value.trim();
        const date = document.getElementById('annivDate').value;
        const icon = document.getElementById('annivIcon').value.trim() || 'üíù';
        if (!title) {
          showToast('‚ö†Ô∏è ËØ∑ËæìÂÖ•Ê†áÈ¢ò');
          return;
        }
        if (!date) {
          showToast('‚ö†Ô∏è ËØ∑ÈÄâÊã©Êó•Êúü');
          return;
        }
        const annivs = loadAnniversaries();
        annivs.push({ id: Date.now(), title, date, icon });
        storeAnniversaries(annivs);
        closeAnnivModal();
        renderAnniversaries();
        showToast('‚úÖ Á∫™ÂøµÊó•Â∑≤Ê∑ªÂä†');
      }

      function deleteAnniversary(id) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•Á∫™ÂøµÊó•Ôºü')) return;
        let annivs = loadAnniversaries();
        annivs = annivs.filter(a => a.id !== id);
        storeAnniversaries(annivs);
        renderAnniversaries();
        showToast('Â∑≤Âà†Èô§');
      }

      // ======= HOME PAGE PAGINATION =======
      const homePages = document.getElementById('homePages');
      const pageDots = document.getElementById('pageDots');

      function goToPage(pageIndex) {
        const pages = homePages.querySelectorAll('.home-page');
        if (pageIndex < 0 || pageIndex >= pages.length) return;
        homePages.scrollTo({ left: pageIndex * homePages.clientWidth, behavior: 'smooth' });
        updatePageDots(pageIndex);
      }

      function updatePageDots(activeIndex) {
        const dots = pageDots.querySelectorAll('.page-dot');
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === activeIndex);
        });
      }

      homePages.addEventListener('scroll', () => {
        const scrollLeft = homePages.scrollLeft;
        const pageWidth = homePages.clientWidth;
        const currentPage = Math.round(scrollLeft / pageWidth);
        updatePageDots(currentPage);
      });

      // ======= DATA-DRIVEN HOME PAGES =======
      const APP_DEFS = [
        { id: 'contacts', name: '‰ø°ÊÅØ', icon: 'https://i.postimg.cc/1fnmsLFC/IMG-1711.jpg', action: 'openContacts' },
        { id: 'weibo', name: 'ÂæÆÂçö', icon: 'https://i.postimg.cc/TpLdfZbz/IMG-1709.jpg', action: 'openWeibo' },
        {
          id: 'calendar',
          name: 'Êó•ÂéÜ',
          icon: 'https://i.postimg.cc/QH3DXzJr/wei-xin-tu-pian-20260225055225-1195-11.jpg',
          action: 'openCalendarApp',
        },
        {
          id: 'anniversary',
          name: 'Á∫™ÂøµÊó•',
          icon: 'https://i.postimg.cc/mts4bnyW/wei-xin-tu-pian-20260225055226-1196-11.jpg',
          action: 'openAnniversaryApp',
        },
        {
          id: 'musicApp',
          name: 'Èü≥‰πê',
          icon: '',
          action: 'openMusicApp',
          svgIcon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="white" stroke-width="2" fill="none"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
        },
        {
          id: 'shop',
          name: 'ÂïÜÂüé',
          icon: '',
          action: 'openShop',
          svgIcon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="white" stroke-width="2" fill="none"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>',
        },
        {
          id: 'settings',
          name: 'ËÆæÁΩÆ',
          icon: 'https://i.postimg.cc/8sWDgGWq/wei-xin-tu-pian-20260225055224-1194-11.jpg',
          action: 'openSettings',
        },
      ];

      function loadHomeLayout() {
        try {
          const l = localStorage.getItem('ai_phone_home_layout');
          if (l) return JSON.parse(l);
        } catch {}
        // Default layout: all apps on page 0
        return {
          pages: [{ apps: APP_DEFS.map(a => a.id) }, { apps: [] }],
        };
      }
      function storeHomeLayout(layout) {
        safeStore('ai_phone_home_layout', layout);
      }
      let homeLayout = loadHomeLayout();
      // Ensure layout has 2 pages
      if (!homeLayout.pages || homeLayout.pages.length < 2) {
        homeLayout = { pages: [{ apps: APP_DEFS.map(a => a.id) }, { apps: [] }] };
        storeHomeLayout(homeLayout);
      }

      function renderHomePages() {
        for (let pageIdx = 0; pageIdx < 2; pageIdx++) {
          const pageEl = document.getElementById(`homePage${pageIdx}`);
          if (!pageEl) continue;
          const pageData = homeLayout.pages[pageIdx] || { apps: [] };

          let html = '';

          // Widget area (only on page 0 for now - widgets are global)
          if (pageIdx === 0) {
            html += '<div class="widget-area" id="widgetArea"></div>';
            html += '<div class="add-widget-btn" onclick="openWidgetPicker()">‚ú® Ê∑ªÂä†Â∞èÁªÑ‰ª∂</div>';
          }

          // App grid
          if (pageData.apps.length > 0) {
            html += '<div class="app-grid">';
            pageData.apps.forEach(appId => {
              const app = APP_DEFS.find(a => a.id === appId);
              if (!app) return;
              html += `<div class="app-icon" onclick="${app.action}()">`;
              if (app.icon) {
                html += `<div class="icon-box"><img src="${app.icon}" alt="${esc(app.name)}" /></div>`;
              } else if (app.svgIcon) {
                const bgColors = { musicApp: 'linear-gradient(135deg,#e94560,#533483)', shop: 'linear-gradient(135deg,#ff6b9d,#e91e63)' };
                html += `<div class="icon-box" style="background:${bgColors[app.id] || '#eee'};display:flex;align-items:center;justify-content:center;">${app.svgIcon}</div>`;
              } else {
                const bgColors = { musicApp: 'linear-gradient(135deg,#e94560,#533483)', shop: 'linear-gradient(135deg,#ff6b9d,#e91e63)' };
                html += `<div class="icon-box" style="background:${bgColors[app.id] || '#eee'};font-size:28px;">${app.emoji || 'üì±'}</div>`;
              }
              html += `<div class="app-name">${esc(app.name)}</div>`;
              html += '</div>';
            });
            html += '</div>';
          }

          // Empty page hint for page 1 if no apps
          if (pageIdx === 1 && pageData.apps.length === 0) {
            html +=
              '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0.5;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,0.5);gap:12px;padding:40px;">';
            html += '<div style="font-size:48px;">üì±</div>';
            html += '<div style="font-size:14px;">ÂêëÂ∑¶ÊªëÂä®Êü•ÁúãÊõ¥Â§ö</div>';
            html += '<div style="font-size:12px;opacity:0.7;">ÂèØÂú®Ê≠§È°µÊ∑ªÂä†Â∫îÁî®</div>';
            html += '</div>';
          }

          pageEl.innerHTML = html;
        }

        // Re-render widgets into the widget area on page 0
        renderWidgets();
        initWidgetDrag();
      }

      // Initial render
      renderHomePages();

      // ======= API LAYER =======
      const API_BASE = 'http://localhost:4000';
      async function apiFetch(path, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const resp = await fetch(API_BASE + path, { ...options, headers });
        if (resp.status === 401) {
          // Token expired, clear and go back to auth
          authToken = null;
          localStorage.removeItem('ai_phone_token');
          serverMode = false;
          document.getElementById('authScreen').classList.remove('hidden');
          showToast('‚ö†Ô∏è ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
          throw new Error('Unauthorized');
        }
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
        return data;
      }

      // Sync data from server after login
      async function syncFromServer() {
        if (!serverMode || !authToken) return;
        try {
          // Sync contacts
          const serverContacts = await apiFetch('/api/contacts');
          if (serverContacts.length > 0) {
            // Merge: server data takes priority, but keep local-only contacts
            const serverIds = new Set(serverContacts.map(c => c.id));
            const localOnly = contacts.filter(c => !serverIds.has(c.id));
            contacts = [...serverContacts.map(c => ({
              ...c,
              messages: c.messages || [],
              pinned: c.pinned || false,
              muted: c.muted || false,
              chatBg: c.chatBg || '',
            })), ...localOnly];
          }
          // Push local contacts to server if server had none
          if (serverContacts.length === 0 && contacts.length > 0) {
            for (const c of contacts) {
              try { await apiFetch('/api/contacts', { method: 'POST', body: JSON.stringify(c) }); } catch {}
            }
          }
          storeContacts(contacts);

          // Sync settings
          try {
            const serverSettings = await apiFetch('/api/settings');
            if (serverSettings && Object.keys(serverSettings).length > 0) {
              settings = { ...defaultSettings, ...serverSettings };
              storeSettings(settings);
            }
          } catch {}

          // Sync widgets
          try {
            const serverWidgets = await apiFetch('/api/widgets');
            if (serverWidgets.length > 0) {
              widgets = serverWidgets;
              storeWidgets(widgets);
            }
          } catch {}

          // Sync weibo
          try {
            const serverWeibo = await apiFetch('/api/weibo');
            if (serverWeibo.length > 0) {
              weiboPosts = serverWeibo;
              storeWeiboPosts(weiboPosts);
            }
          } catch {}

          // Sync anniversaries
          try {
            const serverAnniv = await apiFetch('/api/anniversaries');
            if (serverAnniv.length > 0) {
              anniversaries = serverAnniv;
              storeAnniversaries(anniversaries);
            }
          } catch {}

          renderHomePages();
          console.log('‚úÖ Data synced from server');
        } catch (e) {
          console.warn('Sync failed:', e.message);
        }
      }

      // Wrap store functions to also push to server
      const _origStoreContacts = storeContacts;
      storeContacts = function(c) {
        _origStoreContacts(c);
        if (serverMode && authToken) {
          // Debounced server sync
          clearTimeout(storeContacts._timer);
          storeContacts._timer = setTimeout(async () => {
            try {
              // Simple approach: replace all contacts on server
              const serverContacts = await apiFetch('/api/contacts');
              const serverIds = new Set(serverContacts.map(x => x.id));
              // Update existing, create new
              for (const contact of c) {
                if (serverIds.has(contact.id)) {
                  await apiFetch(`/api/contacts/${contact.id}`, { method: 'PUT', body: JSON.stringify(contact) });
                } else {
                  await apiFetch('/api/contacts', { method: 'POST', body: JSON.stringify(contact) });
                }
              }
              // Delete removed contacts
              const localIds = new Set(c.map(x => x.id));
              for (const sc of serverContacts) {
                if (!localIds.has(sc.id)) {
                  await apiFetch(`/api/contacts/${sc.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) { console.warn('Contact sync error:', e.message); }
          }, 1000);
        }
      };

      const _origStoreSettings = storeSettings;
      storeSettings = function(s) {
        _origStoreSettings(s);
        if (serverMode && authToken) {
          apiFetch('/api/settings', { method: 'PUT', body: JSON.stringify(s) }).catch(e => console.warn('Settings sync error:', e.message));
        }
      };

      const _origStoreWidgets = storeWidgets;
      storeWidgets = function(w) {
        _origStoreWidgets(w);
        if (serverMode && authToken) {
          clearTimeout(storeWidgets._timer);
          storeWidgets._timer = setTimeout(async () => {
            try {
              const serverWidgets = await apiFetch('/api/widgets');
              const serverIds = new Set(serverWidgets.map(x => x.id));
              for (const widget of w) {
                if (serverIds.has(widget.id)) {
                  await apiFetch(`/api/widgets/${widget.id}`, { method: 'PUT', body: JSON.stringify(widget) });
                } else {
                  await apiFetch('/api/widgets', { method: 'POST', body: JSON.stringify(widget) });
                }
              }
              const localIds = new Set(w.map(x => x.id));
              for (const sw of serverWidgets) {
                if (!localIds.has(sw.id)) {
                  await apiFetch(`/api/widgets/${sw.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) { console.warn('Widget sync error:', e.message); }
          }, 1000);
        }
      };

      const _origStoreWeiboPosts = storeWeiboPosts;
      storeWeiboPosts = function(w) {
        _origStoreWeiboPosts(w);
        if (serverMode && authToken) {
          clearTimeout(storeWeiboPosts._timer);
          storeWeiboPosts._timer = setTimeout(async () => {
            try {
              const serverWeibo = await apiFetch('/api/weibo');
              const serverIds = new Set(serverWeibo.map(x => x.id));
              for (const post of w) {
                if (serverIds.has(post.id)) {
                  await apiFetch(`/api/weibo/${post.id}`, { method: 'PUT', body: JSON.stringify(post) });
                } else {
                  await apiFetch('/api/weibo', { method: 'POST', body: JSON.stringify(post) });
                }
              }
              const localIds = new Set(w.map(x => x.id));
              for (const sp of serverWeibo) {
                if (!localIds.has(sp.id)) {
                  await apiFetch(`/api/weibo/${sp.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) { console.warn('Weibo sync error:', e.message); }
          }, 1000);
        }
      };

      const _origStoreAnniversaries = storeAnniversaries;
      storeAnniversaries = function(a) {
        _origStoreAnniversaries(a);
        if (serverMode && authToken) {
          clearTimeout(storeAnniversaries._timer);
          storeAnniversaries._timer = setTimeout(async () => {
            try {
              const serverAnniv = await apiFetch('/api/anniversaries');
              const serverIds = new Set(serverAnniv.map(x => x.id));
              for (const ann of a) {
                if (serverIds.has(ann.id)) {
                  await apiFetch(`/api/anniversaries/${ann.id}`, { method: 'PUT', body: JSON.stringify(ann) });
                } else {
                  await apiFetch('/api/anniversaries', { method: 'POST', body: JSON.stringify(ann) });
                }
              }
              const localIds = new Set(a.map(x => x.id));
              for (const sa of serverAnniv) {
                if (!localIds.has(sa.id)) {
                  await apiFetch(`/api/anniversaries/${sa.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) { console.warn('Anniversary sync error:', e.message); }
          }, 1000);
        }
      };

      // ======= AUTH =======
      let authMode = 'login'; // 'login' | 'register'
      let authToken = localStorage.getItem('ai_phone_token') || null;
      let serverMode = !!authToken;

      function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        document.getElementById('authTitle').textContent = authMode === 'login' ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
        document.getElementById('authBtn').textContent = authMode === 'login' ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
        document.getElementById('authToggle').textContent = authMode === 'login' ? 'Ê≤°ÊúâË¥¶Âè∑ÔºüÊ≥®ÂÜå' : 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁôªÂΩï';
        document.getElementById('authError').style.display = 'none';
      }

      async function doAuth() {
        const username = document.getElementById('authUsername').value.trim();
        const password = document.getElementById('authPassword').value.trim();
        const errEl = document.getElementById('authError');
        if (!username || !password) { errEl.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å'; errEl.style.display = 'block'; return; }
        const btn = document.getElementById('authBtn');
        btn.disabled = true; btn.textContent = 'ËØ∑Á®çÂÄô‚Ä¶';
        try {
          const url = API_BASE + (authMode === 'login' ? '/api/auth/login' : '/api/auth/register');
          const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'Êìç‰ΩúÂ§±Ë¥•');
          authToken = data.token;
          localStorage.setItem('ai_phone_token', authToken);
          serverMode = true;
          errEl.style.display = 'none';
          document.getElementById('authScreen').classList.add('hidden');
          showToast('‚úÖ ' + (authMode === 'login' ? 'ÁôªÂΩïÊàêÂäü' : 'Ê≥®ÂÜåÊàêÂäü'));
          // Sync data from server after login
          syncFromServer();
        } catch (e) {
          errEl.textContent = e.message; errEl.style.display = 'block';
        } finally {
          btn.disabled = false; btn.textContent = authMode === 'login' ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
        }
      }

      function skipAuth() {
        serverMode = false;
        document.getElementById('authScreen').classList.add('hidden');
      }

      // Auto-skip auth if token exists
      if (authToken) {
        document.getElementById('authScreen').classList.add('hidden');
        serverMode = true;
        // Sync data from server on page load
        syncFromServer();
      }

      // ======= CHAT DROPDOWN MENU =======
      let chatMenuOpen = false;
      function toggleChatMenu() {
        if (chatMenuOpen) {
          closeChatMenu();
          return;
        }
        const c = contacts.find(x => x.id === currentContactId);
        if (!c) return;
        chatMenuOpen = true;
        const menu = document.getElementById('chatDropdownMenu');
        const pinText = c.pinned ? 'üìå ÂèñÊ∂àÁΩÆÈ°∂' : 'üìå ÁΩÆÈ°∂ËÅäÂ§©';
        const muteText = c.muted ? 'üîî ÂºÄÂêØÈÄöÁü•' : 'üîï Ê∂àÊÅØÂÖçÊâìÊâ∞';
        menu.innerHTML = `
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('edit')">‚úèÔ∏è ‰øÆÊîπÂ§áÊ≥®</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('pin')">${pinText}</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('mute')">${muteText}</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('clear')">üßπ Ê∏ÖÁ©∫ËÅäÂ§©</div>
          <div style="padding:12px 16px;cursor:pointer;font-size:14px;color:#ff3b30;" onclick="chatMenuAction('delete')">üóëÔ∏è Âà†Èô§ËÅîÁ≥ª‰∫∫</div>
        `;
        menu.style.display = 'block';
        // Close when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeChatMenuOutside, { once: true });
        }, 10);
      }
      function closeChatMenu() {
        chatMenuOpen = false;
        document.getElementById('chatDropdownMenu').style.display = 'none';
        document.removeEventListener('click', closeChatMenuOutside);
      }
      function closeChatMenuOutside(e) {
        if (!document.getElementById('chatDropdownMenu').contains(e.target) && e.target.id !== 'chatMenuBtn') {
          closeChatMenu();
        }
      }
      function chatMenuAction(action) {
        closeChatMenu();
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        if (!c) return;
        switch (action) {
          case 'edit':
            editCurrentContact();
            break;
          case 'pin':
            c.pinned = !c.pinned;
            storeContacts(contacts);
            showToast(c.pinned ? 'Â∑≤ÁΩÆÈ°∂' : 'Â∑≤ÂèñÊ∂àÁΩÆÈ°∂');
            break;
          case 'mute':
            c.muted = !c.muted;
            storeContacts(contacts);
            showToast(c.muted ? 'Â∑≤ÂºÄÂêØÂÖçÊâìÊâ∞' : 'Â∑≤ÂÖ≥Èó≠ÂÖçÊâìÊâ∞');
            break;
          case 'clear':
            if (!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºü')) return;
            c.messages = [];
            c.lastTime = '';
            storeContacts(contacts);
            renderChatMessages(c);
            updateGenerateButton();
            showToast('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            break;
          case 'delete':
            if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•ËÅîÁ≥ª‰∫∫ÂèäÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºü')) return;
            contacts = contacts.filter(x => x.id !== currentContactId);
            storeContacts(contacts);
            closeChat();
            showToast('Â∑≤Âà†Èô§');
            break;
        }
      }

      // ======= MUSIC APP =======
      let musicPlaylist = JSON.parse(localStorage.getItem('ai_phone_music_playlist') || '[]');
      let musicCurrentIdx = -1;
      let musicPlaying = false;
      let musicAppAudio = null;

      function openMusicApp() {
        renderMusicApp();
        pushScreen('musicApp');
      }
      function closeMusicApp() {
        popScreen();
      }

      function renderMusicApp() {
        const pl = document.getElementById('musicAppPlaylist');
        if (!pl) return;
        let html = '<div class="music-app-playlist-title"><span>Êí≠ÊîæÂàóË°® (' + musicPlaylist.length + ')</span></div>';
        musicPlaylist.forEach((s, i) => {
          const active = i === musicCurrentIdx ? ' active' : '';
          const coverHtml = s.cover ? `<img src="${esc(s.cover)}">` : 'üéµ';
          html += `<div class="music-pl-item${active}" onclick="musicPlayAt(${i})"><div class="pl-cover">${coverHtml}</div><div class="pl-info"><div class="pl-name">${esc(s.name)}</div><div class="pl-artist">${esc(s.artist || 'Êú™Áü•Ê≠åÊâã')}</div></div><div class="pl-delete" onclick="event.stopPropagation();musicRemove(${i})">‚úï</div></div>`;
        });
        pl.innerHTML = html;
        // Update now playing display
        if (musicCurrentIdx >= 0 && musicPlaylist[musicCurrentIdx]) {
          const s = musicPlaylist[musicCurrentIdx];
          document.getElementById('musicAppSongTitle').textContent = s.name;
          document.getElementById('musicAppArtist').textContent = s.artist || 'Êú™Áü•Ê≠åÊâã';
          const art = document.getElementById('musicAlbumArt');
          if (s.cover) art.innerHTML = `<img src="${esc(s.cover)}">`;
          else art.innerHTML = 'üéµ';
        }
      }

      function toggleMusicAddForm() {
        const form = document.getElementById('musicAddForm');
        form.style.display = form.style.display === 'none' ? 'flex' : 'none';
      }

      function musicAddSong() {
        const url = document.getElementById('musicAddUrl').value.trim();
        const name = document.getElementById('musicAddName').value.trim() || 'Êú™ÂëΩÂêçÊ≠åÊõ≤';
        const artist = document.getElementById('musicAddArtist').value.trim();
        const cover = document.getElementById('musicAddCover').value.trim();
        if (!url) { showToast('ËØ∑ËæìÂÖ•Èü≥È¢ëÈìæÊé•'); return; }
        musicPlaylist.push({ url, name, artist, cover });
        safeStore('ai_phone_music_playlist', JSON.stringify(musicPlaylist));
        document.getElementById('musicAddUrl').value = '';
        document.getElementById('musicAddName').value = '';
        document.getElementById('musicAddArtist').value = '';
        document.getElementById('musicAddCover').value = '';
        document.getElementById('musicAddForm').style.display = 'none';
        renderMusicApp();
        showToast('‚úÖ Â∑≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®');
      }

      function musicRemove(idx) {
        musicPlaylist.splice(idx, 1);
        safeStore('ai_phone_music_playlist', JSON.stringify(musicPlaylist));
        if (idx === musicCurrentIdx) { musicStop(); musicCurrentIdx = -1; }
        else if (idx < musicCurrentIdx) musicCurrentIdx--;
        renderMusicApp();
      }

      function musicPlayAt(idx) {
        if (idx < 0 || idx >= musicPlaylist.length) return;
        musicCurrentIdx = idx;
        const s = musicPlaylist[idx];
        if (musicAppAudio) musicAppAudio.pause();
        musicAppAudio = new Audio(s.url);
        musicAppAudio.addEventListener('timeupdate', musicUpdateProgress);
        musicAppAudio.addEventListener('ended', musicNext);
        musicAppAudio.addEventListener('error', () => showToast('‚ö†Ô∏è Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•'));
        musicAppAudio.play().catch(() => showToast('‚ö†Ô∏è Êí≠ÊîæÂ§±Ë¥•'));
        musicPlaying = true;
        document.getElementById('musicAlbumArt').classList.remove('paused');
        document.getElementById('musicAppPlayBtn').innerHTML = '‚è∏Ô∏è';
        renderMusicApp();
      }

      function musicTogglePlay() {
        if (!musicAppAudio || musicCurrentIdx < 0) {
          if (musicPlaylist.length > 0) musicPlayAt(0);
          return;
        }
        if (musicPlaying) {
          musicAppAudio.pause();
          musicPlaying = false;
          document.getElementById('musicAlbumArt').classList.add('paused');
          document.getElementById('musicAppPlayBtn').innerHTML = '‚ñ∂Ô∏è';
        } else {
          musicAppAudio.play().catch(() => {});
          musicPlaying = true;
          document.getElementById('musicAlbumArt').classList.remove('paused');
          document.getElementById('musicAppPlayBtn').innerHTML = '‚è∏Ô∏è';
        }
      }

      function musicStop() {
        if (musicAppAudio) { musicAppAudio.pause(); musicAppAudio = null; }
        musicPlaying = false;
        document.getElementById('musicAlbumArt').classList.add('paused');
        document.getElementById('musicAppPlayBtn').innerHTML = '‚ñ∂Ô∏è';
        document.getElementById('musicAppProgressFill').style.width = '0%';
        document.getElementById('musicAppCurTime').textContent = '0:00';
        document.getElementById('musicAppDurTime').textContent = '0:00';
      }

      function musicPrev() {
        if (musicPlaylist.length === 0) return;
        let idx = musicCurrentIdx - 1;
        if (idx < 0) idx = musicPlaylist.length - 1;
        musicPlayAt(idx);
      }

      function musicNext() {
        if (musicPlaylist.length === 0) return;
        let idx = musicCurrentIdx + 1;
        if (idx >= musicPlaylist.length) idx = 0;
        musicPlayAt(idx);
      }

      function musicUpdateProgress() {
        if (!musicAppAudio) return;
        const cur = musicAppAudio.currentTime;
        const dur = musicAppAudio.duration || 0;
        const pct = dur > 0 ? (cur / dur) * 100 : 0;
        document.getElementById('musicAppProgressFill').style.width = pct + '%';
        document.getElementById('musicAppCurTime').textContent = fmtTime(cur);
        document.getElementById('musicAppDurTime').textContent = fmtTime(dur);
      }

      function fmtTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return m + ':' + String(sec).padStart(2, '0');
      }

      function seekMusic(e) {
        if (!musicAppAudio || !musicAppAudio.duration) return;
        const bar = document.getElementById('musicAppProgressBar');
        const rect = bar.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        musicAppAudio.currentTime = pct * musicAppAudio.duration;
      }

      // ======= SHOPPING MALL =======
      let shopBalance = parseFloat(localStorage.getItem('ai_phone_shop_balance') || '1000');
      let shopGiftMode = false; // true when opened from chat gift button

      const SHOP_ITEMS = [
        { icon: 'üåπ', name: 'Áé´Áë∞Ëä±', price: 10, category: 'È≤úËä±' },
        { icon: 'üíê', name: 'Ëä±Êùü', price: 50, category: 'È≤úËä±' },
        { icon: 'üß∏', name: 'Ê≥∞Ëø™ÁÜä', price: 80, category: 'Áé©ÂÅ∂' },
        { icon: 'üéÄ', name: 'Ëù¥Ëù∂Áªì', price: 15, category: 'È•∞ÂìÅ' },
        { icon: 'üíç', name: 'ÊàíÊåá', price: 520, category: 'È¶ñÈ•∞' },
        { icon: 'üëë', name: 'ÁöáÂÜ†', price: 999, category: 'È¶ñÈ•∞' },
        { icon: 'üéÇ', name: 'ËõãÁ≥ï', price: 66, category: 'ÁæéÈ£ü' },
        { icon: 'üç´', name: 'Â∑ßÂÖãÂäõ', price: 30, category: 'ÁæéÈ£ü' },
        { icon: 'üßã', name: 'Â•∂Ëå∂', price: 20, category: 'ÁæéÈ£ü' },
        { icon: 'üì±', name: 'ÊâãÊú∫', price: 888, category: 'Êï∞Á†Å' },
        { icon: 'üéÆ', name: 'Ê∏∏ÊàèÊú∫', price: 299, category: 'Êï∞Á†Å' },
        { icon: '‚úàÔ∏è', name: 'Êú∫Á•®', price: 1500, category: 'ÊóÖË°å' },
      ];

      function openShop() {
        shopGiftMode = false;
        renderShop();
        pushScreen('shop');
      }
      function openShopForGift() {
        if (!currentContactId) return;
        shopGiftMode = true;
        renderShop();
        pushScreen('shop');
      }
      function closeShop() {
        shopGiftMode = false;
        popScreen();
      }

      function renderShop() {
        document.getElementById('shopBalanceAmount').textContent = '¬•' + shopBalance.toFixed(0);
        const body = document.getElementById('shopBody');
        const categories = [...new Set(SHOP_ITEMS.map(i => i.category))];
        let html = '';
        categories.forEach(cat => {
          html += `<div class="shop-section-title">${cat}</div><div class="shop-grid">`;
          SHOP_ITEMS.filter(i => i.category === cat).forEach(item => {
            html += `<div class="shop-item" onclick="buyShopItem('${esc(item.icon)}','${esc(item.name)}',${item.price})"><div class="shop-icon">${item.icon}</div><div class="shop-name">${esc(item.name)}</div><div class="shop-price">¬•${item.price}</div></div>`;
          });
          html += '</div>';
        });
        body.innerHTML = html;
      }

      function buyShopItem(icon, name, price) {
        if (shopBalance < price) { showToast('‚ö†Ô∏è ‰ΩôÈ¢ù‰∏çË∂≥'); return; }
        if (!confirm(`Á°ÆÂÆöË¥≠‰π∞ ${icon} ${name}Ôºà¬•${price}ÔºâÔºü`)) return;
        shopBalance -= price;
        safeStore('ai_phone_shop_balance', shopBalance);
        renderShop();
        showToast(`‚úÖ Â∑≤Ë¥≠‰π∞ ${icon} ${name}`);
        if (shopGiftMode && currentContactId) {
          const contact = contacts.find(c => c.id === currentContactId);
          if (contact) {
            contact.messages.push({ role: 'user', content: `__gift__${JSON.stringify({ icon, name })}` });
            contact.lastTime = getNowTimeStr();
            storeContacts(contacts);
            closeShop();
            renderChatMessages(contact);
            scrollToBottom();
          }
        }
      }

      function shopRecharge() {
        const amount = prompt('ËæìÂÖ•ÂÖÖÂÄºÈáëÈ¢ùÔºö', '500');
        if (!amount) return;
        const val = parseFloat(amount);
        if (isNaN(val) || val <= 0) { showToast('‚ö†Ô∏è ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ¢ù'); return; }
        shopBalance += val;
        safeStore('ai_phone_shop_balance', shopBalance);
        renderShop();
        showToast(`‚úÖ Â∑≤ÂÖÖÂÄº ¬•${val.toFixed(0)}`);
      }

      // ======= CHAT IMAGE SEND =======
      function pickChatImage() {
        document.getElementById('chatImageInput').click();
      }
      document.getElementById('chatImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || !currentContactId) return;
        const reader = new FileReader();
        reader.onload = async function(ev) {
          const dataUrl = await compressImage(ev.target.result, 300);
          const contact = contacts.find(c => c.id === currentContactId);
          if (!contact) return;
          contact.messages.push({ role: 'user', content: '__image__' + dataUrl });
          contact.lastTime = getNowTimeStr();
          storeContacts(contacts);
          renderChatMessages(contact);
          scrollToBottom();
        };
        reader.readAsDataURL(file);
        this.value = '';
      });

      // Init
      renderColorOptions();
    </script>
  </body>
</html>
