<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AIÊâãÊú∫Ê®°ÊãüÂô®</title>
    <style>
      @font-face {
        font-family: 'CustomFont';
        src: url('https://files.catbox.moe/c7a1xyp0k8k2en2d.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }
      :root {
        --primary: #3478f6;
        --primary-light: #5a9cf6;
        --primary-dark: #2660d4;
        --accent: #ff6b8a;
        --success: #30d158;
        --warning: #ff9f0a;
        --danger: #ff453a;
        --purple: #af52de;
        --glass-bg: rgba(255, 255, 255, 0.72);
        --glass-border: rgba(255, 255, 255, 0.45);
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        --glass-blur: blur(24px);
        --card-radius: 20px;
        --btn-radius: 14px;
        --transition: 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          'SF Pro Text',
          'PingFang SC',
          'Hiragino Sans GB',
          'Microsoft YaHei',
          sans-serif;
        background: #0a0a0a;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden;
        letter-spacing: -0.015em;
        color: #1d1d1f;
      }
      .phone {
        width: 375px;
        height: 812px;
        background: #000;
        border-radius: 48px;
        overflow: hidden;
        position: relative;
        box-shadow:
          0 0 0 2px #333,
          0 0 0 6px #1a1a1a,
          0 0 120px rgba(52, 120, 246, 0.06),
          0 40px 100px rgba(0, 0, 0, 0.7);
        border: 6px solid #1a1a1a;
        transition: all 0.35s ease;
      }
      .phone.fullscreen-mode {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
        border: none;
        box-shadow: none;
      }
      .notch {
        display: none;
      }
      .status-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 44px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 28px;
        z-index: 999;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
      }
      .status-bar.dark {
        color: #000;
      }
      .status-bar .time {
        font-size: 15px;
        font-weight: 700;
      }
      .status-bar .icons {
        display: flex;
        gap: 5px;
        align-items: center;
        font-size: 11px;
      }
      .home-indicator {
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 134px;
        height: 5px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        z-index: 999;
      }
      .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transition:
          transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94),
          opacity 0.35s ease;
      }
      .screen.hidden {
        pointer-events: none;
        opacity: 0;
      }

      /* Lock Screen */
      .lock-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
        cursor: pointer;
        user-select: none;
      }
      .lock-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.2);
      }
      .lock-time-card {
        margin-top: 160px;
        z-index: 1;
        text-align: center;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(20px);
        border-radius: 28px;
        padding: 24px 40px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }
      .lock-time-card .lock-time {
        font-size: 64px;
        font-weight: 200;
        color: #fff;
        letter-spacing: 3px;
      }
      .lock-time-card .lock-date {
        font-size: 16px;
        color: rgba(255, 255, 255, 0.85);
        margin-top: 4px;
        font-weight: 400;
      }
      .lock-shortcuts {
        position: absolute;
        bottom: 40px;
        display: flex;
        gap: 200px;
        z-index: 1;
      }
      .lock-shortcut {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .lock-unlock {
        position: absolute;
        bottom: 100px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 13px;
        animation: pulse 2s infinite;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }
      .lock-unlock .arrow {
        font-size: 20px;
        animation: bounceUp 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
      }
      @keyframes bounceUp {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      /* Home Screen */
      .home-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat;
        padding: 54px 0 0;
        z-index: 50;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .home-screen::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.08);
      }

      /* ====== Profile Banner (Top Decorative Card) ====== */
      .home-profile-banner {
        position: relative;
        z-index: 1;
        width: calc(100% - 32px);
        margin: 6px 0 8px;
        background: rgba(255,255,255,0.82);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-radius: 22px;
        padding: 14px 18px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        border: 1px solid rgba(255,255,255,0.6);
      }
      .home-profile-banner .pb-time-block {
        display: flex;
        flex-direction: column;
        min-width: 80px;
      }
      .home-profile-banner .pb-time {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        line-height: 1;
        letter-spacing: 1px;
      }
      .home-profile-banner .pb-day {
        font-size: 11px;
        color: #e91e63;
        margin-top: 4px;
        font-weight: 500;
      }
      .home-profile-banner .pb-avatar-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }
      .home-profile-banner .pb-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: 3px solid rgba(233,30,99,0.2);
        overflow: hidden;
        background: #fce4ec;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: #e91e63;
        cursor: pointer;
        margin-top: -28px;
        box-shadow: 0 4px 16px rgba(233,30,99,0.15);
      }
      .home-profile-banner .pb-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .home-profile-banner .pb-name {
        font-size: 13px;
        font-weight: 600;
        color: #555;
        margin-top: 4px;
        text-align: center;
        max-width: 90px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .home-profile-banner .pb-date-block {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        min-width: 70px;
      }
      .home-profile-banner .pb-heart {
        color: #e91e63;
        font-size: 16px;
        margin-bottom: 2px;
      }
      .home-profile-banner .pb-date {
        font-size: 13px;
        font-weight: 600;
        color: #999;
      }
      .home-profile-banner .pb-year {
        font-size: 18px;
        font-weight: 300;
        color: #f8bbd0;
        letter-spacing: 1px;
      }

      /* ====== Home Mini Music Player ====== */
      .home-music-card {
        position: relative;
        z-index: 1;
        width: calc(50% - 20px);
        background: rgba(255,255,255,0.82);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-radius: 22px;
        padding: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        border: 1px solid rgba(255,255,255,0.6);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .home-music-card .hm-header {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .home-music-card .hm-avatar {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        overflow: hidden;
        background: #f3e5f5;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
      }
      .home-music-card .hm-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .home-music-card .hm-info {
        flex: 1;
        min-width: 0;
      }
      .home-music-card .hm-user {
        font-size: 13px;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .home-music-card .hm-status {
        font-size: 10px;
        color: #aaa;
      }
      .home-music-card .hm-now {
        display: flex;
        align-items: center;
        gap: 6px;
        background: rgba(0,0,0,0.03);
        border-radius: 12px;
        padding: 6px 8px;
      }
      .home-music-card .hm-cover {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        overflow: hidden;
        background: #e1bee7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
      }
      .home-music-card .hm-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .home-music-card .hm-song-info {
        flex: 1;
        min-width: 0;
      }
      .home-music-card .hm-song-title {
        font-size: 11px;
        font-weight: 500;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .home-music-card .hm-song-artist {
        font-size: 9px;
        color: #bbb;
      }
      .home-music-card .hm-progress {
        width: 100%;
        height: 2px;
        background: rgba(0,0,0,0.06);
        border-radius: 1px;
        overflow: hidden;
        margin-top: 2px;
      }
      .home-music-card .hm-progress-fill {
        height: 100%;
        background: #e91e63;
        border-radius: 1px;
        width: 30%;
        transition: width 0.3s;
      }
      .home-music-card .hm-controls {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-top: -2px;
      }
      .home-music-card .hm-ctrl {
        font-size: 14px;
        cursor: pointer;
        color: #888;
        transition: color 0.15s;
      }
      .home-music-card .hm-ctrl:hover {
        color: #e91e63;
      }

      /* ====== Home Photo Wall Card ====== */
      .home-photo-wall {
        position: relative;
        z-index: 1;
        width: calc(50% - 20px);
        background: rgba(255,255,255,0.82);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-radius: 22px;
        padding: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        border: 1px solid rgba(255,255,255,0.6);
        display: flex;
        flex-direction: column;
        gap: 4px;
        overflow: hidden;
        cursor: pointer;
      }
      .home-photo-wall .hpw-title {
        font-size: 11px;
        font-weight: 600;
        color: #e91e63;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 4px;
      }
      .home-photo-wall .hpw-title .hpw-lock {
        font-size: 10px;
        color: #ccc;
      }
      .home-photo-wall .hpw-single {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }
      .home-photo-wall .hpw-single img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .home-photo-wall .hpw-nav {
        position: absolute;
        bottom: 4px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 4px;
      }
      .home-photo-wall .hpw-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: rgba(255,255,255,0.4);
      }
      .home-photo-wall .hpw-dot.active {
        background: #fff;
      }
      .home-photo-wall .hpw-arrows {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        display: flex;
        justify-content: space-between;
        padding: 0 2px;
        pointer-events: none;
      }
      .home-photo-wall .hpw-arrow {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(0,0,0,0.25);
        color: #fff;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .home-photo-wall:hover .hpw-arrow {
        opacity: 1;
      }
      .home-photo-wall .hpw-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        color: #f48fb1;
        gap: 4px;
        font-size: 11px;
      }
      .home-photo-wall .hpw-label {
        font-size: 10px;
        color: #ccc;
        text-align: center;
        padding-top: 2px;
      }

      /* ====== Home Widgets Row ====== */
      .home-widgets-row {
        position: relative;
        z-index: 1;
        width: calc(100% - 32px);
        display: flex;
        gap: 10px;
        margin-bottom: 6px;
      }
      .home-search {
        position: relative;
        z-index: 1;
        width: calc(100% - 48px);
        margin: 10px 0 20px;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 24px;
        padding: 10px 16px;
        font-size: 14px;
        color: rgba(255, 255, 255, 0.9);
        text-align: center;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }
      .home-search svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 2.5;
        fill: none;
      }
      .widget-area {
        position: relative;
        z-index: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 0 20px;
        max-height: 300px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .widget-area::-webkit-scrollbar {
        display: none;
      }
      .widget-card {
        border-radius: 32px;
        padding: 20px;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        transition:
          transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
          box-shadow 0.3s;
        cursor: grab;
        border: none;
        color: #fff;
      }
      .widget-card::before {
        display: none;
      }
      .widget-card:active {
        cursor: grabbing;
      }
      .widget-card.dragging {
        opacity: 0.7;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        transform: scale(1.03);
        z-index: 10;
      }
      .widget-card.drag-over {
        border-top: 3px solid #ff8fa3;
      }
      .widget-card .widget-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-size: cover;
        background-position: center;
        z-index: 0;
        border-radius: 18px;
      }
      .widget-card .widget-bg::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 28px;
      }
      .widget-card .widget-content {
        position: relative;
        z-index: 1;
      }
      .widget-card .widget-remove {
        position: absolute;
        top: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(255, 59, 48, 0.85);
        color: #fff;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .widget-card:hover .widget-remove {
        display: flex;
      }
      .widget-card .widget-bg-btn {
        position: absolute;
        bottom: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.3);
        color: #fff;
        font-size: 11px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .widget-card:hover .widget-bg-btn {
        display: flex;
      }
      .add-widget-btn {
        position: relative;
        z-index: 1;
        margin: 8px auto 0;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 2px dashed rgba(255, 255, 255, 0.4);
        border-radius: 14px;
        padding: 7px 18px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
      }
      .add-widget-btn:hover {
        background: rgba(255, 255, 255, 0.35);
      }

      /* App Grid & Dock */
      .home-content {
        flex: 1;
        width: 100%;
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
      }
      .app-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px 0;
        padding: 10px 24px;
        width: 100%;
      }
      .app-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .app-icon:active .icon-box {
        transform: scale(0.88);
      }
      .app-icon.dragging {
        opacity: 0.4;
      }
      .app-icon.drag-over {
        outline: 2px dashed rgba(255,255,255,0.6);
        outline-offset: 4px;
        border-radius: 16px;
      }
      .icon-box {
        width: 62px;
        height: 62px;
        border-radius: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        transition:
          transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
          box-shadow 0.3s;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        overflow: hidden;
        background: rgba(255, 255, 255, 0.9);
        position: relative;
        border: none;
      }
      .icon-box:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
      }
      .icon-box::after {
        display: none;
      }
      .icon-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .app-name {
        font-size: 10px;
        color: #fff;
        text-align: center;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
      }
      .icon-settings {
        background: #8e8e93;
      }
      .icon-contacts {
        background: #007aff;
      }
      .icon-moments {
        background: #34c759;
      }
      .home-dock {
        position: absolute;
        bottom: 24px;
        left: 20px;
        right: 20px;
        z-index: 2;
        padding: 18px 24px;
        display: flex;
        justify-content: space-around;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px);
        border-radius: 36px;
        border: none;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }
      .home-dock::before {
        display: none;
      }
      .dock-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }
      .dock-icon .icon-box {
        width: 52px;
        height: 52px;
        border-radius: 12px;
      }
      .lock-btn-home {
        position: relative;
        z-index: 1;
        margin-top: auto;
        margin-bottom: 10px;
        cursor: pointer;
        opacity: 0.6;
        font-size: 12px;
        color: #fff;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
      }

      /* App Header */
      .app-header {
        height: 88px;
        padding: 44px 16px 0;
        display: flex;
        align-items: center;
        position: relative;
        flex-shrink: 0;
      }
      .app-header .back-btn {
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.05);
        -webkit-tap-highlight-color: transparent;
        z-index: 10;
        transition: background 0.2s;
        min-width: 44px;
        min-height: 44px;
        position: relative;
      }
      .app-header .back-btn:active {
        background: rgba(0, 0, 0, 0.1);
      }
      .app-header .back-btn span {
        display: none;
      }
      .app-header .back-btn svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        stroke-width: 2.5;
        fill: none;
      }
      .app-header .header-title {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-size: 17px;
        font-weight: 600;
        max-width: 55%;
        text-align: center;
        pointer-events: none;
      }
      .app-header .header-title[onclick] {
        pointer-events: auto;
      }
      .app-header .header-right {
        position: absolute;
        right: 16px;
        font-size: 22px;
        cursor: pointer;
        z-index: 1;
      }
      .app-header .header-actions {
        position: absolute;
        right: 16px;
        display: flex;
        gap: 14px;
        z-index: 1;
      }
      .app-header .header-actions span {
        font-size: 18px;
        cursor: pointer;
      }

      /* Contacts (Messages) Screen */
      .contacts-screen {
        background: #f2f2f7;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .contacts-screen.active {
        transform: translateX(0);
      }
      .contacts-screen .app-header {
        background: rgba(242, 242, 247, 0.92);
        backdrop-filter: blur(14px);
        border-bottom: 0.5px solid #d1d1d6;
      }
      .contacts-screen .app-header .header-title {
        color: #000;
      }
      .contacts-screen .app-header .back-btn {
        color: #07c160;
      }
      .contacts-screen .app-header .header-actions span {
        color: #07c160;
      }
      .contacts-search {
        margin: 0 16px 8px;
        position: relative;
      }
      .contacts-search input {
        width: 100%;
        background: rgba(118, 118, 128, 0.12);
        border: none;
        border-radius: 10px;
        padding: 8px 12px 8px 32px;
        font-size: 14px;
        outline: none;
        color: #000;
        font-family: inherit;
      }
      .contacts-search::before {
        content: 'üîç';
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 13px;
      }
      .contacts-body {
        flex: 1;
        overflow-y: auto;
        background: url('https://i.postimg.cc/HnTsSRfW/IMG-1723.jpg') center/cover no-repeat fixed;
      }
      .contact-item {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        margin: 0 16px 10px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        cursor: pointer;
        gap: 14px;
        transition:
          transform 0.15s,
          background 0.15s;
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
      }
      .contact-item:active {
        transform: scale(0.98);
        background: rgba(255, 255, 255, 0.9);
      }
      .contact-item:active {
        background: rgba(220, 220, 220, 0.88);
      }
      .contact-item.pinned {
        background: rgba(245, 245, 234, 0.9);
      }
      .contact-avatar {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        font-weight: bold;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .contact-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .contact-avatar .online-dot {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #34c759;
        border: 2px solid #fff;
      }
      .contact-info {
        flex: 1;
        min-width: 0;
      }
      .contact-name {
        font-size: 16px;
        color: #000;
        font-weight: 500;
      }
      .contact-name .pin-icon {
        font-size: 11px;
        color: #ff9500;
        margin-left: 3px;
      }
      .contact-name .mute-icon {
        font-size: 11px;
        color: #999;
        margin-left: 3px;
      }
      .contact-preview {
        font-size: 13px;
        color: #8e8e93;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .contact-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
        flex-shrink: 0;
      }
      .contact-time {
        font-size: 11px;
        color: #8e8e93;
      }
      .unread-badge {
        background: #ff3b30;
        color: #fff;
        font-size: 10px;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
      }
      .empty-contacts {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 40px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        text-align: center;
        gap: 12px;
        text-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
      }
      .empty-contacts .empty-icon {
        font-size: 48px;
        opacity: 0.7;
      }

      /* New Contact Screen */
      .new-contact-screen {
        background: #f2f2f7;
        display: flex;
        flex-direction: column;
        z-index: 70;
        transform: translateX(100%);
      }
      .new-contact-screen.active {
        transform: translateX(0);
      }
      .new-contact-screen .app-header {
        background: #f2f2f7;
        border-bottom: 0.5px solid #c6c6c8;
      }
      .new-contact-screen .app-header .header-title {
        color: #000;
      }
      .new-contact-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
      }
      .avatar-picker {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        gap: 12px;
      }
      .avatar-preview {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        color: #fff;
        font-weight: bold;
        overflow: hidden;
        cursor: pointer;
        position: relative;
      }
      .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .avatar-preview .avatar-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font-size: 11px;
        text-align: center;
        padding: 2px 0;
        font-weight: normal;
      }
      .color-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .color-dot {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition:
          border-color 0.2s,
          transform 0.15s;
      }
      .color-dot.selected {
        border-color: #007aff;
        transform: scale(1.15);
      }
      .form-section {
        margin-bottom: 20px;
      }
      .form-section-title {
        font-size: 13px;
        color: #86868b;
        text-transform: uppercase;
        padding: 0 16px 8px;
        letter-spacing: 0.5px;
      }
      .form-card {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
      }
      .form-item {
        padding: 12px 16px;
        border-bottom: 0.5px solid #e5e5ea;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .form-item:last-child {
        border-bottom: none;
      }
      .form-item label {
        font-size: 15px;
        color: #000;
      }
      .form-item input,
      .form-item textarea {
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        width: 100%;
        font-family: inherit;
      }
      .form-item textarea {
        resize: none;
        min-height: 60px;
      }
      .form-item input:focus,
      .form-item textarea:focus {
        border-color: #007aff;
        background: #fff;
      }
      .form-item .hint {
        font-size: 12px;
        color: #86868b;
        line-height: 1.4;
      }
      .create-btn {
        display: block;
        width: 100%;
        padding: 14px;
        background: #07c160;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 16px;
      }
      .create-btn:active {
        background: #06a855;
      }
      .import-btn {
        display: block;
        width: 100%;
        padding: 14px;
        background: #5856d6;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 10px;
      }
      .import-btn:active {
        background: #4a48c4;
      }
      .chat-screen {
        background: #ededed;
        display: flex;
        flex-direction: column;
        z-index: 65;
        transform: translateX(100%);
      }
      .chat-screen.active {
        transform: translateX(0);
      }
      .chat-screen .app-header {
        background: rgba(237, 237, 237, 0.92);
        backdrop-filter: blur(12px);
        border-bottom: 0.5px solid #d6d6d6;
      }
      .chat-screen .app-header .header-title {
        color: #000;
        cursor: pointer;
      }
      .chat-screen .app-header .back-btn {
        color: #07c160;
      }
      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px 14px;
        background: #ededed;
        scroll-behavior: smooth;
      }
      .chat-container::-webkit-scrollbar {
        width: 3px;
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 2px;
      }
      .message-row {
        display: flex;
        margin-bottom: 14px;
        align-items: flex-start;
      }
      .message-row.user {
        flex-direction: row-reverse;
      }
      .msg-avatar {
        width: 36px;
        height: 36px;
        border-radius: 4px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #fff;
        font-weight: bold;
        overflow: hidden;
      }
      .msg-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
      }
      .message-row.ai .msg-avatar {
        margin-right: 8px;
      }
      .message-row.user .msg-avatar {
        background: #e891a8;
        margin-left: 8px;
      }
      .bubble {
        max-width: 72%;
        padding: 10px 14px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.5;
        word-break: break-word;
        position: relative;
        white-space: pre-wrap;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .message-row.ai .bubble {
        background: #fff;
        color: #1d1d1f;
        border-top-left-radius: 4px;
      }
      .message-row.ai .bubble::before {
        display: none;
      }
      .message-row.user .bubble {
        background: #007aff;
        color: #fff;
        border-top-right-radius: 4px;
      }
      .message-row.user .bubble::after {
        display: none;
      }
      .typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 0;
      }
      .typing-indicator span {
        width: 6px;
        height: 6px;
        background: #999;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
      }
      .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes typingBounce {
        0%,
        80%,
        100% {
          transform: scale(0.6);
          opacity: 0.4;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .input-bar {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 10px 16px 20px;
        display: flex;
        align-items: flex-end;
        gap: 10px;
        border-top: none;
        flex-shrink: 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.02);
      }
      .input-bar textarea {
        flex: 1;
        border: none;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 15px;
        line-height: 1.4;
        resize: none;
        outline: none;
        max-height: 100px;
        min-height: 40px;
        font-family: inherit;
        background: #f2f2f7;
        transition: background 0.2s;
      }
      .input-bar textarea:focus {
        background: #fff;
        box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
      }
      .input-bar textarea:focus {
        border-color: #07c160;
      }
      .send-btn {
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: var(--btn-radius);
        padding: 0 20px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        flex-shrink: 0;
        height: 40px;
        box-shadow: 0 4px 16px rgba(52, 120, 246, 0.25);
        transition: all var(--transition);
      }
      .send-btn:hover {
        transform: scale(1.03);
        box-shadow: 0 6px 20px rgba(52, 120, 246, 0.35);
      }
      .send-btn:active {
        transform: scale(0.96);
      }
      .send-btn:disabled {
        background: #aeaeb2;
        cursor: not-allowed;
        box-shadow: none;
      }
      .generate-btn {
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 18px;
        padding: 8px 20px;
        font-size: 13px;
        cursor: pointer;
        margin: 8px auto;
        display: block;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        transition:
          background 0.2s,
          transform 0.15s;
      }
      .generate-btn:hover {
        background: #005ec4;
      }
      .generate-btn:active {
        transform: scale(0.95);
      }
      .generate-btn:disabled {
        background: #a0c4e8;
        cursor: not-allowed;
      }
      .generate-row {
        text-align: center;
        margin: 6px 0 10px;
      }
      /* Transfer & Red Packet */
      .msg-transfer {
        background: #fff;
        border-radius: 4px;
        padding: 0;
        width: 230px;
        overflow: hidden;
        cursor: pointer;
      }
      .msg-transfer .transfer-body {
        padding: 12px 14px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .msg-transfer .transfer-icon {
        font-size: 28px;
        flex-shrink: 0;
      }
      .msg-transfer .transfer-info {
        flex: 1;
      }
      .msg-transfer .transfer-amount {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }
      .msg-transfer .transfer-note {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .msg-transfer .transfer-footer {
        background: #f7f7f7;
        padding: 6px 14px;
        font-size: 11px;
        color: #999;
        border-top: 0.5px solid #e5e5ea;
      }
      .msg-redpacket {
        background: #fa9d3b;
        border-radius: 8px;
        padding: 0;
        width: 230px;
        overflow: hidden;
        cursor: pointer;
        color: #fff;
        position: relative;
      }
      .msg-redpacket .rp-body {
        padding: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
        min-height: 70px;
      }
      .msg-redpacket .rp-icon {
        font-size: 36px;
        flex-shrink: 0;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      .msg-redpacket .rp-info {
        flex: 1;
      }
      .msg-redpacket .rp-greeting {
        font-size: 15px;
        font-weight: 500;
        line-height: 1.4;
      }
      .msg-redpacket .rp-amount {
        font-size: 11px;
        opacity: 0.8;
        margin-top: 4px;
      }
      .msg-redpacket .rp-footer {
        background: rgba(0, 0, 0, 0.1);
        padding: 5px 14px;
        font-size: 11px;
        display: flex;
        justify-content: space-between;
      }
      .msg-redpacket.opened {
        background: #c8a070;
      }
      .msg-redpacket.opened .rp-icon {
        opacity: 0.5;
      }
      /* Extra buttons in input bar */
      .input-extras {
        display: flex;
        gap: 6px;
        padding: 6px 10px;
        background: rgba(240, 240, 240, 0.95);
        backdrop-filter: blur(8px);
        border-top: 0.5px solid #d6d6d6;
        flex-shrink: 0;
      }
      .extra-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(221, 221, 221, 0.6);
        border-radius: 16px;
        padding: 5px 14px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        color: #555;
        transition: all 0.15s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }
      .extra-btn:hover {
        background: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .extra-btn:active {
        background: #f0f0f0;
        transform: scale(0.96);
      }
      /* Transfer/RP modal */
      .trp-modal .trp-amount-input {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 14px;
        font-size: 24px;
        font-weight: 600;
        text-align: center;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
      }
      .trp-modal .trp-amount-input:focus {
        border-color: #007aff;
        background: #fff;
      }
      .trp-modal .trp-note-input {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
        margin-top: 10px;
      }
      .trp-modal .trp-note-input:focus {
        border-color: #007aff;
        background: #fff;
      }
      .trp-modal .trp-preview {
        text-align: center;
        margin: 12px 0 4px;
        font-size: 13px;
        color: #999;
      }
      .trp-send-btn {
        display: block;
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 14px;
        color: #fff;
      }
      .trp-send-btn.transfer {
        background: #07c160;
      }
      .trp-send-btn.transfer:active {
        background: #06a855;
      }
      .trp-send-btn.redpacket {
        background: #fa9d3b;
      }
      .trp-send-btn.redpacket:active {
        background: #e88e30;
      }
      .system-msg {
        text-align: center;
        color: #999;
        font-size: 11px;
        margin: 10px 0;
      }
      .weibo-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .weibo-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .weibo-screen.active {
        transform: translateX(0);
      }
      .weibo-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .weibo-screen .app-header .header-title {
        color: #e6162d;
        font-weight: 700;
      }
      .weibo-screen .app-header .back-btn {
        color: #e6162d;
      }
      .weibo-screen .app-header .header-actions span {
        color: #e6162d;
      }
      .weibo-tabs {
        display: flex;
        background: transparent;
        border-bottom: none;
        flex-shrink: 0;
        padding: 0 16px;
        gap: 16px;
      }
      .weibo-tab {
        text-align: center;
        padding: 8px 16px;
        font-size: 15px;
        color: #666;
        cursor: pointer;
        position: relative;
        transition: all 0.2s;
        border-radius: 20px;
      }
      .weibo-tab.active {
        color: #fff;
        font-weight: 600;
        background: #e6162d;
        box-shadow: 0 4px 12px rgba(230, 22, 45, 0.3);
      }
      .weibo-body {
        flex: 1;
        overflow-y: auto;
        padding-top: 16px;
      }
      .weibo-post {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        margin: 0 16px 16px;
        border-radius: 24px;
        padding: 16px 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .weibo-post-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .weibo-post-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
        font-size: 16px;
        overflow: hidden;
      }
      .weibo-post-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .weibo-post-user {
        flex: 1;
      }
      .weibo-post-name {
        font-size: 15px;
        font-weight: 500;
        color: #333;
      }
      .weibo-post-time {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .weibo-post-content {
        font-size: 15px;
        line-height: 1.6;
        color: #333;
        margin-bottom: 10px;
      }
      .weibo-post-content .hashtag {
        color: #e6162d;
      }
      .weibo-post-actions {
        display: flex;
        justify-content: space-around;
        padding-top: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
      }
      .weibo-action {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 13px;
        color: #999;
        cursor: pointer;
        padding: 4px 8px;
      }
      .weibo-action:hover {
        color: #e6162d;
      }
      .weibo-action.liked {
        color: #e6162d;
      }
      .weibo-compose {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid #eee;
        padding: 10px 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 10;
        transform: translateY(100%);
        transition: transform 0.3s;
      }
      .weibo-compose.open {
        transform: translateY(0);
      }
      .weibo-compose textarea {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        font-size: 14px;
        resize: none;
        min-height: 80px;
        outline: none;
        font-family: inherit;
      }
      .weibo-compose textarea:focus {
        border-color: #e6162d;
      }
      .weibo-compose-bar {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .weibo-compose-bar .cancel-btn {
        background: #f5f5f5;
        color: #666;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
      }
      .weibo-compose-bar .post-btn {
        background: #e6162d;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 20px;
        font-size: 14px;
        cursor: pointer;
      }
      .weibo-compose-bar .post-btn:disabled {
        background: #f5a0a8;
        cursor: not-allowed;
      }
      .weibo-refresh-bar {
        display: flex;
        justify-content: center;
        padding: 10px;
        background: transparent;
        flex-shrink: 0;
      }
      .weibo-refresh-btn {
        background: #e6162d;
        color: #fff;
        border: none;
        border-radius: 20px;
        padding: 8px 24px;
        font-size: 13px;
        cursor: pointer;
      }
      .weibo-refresh-btn:disabled {
        background: #f5a0a8;
        cursor: not-allowed;
      }
      .weibo-refresh-btn:hover:not(:disabled) {
        background: #c9122a;
      }
      .settings-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .settings-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(242, 242, 247, 0.6);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .settings-screen.active {
        transform: translateX(0);
      }
      .settings-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .settings-screen .app-header .header-title {
        color: #000;
      }
      .settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
        padding-bottom: 40px;
      }
      .settings-section {
        margin-bottom: 28px;
      }
      .settings-section-title {
        font-size: 13px;
        color: #86868b;
        text-transform: uppercase;
        padding: 0 16px 8px;
        letter-spacing: 0.5px;
      }
      .settings-card {
        background: transparent;
        border-radius: 0;
        overflow: visible;
      }
      .settings-item {
        padding: 16px 20px;
        margin-bottom: 16px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
      .settings-item label {
        font-size: 15px;
        color: #000;
      }
      .settings-item input,
      .settings-item select {
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        width: 100%;
        font-family: inherit;
      }
      .settings-item input:focus,
      .settings-item select:focus {
        border-color: #007aff;
        background: #fff;
      }
      .settings-item .hint {
        font-size: 12px;
        color: #86868b;
        line-height: 1.4;
      }
      .save-btn {
        display: block;
        width: 100%;
        padding: 16px;
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 16px;
        box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
        transition:
          transform 0.15s,
          box-shadow 0.15s;
      }
      .save-btn:active {
        transform: scale(0.98);
        box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
      }
      .save-btn:active {
        background: #005ec4;
      }
      .toast {
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 10px 24px;
        border-radius: 20px;
        font-size: 14px;
        z-index: 500;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      .toast.show {
        opacity: 1;
      }
      @media (max-height: 700px) {
        .phone {
          height: 95vh;
          border-radius: 30px;
        }
      }
      @media (max-width: 400px) {
        .phone {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
          box-shadow: none;
        }
      }
      /* Modal overlay */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 300;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.show {
        display: flex;
      }
      .modal-box {
        background: #fff;
        border-radius: 14px;
        width: 300px;
        max-height: 500px;
        overflow-y: auto;
        padding: 20px;
      }
      .modal-box h3 {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 16px;
        text-align: center;
      }
      .modal-box .form-item {
        padding: 8px 0;
        border-bottom: none;
      }
      .modal-box .modal-btns {
        display: flex;
        gap: 10px;
        margin-top: 16px;
      }
      .modal-box .modal-btns button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        cursor: pointer;
      }
      .modal-box .modal-btns .btn-cancel {
        background: #f2f2f7;
        color: #333;
      }
      .modal-box .modal-btns .btn-save {
        background: #07c160;
        color: #fff;
      }
      /* Message context menu */
      .msg-context-menu {
        position: absolute;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        z-index: 400;
        min-width: 120px;
        overflow: hidden;
        animation: menuFadeIn 0.15s ease;
      }
      @keyframes menuFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .msg-context-menu .ctx-item {
        padding: 11px 16px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 0.5px solid #f0f0f0;
      }
      .msg-context-menu .ctx-item:last-child {
        border-bottom: none;
      }
      .msg-context-menu .ctx-item:active {
        background: #f2f2f7;
      }
      .msg-context-menu .ctx-item.danger {
        color: #ff3b30;
      }
      .msg-context-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 399;
      }
      /* Edit message modal */
      .edit-msg-modal .edit-msg-textarea {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #f9f9f9;
        font-family: inherit;
        resize: none;
        min-height: 80px;
      }
      .edit-msg-modal .edit-msg-textarea:focus {
        border-color: #007aff;
        background: #fff;
      }
      /* Notification popup */
      .notif-popup {
        position: absolute;
        top: 50px;
        left: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.97);
        border-radius: 14px;
        padding: 12px 14px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        z-index: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        animation: notifSlide 0.35s ease;
      }
      @keyframes notifSlide {
        from {
          transform: translateY(-80px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .notif-popup.hiding {
        animation: notifSlideOut 0.3s ease forwards;
      }
      @keyframes notifSlideOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-80px);
          opacity: 0;
        }
      }
      .notif-avatar {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: bold;
        font-size: 16px;
        flex-shrink: 0;
        overflow: hidden;
      }
      .notif-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .notif-body {
        flex: 1;
        min-width: 0;
      }
      .notif-title {
        font-size: 14px;
        font-weight: 600;
        color: #000;
      }
      .notif-text {
        font-size: 13px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 2px;
      }
      .notif-app {
        font-size: 11px;
        color: #999;
        margin-top: 1px;
      }
      /* Contact list extras */
      .contact-item .pin-icon {
        font-size: 12px;
        color: #ff9500;
        margin-left: 4px;
      }
      .contact-item .mute-icon {
        font-size: 12px;
        color: #999;
        margin-left: 4px;
      }
      .contact-item.pinned {
        background: rgba(245, 245, 234, 0.88);
      }
      /* Contact context menu */
      .contact-ctx-menu {
        position: absolute;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        z-index: 400;
        min-width: 140px;
        overflow: hidden;
        animation: menuFadeIn 0.15s ease;
      }
      .contact-ctx-menu .ctx-item {
        padding: 11px 16px;
        font-size: 14px;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 0.5px solid #f0f0f0;
      }
      .contact-ctx-menu .ctx-item:last-child {
        border-bottom: none;
      }
      .contact-ctx-menu .ctx-item:active {
        background: #f2f2f7;
      }
      .contact-ctx-menu .ctx-item.danger {
        color: #ff3b30;
      }
      /* Chat bg picker in edit modal */
      .bg-options {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 6px;
      }
      .bg-option {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        border: 3px solid transparent;
        transition: border-color 0.2s;
        background-size: cover;
        background-position: center;
      }
      .bg-option.selected {
        border-color: #07c160;
      }
      .bg-option.custom-bg {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f2f2f7;
        font-size: 18px;
      }

      /* ======= WIDGETS ======= */
      .widget-area {
        position: relative;
        z-index: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        padding: 0 4px;
        max-height: 420px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .widget-area::-webkit-scrollbar {
        display: none;
      }
      .widget-card {
        border-radius: 20px;
        padding: 14px 16px;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(16px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        transition:
          transform 0.15s,
          box-shadow 0.2s;
        cursor: grab;
      }
      .widget-card:active {
        cursor: grabbing;
      }
      .widget-card.dragging {
        opacity: 0.7;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        transform: scale(1.03);
        z-index: 10;
      }
      .widget-card.drag-over {
        border-top: 3px solid #ff8fa3;
      }
      .widget-card .widget-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-size: cover;
        background-position: center;
        z-index: 0;
        border-radius: 20px;
      }
      .widget-card .widget-bg::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.45);
        border-radius: 20px;
      }
      .widget-card .widget-content {
        position: relative;
        z-index: 1;
      }
      .widget-card .widget-remove {
        position: absolute;
        top: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(255, 59, 48, 0.85);
        color: #fff;
        font-size: 13px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        line-height: 1;
      }
      .widget-card:hover .widget-remove,
      .widget-card .widget-remove.visible {
        display: flex;
      }
      .widget-card .widget-bg-btn {
        position: absolute;
        bottom: 6px;
        right: 8px;
        z-index: 2;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        font-size: 11px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .widget-card:hover .widget-bg-btn {
        display: flex;
      }

      /* Widget: Cute Clock */
      .w-clock {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .w-clock .clock-face {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: #fce4ec;
        border: 3px solid #f48fb1;
        position: relative;
        box-shadow: 0 2px 8px rgba(244, 143, 177, 0.3);
      }
      .w-clock .clock-center {
        position: absolute;
        width: 6px;
        height: 6px;
        background: #e91e63;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3;
      }
      .w-clock .clock-hand {
        position: absolute;
        bottom: 50%;
        left: 50%;
        transform-origin: bottom center;
        border-radius: 2px;
      }
      .w-clock .hand-hour {
        width: 3px;
        height: 20px;
        background: #e91e63;
      }
      .w-clock .hand-minute {
        width: 2px;
        height: 26px;
        background: #f06292;
      }
      .w-clock .hand-second {
        width: 1px;
        height: 28px;
        background: #f48fb1;
      }
      .w-clock .clock-info {
        flex: 1;
      }
      .w-clock .clock-digital {
        font-size: 28px;
        font-weight: 700;
        color: #e91e63;
      }
      .w-clock .clock-label {
        font-size: 12px;
        color: #f48fb1;
        margin-top: 2px;
      }

      /* Widget: Calendar */
      .w-calendar {
        text-align: center;
      }
      .w-calendar .cal-month {
        font-size: 14px;
        font-weight: 600;
        color: #7c4dff;
        margin-bottom: 8px;
      }
      .w-calendar .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        font-size: 11px;
      }
      .w-calendar .cal-day-name {
        color: #b39ddb;
        font-weight: 600;
        padding: 2px 0;
      }
      .w-calendar .cal-day {
        padding: 3px 0;
        border-radius: 50%;
        color: #555;
      }
      .w-calendar .cal-day.today {
        background: #7c4dff;
        color: #fff;
        font-weight: 700;
      }
      .w-calendar .cal-day.empty {
        visibility: hidden;
      }

      /* Widget: Mood */
      .w-mood {
        text-align: center;
        padding: 4px 0;
      }
      .w-mood .mood-title {
        font-size: 12px;
        color: #aaa;
        font-weight: 500;
        margin-bottom: 10px;
        letter-spacing: 1px;
      }
      .w-mood .mood-options {
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      .w-mood .mood-dot {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        border: 2px solid transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #fff;
        font-weight: 600;
        opacity: 0.5;
      }
      .w-mood .mood-dot:hover {
        transform: scale(1.15);
        opacity: 0.8;
      }
      .w-mood .mood-dot.selected {
        opacity: 1;
        transform: scale(1.2);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        border-color: rgba(255, 255, 255, 0.6);
      }
      .w-mood .mood-result {
        font-size: 13px;
        color: #888;
        margin-top: 10px;
        font-weight: 500;
      }

      /* Widget: Memo */
      .w-memo .memo-title {
        font-size: 13px;
        font-weight: 600;
        color: #00897b;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .w-memo textarea {
        width: 100%;
        min-height: 50px;
        border: none;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 13px;
        font-family: inherit;
        resize: none;
        outline: none;
        color: #333;
      }

      /* Widget: Pet */
      .w-pet {
        text-align: center;
      }
      .w-pet .pet-display {
        font-size: 48px;
        animation: petBounce 2s infinite;
      }
      @keyframes petBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-6px);
        }
      }
      .w-pet .pet-name {
        font-size: 13px;
        font-weight: 600;
        color: #ff7043;
        margin-top: 4px;
      }
      .w-pet .pet-status {
        font-size: 11px;
        color: #ffab91;
        margin-top: 2px;
      }
      .w-pet .pet-actions {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }
      .w-pet .pet-btn {
        background: #ff8a65;
        border: none;
        border-radius: 14px;
        padding: 4px 12px;
        font-size: 11px;
        cursor: pointer;
        color: #fff;
      }

      /* Widget: Countdown */
      .w-countdown {
        text-align: center;
      }
      .w-countdown .cd-title {
        font-size: 13px;
        color: #ec407a;
        font-weight: 600;
        margin-bottom: 6px;
      }
      .w-countdown .cd-number {
        font-size: 36px;
        font-weight: 800;
        color: #ec407a;
      }
      .w-countdown .cd-unit {
        font-size: 12px;
        color: #f48fb1;
      }
      .w-countdown .cd-date {
        font-size: 11px;
        color: #ce93d8;
        margin-top: 4px;
      }

      /* Widget: Weather */
      .w-weather {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .w-weather .weather-icon {
        font-size: 40px;
      }
      .w-weather .weather-info {
        flex: 1;
      }
      .w-weather .weather-temp {
        font-size: 28px;
        font-weight: 700;
        color: #29b6f6;
      }
      .w-weather .weather-desc {
        font-size: 12px;
        color: #81d4fa;
      }
      .w-weather .weather-loc {
        font-size: 11px;
        color: #b3e5fc;
      }

      /* Widget: Photo */
      .w-photo {
        text-align: center;
      }
      .w-photo .photo-frame {
        width: 100%;
        aspect-ratio: 16/9;
        border-radius: 14px;
        overflow: hidden;
        background: #ffe0b2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        cursor: pointer;
        position: relative;
        border: 3px solid rgba(255, 183, 77, 0.4);
      }
      .w-photo .photo-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .w-photo .photo-label {
        font-size: 11px;
        color: #ffb74d;
        margin-top: 6px;
      }

      /* Widget: Quote */
      .w-quote {
        text-align: center;
        padding: 8px 0;
      }
      .w-quote .quote-icon {
        font-size: 20px;
        color: #a5d6a7;
      }
      .w-quote .quote-text {
        font-size: 14px;
        color: #4caf50;
        font-style: italic;
        margin: 6px 0;
        line-height: 1.5;
      }
      .w-quote .quote-author {
        font-size: 11px;
        color: #81c784;
      }
      .w-quote .quote-edit-btn {
        margin-top: 6px;
        background: none;
        border: 1px dashed #a5d6a7;
        border-radius: 12px;
        padding: 3px 12px;
        font-size: 11px;
        color: #81c784;
        cursor: pointer;
        transition: all 0.15s;
      }
      .w-quote .quote-edit-btn:hover {
        background: rgba(165, 214, 167, 0.15);
        border-color: #66bb6a;
      }
      .w-quote .quote-edit-area {
        text-align: left;
        margin-top: 8px;
      }
      .w-quote .quote-edit-area textarea,
      .w-quote .quote-edit-area input {
        width: 100%;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        padding: 6px 8px;
        font-size: 12px;
        outline: none;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.5);
        margin-bottom: 4px;
      }
      .w-quote .quote-edit-area textarea {
        min-height: 40px;
        resize: none;
      }
      .w-quote .quote-edit-area textarea:focus,
      .w-quote .quote-edit-area input:focus {
        border-color: #66bb6a;
      }
      .w-quote .quote-save-btn {
        background: #66bb6a;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 4px 14px;
        font-size: 11px;
        cursor: pointer;
        margin-top: 4px;
      }

      /* Widget: Todo */
      .w-todo .todo-title {
        font-size: 13px;
        font-weight: 600;
        color: #5c6bc0;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .w-todo .todo-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .w-todo .todo-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #555;
        cursor: pointer;
      }
      .w-todo .todo-item.done {
        text-decoration: line-through;
        color: #bbb;
      }
      .w-todo .todo-item .todo-delete {
        margin-left: auto;
        font-size: 12px;
        color: #ccc;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.15s;
        flex-shrink: 0;
        padding: 0 2px;
      }
      .w-todo .todo-item:hover .todo-delete {
        opacity: 1;
        color: #ff5252;
      }
      .w-todo .todo-check {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid #9fa8da;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
      }
      .w-todo .todo-item.done .todo-check {
        background: #7986cb;
        border-color: #7986cb;
        color: #fff;
      }
      .w-todo .todo-add {
        margin-top: 6px;
        display: flex;
        gap: 4px;
      }
      .w-todo .todo-add input {
        flex: 1;
        border: 1px solid #c5cae9;
        border-radius: 10px;
        padding: 4px 8px;
        font-size: 12px;
        outline: none;
        font-family: inherit;
      }
      .w-todo .todo-add button {
        background: #7986cb;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
      }

      /* Widget: Music */
      .w-music {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .w-music .music-main {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .w-music .music-cover {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        background: #ba68c8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        animation: musicSpin 4s linear infinite;
        box-shadow: 0 2px 8px rgba(186, 104, 200, 0.3);
      }
      .w-music .music-cover.paused {
        animation-play-state: paused;
      }
      @keyframes musicSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .w-music .music-info {
        flex: 1;
      }
      .w-music .music-title {
        font-size: 14px;
        font-weight: 600;
        color: #8e24aa;
      }
      .w-music .music-artist {
        font-size: 11px;
        color: #ce93d8;
      }
      .w-music .music-controls {
        display: flex;
        gap: 10px;
        margin-top: 6px;
      }
      .w-music .music-btn {
        font-size: 16px;
        cursor: pointer;
      }
      .w-music .music-url-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .w-music .music-url-input {
        flex: 1;
        border: 1px solid #e0d0e8;
        border-radius: 8px;
        padding: 5px 8px;
        font-size: 11px;
        outline: none;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.6);
      }
      .w-music .music-url-input:focus {
        border-color: #ba68c8;
      }
      .w-music .music-url-btn {
        background: #ba68c8;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 5px 10px;
        font-size: 11px;
        cursor: pointer;
        white-space: nowrap;
      }
      .w-music .music-progress {
        width: 100%;
        height: 3px;
        background: rgba(186, 104, 200, 0.2);
        border-radius: 2px;
        overflow: hidden;
      }
      .w-music .music-progress-fill {
        height: 100%;
        background: #ba68c8;
        border-radius: 2px;
        transition: width 0.3s;
      }

      /* Widget: Photo Wall (Decorative) */
      .w-photowall {
        position: relative;
        min-height: 180px;
        overflow: hidden;
        border-radius: 12px;
      }
      .w-photowall .pw-deco-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: center;
      }
      .w-photowall .pw-deco-item {
        position: relative;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        background: #f5f5f5;
      }
      .w-photowall .pw-deco-item:hover {
        transform: scale(1.05) rotate(0deg) !important;
        box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        z-index: 5;
      }
      .w-photowall .pw-deco-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .w-photowall .pw-deco-item .pw-deco-del {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(255,59,48,0.85);
        color: #fff;
        font-size: 10px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 3;
        line-height: 1;
      }
      .w-photowall .pw-deco-item:hover .pw-deco-del {
        display: flex;
      }
      .w-photowall .pw-deco-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 140px;
        color: #ccc;
        gap: 8px;
        cursor: pointer;
      }
      .w-photowall .pw-deco-empty-icon {
        font-size: 40px;
        opacity: 0.5;
      }
      .w-photowall .pw-deco-empty-text {
        font-size: 13px;
      }
      .w-photowall .pw-deco-add {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed rgba(0,0,0,0.12);
        border-radius: 6px;
        cursor: pointer;
        font-size: 20px;
        color: #ccc;
        transition: all 0.2s;
        min-height: 50px;
      }
      .w-photowall .pw-deco-add:hover {
        border-color: rgba(0,0,0,0.25);
        color: #999;
        background: rgba(0,0,0,0.03);
      }
      /* Photo wall layout modes */
      .w-photowall .pw-layout-scattered {
        position: relative;
        min-height: 180px;
      }
      .w-photowall .pw-layout-scattered .pw-deco-item {
        position: absolute;
        border: 3px solid #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      .w-photowall .pw-layout-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
      }
      .w-photowall .pw-layout-grid .pw-deco-item {
        aspect-ratio: 1;
        border: 2px solid #fff;
      }
      .w-photowall .pw-layout-masonry {
        column-count: 3;
        column-gap: 4px;
      }
      .w-photowall .pw-layout-masonry .pw-deco-item {
        break-inside: avoid;
        margin-bottom: 4px;
        border: 2px solid #fff;
      }
      .w-photowall .pw-deco-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .w-photowall .pw-deco-title {
        font-size: 13px;
        font-weight: 600;
        color: #e91e63;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .w-photowall .pw-deco-actions {
        display: flex;
        gap: 6px;
      }
      .w-photowall .pw-deco-btn {
        background: rgba(233,30,99,0.1);
        border: none;
        border-radius: 10px;
        padding: 3px 10px;
        font-size: 11px;
        color: #e91e63;
        cursor: pointer;
        transition: background 0.15s;
      }
      .w-photowall .pw-deco-btn:hover {
        background: rgba(233,30,99,0.2);
      }
      .w-photowall .pw-deco-btn:active {
        transform: scale(0.95);
      }

      /* Widget: Battery */
      .w-battery {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .w-battery .bat-visual {
        width: 60px;
        height: 28px;
        border: 3px solid #66bb6a;
        border-radius: 6px;
        position: relative;
        overflow: hidden;
      }
      .w-battery .bat-visual::after {
        content: '';
        position: absolute;
        right: -8px;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 12px;
        background: #66bb6a;
        border-radius: 0 2px 2px 0;
      }
      .w-battery .bat-fill {
        height: 100%;
        background: #66bb6a;
        border-radius: 3px;
        transition: width 0.3s;
      }
      .w-battery .bat-info {
        flex: 1;
      }
      .w-battery .bat-percent {
        font-size: 22px;
        font-weight: 700;
        color: #43a047;
      }
      .w-battery .bat-label {
        font-size: 11px;
        color: #81c784;
      }

      /* Widget: Love Days */
      .w-lovedays {
        text-align: center;
        background: rgba(252, 228, 236, 0.6);
        border-radius: 20px;
      }
      .w-lovedays .ld-hearts {
        font-size: 20px;
        letter-spacing: 4px;
      }
      .w-lovedays .ld-title {
        font-size: 13px;
        color: #e91e63;
        font-weight: 600;
        margin: 4px 0;
      }
      .w-lovedays .ld-days {
        font-size: 32px;
        font-weight: 800;
        color: #e91e63;
      }
      .w-lovedays .ld-label {
        font-size: 12px;
        color: #f48fb1;
      }
      .w-lovedays .ld-date-info {
        font-size: 11px;
        color: #f8bbd0;
        margin-top: 4px;
      }

      /* Widget Picker Modal */
      .widget-picker-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        max-height: 360px;
        overflow-y: auto;
      }
      .widget-picker-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 12px 6px;
        background: #f9f9f9;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.15s;
        border: 2px solid transparent;
      }
      .widget-picker-item:hover {
        background: #fff0f5;
        border-color: #ffb6c1;
      }
      .widget-picker-item:active {
        transform: scale(0.95);
      }
      .widget-picker-item .wp-icon {
        font-size: 28px;
      }
      .widget-picker-item .wp-name {
        font-size: 11px;
        color: #555;
        text-align: center;
        font-weight: 500;
      }

      /* Home Pages (pagination) */
      .home-pages {
        flex: 1;
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        scrollbar-width: none;
        width: 100%;
        position: relative;
        z-index: 1;
      }
      .home-pages::-webkit-scrollbar {
        display: none;
      }
      .home-page {
        min-width: 100%;
        scroll-snap-align: start;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 0 0;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .home-page::-webkit-scrollbar {
        display: none;
      }
      .page-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 8px 0 4px;
        position: relative;
        z-index: 1;
      }
      .page-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.35);
        transition: all 0.25s;
        cursor: pointer;
      }
      .page-dot.active {
        background: #fff;
        transform: scale(1.2);
      }

      /* Add widget button on home */
      .add-widget-btn {
        position: relative;
        z-index: 1;
        margin: 0 auto;
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(10px);
        border: 2px dashed rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        padding: 8px 20px;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .add-widget-btn:hover {
        background: rgba(255, 255, 255, 0.65);
        border-color: rgba(255, 255, 255, 0.8);
      }
      .add-widget-btn:active {
        transform: scale(0.96);
      }

      /* Calendar App */
      .calendar-app-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .calendar-app-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(242, 242, 247, 0.7);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .calendar-app-screen.active {
        transform: translateX(0);
      }
      .calendar-app-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .calendar-app-screen .app-header .header-title {
        color: #ff3b30;
      }
      .calendar-app-screen .app-header .back-btn {
        color: #ff3b30;
      }
      .calendar-app-screen .app-header .header-actions span {
        color: #ff3b30;
        font-size: 16px;
        cursor: pointer;
      }
      .cal-app-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }
      .cal-app-month {
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        color: #ff3b30;
        margin-bottom: 12px;
      }
      .cal-app-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .cal-app-grid .cal-hd {
        text-align: center;
        font-size: 12px;
        color: #999;
        font-weight: 600;
        padding: 6px 0;
      }
      .cal-app-grid .cal-cell {
        text-align: center;
        padding: 8px 0;
        font-size: 14px;
        color: #333;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        transition: background 0.15s;
      }
      .cal-app-grid .cal-cell:hover {
        background: #fff0f0;
      }
      .cal-app-grid .cal-cell.today {
        background: #ff3b30;
        color: #fff;
        font-weight: 700;
      }
      .cal-app-grid .cal-cell.empty {
        visibility: hidden;
      }
      .cal-app-grid .cal-cell.has-event::after {
        content: '';
        position: absolute;
        bottom: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: #ff3b30;
      }
      .cal-app-grid .cal-cell.today.has-event::after {
        background: #fff;
      }
      .cal-app-events {
        margin-top: 16px;
      }
      .cal-app-events .cal-ev-title {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }
      .cal-ev-item {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 14px 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }
      .cal-ev-icon {
        font-size: 24px;
      }
      .cal-ev-info {
        flex: 1;
      }
      .cal-ev-name {
        font-size: 14px;
        font-weight: 500;
        color: #333;
      }
      .cal-ev-date {
        font-size: 12px;
        color: #999;
        margin-top: 2px;
      }
      .cal-ev-days {
        font-size: 13px;
        font-weight: 600;
        color: #ff3b30;
        flex-shrink: 0;
      }

      /* Anniversary App */
      .anniversary-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .anniversary-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 245, 247, 0.6);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .anniversary-screen.active {
        transform: translateX(0);
      }
      .anniversary-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .anniversary-screen .app-header .header-title {
        color: #e91e63;
      }
      .anniversary-screen .app-header .back-btn {
        color: #e91e63;
      }
      .anniversary-screen .app-header .header-actions span {
        color: #e91e63;
      }
      .anniv-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }
      .anniv-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: 0 8px 24px rgba(233, 30, 99, 0.08);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
      .anniv-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #e91e63;
      }
      .anniv-card .anniv-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }
      .anniv-card .anniv-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
      }
      .anniv-card .anniv-days {
        font-size: 36px;
        font-weight: 800;
        color: #e91e63;
        margin: 8px 0 4px;
      }
      .anniv-card .anniv-label {
        font-size: 13px;
        color: #f48fb1;
      }
      .anniv-card .anniv-date-info {
        font-size: 12px;
        color: #ccc;
        margin-top: 4px;
      }
      .anniv-card .anniv-delete {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 16px;
        cursor: pointer;
        color: #ccc;
        transition: color 0.15s;
      }
      .anniv-card .anniv-delete:hover {
        color: #ff3b30;
      }
      .anniv-empty {
        text-align: center;
        padding: 80px 20px;
        color: #f48fb1;
        font-size: 14px;
      }
      .anniv-empty .anniv-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      /* ======= MUSIC APP (Minimalist Black & White Style) ======= */
      .music-app-screen {
        background: #000;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
        color: #fff;
      }
      .music-app-screen.active {
        transform: translateX(0);
      }
      .music-app-screen .app-header {
        background: transparent;
        border-bottom: none;
        height: 60px;
        padding-top: 20px;
      }
      .music-app-screen .app-header .header-title {
        color: #fff;
        font-weight: 300;
        letter-spacing: 2px;
        text-transform: uppercase;
        font-size: 14px;
      }
      .music-app-screen .app-header .back-btn {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
      }
      .music-app-screen .app-header .header-actions span {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .music-app-body {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        padding: 0;
        background: #111;
      }

      /* Player Section (Top) */
      .music-player-section {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        overflow: hidden;
      }

      /* Vinyl Record Style */
      .music-vinyl-container {
        position: relative;
        width: 260px;
        height: 260px;
        margin: 30px 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .music-vinyl-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: repeating-radial-gradient(circle at center, #111 0, #111 2px, #181818 3px, #111 4px);
        box-shadow:
          0 20px 50px rgba(0, 0, 0, 0.8),
          inset 0 0 20px rgba(255, 255, 255, 0.05);
        border: 2px solid #222;
      }

      .music-album-art {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #222;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        animation: musicAppSpin 15s linear infinite;
        z-index: 2;
        border: 3px solid #000;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      }
      .music-album-art.paused {
        animation-play-state: paused;
      }
      .music-album-art img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .music-album-art svg {
        width: 40px;
        height: 40px;
        fill: #444;
      }
      @keyframes musicAppSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Stylus (Tonearm) */
      .music-stylus {
        position: absolute;
        top: -10px;
        right: 30px;
        width: 70px;
        height: 110px;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 150"><path d="M80,10 C80,20 70,30 60,30 L40,30 L20,120 L10,130 L20,140 L30,130 L40,40 L60,40 C75,40 90,25 90,10 Z" fill="%23555" stroke="%23333" stroke-width="2"/><circle cx="80" cy="10" r="15" fill="%23444" stroke="%23222" stroke-width="2"/></svg>')
          no-repeat center/contain;
        transform-origin: 80px 10px;
        transform: rotate(-35deg);
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
      }
      .music-stylus.playing {
        transform: rotate(-5deg);
      }

      .music-app-title {
        font-size: 20px;
        font-weight: 600;
        margin-top: 10px;
        text-align: center;
        color: #fff;
        letter-spacing: 0.5px;
      }
      .music-app-artist {
        font-size: 13px;
        color: #888;
        margin-top: 6px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .music-app-progress {
        width: 100%;
        margin: 30px 0 15px;
        padding: 0 30px;
      }
      .music-app-progress-bar {
        width: 100%;
        height: 2px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 1px;
        overflow: visible;
        cursor: pointer;
        position: relative;
      }
      .music-app-progress-fill {
        height: 100%;
        background: #fff;
        border-radius: 1px;
        transition: width 0.1s linear;
        position: relative;
      }
      .music-app-progress-fill::after {
        content: '';
        position: absolute;
        right: -4px;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background: #fff;
        border-radius: 50%;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }
      .music-app-times {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: #555;
        margin-top: 10px;
        font-family: monospace;
      }

      .music-app-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 40px;
        margin: 15px 0 30px;
        width: 100%;
      }
      .music-app-controls .ctrl-btn {
        cursor: pointer;
        color: #888;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .music-app-controls .ctrl-btn:hover {
        color: #fff;
      }
      .music-app-controls .ctrl-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }
      .music-app-controls .ctrl-play {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #000;
        transition: transform 0.2s;
      }
      .music-app-controls .ctrl-play:active {
        transform: scale(0.92);
      }
      .music-app-controls .ctrl-play svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      /* Playlist Section (Bottom) */
      .music-app-playlist-container {
        flex: 1;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
        padding: 25px;
      }

      .music-app-playlist-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .music-app-playlist-title .add-btn {
        font-size: 12px;
        color: #888;
        font-weight: normal;
        cursor: pointer;
        padding: 5px 12px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.05);
        transition: all 0.2s;
      }
      .music-app-playlist-title .add-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .music-pl-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        cursor: pointer;
        transition: all 0.2s;
      }
      .music-pl-item:last-child {
        border-bottom: none;
      }
      .music-pl-item:hover {
        padding-left: 5px;
      }
      .music-pl-item.active .pl-name {
        color: #fff;
        font-weight: 600;
      }
      .music-pl-item.active .pl-index {
        color: #fff;
      }

      .music-pl-item .pl-index {
        width: 20px;
        text-align: center;
        font-size: 12px;
        color: #444;
        font-family: monospace;
      }

      .music-pl-item .pl-cover {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        background: #1a1a1a;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .music-pl-item .pl-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .music-pl-item .pl-cover svg {
        width: 20px;
        height: 20px;
        fill: #333;
      }

      .music-pl-item .pl-info {
        flex: 1;
        min-width: 0;
      }
      .music-pl-item .pl-name {
        font-size: 14px;
        color: #aaa;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
      }
      .music-pl-item .pl-artist {
        font-size: 11px;
        color: #555;
        text-transform: uppercase;
      }

      .music-pl-item .pl-delete {
        padding: 8px;
        color: #333;
        transition: color 0.2s;
      }
      .music-pl-item .pl-delete:hover {
        color: #ff3b30;
      }

      .music-add-form {
        width: 100%;
        background: #f9f9f9;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 1px solid #eee;
      }
      .music-add-form input {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        color: #333;
        outline: none;
        font-family: inherit;
      }
      .music-add-form input::placeholder {
        color: #aaa;
      }
      .music-add-form input:focus {
        border-color: #ff3a3a;
      }
      .music-add-form .music-add-row {
        display: flex;
        gap: 8px;
        margin-top: 4px;
      }
      .music-add-form .music-add-btn {
        flex: 1;
        background: #ff3a3a;
        color: #fff;
        border: none;
        border-radius: 20px;
        padding: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }
      .music-add-form .music-cancel-btn {
        flex: 1;
        background: #eee;
        color: #666;
        border: none;
        border-radius: 20px;
        padding: 10px;
        font-size: 14px;
        cursor: pointer;
      }

      /* ======= SHOPPING MALL ======= */
      .shop-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
      }
      .shop-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 245, 247, 0.6);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .shop-screen.active {
        transform: translateX(0);
      }
      .shop-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .shop-screen .app-header .header-title {
        color: #e91e63;
      }
      .shop-screen .app-header .back-btn {
        color: #e91e63;
      }
      .shop-balance {
        text-align: center;
        padding: 16px;
        background: #e91e63;
        margin: 12px 16px;
        border-radius: 16px;
        color: #fff;
        box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3);
      }
      .shop-balance .bal-label {
        font-size: 12px;
        opacity: 0.8;
      }
      .shop-balance .bal-amount {
        font-size: 32px;
        font-weight: 800;
        margin: 4px 0;
      }
      .shop-balance .bal-recharge {
        background: rgba(255, 255, 255, 0.25);
        border: none;
        border-radius: 20px;
        padding: 6px 20px;
        font-size: 12px;
        color: #fff;
        cursor: pointer;
      }
      .shop-body {
        flex: 1;
        overflow-y: auto;
        padding: 0 16px 30px;
      }
      .shop-section-title {
        font-size: 15px;
        font-weight: 600;
        color: #e91e63;
        margin: 16px 0 10px;
      }
      .shop-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      .shop-item {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 16px 8px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition:
          transform 0.15s,
          box-shadow 0.15s;
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
      .shop-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      }
      .shop-item:active {
        transform: scale(0.96);
      }
      .shop-item .shop-icon {
        font-size: 32px;
        margin-bottom: 6px;
      }
      .shop-item .shop-name {
        font-size: 12px;
        color: #333;
        font-weight: 500;
      }
      .shop-item .shop-price {
        font-size: 11px;
        color: #e91e63;
        font-weight: 600;
        margin-top: 4px;
      }
      /* Gift message in chat */
      .msg-gift {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 16px;
        width: 200px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 24px rgba(233, 30, 99, 0.1);
      }
      .msg-gift .gift-icon {
        font-size: 48px;
        margin-bottom: 8px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
      }
      .msg-gift .gift-text {
        font-size: 14px;
        color: #e91e63;
        font-weight: 600;
      }
      .msg-gift .gift-note {
        font-size: 11px;
        color: #999;
        margin-top: 6px;
      }
      /* Image message */
      .msg-image {
        max-width: 200px;
        border-radius: 16px;
        overflow: hidden;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .msg-image img {
        width: 100%;
        display: block;
        border-radius: 16px;
      }

      /* Memory Panel */
      .memory-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 12px;
      }
      .memory-item {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 10px 12px;
        position: relative;
        border: 1px solid #eee;
      }
      .memory-item .mem-category {
        font-size: 10px;
        font-weight: 600;
        color: #fff;
        background: #7c4dff;
        border-radius: 8px;
        padding: 1px 8px;
        display: inline-block;
        margin-bottom: 4px;
      }
      .memory-item .mem-category.cat-ÂÅèÂ•Ω {
        background: #e91e63;
      }
      .memory-item .mem-category.cat-‰∫ãÂÆû {
        background: #2196f3;
      }
      .memory-item .mem-category.cat-ÂÖ≥Á≥ª {
        background: #ff9800;
      }
      .memory-item .mem-category.cat-ÁªèÂéÜ {
        background: #4caf50;
      }
      .memory-item .mem-category.cat-ÊÄßÊ†º {
        background: #9c27b0;
      }
      .memory-item .mem-content {
        font-size: 13px;
        color: #333;
        line-height: 1.4;
        word-break: break-word;
      }
      .memory-item .mem-time {
        font-size: 10px;
        color: #bbb;
        margin-top: 4px;
      }
      .memory-item .mem-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 6px;
      }
      .memory-item .mem-actions span {
        font-size: 12px;
        cursor: pointer;
        opacity: 0.4;
        transition: opacity 0.15s;
      }
      .memory-item:hover .mem-actions span {
        opacity: 1;
      }
      .memory-add-section {
        border-top: 1px solid #eee;
        padding-top: 10px;
        margin-top: 4px;
      }
      .memory-add-section select,
      .memory-add-section textarea {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 8px;
        padding: 8px 10px;
        font-size: 13px;
        outline: none;
        font-family: inherit;
        background: #f9f9f9;
        margin-bottom: 6px;
      }
      .memory-add-section textarea {
        resize: none;
        min-height: 50px;
      }
      .memory-add-section select:focus,
      .memory-add-section textarea:focus {
        border-color: #7c4dff;
        background: #fff;
      }
      .memory-add-btn {
        width: 100%;
        padding: 8px;
        background: #7c4dff;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
      }
      .memory-add-btn:active {
        background: #6a3de8;
      }
      .memory-empty {
        text-align: center;
        padding: 30px 10px;
        color: #ccc;
        font-size: 13px;
      }
      .memory-empty .mem-empty-icon {
        font-size: 36px;
        margin-bottom: 8px;
      }
      .memory-auto-btn {
        width: 100%;
        padding: 8px;
        background: #667eea;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .memory-auto-btn:active {
        opacity: 0.8;
      }
      .memory-auto-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Memory Screen */
      .memory-screen {
        background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover no-repeat fixed;
        display: flex;
        flex-direction: column;
        z-index: 66;
        transform: translateX(100%);
      }
      .memory-screen::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(242, 242, 247, 0.85);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        z-index: -1;
      }
      .memory-screen.active {
        transform: translateX(0);
      }
      .memory-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .memory-screen .app-header .header-title {
        color: #7c4dff;
      }
      .memory-screen .app-header .back-btn {
        color: #7c4dff;
      }
      .memory-screen .app-header .header-actions span {
        color: #7c4dff;
      }
      .memory-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: 40px;
      }
      .memory-stats {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .memory-stat-chip {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: #fff;
        cursor: pointer;
        transition: all 0.15s;
        opacity: 0.6;
      }
      .memory-stat-chip.active {
        opacity: 1;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .memory-item {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 12px 14px;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.6);
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        transition: transform 0.15s;
      }
      .memory-item:active {
        transform: scale(0.98);
      }
      .memory-item .mem-category {
        font-size: 10px;
        font-weight: 600;
        color: #fff;
        border-radius: 8px;
        padding: 2px 8px;
        display: inline-block;
        margin-bottom: 6px;
      }
      .memory-item .mem-category.cat-ÂÅèÂ•Ω {
        background: #e91e63;
      }
      .memory-item .mem-category.cat-‰∫ãÂÆû {
        background: #2196f3;
      }
      .memory-item .mem-category.cat-ÂÖ≥Á≥ª {
        background: #ff9800;
      }
      .memory-item .mem-category.cat-ÁªèÂéÜ {
        background: #4caf50;
      }
      .memory-item .mem-category.cat-ÊÄßÊ†º {
        background: #9c27b0;
      }
      .memory-item .mem-category.cat-ÂÖ∂‰ªñ {
        background: #607d8b;
      }
      .memory-item .mem-content {
        font-size: 14px;
        color: #333;
        line-height: 1.5;
        word-break: break-word;
      }
      .memory-item .mem-time {
        font-size: 10px;
        color: #bbb;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .memory-item .mem-source {
        font-size: 9px;
        padding: 1px 6px;
        border-radius: 4px;
        background: #f0f0f0;
        color: #999;
      }
      .memory-item .mem-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 8px;
      }
      .memory-item .mem-actions span {
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.15s;
      }
      .memory-item:hover .mem-actions span {
        opacity: 0.6;
      }
      .memory-item .mem-actions span:hover {
        opacity: 1;
      }
      .memory-add-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 16px;
        margin-top: 12px;
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
      }
      .memory-add-card .add-title {
        font-size: 14px;
        font-weight: 600;
        color: #7c4dff;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .memory-add-card select,
      .memory-add-card textarea {
        width: 100%;
        border: 1px solid #e5e5ea;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        font-family: inherit;
        background: #f9f9f9;
        margin-bottom: 8px;
      }
      .memory-add-card textarea {
        resize: none;
        min-height: 60px;
      }
      .memory-add-card select:focus,
      .memory-add-card textarea:focus {
        border-color: #7c4dff;
        background: #fff;
      }
      .memory-add-btn {
        width: 100%;
        padding: 10px;
        background: #7c4dff;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }
      .memory-add-btn:active {
        background: #6a3de8;
        transform: scale(0.98);
      }
      .memory-empty {
        text-align: center;
        padding: 40px 20px;
        color: #bbb;
        font-size: 14px;
      }
      .memory-empty .mem-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
      }
      .memory-section-title {
        font-size: 13px;
        font-weight: 600;
        color: #86868b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0 4px 8px;
        margin-top: 16px;
      }

      /* ======= PHOTO WALL ======= */
      .photowall-screen {
        background: #000;
        display: flex;
        flex-direction: column;
        z-index: 60;
        transform: translateX(100%);
        color: #fff;
      }
      .photowall-screen.active {
        transform: translateX(0);
      }
      .photowall-screen .app-header {
        background: transparent;
        border-bottom: none;
      }
      .photowall-screen .app-header .header-title {
        color: #fff;
        font-weight: 300;
        letter-spacing: 2px;
        text-transform: uppercase;
        font-size: 14px;
      }
      .photowall-screen .app-header .back-btn {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
      }
      .photowall-screen .app-header .header-actions span {
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.08);
        transition: background 0.2s;
      }
      .photowall-screen .app-header .header-actions span:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      .pw-body {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        background: #0a0a0a;
      }
      .pw-body::-webkit-scrollbar {
        width: 0;
      }
      /* Masonry-style grid */
      .pw-grid {
        column-count: 2;
        column-gap: 3px;
        padding: 3px;
      }
      .pw-item {
        break-inside: avoid;
        margin-bottom: 3px;
        position: relative;
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      .pw-item:active {
        opacity: 0.85;
      }
      .pw-item img {
        width: 100%;
        display: block;
        border-radius: 4px;
      }
      .pw-item .pw-delete {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(8px);
        color: #fff;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.15s;
        z-index: 2;
      }
      .pw-item .pw-delete:hover {
        background: rgba(255, 59, 48, 0.8);
      }
      .pw-item:hover .pw-delete {
        display: flex;
      }
      .pw-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 60vh;
        color: rgba(255, 255, 255, 0.3);
        gap: 16px;
      }
      .pw-empty-icon {
        font-size: 64px;
        opacity: 0.4;
      }
      .pw-empty-text {
        font-size: 15px;
        letter-spacing: 1px;
      }
      .pw-empty-hint {
        font-size: 12px;
        opacity: 0.5;
      }
      /* Lightbox */
      .pw-lightbox {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 500;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .pw-lightbox.show {
        display: flex;
      }
      .pw-lightbox img {
        max-width: 95%;
        max-height: 80%;
        border-radius: 8px;
        object-fit: contain;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
      .pw-lightbox-close {
        position: absolute;
        top: 50px;
        right: 16px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
      }
      .pw-lightbox-close:hover {
        background: rgba(255, 255, 255, 0.25);
      }
      .pw-add-floating {
        position: absolute;
        bottom: 30px;
        right: 20px;
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: #fff;
        color: #000;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        z-index: 10;
      }
      .pw-add-floating:active {
        transform: scale(0.92);
      }
      .pw-add-floating:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      }
      .pw-counter {
        position: absolute;
        bottom: 30px;
        left: 20px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.35);
        letter-spacing: 1px;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div id="phone" class="phone">
      <div class="status-bar" id="statusBar">
        <div class="time" id="statusTime">9:41</div>
        <div class="icons">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
            <path
              d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3a4.237 4.237 0 00-6 0zm-4-4l2 2a7.074 7.074 0 0110 0l2-2C15.14 9.14 8.87 9.14 5 13z"
            />
          </svg>
          <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
            <rect x="2" y="6" width="18" height="12" rx="2" />
            <rect x="22" y="9" width="2" height="6" rx="1" />
          </svg>
        </div>
      </div>
      <div class="toast" id="toast"></div>

      <!-- Auth Screen -->
      <div
        class="screen"
        id="authScreen"
        style="
          background: #f2f2f7;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 40px;
          z-index: 200;
        "
      >
        <div style="text-align: center; width: 100%">
          <div style="font-size: 22px; margin-bottom: 16px; color: #007aff; font-weight: 600">AI Phone</div>
          <h2 id="authTitle" style="font-size: 22px; margin-bottom: 24px">ÁôªÂΩï</h2>
          <div
            id="authError"
            style="
              display: none;
              background: #fee;
              color: #ff3b30;
              padding: 8px 12px;
              border-radius: 8px;
              font-size: 13px;
              margin-bottom: 12px;
            "
          ></div>
          <input
            type="text"
            id="authUsername"
            placeholder="Áî®Êà∑Âêç"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #e5e5ea;
              border-radius: 10px;
              font-size: 15px;
              margin-bottom: 10px;
              outline: none;
              font-family: inherit;
            "
          />
          <input
            type="password"
            id="authPassword"
            placeholder="ÂØÜÁ†Å"
            style="
              width: 100%;
              padding: 12px;
              border: 1px solid #e5e5ea;
              border-radius: 10px;
              font-size: 15px;
              margin-bottom: 16px;
              outline: none;
              font-family: inherit;
            "
          />
          <button
            id="authBtn"
            onclick="doAuth()"
            style="
              width: 100%;
              padding: 14px;
              background: #007aff;
              color: #fff;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
            "
          >
            ÁôªÂΩï
          </button>
          <div style="margin-top: 12px">
            <span id="authToggle" style="font-size: 13px; color: #007aff; cursor: pointer" onclick="toggleAuthMode()"
              >Ê≤°ÊúâË¥¶Âè∑ÔºüÊ≥®ÂÜå</span
            >
          </div>
          <div style="margin-top: 10px">
            <span style="font-size: 12px; color: #999; cursor: pointer" onclick="skipAuth()"
              >Ë∑≥ËøáÁôªÂΩïÔºà‰ªÖÊú¨Âú∞Â≠òÂÇ®Ôºâ</span
            >
          </div>
        </div>
      </div>

      <div class="screen lock-screen" id="lockScreen">
        <div class="lock-time-card">
          <div class="lock-time" id="lockTime">9:41</div>
          <div class="lock-date" id="lockDate">1Êúà1Êó• ÊòüÊúü‰∏Ä</div>
        </div>
        <div class="lock-unlock">
          <div class="arrow">‚åÉ</div>
          ‰∏äÊªëËß£ÈîÅ
        </div>
      </div>

      <div class="screen home-screen hidden" id="homeScreen">
        <div class="home-search" onclick="showToast('ÊêúÁ¥¢ÂäüËÉΩÂºÄÂèë‰∏≠')">
          <svg viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          ÊêúÁ¥¢
        </div>
        <div class="home-pages" id="homePages">
          <div class="home-page" id="homePage0"></div>
          <div class="home-page" id="homePage1"></div>
        </div>
        <div class="page-dots" id="pageDots">
          <div class="page-dot active" onclick="goToPage(0)"></div>
          <div class="page-dot" onclick="goToPage(1)"></div>
        </div>
        <div
          style="
            position: relative;
            z-index: 1;
            margin-bottom: 60px;
            cursor: pointer;
            opacity: 0.7;
            font-size: 13px;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
          "
          onclick="lockPhone()"
        >
          ÈîÅÂ±è
        </div>
      </div>

      <div class="screen contacts-screen" id="contactsScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeContacts()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </div>
          <div class="header-title">‰ø°ÊÅØ</div>
          <div class="header-actions">
            <span onclick="openImportCard()" title="ÂØºÂÖ•ËßíËâ≤Âç°" style="font-size: 16px">ÂØºÂÖ•</span
            ><span onclick="openNewGroup()" title="ÂèëËµ∑Áæ§ËÅä" style="font-size: 16px">Áæ§ËÅä</span
            ><span onclick="openNewContact()" title="Êñ∞Âª∫ËÅîÁ≥ª‰∫∫" style="font-size: 24px">Ôºã</span>
          </div>
        </div>
        <div class="contacts-body" id="contactsBody"></div>
      </div>

      <div class="screen new-contact-screen" id="newGroupScreen" style="z-index: 75">
        <div class="app-header">
          <div class="back-btn" onclick="closeNewGroup()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">ÂèëËµ∑Áæ§ËÅä</div>
        </div>
        <div class="new-contact-body">
          <div class="form-section">
            <div class="form-section-title">Áæ§ËÅäÂêçÁß∞</div>
            <div class="form-card">
              <div class="form-item">
                <input type="text" id="newGroupName" placeholder="ËæìÂÖ•Áæ§ËÅäÂêçÁß∞" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">ÈÄâÊã©ÊàêÂëò</div>
            <div class="form-card" id="groupMemberSelect" style="max-height: 300px; overflow-y: auto">
              <!-- Members will be rendered here -->
            </div>
          </div>
          <button class="create-btn" onclick="createGroup()">ÂàõÂª∫Áæ§ËÅä</button>
        </div>
      </div>

      <!-- Group Management Screen -->
      <div class="screen new-contact-screen" id="groupManageScreen" style="z-index: 76">
        <div class="app-header">
          <div class="back-btn" onclick="closeGroupManage()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">Áæ§ËÅäÁÆ°ÁêÜ</div>
        </div>
        <div class="new-contact-body">
          <div class="avatar-picker">
            <div
              class="avatar-preview"
              id="groupAvatarPreview"
              style="background: #5856d6"
              onclick="pickAvatar('group')"
            >
              üë•
              <div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Áæ§ËÅä‰ø°ÊÅØ</div>
            <div class="form-card">
              <div class="form-item">
                <label>Áæ§ÂêçÁß∞</label>
                <input type="text" id="groupManageName" placeholder="ËæìÂÖ•Áæ§ÂêçÁß∞" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title" id="groupMemberTitle">Áæ§ÊàêÂëò (0)</div>
            <div class="form-card" id="groupMemberList" style="max-height: 260px; overflow-y: auto"></div>
          </div>
          <button class="create-btn" onclick="saveGroupManage()" style="background: #007aff">‰øùÂ≠ò‰øÆÊîπ</button>
          <button class="create-btn" onclick="addMemberToGroup()" style="background: #07c160; margin-top: 10px">
            Ê∑ªÂä†ÊàêÂëò
          </button>
          <button class="create-btn" onclick="dissolveGroup()" style="background: #ff3b30; margin-top: 10px">
            Ëß£Êï£Áæ§ËÅä
          </button>
        </div>
      </div>

      <div class="screen new-contact-screen" id="newContactScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeNewContact()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title" id="newContactTitle">Êñ∞Âª∫ËÅîÁ≥ª‰∫∫</div>
        </div>
        <div class="new-contact-body">
          <div class="avatar-picker">
            <div class="avatar-preview" id="newAvatarPreview" style="background: #07c160" onclick="pickAvatar('new')">
              ?
              <div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>
            </div>
            <div class="color-options" id="colorOptions"></div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Âü∫Êú¨‰ø°ÊÅØ</div>
            <div class="form-card">
              <div class="form-item">
                <label>ÂêçÁß∞</label><input type="text" id="newContactName" placeholder="ËæìÂÖ•ËÅîÁ≥ª‰∫∫ÂêçÁß∞" />
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">AI ËÆæÂÆö</div>
            <div class="form-card">
              <div class="form-item">
                <label>Á≥ªÁªüÊèêÁ§∫ËØç</label><textarea id="newContactPrompt" placeholder="‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã"></textarea>
                <div class="hint">ÂÆö‰πâËØ•ËÅîÁ≥ª‰∫∫ÁöÑ AI ËßíËâ≤ÂíåË°å‰∏∫ÊñπÂºè</div>
              </div>
            </div>
          </div>
          <button class="create-btn" id="createOrSaveBtn" onclick="createContact()">ÂàõÂª∫ËÅîÁ≥ª‰∫∫</button>
          <button class="import-btn" onclick="openImportCard()">ÂØºÂÖ• PNG ËßíËâ≤Âç°</button>
        </div>
      </div>

      <div class="screen chat-screen" id="chatScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeChat()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </div>
          <div class="header-title" id="chatTitle" onclick="editCurrentContact()">AIÂä©Êâã</div>
          <div class="header-actions">
            <span onclick="toggleChatMenu()" id="chatMenuBtn" style="font-size: 24px; cursor: pointer">‚ãØ</span>
          </div>
        </div>
        <!-- Chat dropdown menu -->
        <div
          id="chatDropdownMenu"
          style="
            display: none;
            position: absolute;
            top: 82px;
            right: 12px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            min-width: 160px;
            overflow: hidden;
            animation: menuFadeIn 0.15s ease;
          "
        ></div>
        <div class="chat-container" id="chatContainer"></div>
        <div id="generateRow" class="generate-row" style="display: none">
          <button class="generate-btn" id="generateBtn" onclick="generateReply()">ÁîüÊàêÂõûÂ§ç</button>
        </div>
        <div class="input-extras">
          <div class="extra-btn" onclick="openTransferModal()">ËΩ¨Ë¥¶</div>
          <div class="extra-btn" onclick="openRedPacketModal()">Á∫¢ÂåÖ</div>
          <div class="extra-btn" onclick="openShopForGift()">Á§ºÁâ©</div>
          <div class="extra-btn" onclick="pickChatImage()">ÂõæÁâá</div>
        </div>
        <div class="input-bar">
          <textarea id="userInput" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ‚Ä¶"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">ÂèëÈÄÅ</button>
        </div>
      </div>

      <div class="screen weibo-screen" id="weiboScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeWeibo()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">ÂæÆÂçö</div>
          <div class="header-actions">
            <span onclick="refreshWeibo()" title="AIÂà∑Êñ∞" style="font-size: 16px">Âà∑Êñ∞</span
            ><span onclick="toggleWeiboCompose()" title="ÂèëÂæÆÂçö" style="font-size: 16px">ÂèëÂ∏É</span>
          </div>
        </div>
        <div class="weibo-tabs">
          <div class="weibo-tab active" onclick="switchWeiboTab(this, 'follow')">ÂÖ≥Ê≥®</div>
          <div class="weibo-tab" onclick="switchWeiboTab(this, 'hot')">ÁÉ≠Èó®</div>
          <div class="weibo-tab" onclick="switchWeiboTab(this, 'mine')">ÊàëÁöÑ</div>
        </div>
        <div class="weibo-body" id="weiboBody"></div>
        <div class="weibo-compose" id="weiboCompose">
          <textarea id="weiboInput" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã‚Ä¶"></textarea>
          <div class="weibo-compose-bar">
            <button class="cancel-btn" onclick="toggleWeiboCompose()">ÂèñÊ∂à</button>
            <button class="post-btn" onclick="postWeibo()">ÂèëÂ∏É</button>
          </div>
        </div>
      </div>

      <div class="screen settings-screen" id="settingsScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeSettings()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">ËÆæÁΩÆ</div>
        </div>
        <div class="settings-body">
          <div class="settings-section">
            <div class="settings-section-title">Áî®Êà∑ËÆæÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>Áî®Êà∑ÊòµÁß∞</label><input type="text" id="settingUserName" placeholder="Êàë" />
                <div class="hint">ËÅäÂ§©ÂíåÂæÆÂçö‰∏≠ÊòæÁ§∫ÁöÑÊòµÁß∞</div>
              </div>
              <div class="settings-item">
                <label>Áî®Êà∑Â§¥ÂÉè</label>
                <div style="display: flex; align-items: center; gap: 12px">
                  <div
                    id="userAvatarPreview"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 8px;
                      background: #1989fa;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      color: #fff;
                      font-weight: bold;
                      font-size: 18px;
                      overflow: hidden;
                      cursor: pointer;
                      flex-shrink: 0;
                    "
                    onclick="pickAvatar('user')"
                  >
                    Êàë
                  </div>
                  <div class="hint">ÁÇπÂáªÂ§¥ÂÉèÊõ¥Êç¢</div>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">‰∫∫ËÆæÈù¢ÂÖ∑</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>ËßíËâ≤‰∫∫ËÆæ (Persona)</label>
                <textarea
                  id="settingPersona"
                  style="
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 13px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    resize: vertical;
                    min-height: 80px;
                  "
                  placeholder="ÊèèËø∞‰Ω†ÊâÆÊºîÁöÑËßíËâ≤Ôºå‰æãÂ¶ÇÔºöÊàëÊòØ‰∏Ä‰∏™18Â≤ÅÁöÑÂ§ßÂ≠¶ÁîüÔºåÊÄßÊ†ºÂºÄÊúóÔºåÂñúÊ¨¢Èü≥‰πêÂíåÊóÖË°å‚Ä¶"
                ></textarea>
                <div class="hint">‰∫∫ËÆæ‰ø°ÊÅØ‰ºö‰Ωú‰∏∫Á≥ªÁªüÊèêÁ§∫ËØçÊ≥®ÂÖ•ÔºåËÆ© AI ‰∫ÜËß£"‰Ω†ÊòØË∞Å"Ôºå‰ªéËÄåÊõ¥Â•ΩÂú∞‰∏é‰Ω†‰∫íÂä®</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">API ÈÖçÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>API Á´ØÁÇπ</label
                ><input
                  type="url"
                  id="settingEndpoint"
                  placeholder="https://morning-rain-6898.ruoxixin2.workers.dev/v1/chat/completions"
                />
                <div class="hint">ÂÖºÂÆπ OpenAI Ê†ºÂºèÁöÑ API Á´ØÁÇπ</div>
              </div>
              <div class="settings-item">
                <label>API KeyÔºàÂèØÈÄâÔºâ</label
                ><input type="password" id="settingApiKey" placeholder="ÁïôÁ©∫Âàô‰ΩøÁî®‰∏≠ËΩ¨ÊúçÂä°Âô®ÂÜÖÁΩÆKey" />
                <div class="hint">Â¶ÇÊûú‰∏≠ËΩ¨ÊúçÂä°Âô®Â∑≤ÂÜÖÁΩÆ API KeyÔºåÊ≠§Â§ÑÂèØÁïôÁ©∫</div>
              </div>
              <div class="settings-item">
                <label>Ê®°Âûã</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input type="text" id="settingModel" placeholder="gpt-4o-mini" style="flex: 1" />
                  <button
                    class="save-btn"
                    style="width: auto; padding: 8px 14px; font-size: 13px; margin: 0; white-space: nowrap"
                    onclick="fetchModels()"
                    id="fetchModelsBtn"
                  >
                    üì° ÊãâÂèñÊ®°Âûã
                  </button>
                </div>
                <select
                  id="modelSelect"
                  style="
                    display: none;
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 14px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    margin-top: 6px;
                  "
                  onchange="selectFetchedModel(this.value)"
                ></select>
                <div class="hint">Â¶Ç gpt-4o-mini„ÄÅgpt-4o„ÄÅclaude-3-sonnet Á≠âÔºõÁÇπÂáª"ÊãâÂèñÊ®°Âûã"ÂèØËá™Âä®Ëé∑ÂèñÂèØÁî®Ê®°ÂûãÂàóË°®</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">ÁîüÊàêÂèÇÊï∞</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>Ê∏©Â∫¶ (Temperature)</label
                ><input type="number" id="settingTemperature" placeholder="0.7" min="0" max="2" step="0.1" />
                <div class="hint">ÊéßÂà∂ÂõûÂ§çÁöÑÈöèÊú∫ÊÄßÔºåËåÉÂõ¥ 0-2</div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">‰∏ñÁïå‰π¶ / Á†¥Áî≤</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>‰∏ñÁïå‰π¶ (Worldbook)</label>
                <textarea
                  id="settingWorldbook"
                  style="
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 13px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    resize: vertical;
                    min-height: 80px;
                  "
                  placeholder="Âú®Ê≠§ËæìÂÖ•‰∏ñÁïåËßÇËÆæÂÆö„ÄÅËÉåÊôØ‰ø°ÊÅØÁ≠âÔºå‰ºö‰Ωú‰∏∫ÂÖ®Â±ÄÁ≥ªÁªüÊèêÁ§∫ËØçÊ≥®ÂÖ•Âà∞ÊâÄÊúâÂØπËØù‰∏≠‚Ä¶"
                ></textarea>
                <div class="hint">‰∏ñÁïå‰π¶ÂÜÖÂÆπ‰ºöÂú®ËÅîÁ≥ª‰∫∫ÁöÑÁ≥ªÁªüÊèêÁ§∫ËØç‰πãÂêéÊ≥®ÂÖ•ÔºåÁî®‰∫éË°•ÂÖÖ‰∏ñÁïåËßÇ„ÄÅËßÑÂàôËÆæÂÆöÁ≠âÂÖ®Â±ÄËÉåÊôØ‰ø°ÊÅØ</div>
              </div>
              <div class="settings-item">
                <label>Á†¥Áî≤ÊèêÁ§∫ËØç (Jailbreak)</label>
                <textarea
                  id="settingJailbreak"
                  style="
                    border: 1px solid #e5e5ea;
                    border-radius: 8px;
                    padding: 10px 12px;
                    font-size: 13px;
                    outline: none;
                    background: #f9f9f9;
                    width: 100%;
                    font-family: inherit;
                    resize: vertical;
                    min-height: 80px;
                  "
                  placeholder="Âú®Ê≠§ËæìÂÖ•Á†¥Áî≤/Ë∂äÁã±ÊèêÁ§∫ËØçÔºå‰ºö‰Ωú‰∏∫ÊúÄÂêé‰∏ÄÊù°Á≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•‚Ä¶"
                ></textarea>
                <div class="hint">
                  Á†¥Áî≤ÊèêÁ§∫ËØç‰ºöÂú®ÊâÄÊúâËÅäÂ§©Ê∂àÊÅØ‰πãÂêé„ÄÅAI ÂõûÂ§ç‰πãÂâç‰Ωú‰∏∫ÊúÄÂêé‰∏ÄÊù° system Ê∂àÊÅØÊ≥®ÂÖ•ÔºåÁî®‰∫éËß£Èô§ AI
                  ÁöÑÈôêÂà∂ÊàñÂº∫ÂåñËßíËâ≤ÊâÆÊºî
                </div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">ÊòæÁ§∫ËÆæÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item" style="flex-direction:row;align-items:center;justify-content:space-between;">
                <div>
                  <label>ÂÖ®Â±èÊ®°Âºè</label>
                  <div class="hint">ÈöêËóèÊâãÊú∫Â§ñÂ£≥ÔºåÂÖ®Â±èÊòæÁ§∫ÁïåÈù¢</div>
                </div>
                <div style="position:relative;width:51px;height:31px;cursor:pointer;" onclick="toggleFullscreen()" id="fullscreenToggle">
                  <div style="width:51px;height:31px;border-radius:15.5px;background:#e9e9ea;transition:background 0.2s;" id="fullscreenTrack"></div>
                  <div style="position:absolute;top:2px;left:2px;width:27px;height:27px;border-radius:50%;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:transform 0.2s;" id="fullscreenThumb"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">Â£ÅÁ∫∏ËÆæÁΩÆ</div>
            <div class="settings-card">
              <div class="settings-item">
                <label>ÈîÅÂ±èÂ£ÅÁ∫∏</label>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap">
                  <div
                    id="lockWpPreview"
                    style="
                      width: 60px;
                      height: 100px;
                      border-radius: 8px;
                      background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover;
                      border: 2px solid #ddd;
                      flex-shrink: 0;
                    "
                  ></div>
                  <button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0"
                    onclick="pickWallpaper('lock')"
                  >
                    Êõ¥Êç¢</button
                  ><button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0; background: #ff3b30"
                    onclick="resetWallpaper('lock')"
                  >
                    ÊÅ¢Â§çÈªòËÆ§
                  </button>
                </div>
              </div>
              <div class="settings-item">
                <label>‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</label>
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap">
                  <div
                    id="homeWpPreview"
                    style="
                      width: 60px;
                      height: 100px;
                      border-radius: 8px;
                      background: url('https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg') center/cover;
                      border: 2px solid #ddd;
                      flex-shrink: 0;
                    "
                  ></div>
                  <button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0"
                    onclick="pickWallpaper('home')"
                  >
                    Êõ¥Êç¢</button
                  ><button
                    class="save-btn"
                    style="width: auto; padding: 8px 16px; font-size: 13px; margin: 0; background: #ff3b30"
                    onclick="resetWallpaper('home')"
                  >
                    ÊÅ¢Â§çÈªòËÆ§
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button class="save-btn" onclick="saveSettings()">‰øùÂ≠òËÆæÁΩÆ</button>
        </div>
      </div>

      <div class="control-center" id="controlCenter">
        <div class="control-overlay" onclick="closeControlCenter()"></div>
        <div class="control-panel">
          <div class="control-row">
            <div class="control-tile">
              <div class="tile-icon active">‚úàÔ∏è</div>
              <div class="tile-label">È£ûË°åÊ®°Âºè</div>
              <div class="tile-status">ÂÖ≥</div>
            </div>
            <div class="control-tile">
              <div class="tile-icon active">üì∂</div>
              <div class="tile-label">ËúÇÁ™ùÁΩëÁªú</div>
              <div class="tile-status">ÂºÄ</div>
            </div>
          </div>
          <div class="control-row">
            <div class="control-tile">
              <div class="tile-icon active" style="background: #007aff">üì°</div>
              <div class="tile-label">Wi-Fi</div>
              <div class="tile-status">Â∑≤ËøûÊé•</div>
            </div>
            <div class="control-tile">
              <div class="tile-icon active" style="background: #007aff">üîµ</div>
              <div class="tile-label">ËìùÁâô</div>
              <div class="tile-status">ÂºÄ</div>
            </div>
          </div>
          <div class="control-row" style="gap: 12px">
            <div class="brightness-slider">
              <div class="brightness-fill"></div>
              <div class="brightness-icon">‚òÄÔ∏è</div>
            </div>
            <div class="brightness-slider">
              <div class="brightness-fill" style="height: 40%"></div>
              <div class="brightness-icon">üîä</div>
            </div>
          </div>
          <div class="control-handle"></div>
        </div>
      </div>

      <!-- Calendar App Screen -->
      <div class="screen calendar-app-screen" id="calendarAppScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeCalendarApp()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">Êó•ÂéÜ</div>
          <div class="header-actions">
            <span onclick="calendarPrevMonth()">‚óÄ</span><span onclick="calendarNextMonth()">‚ñ∂</span>
          </div>
        </div>
        <div class="cal-app-body" id="calAppBody"></div>
      </div>

      <!-- Anniversary App Screen -->
      <div class="screen anniversary-screen" id="anniversaryScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeAnniversaryApp()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">Á∫™ÂøµÊó•</div>
          <div class="header-actions"><span onclick="openAddAnniversary()">Ôºã</span></div>
        </div>
        <div class="anniv-body" id="annivBody"></div>
      </div>

      <!-- Music App Screen -->
      <div class="screen music-app-screen" id="musicAppScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeMusicApp()">
            <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5" fill="none">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </div>
          <div class="header-title">Now Playing</div>
          <div class="header-actions">
            <span onclick="toggleMusicAddForm()" title="Add Song">
              <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </span>
          </div>
        </div>
        <div class="music-app-body" id="musicAppBody">
          <div class="music-player-section">
            <div class="music-stylus" id="musicStylus"></div>
            <div class="music-vinyl-container">
              <div class="music-vinyl-bg"></div>
              <div class="music-album-art paused" id="musicAlbumArt">
                <svg viewBox="0 0 24 24">
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
                </svg>
              </div>
            </div>

            <div class="music-app-title" id="musicAppSongTitle">No Track</div>
            <div class="music-app-artist" id="musicAppArtist">Select a song to play</div>

            <div class="music-app-progress">
              <div class="music-app-progress-bar" id="musicAppProgressBar" onclick="seekMusic(event)">
                <div class="music-app-progress-fill" id="musicAppProgressFill"></div>
              </div>
              <div class="music-app-times">
                <span id="musicAppCurTime">00:00</span><span id="musicAppDurTime">00:00</span>
              </div>
            </div>

            <div class="music-app-controls">
              <div class="ctrl-btn" onclick="musicPrev()">
                <svg viewBox="0 0 24 24">
                  <polygon points="19 20 9 12 19 4 19 20"></polygon>
                  <line x1="5" y1="19" x2="5" y2="5"></line>
                </svg>
              </div>
              <div class="ctrl-play" id="musicAppPlayBtn" onclick="musicTogglePlay()">
                <svg viewBox="0 0 24 24" id="playIcon"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
              </div>
              <div class="ctrl-btn" onclick="musicNext()">
                <svg viewBox="0 0 24 24">
                  <polygon points="5 4 15 12 5 20 5 4"></polygon>
                  <line x1="19" y1="5" x2="19" y2="19"></line>
                </svg>
              </div>
            </div>
          </div>

          <div class="music-app-playlist-container">
            <div id="musicAppPlaylist"></div>
            <div class="music-add-form" id="musicAddForm" style="display: none">
              <input type="text" id="musicAddUrl" placeholder="Audio URL (mp3/ogg)" />
              <input type="text" id="musicAddName" placeholder="Song Title" />
              <input type="text" id="musicAddArtist" placeholder="Artist" />
              <input type="text" id="musicAddCover" placeholder="Cover Image URL" />
              <div class="music-add-row">
                <button class="music-add-btn" onclick="musicAddSong()">Add to Library</button>
                <button class="music-cancel-btn" onclick="toggleMusicAddForm()">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Shopping Mall Screen -->
      <div class="screen shop-screen" id="shopScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeShop()">‚Äπ<span>ËøîÂõû</span></div>
          <div class="header-title">Á§ºÁâ©ÂïÜÂüé</div>
        </div>
        <div class="shop-balance">
          <div class="bal-label">ÊàëÁöÑ‰ΩôÈ¢ù</div>
          <div class="bal-amount" id="shopBalanceAmount">1000</div>
          <button class="bal-recharge" onclick="shopRecharge()">ÂÖÖÂÄº</button>
        </div>
        <div class="shop-body" id="shopBody"></div>
      </div>

      <!-- Memory Screen -->
      <div class="screen memory-screen" id="memoryScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closeMemoryScreen()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
          </div>
          <div class="header-title">ÈïøÊúüËÆ∞ÂøÜ</div>
          <div class="header-actions">
            <span onclick="toggleMemoryAdd()" title="Ê∑ªÂä†ËÆ∞ÂøÜ" style="font-size: 22px">Ôºã</span>
          </div>
        </div>
        <div class="memory-body" id="memoryBody">
          <div class="memory-stats" id="memoryStats"></div>
          <button class="memory-auto-btn" id="memoryAutoBtn" onclick="autoExtractMemory()">AI Ëá™Âä®ÊèêÂèñËÆ∞ÂøÜ</button>
          <div id="memoryAddCard" style="display: none" class="memory-add-card">
            <div class="add-title">ÊâãÂä®Ê∑ªÂä†ËÆ∞ÂøÜ</div>
            <select id="memoryAddCategory">
              <option value="ÂÅèÂ•Ω">ÂÅèÂ•Ω</option>
              <option value="‰∫ãÂÆû">‰∫ãÂÆû</option>
              <option value="ÂÖ≥Á≥ª">ÂÖ≥Á≥ª</option>
              <option value="ÁªèÂéÜ">ÁªèÂéÜ</option>
              <option value="ÊÄßÊ†º">ÊÄßÊ†º</option>
              <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
            </select>
            <textarea id="memoryAddContent" placeholder="ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπ‚Ä¶"></textarea>
            <button class="memory-add-btn" onclick="addMemoryManual()">Ê∑ªÂä†</button>
          </div>
          <div class="memory-section-title" id="memoryListTitle">ÊâÄÊúâËÆ∞ÂøÜ</div>
          <div id="memoryList"></div>
        </div>
      </div>

      <!-- Add/Edit Anniversary Modal -->
      <div class="modal-overlay" id="annivModal">
        <div class="modal-box">
          <h3 id="annivModalTitle">Ê∑ªÂä†Á∫™ÂøµÊó•</h3>
          <div class="form-item">
            <label>Ê†áÈ¢ò</label><input type="text" id="annivTitle" placeholder="Â¶ÇÔºöÂú®‰∏ÄËµ∑ÁöÑÊó•Â≠ê" />
          </div>
          <div class="form-item"><label>Êó•Êúü</label><input type="date" id="annivDate" /></div>
          <div class="form-item">
            <label>ÂõæÊ†á</label
            ><input
              type="text"
              id="annivIcon"
              placeholder="üíù"
              maxlength="4"
              style="font-size: 24px; text-align: center"
            />
          </div>
          <div class="modal-btns">
            <button class="btn-cancel" onclick="closeAnnivModal()">ÂèñÊ∂à</button
            ><button class="btn-save" onclick="saveAnniversary()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Message context menu container -->
      <div id="msgContextMenu" style="display: none"></div>

      <!-- Edit message modal -->
      <div class="modal-overlay" id="editMsgModal">
        <div class="modal-box edit-msg-modal">
          <h3>ÁºñËæëÊ∂àÊÅØ</h3>
          <textarea class="edit-msg-textarea" id="editMsgTextarea"></textarea>
          <div class="modal-btns">
            <button class="btn-cancel" onclick="closeEditMsgModal()">ÂèñÊ∂à</button
            ><button class="btn-save" onclick="saveEditMsg()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Modal for editing contact -->
      <div class="modal-overlay" id="editModal">
        <div class="modal-box">
          <h3>ÁºñËæëËÅîÁ≥ª‰∫∫</h3>
          <div class="avatar-picker">
            <div class="avatar-preview" id="editAvatarPreview" style="background: #07c160" onclick="pickAvatar('edit')">
              ?
              <div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>
            </div>
          </div>
          <div class="form-item"><label>Â§áÊ≥®Âêç</label><input type="text" id="editContactName" /></div>
          <div class="form-item">
            <label>Á≥ªÁªüÊèêÁ§∫ËØç</label><textarea id="editContactPrompt" style="min-height: 60px"></textarea>
          </div>
          <div class="form-item">
            <label>ËÅäÂ§©ËÉåÊôØ</label>
            <div class="bg-options" id="bgOptions"></div>
          </div>
          <div class="modal-btns">
            <button class="btn-cancel" onclick="closeEditModal()">ÂèñÊ∂à</button
            ><button class="btn-save" onclick="saveEditContact()">‰øùÂ≠ò</button>
          </div>
        </div>
      </div>

      <!-- Notification popup -->
      <div id="notifPopup" style="display: none"></div>

      <!-- Contact context menu -->
      <div id="contactCtxMenu" style="display: none"></div>

      <!-- Transfer modal -->
      <div class="modal-overlay" id="transferModal">
        <div class="modal-box trp-modal">
          <h3>ËΩ¨Ë¥¶</h3>
          <input type="number" class="trp-amount-input" id="transferAmount" placeholder="0.00" min="0" step="0.01" />
          <input type="text" class="trp-note-input" id="transferNote" placeholder="Ê∑ªÂä†ËΩ¨Ë¥¶ËØ¥ÊòéÔºàÈÄâÂ°´Ôºâ" />
          <div class="trp-preview" id="transferPreview">ËΩ¨Ë¥¶Áªô <span id="transferTo">ÂØπÊñπ</span></div>
          <button class="trp-send-btn transfer" onclick="sendTransfer()">ËΩ¨Ë¥¶</button>
          <div class="modal-btns" style="margin-top: 8px">
            <button class="btn-cancel" onclick="closeTransferModal()" style="width: 100%">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>

      <!-- Red Packet modal -->
      <div class="modal-overlay" id="redPacketModal">
        <div class="modal-box trp-modal" style="background: #fa9d3b; color: #fff">
          <h3 style="color: #fff">ÂèëÁ∫¢ÂåÖ</h3>
          <input
            type="number"
            class="trp-amount-input"
            id="rpAmount"
            placeholder="0.00"
            min="0"
            step="0.01"
            style="color: #e8520a"
          />
          <input
            type="text"
            class="trp-note-input"
            id="rpGreeting"
            placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©"
            style="text-align: center"
          />
          <button
            class="trp-send-btn redpacket"
            onclick="sendRedPacket()"
            style="background: #e8520a; margin-top: 14px"
          >
            Â°ûËøõÁ∫¢ÂåÖ
          </button>
          <div class="modal-btns" style="margin-top: 8px">
            <button
              class="btn-cancel"
              onclick="closeRedPacketModal()"
              style="width: 100%; background: rgba(255, 255, 255, 0.2); color: #fff"
            >
              ÂèñÊ∂à
            </button>
          </div>
        </div>
      </div>

      <!-- Photo Wall Screen -->
      <div class="screen photowall-screen" id="photowallScreen">
        <div class="app-header">
          <div class="back-btn" onclick="closePhotowall()">
            <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5" fill="none">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </div>
          <div class="header-title">Gallery</div>
          <div class="header-actions">
            <span onclick="clearAllPhotos()" title="Ê∏ÖÁ©∫">üóëÔ∏è</span>
          </div>
        </div>
        <div class="pw-body" id="pwBody"></div>
        <div class="pw-counter" id="pwCounter"></div>
        <div class="pw-add-floating" onclick="pickPhotoWall()" title="Ê∑ªÂä†ÁÖßÁâá">Ôºã</div>
        <div class="pw-lightbox" id="pwLightbox" onclick="closePwLightbox()">
          <div class="pw-lightbox-close" onclick="closePwLightbox()">‚úï</div>
          <img id="pwLightboxImg" src="" />
        </div>
      </div>
      <input type="file" id="pwFileInput" accept="image/*" multiple style="display: none" />

      <!-- Widget Picker Modal -->
      <div class="modal-overlay" id="widgetPickerModal">
        <div class="modal-box" style="width: 320px; max-height: 520px">
          <h3>Ê∑ªÂä†Â∞èÁªÑ‰ª∂</h3>
          <div class="widget-picker-grid" id="widgetPickerGrid"></div>
          <div class="modal-btns" style="margin-top: 12px">
            <button class="btn-cancel" onclick="closeWidgetPicker()" style="width: 100%">ÂèñÊ∂à</button>
          </div>
        </div>
      </div>

      <input type="file" id="chatImageInput" accept="image/*" style="display: none" />
      <input type="file" id="avatarFileInput" accept="image/*" style="display: none" />
      <input type="file" id="pngCardInput" accept=".png" style="display: none" />
      <input type="file" id="chatBgFileInput" accept="image/*" style="display: none" />
      <input type="file" id="widgetBgInput" accept="image/*" style="display: none" />
      <input type="file" id="wallpaperInput" accept="image/*" style="display: none" />
    </div>

    <script>
      const AVATAR_COLORS = [
        '#07c160',
        '#1989fa',
        '#ff9500',
        '#ff3b30',
        '#af52de',
        '#5856d6',
        '#ff2d55',
        '#00c7be',
        '#34c759',
        '#ff6482',
      ];
      let screenStack = ['lock'];
      let currentContactId = null;
      let isGroupChat = false;
      let isStreaming = false;
      let editingContactId = null;
      let avatarPickTarget = null; // 'new' | 'edit' | 'user'
      let newContactAvatarData = null;
      let editContactAvatarData = null;

      const defaultSettings = {
        endpoint: 'https://morning-rain-6898.ruoxixin2.workers.dev/v1/chat/completions',
        apiKey: '',
        model: 'gpt-4o-mini',
        temperature: 0.7,
        userName: 'Êàë',
        userAvatar: '',
        persona: '',
        worldbook: '',
        jailbreak: '',
      };
      function loadSettings() {
        try {
          const s = localStorage.getItem('ai_phone_settings');
          return s ? { ...defaultSettings, ...JSON.parse(s) } : { ...defaultSettings };
        } catch {
          return { ...defaultSettings };
        }
      }
      function storeSettings(s) {
        safeStore('ai_phone_settings', s);
      }
      let settings = loadSettings();

      function loadContacts() {
        try {
          const c = localStorage.getItem('ai_phone_contacts');
          return c ? JSON.parse(c) : [];
        } catch {
          return [];
        }
      }
      function storeContacts(c) {
        safeStore('ai_phone_contacts', c);
      }
      let contacts = loadContacts();
      // Migrate old contacts to add new fields
      contacts.forEach(c => {
        if (c.pinned === undefined) c.pinned = false;
        if (c.muted === undefined) c.muted = false;
        if (c.chatBg === undefined) c.chatBg = '';
      });
      if (contacts.length === 0) {
        contacts.push({
          id: Date.now(),
          name: 'AIÂä©Êâã',
          color: '#07c160',
          systemPrompt: '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã',
          messages: [],
          lastTime: '',
          avatar: '',
          pinned: false,
          muted: false,
          chatBg: '',
        });
      }
      storeContacts(contacts);

      function loadWeiboPosts() {
        try {
          const w = localStorage.getItem('ai_phone_weibo');
          return w ? JSON.parse(w) : [];
        } catch {
          return [];
        }
      }
      function storeWeiboPosts(w) {
        safeStore('ai_phone_weibo', w);
      }
      let weiboPosts = loadWeiboPosts();
      if (weiboPosts.length === 0) {
        weiboPosts = [
          {
            id: 1,
            user: 'AIÁßëÊäÄÂâçÊ≤ø',
            color: '#e6162d',
            time: '10ÂàÜÈíüÂâç',
            content: 'ü§ñ #AIÊñ∞Á™ÅÁ†¥# GPT-5 Âç≥Â∞ÜÂèëÂ∏ÉÔºåÊçÆ‰º†Â∞ÜÊîØÊåÅÂ§öÊ®°ÊÄÅÂÆûÊó∂‰∫§‰∫íÔºÅ',
            likes: 1523,
            comments: 342,
            reposts: 128,
            liked: false,
          },
          {
            id: 2,
            user: 'ÊØèÊó•‰∏ÄË®Ä',
            color: '#ff9500',
            time: '30ÂàÜÈíüÂâç',
            content: 'üí° "‰∏çË¶ÅÁ≠âÂæÖÊú∫‰ºöÔºåËÄåË¶ÅÂàõÈÄ†Êú∫‰ºö„ÄÇ" ‚Äî‚Äî Ëêß‰ºØÁ∫≥\n\nÊó©ÂÆâ ‚òÄÔ∏è',
            likes: 892,
            comments: 67,
            reposts: 45,
            liked: false,
          },
          {
            id: 3,
            user: 'ÁæéÈ£üÊé¢Â∫óÂÆò',
            color: '#07c160',
            time: '1Â∞èÊó∂Ââç',
            content: 'üçú Êé¢Â∫óÊâìÂç°ÔºÅÊµìÈÉÅË±öÈ™®Ê±§Â∫ïÊãâÈù¢Êé®ËçêÊåáÊï∞ ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê\n\n#ÁæéÈ£üÊé®Ëçê# #Êé¢Â∫óÊâìÂç°#',
            likes: 2341,
            comments: 456,
            reposts: 89,
            liked: false,
          },
          {
            id: 4,
            user: 'Á®ãÂ∫èÁåøÊó•Êä•',
            color: '#5856d6',
            time: '2Â∞èÊó∂Ââç',
            content: 'üë®‚Äçüíª ‰∫ßÂìÅÁªèÁêÜÔºöËøô‰∏™ÈúÄÊ±ÇÂæàÁÆÄÂçï\nÁ®ãÂ∫èÂëòÔºöÈÇ£‰Ω†Êù•ÂÜô\n‰∫ßÂìÅÁªèÁêÜÔºö...\n\n#Á®ãÂ∫èÂëòÊó•Â∏∏#',
            likes: 5678,
            comments: 1023,
            reposts: 567,
            liked: false,
          },
        ];
        storeWeiboPosts(weiboPosts);
      }

      const phone = document.getElementById('phone');
      const lockScreen = document.getElementById('lockScreen');
      const homeScreen = document.getElementById('homeScreen');
      const contactsScreen = document.getElementById('contactsScreen');
      const newContactScreen = document.getElementById('newContactScreen');
      const chatScreen = document.getElementById('chatScreen');
      const settingsScreen = document.getElementById('settingsScreen');
      const weiboScreen = document.getElementById('weiboScreen');
      const controlCenter = document.getElementById('controlCenter');
      const chatContainer = document.getElementById('chatContainer');
      const userInput = document.getElementById('userInput');
      const sendBtn = document.getElementById('sendBtn');
      const toastEl = document.getElementById('toast');
      const contactsBody = document.getElementById('contactsBody');

      const calendarAppScreen = document.getElementById('calendarAppScreen');
      const anniversaryScreen = document.getElementById('anniversaryScreen');

      const musicAppScreen = document.getElementById('musicAppScreen');
      const shopScreen = document.getElementById('shopScreen');

      const newGroupScreen = document.getElementById('newGroupScreen');
      const groupManageScreen = document.getElementById('groupManageScreen');
      const allScreens = {
        lock: lockScreen,
        home: homeScreen,
        contacts: contactsScreen,
        newContact: newContactScreen,
        newGroup: newGroupScreen,
        groupManage: groupManageScreen,
        chat: chatScreen,
        settings: settingsScreen,
        weibo: weiboScreen,
        calendarApp: calendarAppScreen,
        anniversary: anniversaryScreen,
        musicApp: musicAppScreen,
        shop: shopScreen,
      };

      function updateTime() {
        const now = new Date();
        const t = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        document.getElementById('statusTime').textContent = t;
        document.getElementById('lockTime').textContent = t;
        const days = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
        document.getElementById('lockDate').textContent =
          `${now.getMonth() + 1}Êúà${now.getDate()}Êó• ${days[now.getDay()]}`;
      }
      updateTime();
      setInterval(updateTime, 10000);

      function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 2000);
      }
      function getNowTimeStr() {
        const now = new Date();
        return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      }
      function getActiveScreen() {
        return screenStack[screenStack.length - 1];
      }
      function setStatusBarDark(dark) {
        document.getElementById('statusBar').classList.toggle('dark', dark);
      }
      function esc(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      // Lock
      let lockStartY = 0;
      lockScreen.addEventListener(
        'touchstart',
        e => {
          lockStartY = e.touches[0].clientY;
        },
        { passive: true },
      );
      lockScreen.addEventListener(
        'touchend',
        e => {
          if (lockStartY - e.changedTouches[0].clientY > 60) unlockPhone();
        },
        { passive: true },
      );
      lockScreen.addEventListener('mousedown', e => {
        lockStartY = e.clientY;
      });
      lockScreen.addEventListener('mouseup', e => {
        if (lockStartY - e.clientY > 50) unlockPhone();
      });

      function unlockPhone() {
        lockScreen.style.transform = 'translateY(-100%)';
        lockScreen.style.opacity = '0';
        homeScreen.classList.remove('hidden');
        screenStack = ['home'];
        setTimeout(() => {
          lockScreen.classList.add('hidden');
          lockScreen.style.transform = '';
          lockScreen.style.opacity = '';
        }, 400);
      }
      function lockPhone() {
        screenStack = ['lock'];
        Object.values(allScreens).forEach(s => {
          s.classList.remove('active');
          s.style.transform = '';
        });
        lockScreen.classList.remove('hidden');
        lockScreen.style.transform = '';
        lockScreen.style.opacity = '';
        homeScreen.classList.add('hidden');
        setStatusBarDark(false);
      }

      // Nav
      function pushScreen(name) {
        allScreens[name].classList.add('active');
        allScreens[name].style.transform = '';
        screenStack.push(name);
        setStatusBarDark(name !== 'home');
      }
      function popScreen() {
        if (screenStack.length <= 1) return;
        const name = screenStack.pop();
        allScreens[name].style.transform = '';
        allScreens[name].classList.remove('active');
        setStatusBarDark(getActiveScreen() !== 'home');
      }

      function openContacts() {
        renderContacts();
        pushScreen('contacts');
      }
      function closeContacts() {
        popScreen();
      }
      function openNewGroup() {
        const container = document.getElementById('groupMemberSelect');
        const availableContacts = contacts.filter(c => !c.isGroup && c.systemPrompt);
        if (availableContacts.length === 0) {
          showToast('Ê≤°ÊúâÂèØÁî®ÁöÑËÅîÁ≥ª‰∫∫');
          return;
        }
        container.innerHTML = availableContacts
          .map(
            c => `
          <div class="form-item" style="flex-direction: row; align-items: center; gap: 10px; cursor: pointer;" onclick="toggleMemberSelect(this, ${c.id})">
            <input type="checkbox" class="member-checkbox" value="${c.id}" style="width: 20px; height: 20px;" onclick="event.stopPropagation()">
            <div class="contact-avatar" style="width: 32px; height: 32px; font-size: 12px; ${c.avatar ? '' : 'background:' + c.color}">${c.avatar ? '<img src="' + c.avatar + '">' : c.name.charAt(0)}</div>
            <div style="font-size: 15px;">${esc(c.name)}</div>
          </div>
        `,
          )
          .join('');
        document.getElementById('newGroupName').value = '';
        pushScreen('newGroup');
      }
      function closeNewGroup() {
        popScreen();
      }
      function toggleMemberSelect(el, id) {
        const cb = el.querySelector('.member-checkbox');
        cb.checked = !cb.checked;
      }
      function createGroup() {
        const name = document.getElementById('newGroupName').value.trim();
        if (!name) {
          showToast('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞');
          return;
        }
        const selectedIds = Array.from(document.querySelectorAll('#groupMemberSelect .member-checkbox:checked')).map(
          cb => parseInt(cb.value),
        );
        if (selectedIds.length < 1) {
          showToast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™ÊàêÂëò');
          return;
        }
        const newGroup = {
          id: Date.now(),
          name,
          color: '#5856d6',
          isGroup: true,
          members: selectedIds,
          messages: [],
          lastTime: '',
          avatar: '',
          pinned: false,
          muted: false,
          chatBg: '',
        };
        contacts.unshift(newGroup);
        storeContacts(contacts);
        closeNewGroup();
        renderContacts();
        showToast('Áæ§ËÅäÂ∑≤ÂàõÂª∫');
      }

      function openNewContact() {
        editingContactId = null;
        newContactAvatarData = null;
        document.getElementById('newContactTitle').textContent = 'Êñ∞Âª∫ËÅîÁ≥ª‰∫∫';
        document.getElementById('createOrSaveBtn').textContent = 'ÂàõÂª∫ËÅîÁ≥ª‰∫∫';
        document.getElementById('createOrSaveBtn').onclick = createContact;
        selectedColor = AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)];
        document.getElementById('newContactName').value = '';
        document.getElementById('newContactPrompt').value = '';
        renderColorOptions();
        updateAvatarPreview();
        pushScreen('newContact');
      }
      function closeNewContact() {
        popScreen();
      }
      function openChatWith(contactId) {
        currentContactId = contactId;
        const c = contacts.find(x => x.id === contactId);
        if (!c) return;
        isGroupChat = !!c.isGroup;
        document.getElementById('chatTitle').textContent = c.name + (isGroupChat ? ` (${c.members.length})` : '');
        applyChatBg(c);
        renderChatMessages(c);
        pushScreen('chat');
        updateGenerateButton();
      }
      function applyChatBg(contact) {
        const bg = contact.chatBg || '';
        const container = chatContainer;
        if (!bg) {
          container.style.background = '#ededed';
          container.style.backgroundImage = '';
        } else if (bg.startsWith('data:') || bg.startsWith('http')) {
          container.style.background = `url(${bg}) center/cover no-repeat`;
        } else {
          container.style.background = bg;
          container.style.backgroundImage = '';
        }
      }
      function closeChat() {
        currentContactId = null;
        popScreen();
        renderContacts();
      }
      function openSettings() {
        document.getElementById('settingEndpoint').value = settings.endpoint;
        document.getElementById('settingApiKey').value = settings.apiKey;
        document.getElementById('settingModel').value = settings.model;
        document.getElementById('settingTemperature').value = settings.temperature;
        document.getElementById('settingUserName').value = settings.userName || 'Êàë';
        document.getElementById('settingPersona').value = settings.persona || '';
        document.getElementById('settingWorldbook').value = settings.worldbook || '';
        document.getElementById('settingJailbreak').value = settings.jailbreak || '';
        const uap = document.getElementById('userAvatarPreview');
        if (settings.userAvatar) {
          uap.innerHTML = `<img src="${settings.userAvatar}">`;
        } else {
          uap.textContent = (settings.userName || 'Êàë').charAt(0);
        }
        pushScreen('settings');
      }
      function closeSettings() {
        popScreen();
      }
      function openWeibo() {
        renderWeiboPosts();
        pushScreen('weibo');
      }
      function closeWeibo() {
        document.getElementById('weiboCompose').classList.remove('open');
        weiboComposeOpen = false;
        popScreen();
      }

      // Fetch models from API
      async function fetchModels() {
        const endpoint = document.getElementById('settingEndpoint').value.trim() || defaultSettings.endpoint;
        const apiKey = document.getElementById('settingApiKey').value.trim();
        const btn = document.getElementById('fetchModelsBtn');
        btn.disabled = true;
        btn.textContent = 'ÊãâÂèñ‰∏≠‚Ä¶';
        try {
          // Build candidate URLs for models endpoint
          const candidateUrls = [];

          // 1. Try replacing /chat/completions with /models
          if (endpoint.includes('/chat/completions')) {
            candidateUrls.push(endpoint.replace('/chat/completions', '/models'));
          }
          // 2. Try replacing /completions with /models
          if (endpoint.includes('/completions')) {
            candidateUrls.push(endpoint.replace('/completions', '/models'));
          }
          // 3. Try extracting base URL and appending /v1/models
          try {
            const url = new URL(endpoint);
            const pathParts = url.pathname.split('/').filter(Boolean);
            // Try /v1/models
            candidateUrls.push(`${url.origin}/v1/models`);
            // Try just /models
            candidateUrls.push(`${url.origin}/models`);
            // If path has a prefix like /api, try /api/v1/models
            if (pathParts.length > 0 && pathParts[0] !== 'v1') {
              candidateUrls.push(`${url.origin}/${pathParts[0]}/v1/models`);
              candidateUrls.push(`${url.origin}/${pathParts[0]}/models`);
            }
          } catch {}

          // Deduplicate
          const uniqueUrls = [...new Set(candidateUrls)];
          console.log('Trying model endpoints:', uniqueUrls);

          let models = [];
          let lastError = '';

          for (const modelsUrl of uniqueUrls) {
            try {
              const fetchHeaders = {};
              if (apiKey) fetchHeaders['Authorization'] = `Bearer ${apiKey}`;
              const response = await fetch(modelsUrl, {
                method: 'GET',
                headers: fetchHeaders,
              });

              if (!response.ok) {
                const text = await response.text();
                try {
                  const errData = JSON.parse(text);
                  lastError = errData.error?.message || `HTTP ${response.status}`;
                } catch {
                  lastError = `HTTP ${response.status}`;
                }
                continue;
              }

              const text = await response.text();
              // Check if response is actually JSON
              if (text.trim().startsWith('<')) {
                lastError = `${modelsUrl} ËøîÂõû‰∫Ü HTML È°µÈù¢ËÄåÈùû JSON`;
                continue;
              }

              const data = JSON.parse(text);
              if (Array.isArray(data.data)) {
                models = data.data
                  .map(m => (typeof m === 'string' ? m : m.id))
                  .filter(Boolean)
                  .sort();
              } else if (Array.isArray(data)) {
                models = data
                  .map(m => (typeof m === 'string' ? m : m.id))
                  .filter(Boolean)
                  .sort();
              } else if (data.object === 'list' && Array.isArray(data.data)) {
                models = data.data
                  .map(m => m.id)
                  .filter(Boolean)
                  .sort();
              }

              if (models.length > 0) {
                console.log(`Found ${models.length} models from ${modelsUrl}`);
                break;
              }
            } catch (e) {
              lastError = e.message;
              continue;
            }
          }

          if (models.length === 0) {
            const detail = uniqueUrls.map(u => `‚Ä¢ ${u}`).join('\n');
            throw new Error((lastError || 'Êú™ÊâæÂà∞ÂèØÁî®Ê®°Âûã') + '\n\nÂ∑≤Â∞ùËØï‰ª•‰∏ãÁ´ØÁÇπ:\n' + detail);
          }

          // Populate select
          const select = document.getElementById('modelSelect');
          const currentModel = document.getElementById('settingModel').value.trim();
          select.innerHTML =
            '<option value="">-- ÈÄâÊã©Ê®°Âûã (' +
            models.length +
            '‰∏™) --</option>' +
            models.map(m => `<option value="${m}" ${m === currentModel ? 'selected' : ''}>${m}</option>`).join('');
          select.style.display = 'block';
          showToast(`Â∑≤ÊãâÂèñ ${models.length} ‰∏™Ê®°Âûã`);
        } catch (err) {
          alert('ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•\n\n' + (err.message || String(err)));
          showToast('ÊãâÂèñÂ§±Ë¥•');
          console.error('Fetch models error:', err);
        } finally {
          btn.disabled = false;
          btn.textContent = 'üì° ÊãâÂèñÊ®°Âûã';
        }
      }

      function selectFetchedModel(value) {
        if (value) {
          document.getElementById('settingModel').value = value;
        }
      }

      function saveSettings() {
        settings.endpoint = document.getElementById('settingEndpoint').value.trim() || defaultSettings.endpoint;
        settings.apiKey = document.getElementById('settingApiKey').value.trim();
        settings.model = document.getElementById('settingModel').value.trim() || defaultSettings.model;
        settings.temperature =
          parseFloat(document.getElementById('settingTemperature').value) || defaultSettings.temperature;
        settings.userName = document.getElementById('settingUserName').value.trim() || 'Êàë';
        settings.persona = document.getElementById('settingPersona').value;
        settings.worldbook = document.getElementById('settingWorldbook').value;
        settings.jailbreak = document.getElementById('settingJailbreak').value;
        storeSettings(settings);
        showToast('‚úÖ ËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
      }

      // Avatar picker
      document.getElementById('avatarFileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function (ev) {
          const dataUrl = await compressImage(ev.target.result, 128);
          if (avatarPickTarget === 'new') {
            newContactAvatarData = dataUrl;
            const p = document.getElementById('newAvatarPreview');
            p.innerHTML = `<img src="${dataUrl}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          } else if (avatarPickTarget === 'edit') {
            editContactAvatarData = dataUrl;
            const p = document.getElementById('editAvatarPreview');
            p.innerHTML = `<img src="${dataUrl}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          } else if (avatarPickTarget === 'user') {
            settings.userAvatar = dataUrl;
            storeSettings(settings);
            const uap = document.getElementById('userAvatarPreview');
            uap.innerHTML = `<img src="${dataUrl}">`;
          }
        };
        reader.readAsDataURL(file);
        this.value = '';
      });
      function pickAvatar(target) {
        avatarPickTarget = target;
        document.getElementById('avatarFileInput').click();
      }

      // Control Center
      let ccStartY = 0,
        ccOpen = false;
      phone.addEventListener('mousedown', e => {
        const rect = phone.getBoundingClientRect();
        if (e.clientY - rect.top < 44 && !ccOpen && getActiveScreen() !== 'lock') ccStartY = e.clientY;
      });
      phone.addEventListener('mousemove', e => {
        if (ccStartY > 0 && e.clientY - ccStartY > 40) {
          openControlCenter();
          ccStartY = 0;
        }
      });
      phone.addEventListener('mouseup', () => {
        ccStartY = 0;
      });
      phone.addEventListener(
        'touchstart',
        e => {
          const rect = phone.getBoundingClientRect();
          if (e.touches[0].clientY - rect.top < 44 && !ccOpen && getActiveScreen() !== 'lock')
            ccStartY = e.touches[0].clientY;
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchmove',
        e => {
          if (ccStartY > 0 && e.touches[0].clientY - ccStartY > 40) {
            openControlCenter();
            ccStartY = 0;
          }
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchend',
        () => {
          ccStartY = 0;
        },
        { passive: true },
      );
      function openControlCenter() {
        controlCenter.classList.add('open');
        ccOpen = true;
      }
      function closeControlCenter() {
        controlCenter.classList.remove('open');
        ccOpen = false;
      }

      // Swipe back
      let swipeStartX = 0,
        swipeStartY = 0,
        swiping = false,
        swipeTarget = null;
      function getSwipeScreen() {
        const s = getActiveScreen();
        return [
          'contacts',
          'newContact',
          'chat',
          'settings',
          'weibo',
          'calendarApp',
          'anniversary',
          'musicApp',
          'shop',
          'newGroup',
          'groupManage',
          'memory',
        ].includes(s)
          ? allScreens[s]
          : null;
      }
      phone.addEventListener('mousedown', e => {
        const rect = phone.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const screen = getSwipeScreen();
        if (x < 30 && screen) {
          swipeStartX = e.clientX;
          swipeStartY = e.clientY;
          swiping = true;
          swipeTarget = screen;
          e.preventDefault();
        }
      });
      phone.addEventListener('mousemove', e => {
        if (!swiping || !swipeTarget) return;
        const dx = e.clientX - swipeStartX;
        if (dx > 0 && dx > Math.abs(e.clientY - swipeStartY)) {
          swipeTarget.style.transform = `translateX(${Math.min(dx, 375)}px)`;
          swipeTarget.style.transition = 'none';
        }
      });
      phone.addEventListener('mouseup', e => {
        if (!swiping || !swipeTarget) return;
        swiping = false;
        const dx = e.clientX - swipeStartX;
        swipeTarget.style.transition = '';
        if (dx > 120) {
          const s = getActiveScreen();
          if (s === 'chat') closeChat();
          else if (s === 'newContact') closeNewContact();
          else if (s === 'contacts') closeContacts();
          else if (s === 'settings') closeSettings();
          else if (s === 'weibo') closeWeibo();
          else if (s === 'calendarApp') closeCalendarApp();
          else if (s === 'anniversary') closeAnniversaryApp();
          else if (s === 'musicApp') closeMusicApp();
          else if (s === 'shop') closeShop();
          else if (s === 'newGroup') closeNewGroup();
          else if (s === 'groupManage') closeGroupManage();
        } else {
          swipeTarget.style.transform = 'translateX(0)';
        }
        swipeTarget = null;
      });
      phone.addEventListener(
        'touchstart',
        e => {
          const rect = phone.getBoundingClientRect();
          const x = e.touches[0].clientX - rect.left;
          const screen = getSwipeScreen();
          if (x < 30 && screen) {
            swipeStartX = e.touches[0].clientX;
            swipeStartY = e.touches[0].clientY;
            swiping = true;
            swipeTarget = screen;
          }
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchmove',
        e => {
          if (!swiping || !swipeTarget) return;
          const dx = e.touches[0].clientX - swipeStartX;
          if (dx > 0 && dx > Math.abs(e.touches[0].clientY - swipeStartY)) {
            swipeTarget.style.transform = `translateX(${Math.min(dx, 375)}px)`;
            swipeTarget.style.transition = 'none';
          }
        },
        { passive: true },
      );
      phone.addEventListener(
        'touchend',
        e => {
          if (!swiping || !swipeTarget) return;
          swiping = false;
          const dx = e.changedTouches[0].clientX - swipeStartX;
          swipeTarget.style.transition = '';
          if (dx > 120) {
            const s = getActiveScreen();
            if (s === 'chat') closeChat();
            else if (s === 'newContact') closeNewContact();
            else if (s === 'contacts') closeContacts();
            else if (s === 'settings') closeSettings();
            else if (s === 'weibo') closeWeibo();
            else if (s === 'calendarApp') closeCalendarApp();
            else if (s === 'anniversary') closeAnniversaryApp();
            else if (s === 'musicApp') closeMusicApp();
            else if (s === 'shop') closeShop();
            else if (s === 'groupManage') closeGroupManage();
          } else {
            swipeTarget.style.transform = 'translateX(0)';
          }
          swipeTarget = null;
        },
        { passive: true },
      );

      // Contacts
      function renderContactAvatar(c, size) {
        if (c.avatar) return `<img src="${esc(c.avatar)}" style="width:${size}px;height:${size}px;object-fit:cover;">`;
        return c.name.charAt(0).toUpperCase();
      }

      function getSortedContacts() {
        // Pinned contacts first, then by last message time
        return [...contacts].sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });
      }

      function renderContacts() {
        if (contacts.length === 0) {
          contactsBody.innerHTML =
            '<div class="empty-contacts"><div class="empty-icon">üí¨</div><div>ËøòÊ≤°ÊúâËÅîÁ≥ª‰∫∫</div><div>ÁÇπÂáªÂè≥‰∏äËßí Ôºã Êàñ üì• ÂàõÂª∫</div></div>';
          return;
        }
        const sorted = getSortedContacts();
        contactsBody.innerHTML = sorted
          .map(c => {
            const lastMsg = c.messages.length > 0 ? c.messages[c.messages.length - 1] : null;
            const preview = lastMsg
              ? (lastMsg.role === 'user' ? 'Êàë: ' : '') + lastMsg.content.slice(0, 30)
              : 'ÊöÇÊó†Ê∂àÊÅØ';
            const avatarStyle = c.avatar ? '' : `style="background:${c.color}"`;
            const avatarContent = c.avatar
              ? `<img src="${esc(c.avatar)}">`
              : c.isGroup
                ? 'üë•'
                : c.name.charAt(0).toUpperCase();
            const pinIcon = c.pinned ? '<span class="pin-icon">üìå</span>' : '';
            const muteIcon = c.muted ? '<span class="mute-icon">üîï</span>' : '';
            const groupLabel = c.isGroup ? `<span style="font-size:11px;color:#999;margin-left:3px;">[Áæ§]</span>` : '';
            const pinnedClass = c.pinned ? ' pinned' : '';
            return `<div class="contact-item${pinnedClass}" onclick="openChatWith(${c.id})" oncontextmenu="event.preventDefault();showContactCtxMenu(event,${c.id})"><div class="contact-avatar" ${avatarStyle}>${avatarContent}</div><div class="contact-info"><div class="contact-name">${esc(c.name)}${groupLabel}${pinIcon}${muteIcon}</div><div class="contact-preview">${esc(preview)}</div></div><div class="contact-time">${c.lastTime || ''}</div></div>`;
          })
          .join('');
      }

      // Contact context menu (long press / right click on contact)
      function showContactCtxMenu(e, contactId) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === contactId);
        if (!c) return;
        const phoneRect = phone.getBoundingClientRect();
        let x = e.clientX - phoneRect.left;
        let y = e.clientY - phoneRect.top;
        if (x > 220) x = 220;
        if (y > 650) y = 650;
        const menu = document.getElementById('contactCtxMenu');
        const pinText = c.pinned ? 'ÂèñÊ∂àÁΩÆÈ°∂' : 'üìå ÁΩÆÈ°∂';
        const muteText = c.muted ? 'üîî ÂèñÊ∂àÂÖçÊâìÊâ∞' : 'üîï Ê∂àÊÅØÂÖçÊâìÊâ∞';
        menu.innerHTML = `<div class="msg-context-overlay" onclick="closeContactCtxMenu()"></div><div class="contact-ctx-menu" style="left:${x}px;top:${y}px;">
    <div class="ctx-item" onclick="togglePin(${contactId})">${pinText}</div>
    <div class="ctx-item" onclick="toggleMute(${contactId})">${muteText}</div>
    <div class="ctx-item" onclick="editContactFromList(${contactId})">‚úèÔ∏è ‰øÆÊîπÂ§áÊ≥®</div>
    <div class="ctx-item danger" onclick="closeContactCtxMenu();deleteContact(${contactId})">üóëÔ∏è Âà†Èô§</div>
  </div>`;
        menu.style.display = 'block';
      }
      function closeContactCtxMenu() {
        const m = document.getElementById('contactCtxMenu');
        m.style.display = 'none';
        m.innerHTML = '';
      }
      function togglePin(id) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === id);
        if (c) {
          c.pinned = !c.pinned;
          storeContacts(contacts);
          renderContacts();
          showToast(c.pinned ? 'Â∑≤ÁΩÆÈ°∂' : 'Â∑≤ÂèñÊ∂àÁΩÆÈ°∂');
        }
      }
      function toggleMute(id) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === id);
        if (c) {
          c.muted = !c.muted;
          storeContacts(contacts);
          renderContacts();
          showToast(c.muted ? 'Â∑≤ÂºÄÂêØÂÖçÊâìÊâ∞' : 'Â∑≤ÂÖ≥Èó≠ÂÖçÊâìÊâ∞');
        }
      }
      function editContactFromList(id) {
        closeContactCtxMenu();
        const c = contacts.find(x => x.id === id);
        if (!c) return;
        editingContactId = id;
        editContactAvatarData = c.avatar || null;
        document.getElementById('editContactName').value = c.name;
        document.getElementById('editContactPrompt').value = c.systemPrompt || '';
        const p = document.getElementById('editAvatarPreview');
        if (c.avatar) {
          p.innerHTML = `<img src="${c.avatar}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          p.style.background = 'transparent';
        } else {
          p.style.background = c.color;
          p.innerHTML = c.name.charAt(0).toUpperCase() + '<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
        }
        renderBgOptions(c.chatBg || '');
        document.getElementById('editModal').classList.add('show');
      }

      function deleteContact(id) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§Ôºü')) return;
        contacts = contacts.filter(c => c.id !== id);
        storeContacts(contacts);
        renderContacts();
        showToast('Â∑≤Âà†Èô§');
      }

      let selectedColor = AVATAR_COLORS[0];
      function renderColorOptions() {
        document.getElementById('colorOptions').innerHTML = AVATAR_COLORS.map(
          c =>
            `<div class="color-dot ${c === selectedColor ? 'selected' : ''}" style="background:${c}" onclick="selectColor('${c}')"></div>`,
        ).join('');
      }
      function selectColor(c) {
        selectedColor = c;
        renderColorOptions();
        updateAvatarPreview();
      }
      function updateAvatarPreview() {
        const name = document.getElementById('newContactName').value.trim();
        const p = document.getElementById('newAvatarPreview');
        if (newContactAvatarData) {
          p.innerHTML = `<img src="${newContactAvatarData}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          return;
        }
        p.style.background = selectedColor;
        p.innerHTML = (name ? name.charAt(0).toUpperCase() : '?') + '<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
      }
      document.addEventListener('input', e => {
        if (e.target.id === 'newContactName') updateAvatarPreview();
      });

      function createContact() {
        const name = document.getElementById('newContactName').value.trim();
        if (!name) {
          showToast('‚ö†Ô∏è ËØ∑ËæìÂÖ•ËÅîÁ≥ª‰∫∫ÂêçÁß∞');
          return;
        }
        const prompt = document.getElementById('newContactPrompt').value.trim() || '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã';
        contacts.unshift({
          id: Date.now(),
          name,
          color: selectedColor,
          systemPrompt: prompt,
          messages: [],
          lastTime: '',
          avatar: newContactAvatarData || '',
          pinned: false,
          muted: false,
          chatBg: '',
        });
        storeContacts(contacts);
        closeNewContact();
        renderContacts();
        showToast('‚úÖ ËÅîÁ≥ª‰∫∫Â∑≤ÂàõÂª∫');
      }

      // Edit contact
      let editContactBg = '';
      const BG_PRESETS = [
        { label: 'ÈªòËÆ§', value: '', color: '#ededed' },
        { label: 'Â§ú', value: '#1c1c1e', color: '#1c1c1e' },
        { label: 'Ëìù', value: '#d4e8f7', color: '#d4e8f7' },
        { label: 'Áªø', value: '#d4f0e0', color: '#d4f0e0' },
        { label: 'Á≤â', value: '#f7d4e8', color: '#f7d4e8' },
        { label: 'Á¥´', value: '#e8d4f7', color: '#e8d4f7' },
      ];

      function renderBgOptions(currentBg) {
        editContactBg = currentBg || '';
        const container = document.getElementById('bgOptions');
        container.innerHTML =
          BG_PRESETS.map(
            bg =>
              `<div class="bg-option ${editContactBg === bg.value ? 'selected' : ''}" style="background:${bg.color};" onclick="selectBg('${bg.value}')" title="${bg.label}"></div>`,
          ).join('') +
          `<div class="bg-option custom-bg ${editContactBg && !BG_PRESETS.some(b => b.value === editContactBg) ? 'selected' : ''}" onclick="pickChatBg()" title="Ëá™ÂÆö‰πâÂõæÁâá">üñº</div>`;
      }
      function selectBg(v) {
        editContactBg = v;
        renderBgOptions(v);
      }
      function pickChatBg() {
        document.getElementById('chatBgFileInput').click();
      }
      document.getElementById('chatBgFileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          editContactBg = ev.target.result;
          renderBgOptions(editContactBg);
        };
        reader.readAsDataURL(file);
        this.value = '';
      });

      function editCurrentContact() {
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        if (!c) return;
        editingContactId = currentContactId;
        editContactAvatarData = c.avatar || null;
        document.getElementById('editContactName').value = c.name;
        document.getElementById('editContactPrompt').value = c.systemPrompt || '';
        const p = document.getElementById('editAvatarPreview');
        if (c.avatar) {
          p.innerHTML = `<img src="${c.avatar}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          p.style.background = 'transparent';
        } else {
          p.style.background = c.color;
          p.innerHTML = c.name.charAt(0).toUpperCase() + '<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
        }
        renderBgOptions(c.chatBg || '');
        document.getElementById('editModal').classList.add('show');
      }
      function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
        editingContactId = null;
      }
      function saveEditContact() {
        if (!editingContactId) return;
        const c = contacts.find(x => x.id === editingContactId);
        if (!c) return;
        const newName = document.getElementById('editContactName').value.trim();
        if (newName) c.name = newName;
        c.systemPrompt = document.getElementById('editContactPrompt').value.trim();
        if (editContactAvatarData) c.avatar = editContactAvatarData;
        c.chatBg = editContactBg || '';
        storeContacts(contacts);
        if (currentContactId === editingContactId) {
          document.getElementById('chatTitle').textContent = c.name;
          applyChatBg(c);
        }
        closeEditModal();
        renderContacts();
        showToast('‚úÖ Â∑≤‰øùÂ≠ò');
      }

      // Import PNG character card
      function openImportCard() {
        document.getElementById('pngCardInput').click();
      }
      document.getElementById('pngCardInput').addEventListener('change', async function (e) {
        const file = e.target.files[0];
        if (!file) return;
        this.value = '';
        try {
          const { name, description, personality, scenario, first_mes, system_prompt, avatar } =
            await parsePngCard(file);
          const sysPrompt = [system_prompt, description, personality, scenario].filter(Boolean).join('\n\n');
          const contactName = name || file.name.replace(/\.png$/i, '');
          const newContact = {
            id: Date.now(),
            name: contactName,
            color: AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)],
            systemPrompt: sysPrompt || '‰Ω†ÊòØ‰∏Ä‰∏™ÊúâÁî®ÁöÑAIÂä©Êâã',
            messages: [],
            lastTime: '',
            avatar: avatar || '',
            pinned: false,
            muted: false,
            chatBg: '',
          };
          if (first_mes) {
            newContact.messages.push({ role: 'assistant', content: first_mes });
            newContact.lastTime = getNowTimeStr();
          }
          contacts.unshift(newContact);
          storeContacts(contacts);
          renderContacts();
          showToast(`‚úÖ Â∑≤ÂØºÂÖ•ËßíËâ≤Ôºö${contactName}`);
        } catch (err) {
          showToast(`‚ö†Ô∏è ÂØºÂÖ•Â§±Ë¥•Ôºö${err.message}`);
        }
      });

      // Compress image to small JPEG data URL
      function compressImage(dataUrl, maxSize = 128) {
        return new Promise(resolve => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width,
              h = img.height;
            if (w > h) {
              if (w > maxSize) {
                h = (h * maxSize) / w;
                w = maxSize;
              }
            } else {
              if (h > maxSize) {
                w = (w * maxSize) / h;
                h = maxSize;
              }
            }
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = () => resolve(dataUrl);
          img.src = dataUrl;
        });
      }

      // Safe localStorage write with quota handling
      function safeStore(key, value) {
        try {
          localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
        } catch (e) {
          showToast('‚ö†Ô∏è Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåËØ∑Âà†Èô§‰∏Ä‰∫õËÅîÁ≥ª‰∫∫ÊàñÊ∏ÖÁêÜÊï∞ÊçÆ');
          console.error('Storage error:', e);
        }
      }

      // Properly decode base64 to UTF-8 string (fixes garbled text for non-ASCII)
      function b64DecodeUnicode(b64str) {
        const binaryStr = atob(b64str);
        const bytes = new Uint8Array(binaryStr.length);
        for (let i = 0; i < binaryStr.length; i++) {
          bytes[i] = binaryStr.charCodeAt(i);
        }
        return new TextDecoder('utf-8').decode(bytes);
      }

      async function parsePngCard(file) {
        const buf = await file.arrayBuffer();
        const bytes = new Uint8Array(buf);
        // Read PNG chunks to find tEXt or iTXt with chara
        let offset = 8; // skip PNG signature
        let charaData = null;
        const td = new TextDecoder('utf-8'); // utf-8 is ASCII-compatible
        while (offset + 8 <= bytes.length) {
          const len = (bytes[offset] << 24) | (bytes[offset + 1] << 16) | (bytes[offset + 2] << 8) | bytes[offset + 3];
          const type = String.fromCharCode(bytes[offset + 4], bytes[offset + 5], bytes[offset + 6], bytes[offset + 7]);
          const chunkData = offset + 8 + len <= bytes.length ? bytes.slice(offset + 8, offset + 8 + len) : null;
          if (chunkData) {
            if (type === 'tEXt') {
              const nullIdx = chunkData.indexOf(0);
              if (nullIdx !== -1) {
                const keyword = td.decode(chunkData.slice(0, nullIdx));
                if (keyword === 'chara') {
                  const b64 = td.decode(chunkData.slice(nullIdx + 1));
                  try {
                    const jsonStr = b64DecodeUnicode(b64.trim());
                    charaData = JSON.parse(jsonStr);
                  } catch (e) {
                    console.warn('tEXt chara parse failed:', e);
                  }
                }
              }
            } else if (type === 'iTXt') {
              const nullIdx = chunkData.indexOf(0);
              if (nullIdx !== -1) {
                const keyword = td.decode(chunkData.slice(0, nullIdx));
                if (keyword === 'chara') {
                  let pos = nullIdx + 1 + 2;
                  while (pos < chunkData.length && chunkData[pos] !== 0) pos++;
                  pos++;
                  while (pos < chunkData.length && chunkData[pos] !== 0) pos++;
                  pos++;
                  const textBytes = chunkData.slice(pos);
                  const b64 = td.decode(textBytes);
                  try {
                    const jsonStr = b64DecodeUnicode(b64.trim());
                    charaData = JSON.parse(jsonStr);
                  } catch (e) {
                    try {
                      charaData = JSON.parse(td.decode(textBytes));
                    } catch (e2) {
                      console.warn('iTXt chara parse failed:', e, e2);
                    }
                  }
                }
              }
            }
          }
          offset += 12 + len;
          if (type === 'IEND') break;
        }
        if (!charaData) throw new Error('Êú™ÊâæÂà∞ËßíËâ≤Âç°Êï∞ÊçÆÔºàËØ∑Á°ÆËÆ§PNGÊñá‰ª∂ÂåÖÂê´ËßíËâ≤Âç°‰ø°ÊÅØÔºâ');
        const d = charaData.data || charaData;
        // Convert file to compressed data URL for avatar persistence
        const rawDataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
        const avatarDataUrl = await compressImage(rawDataUrl, 128);
        return {
          name: d.name || '',
          description: d.description || '',
          personality: d.personality || '',
          scenario: d.scenario || '',
          first_mes: d.first_mes || '',
          system_prompt: d.system_prompt || '',
          avatar: avatarDataUrl,
        };
      }

      // Chat
      let editingMsgIndex = -1;

      function renderChatMessages(contact) {
        chatContainer.innerHTML = `<div class="system-msg">‰∏é ${esc(contact.name)} ÁöÑÂØπËØù</div>`;
        contact.messages.forEach((m, idx) =>
          chatContainer.appendChild(createMessageRow(m.role === 'user' ? 'user' : 'ai', m.content, contact, idx)),
        );
        scrollToBottom();
      }

      function createMessageRow(role, content, contact, msgIndex) {
        const row = document.createElement('div');
        row.className = `message-row ${role}`;
        if (typeof msgIndex === 'number') row.dataset.msgIndex = msgIndex;

        // For group chats, we need to know who sent the message
        let sender = contact;
        let actualRole = role;
        let displayContent = content;

        if (isGroupChat && role === 'ai' && typeof msgIndex === 'number') {
          const msg = contact.messages[msgIndex];
          if (msg && msg.senderId) {
            const member = contacts.find(c => c.id === msg.senderId);
            if (member) sender = member;
          }
        }

        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar';
        if (role === 'ai') {
          if (sender && sender.avatar) {
            avatar.innerHTML = `<img src="${sender.avatar}">`;
          } else {
            avatar.style.background = sender ? sender.color : '#07c160';
            avatar.textContent = sender ? sender.name.charAt(0).toUpperCase() : 'AI';
          }
        } else {
          if (settings.userAvatar) {
            avatar.innerHTML = `<img src="${settings.userAvatar}">`;
          } else {
            avatar.style.background = '#1989fa';
            avatar.textContent = (settings.userName || 'Êàë').charAt(0);
          }
        }
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        if (content === '__typing__') {
          bubble.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
        } else if (content.startsWith('__transfer__')) {
          const data = JSON.parse(content.replace('__transfer__', ''));
          bubble.className = 'msg-transfer';
          bubble.innerHTML = `<div class="transfer-body"><div class="transfer-icon">üí∞</div><div class="transfer-info"><div class="transfer-amount">¬•${esc(data.amount)}</div><div class="transfer-note">${esc(data.note)}</div></div></div><div class="transfer-footer">ÂæÆ‰ø°ËΩ¨Ë¥¶</div>`;
        } else if (content.startsWith('__redpacket__')) {
          const data = JSON.parse(content.replace('__redpacket__', ''));
          const opened = data.opened;
          bubble.className = `msg-redpacket${opened ? ' opened' : ''}`;
          bubble.innerHTML = `<div class="rp-body"><div class="rp-icon">üßß</div><div class="rp-info"><div class="rp-greeting">${esc(data.greeting)}</div><div class="rp-amount">¬•${esc(data.amount)}</div></div></div><div class="rp-footer"><span>${opened ? 'Â∑≤È¢ÜÂèñ' : 'Êü•ÁúãÁ∫¢ÂåÖ'}</span><span>ÂæÆ‰ø°Á∫¢ÂåÖ</span></div>`;
          if (!opened && typeof msgIndex === 'number') {
            bubble.onclick = () => openRedPacketMsg(msgIndex);
          }
        } else if (content.startsWith('__image__')) {
          const imgUrl = content.replace('__image__', '');
          bubble.className = 'msg-image';
          bubble.innerHTML = `<img src="${imgUrl}">`;
        } else if (content.startsWith('__gift__')) {
          const data = JSON.parse(content.replace('__gift__', ''));
          bubble.className = 'msg-gift';
          bubble.innerHTML = `<div class="gift-icon">${data.icon}</div><div class="gift-text">ÈÄÅ‰Ω†‰∏Ä‰∏™${esc(data.name)}</div><div class="gift-note">Á§ºÁâ©</div>`;
        } else {
          bubble.textContent = content;
        }

        // Add context menu on right-click and long-press for actual messages
        if (typeof msgIndex === 'number') {
          bubble.addEventListener('contextmenu', e => {
            e.preventDefault();
            showMsgContextMenu(e, msgIndex, role);
          });
          let longPressTimer = null;
          bubble.addEventListener(
            'touchstart',
            e => {
              longPressTimer = setTimeout(() => {
                e.preventDefault();
                const touch = e.touches[0];
                showMsgContextMenu({ clientX: touch.clientX, clientY: touch.clientY }, msgIndex, role);
              }, 500);
            },
            { passive: false },
          );
          bubble.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
          });
          bubble.addEventListener('touchmove', () => {
            clearTimeout(longPressTimer);
          });
        }

        row.appendChild(avatar);
        if (isGroupChat && role === 'ai') {
          const msgWrapper = document.createElement('div');
          msgWrapper.style.cssText = 'display:flex;flex-direction:column;';
          const senderName = sender ? sender.name : 'Êú™Áü•';
          const nameLabel = document.createElement('div');
          nameLabel.style.cssText = 'font-size:11px;color:#999;margin-bottom:2px;';
          nameLabel.textContent = senderName;
          msgWrapper.appendChild(nameLabel);
          msgWrapper.appendChild(bubble);
          row.appendChild(msgWrapper);
        } else {
          row.appendChild(bubble);
        }
        return row;
      }

      // Message context menu
      function showMsgContextMenu(e, msgIndex, role) {
        closeMsgContextMenu();
        const phoneRect = phone.getBoundingClientRect();
        let x = e.clientX - phoneRect.left;
        let y = e.clientY - phoneRect.top;
        // Clamp within phone bounds
        if (x > 250) x = 250;
        if (y > 700) y = 700;

        const menu = document.getElementById('msgContextMenu');
        let items = '';
        if (role === 'user') {
          items += `<div class="ctx-item" onclick="editMsg(${msgIndex})">‚úèÔ∏è ÁºñËæë</div>`;
          items += `<div class="ctx-item" onclick="recallMsg(${msgIndex})">‚Ü©Ô∏è Êí§Âõû</div>`;
        }
        items += `<div class="ctx-item" onclick="copyMsg(${msgIndex})">üìã Â§çÂà∂</div>`;
        items += `<div class="ctx-item danger" onclick="deleteMsg(${msgIndex})">üóëÔ∏è Âà†Èô§</div>`;

        menu.innerHTML = `<div class="msg-context-overlay" onclick="closeMsgContextMenu()"></div><div class="msg-context-menu" style="left:${x}px;top:${y}px;">${items}</div>`;
        menu.style.display = 'block';
      }

      function closeMsgContextMenu() {
        const menu = document.getElementById('msgContextMenu');
        menu.style.display = 'none';
        menu.innerHTML = '';
      }

      function deleteMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) {
          showToast('‚ö†Ô∏è Âà†Èô§Â§±Ë¥•ÔºöÊú™ÊâæÂà∞ËÅîÁ≥ª‰∫∫');
          return;
        }
        if (idx < 0 || idx >= contact.messages.length) {
          showToast('‚ö†Ô∏è Âà†Èô§Â§±Ë¥•ÔºöÊ∂àÊÅØ‰∏çÂ≠òÂú®');
          return;
        }
        contact.messages.splice(idx, 1);
        storeContacts(contacts);
        renderChatMessages(contact);
        updateGenerateButton();
        showToast('Â∑≤Âà†Èô§');
      }

      function recallMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || idx < 0 || idx >= contact.messages.length) return;
        if (contact.messages[idx].role !== 'user') {
          showToast('Âè™ËÉΩÊí§ÂõûËá™Â∑±ÁöÑÊ∂àÊÅØ');
          return;
        }
        contact.messages.splice(idx, 1);
        storeContacts(contacts);
        renderChatMessages(contact);
        updateGenerateButton();
        // Add recall system message
        const sysMsg = document.createElement('div');
        sysMsg.className = 'system-msg';
        sysMsg.textContent = '‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
        chatContainer.appendChild(sysMsg);
        scrollToBottom();
        showToast('Â∑≤Êí§Âõû');
      }

      function copyMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || idx < 0 || idx >= contact.messages.length) return;
        const text = contact.messages[idx].content;
        navigator.clipboard
          .writeText(text)
          .then(() => showToast('Â∑≤Â§çÂà∂'))
          .catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showToast('Â∑≤Â§çÂà∂');
          });
      }

      function editMsg(idx) {
        closeMsgContextMenu();
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || idx < 0 || idx >= contact.messages.length) return;
        if (contact.messages[idx].role !== 'user') {
          showToast('Âè™ËÉΩÁºñËæëËá™Â∑±ÁöÑÊ∂àÊÅØ');
          return;
        }
        editingMsgIndex = idx;
        document.getElementById('editMsgTextarea').value = contact.messages[idx].content;
        document.getElementById('editMsgModal').classList.add('show');
      }

      function closeEditMsgModal() {
        document.getElementById('editMsgModal').classList.remove('show');
        editingMsgIndex = -1;
      }

      function saveEditMsg() {
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || editingMsgIndex < 0 || editingMsgIndex >= contact.messages.length) return;
        const newText = document.getElementById('editMsgTextarea').value.trim();
        if (!newText) {
          showToast('Ê∂àÊÅØ‰∏çËÉΩ‰∏∫Á©∫');
          return;
        }
        contact.messages[editingMsgIndex].content = newText;
        storeContacts(contacts);
        renderChatMessages(contact);
        updateGenerateButton();
        closeEditMsgModal();
        showToast('Â∑≤ÁºñËæë');
      }

      function scrollToBottom() {
        requestAnimationFrame(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });
      }
      userInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      });
      userInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      function updateGenerateButton() {
        if (!currentContactId) {
          hideGenerateBtn();
          return;
        }
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || contact.messages.length === 0) {
          hideGenerateBtn();
          return;
        }
        const lastMsg = contact.messages[contact.messages.length - 1];
        const btn = document.getElementById('generateBtn');
        if (lastMsg.role === 'user') {
          btn.textContent = 'üîÑ ÁîüÊàêÂõûÂ§ç';
        } else {
          btn.textContent = 'üîÑ ÈáçÊñ∞ÁîüÊàê';
        }
        showGenerateBtn();
      }
      function showGenerateBtn() {
        document.getElementById('generateRow').style.display = 'block';
        scrollToBottom();
      }
      function hideGenerateBtn() {
        document.getElementById('generateRow').style.display = 'none';
      }

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isStreaming || !currentContactId) return;
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        chatContainer.appendChild(createMessageRow('user', text, contact));
        contact.messages.push({ role: 'user', content: text });
        contact.lastTime = getNowTimeStr();
        storeContacts(contacts);
        userInput.value = '';
        userInput.style.height = 'auto';
        scrollToBottom();
        updateGenerateButton();
      }

      async function generateReply() {
        if (isStreaming || !currentContactId) return;
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;

        // If last message is from AI (regenerate mode), remove it/them first
        if (contact.messages.length > 0 && contact.messages[contact.messages.length - 1].role === 'assistant') {
          if (isGroupChat) {
            // Remove all trailing assistant messages (the entire last round)
            while (contact.messages.length > 0 && contact.messages[contact.messages.length - 1].role === 'assistant') {
              contact.messages.pop();
            }
          } else {
            contact.messages.pop();
          }
          storeContacts(contacts);
        }

        hideGenerateBtn();

        // Group chat: sequential generation per member
        if (isGroupChat) {
          isStreaming = true;
          sendBtn.disabled = true;
          document.getElementById('generateBtn').disabled = true;
          try {
            const memberIds = contact.members || [];
            const memberNames = memberIds.map(id => contacts.find(c => c.id === id)?.name).filter(Boolean);
            let anyReplied = false;

            for (let mi = 0; mi < memberIds.length; mi++) {
              const memberId = memberIds[mi];
              const member = contacts.find(c => c.id === memberId);
              if (!member) continue;

              // Show typing indicator with this member's avatar and name
              const typingRow = createMessageRow('ai', '__typing__', contact);
              // Override avatar to show member's avatar
              const typingAvatar = typingRow.querySelector('.msg-avatar');
              if (typingAvatar) {
                if (member.avatar) {
                  typingAvatar.innerHTML = `<img src="${member.avatar}">`;
                  typingAvatar.style.background = '';
                } else {
                  typingAvatar.style.background = member.color;
                  typingAvatar.textContent = member.name.charAt(0).toUpperCase();
                }
              }
              // Override name label to show member's name
              const typingNameLabel = typingRow.querySelector('div[style*="font-size:11px"]');
              if (typingNameLabel) {
                typingNameLabel.textContent = member.name;
              }
              chatContainer.appendChild(typingRow);
              scrollToBottom();

              // Build messages for this specific member
              const messages = [];

              // System prompt: this member's own persona + group context
              const otherMembers = memberIds
                .filter(id => id !== memberId)
                .map(id => contacts.find(c => c.id === id))
                .filter(Boolean);
              const otherContext = otherMembers
                .map(c => `${c.name}: ${(c.systemPrompt || '').slice(0, 200)}`)
                .join('\n');

              // Build a single system message to avoid API rejection
              let sysContent = member.systemPrompt || '‰Ω†ÊòØ' + member.name;
              sysContent += `\n\n[Áæ§ËÅäÔºö${contact.name}ÔºåÊàêÂëòÔºö${otherMembers.map(c => c.name).join('„ÄÅ')}]\n‰ª•${member.name}ÁöÑË∫´‰ªΩÂõûÂ§çÔºå‰∏çÂä†ÂêçÂ≠óÂâçÁºÄ„ÄÇËã•Êó†ÈúÄÂõûÂ§çÂàôÂè™ËØ¥[SKIP]„ÄÇ`;
              if (settings.persona && settings.persona.trim())
                sysContent += `\n\n[Áî®Êà∑‰∫∫ËÆæ]\n${settings.persona.trim()}`;
              if (settings.worldbook && settings.worldbook.trim()) sysContent += `\n\n${settings.worldbook.trim()}`;
              if (settings.jailbreak && settings.jailbreak.trim()) sysContent += `\n\n${settings.jailbreak.trim()}`;
              messages.push({ role: 'system', content: sysContent });

              // Add conversation history (limit to last 15 messages)
              // For group chat: convert this-round assistant messages to user role
              // to avoid ending with assistant before requesting another assistant reply
              const recentMessages = contact.messages.slice(-15);
              recentMessages.forEach(m => {
                let content = m.content;
                if (
                  content.startsWith('__image__') ||
                  content.startsWith('__gift__') ||
                  content.startsWith('__transfer__') ||
                  content.startsWith('__redpacket__')
                ) {
                  return; // skip special messages
                }
                if (m.role === 'assistant' && m.senderId) {
                  const s = contacts.find(c => c.id === m.senderId);
                  if (s) content = `[${s.name}] ${content}`;
                  // Convert other members' replies from this round to user role
                  // so API doesn't reject consecutive assistant messages
                  messages.push({ role: 'user', content });
                } else {
                  messages.push({ role: m.role, content });
                }
              });

              try {
                const headers = { 'Content-Type': 'application/json' };
                if (settings.apiKey) headers['Authorization'] = `Bearer ${settings.apiKey}`;
                const response = await fetch(settings.endpoint, {
                  method: 'POST',
                  headers,
                  body: JSON.stringify({
                    model: settings.model,
                    messages,
                    stream: false,
                    temperature: settings.temperature,
                    max_tokens: 4096,
                  }),
                });

                const text = await response.text();
                if (text.trim().startsWith('<!') || text.trim().startsWith('<html'))
                  throw new Error('API ËøîÂõû‰∫ÜÁΩëÈ°µËÄåÈùû JSON');
                if (!response.ok) {
                  let errData = {};
                  try {
                    errData = JSON.parse(text);
                  } catch (e) {}
                  throw new Error(errData.error?.message || `HTTP ${response.status}`);
                }

                const data = JSON.parse(text);
                let reply = (data.choices?.[0]?.message?.content || '').trim();

                if (typingRow.parentNode) chatContainer.removeChild(typingRow);

                // Check if member chose to skip
                if (!reply || reply === '[SKIP]' || reply.includes('[SKIP]')) {
                  continue;
                }

                // Remove any self-referencing prefix like [MemberName]
                const selfPrefix = new RegExp(`^\\[${member.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\]\\s*`);
                reply = reply.replace(selfPrefix, '');

                // Add as a message from this member
                const msgIdx = contact.messages.length;
                contact.messages.push({ role: 'assistant', content: reply, senderId: memberId });
                // Save incrementally after each member responds
                storeContacts(contacts);
                const row = createMessageRow('ai', reply, contact, msgIdx);
                chatContainer.appendChild(row);
                scrollToBottom();
                anyReplied = true;

                // Small delay before next member
                if (mi < memberIds.length - 1) {
                  await new Promise(r => setTimeout(r, 800));
                }
              } catch (memberErr) {
                if (typingRow.parentNode) chatContainer.removeChild(typingRow);
                console.warn(`Member ${member.name} generation failed:`, memberErr.message);
                let errMsg = memberErr.message;
                if (errMsg === 'Failed to fetch' || errMsg.includes('NetworkError') || errMsg.includes('fetch')) {
                  errMsg = 'ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºàÂèØËÉΩÊòØAPIÂú∞ÂùÄÊó†Êïà„ÄÅSSLËØÅ‰π¶ÈîôËØØÊàñÁΩëÁªú‰∏çÈÄöÔºâ';
                }
                const errRow = document.createElement('div');
                errRow.className = 'system-msg';
                errRow.textContent = `‚ö†Ô∏è ${member.name} ÁîüÊàêÂ§±Ë¥•: ${errMsg}`;
                chatContainer.appendChild(errRow);
                scrollToBottom();
              }
            }

            if (!anyReplied) {
              chatContainer.appendChild(createMessageRow('ai', '(Áæ§ÈáåÊöÇÊó∂Ê≤°Êúâ‰∫∫ÂõûÂ§ç)', contact));
            }

            contact.lastTime = getNowTimeStr();
            storeContacts(contacts);
            renderContacts();
          } catch (err) {
            chatContainer.appendChild(createMessageRow('ai', `‚ö†Ô∏è ${err.message}`, contact));
            scrollToBottom();
          } finally {
            isStreaming = false;
            sendBtn.disabled = false;
            document.getElementById('generateBtn').disabled = false;
            userInput.focus();
            updateGenerateButton();
          }
          return;
        }

        // Single chat generation
        const typingRow = createMessageRow('ai', '__typing__', contact);
        chatContainer.appendChild(typingRow);
        scrollToBottom();
        isStreaming = true;
        sendBtn.disabled = true;
        document.getElementById('generateBtn').disabled = true;

        try {
          const messages = [];

          {
            if (contact.systemPrompt) messages.push({ role: 'system', content: contact.systemPrompt });
          }

          if (settings.persona && settings.persona.trim())
            messages.push({ role: 'system', content: `[Áî®Êà∑‰∫∫ËÆæ‰ø°ÊÅØ]\n${settings.persona.trim()}` });
          const memCtx = getMemoryContext();
          if (memCtx) messages.push({ role: 'system', content: memCtx });
          if (settings.worldbook && settings.worldbook.trim())
            messages.push({ role: 'system', content: settings.worldbook.trim() });

          contact.messages.forEach(m => {
            let content = m.content;

            if (content.startsWith('__image__')) {
              const imgUrl = content.replace('__image__', '');
              messages.push({
                role: m.role,
                content: [
                  { type: 'image_url', image_url: { url: imgUrl } },
                  { type: 'text', text: '(Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåËØ∑ÊèèËø∞Âπ∂ÂõûÂ∫î)' },
                ],
              });
            } else if (content.startsWith('__gift__')) {
              const gd = JSON.parse(content.replace('__gift__', ''));
              messages.push({ role: m.role, content: `(Áî®Êà∑ÈÄÅ‰∫Ü‰Ω†‰∏Ä‰∏™Á§ºÁâ©Ôºö${gd.name} ${gd.icon})` });
            } else if (!content.startsWith('__transfer__') && !content.startsWith('__redpacket__')) {
              messages.push({ role: m.role, content: content });
            }
          });

          if (settings.jailbreak && settings.jailbreak.trim())
            messages.push({ role: 'system', content: settings.jailbreak.trim() });
          const headers = { 'Content-Type': 'application/json' };
          if (settings.apiKey) headers['Authorization'] = `Bearer ${settings.apiKey}`;
          let response;
          try {
            response = await fetch(settings.endpoint, {
              method: 'POST',
              headers,
              body: JSON.stringify({
                model: settings.model,
                messages,
                stream: false,
                temperature: settings.temperature,
                max_tokens: 4096,
              }),
            });
          } catch (fetchErr) {
            throw new Error(`Êó†Ê≥ïËøûÊé•Âà∞ API Á´ØÁÇπÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ´ØÁÇπÂú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ„ÄÇ\n\nËØ¶ÊÉÖ: ${fetchErr.message}`);
          }

          const text = await response.text();

          // Check if response is HTML (endpoint returned a web page, not API)
          if (text.trim().startsWith('<!') || text.trim().startsWith('<html')) {
            throw new Error(
              `API Á´ØÁÇπËøîÂõû‰∫ÜÁΩëÈ°µËÄåÈùû JSON Êï∞ÊçÆ„ÄÇ\n\nËøôÈÄöÂ∏∏ÊÑèÂë≥ÁùÄÔºö\n‚Ä¢ ‰∏≠ËΩ¨ÊúçÂä°Âô®Âú∞ÂùÄÂ∑≤Â§±ÊïàÊàñ‰∏çÊ≠£Á°Æ\n‚Ä¢ Á´ØÁÇπ URL ÊåáÂêë‰∫Ü‰∏Ä‰∏™ÁΩëÈ°µËÄå‰∏çÊòØ API\n\nËØ∑ÂâçÂæÄ„ÄêËÆæÁΩÆ„ÄëÊõ¥Êç¢ API Á´ØÁÇπÂú∞ÂùÄ„ÄÇ`,
            );
          }

          if (!response.ok) {
            let errData = {};
            try {
              errData = JSON.parse(text);
            } catch (e) {}
            throw new Error(errData.error?.message || `HTTP ${response.status}: ${text.slice(0, 150)}`);
          }

          let data;
          try {
            data = JSON.parse(text);
          } catch (e) {
            throw new Error(`API ËøîÂõû‰∫ÜÊó†Ê≥ïËß£ÊûêÁöÑÊï∞ÊçÆ: ${text.slice(0, 150)}`);
          }

          let fullContent = data.choices?.[0]?.message?.content || '';
          chatContainer.removeChild(typingRow);

          if (!fullContent) {
            const aiRow = createMessageRow('ai', '‚ö†Ô∏è AI ËøîÂõû‰∫ÜÁ©∫ÂõûÂ§ç', contact);
            chatContainer.appendChild(aiRow);
          } else {
            const msgIdx = contact.messages.length;
            contact.messages.push({ role: 'assistant', content: fullContent });
            const row = createMessageRow('ai', fullContent, contact, msgIdx);
            chatContainer.appendChild(row);
            scrollToBottom();
          }
          contact.lastTime = getNowTimeStr();
          storeContacts(contacts);
          renderContacts();
          if (!contact.muted) {
            showNotification(contact, fullContent);
          }
        } catch (err) {
          if (typingRow.parentNode) chatContainer.removeChild(typingRow);
          chatContainer.appendChild(createMessageRow('ai', `‚ö†Ô∏è ${err.message}`, contact));
          scrollToBottom();
          alert(
            'ÁîüÊàêÂõûÂ§çÂ§±Ë¥•\n\n' +
              err.message +
              '\n\nÂΩìÂâçÈÖçÁΩÆÔºö\n‚Ä¢ Á´ØÁÇπÔºö' +
              settings.endpoint +
              '\n‚Ä¢ Ê®°ÂûãÔºö' +
              settings.model,
          );
        } finally {
          isStreaming = false;
          sendBtn.disabled = false;
          document.getElementById('generateBtn').disabled = false;
          userInput.focus();
          updateGenerateButton();
        }
      }

      // AI call helper (non-streaming)
      async function aiCall(systemPrompt, userPrompt) {
        const aiHeaders = { 'Content-Type': 'application/json' };
        if (settings.apiKey) aiHeaders['Authorization'] = `Bearer ${settings.apiKey}`;
        let response;
        try {
          response = await fetch(settings.endpoint, {
            method: 'POST',
            headers: aiHeaders,
            body: JSON.stringify({
              model: settings.model,
              messages: [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt },
              ],
              temperature: settings.temperature,
              max_tokens: 4096,
            }),
          });
        } catch (fetchErr) {
          throw new Error(`Êó†Ê≥ïËøûÊé•Âà∞ API Á´ØÁÇπÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ´ØÁÇπÂú∞ÂùÄÊòØÂê¶Ê≠£Á°Æ„ÄÇ\nËØ¶ÊÉÖ: ${fetchErr.message}`);
        }
        const text = await response.text();
        if (text.trim().startsWith('<!') || text.trim().startsWith('<html')) {
          throw new Error('API Á´ØÁÇπËøîÂõû‰∫ÜÁΩëÈ°µËÄåÈùû JSONÔºåËØ∑ÂâçÂæÄ„ÄêËÆæÁΩÆ„ÄëÊõ¥Êç¢ API Á´ØÁÇπÂú∞ÂùÄ„ÄÇ');
        }
        if (!response.ok) {
          let errData = {};
          try {
            errData = JSON.parse(text);
          } catch (e) {}
          throw new Error(errData.error?.message || `HTTP ${response.status}: ${text.slice(0, 150)}`);
        }
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          throw new Error(`API ËøîÂõû‰∫ÜÊó†Ê≥ïËß£ÊûêÁöÑÊï∞ÊçÆ: ${text.slice(0, 150)}`);
        }
        return data.choices?.[0]?.message?.content || '';
      }

      // Weibo
      let currentWeiboTab = 'follow';
      let weiboRefreshing = false;

      function switchWeiboTab(el, tab) {
        document.querySelectorAll('.weibo-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        currentWeiboTab = tab;
        renderWeiboPosts();
      }

      function renderWeiboPosts() {
        const body = document.getElementById('weiboBody');
        let posts = weiboPosts;
        if (currentWeiboTab === 'mine') posts = weiboPosts.filter(p => p.isMine);
        else if (currentWeiboTab === 'hot') posts = [...weiboPosts].sort((a, b) => b.likes - a.likes);
        if (posts.length === 0) {
          body.innerHTML =
            '<div style="text-align:center;padding:60px 20px;color:#999;font-size:14px;">ËøòÊ≤°ÊúâÂæÆÂçöÂÜÖÂÆπ</div>';
          return;
        }
        body.innerHTML = posts
          .map(p => {
            const avatarHtml = p.avatar ? `<img src="${esc(p.avatar)}">` : p.user.charAt(0);
            const avatarStyle = p.avatar ? '' : `style="background:${p.color}"`;
            return `<div class="weibo-post"><div class="weibo-post-header"><div class="weibo-post-avatar" ${avatarStyle}>${avatarHtml}</div><div class="weibo-post-user"><div class="weibo-post-name">${esc(p.user)}</div><div class="weibo-post-time">${p.time}</div></div></div><div class="weibo-post-content">${formatWeiboContent(p.content)}</div><div class="weibo-post-actions"><div class="weibo-action" onclick="repostWeibo(${p.id})">üîÅ ${formatNum(p.reposts)}</div><div class="weibo-action" onclick="commentWeibo(${p.id})">üí¨ ${formatNum(p.comments)}</div><div class="weibo-action ${p.liked ? 'liked' : ''}" onclick="likeWeibo(${p.id})">‚ù§Ô∏è ${formatNum(p.likes)}</div></div></div>`;
          })
          .join('');
      }

      function formatWeiboContent(content) {
        return esc(content).replace(/#([^#]+)#/g, '<span class="hashtag">#$1#</span>');
      }
      function formatNum(n) {
        if (n >= 10000) return (n / 10000).toFixed(1) + '‰∏á';
        if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
        return n;
      }
      function likeWeibo(id) {
        const p = weiboPosts.find(x => x.id === id);
        if (!p) return;
        p.liked = !p.liked;
        p.likes += p.liked ? 1 : -1;
        storeWeiboPosts(weiboPosts);
        renderWeiboPosts();
      }
      function repostWeibo(id) {
        const p = weiboPosts.find(x => x.id === id);
        if (p) {
          p.reposts++;
          storeWeiboPosts(weiboPosts);
          renderWeiboPosts();
          showToast('Â∑≤ËΩ¨Âèë');
        }
      }
      function commentWeibo(id) {
        showToast('ËØÑËÆ∫ÂäüËÉΩÂºÄÂèë‰∏≠');
      }

      let weiboComposeOpen = false;
      function toggleWeiboCompose() {
        weiboComposeOpen = !weiboComposeOpen;
        document.getElementById('weiboCompose').classList.toggle('open', weiboComposeOpen);
        if (weiboComposeOpen) document.getElementById('weiboInput').focus();
      }
      function postWeibo() {
        const content = document.getElementById('weiboInput').value.trim();
        if (!content) {
          showToast('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ');
          return;
        }
        const userName = settings.userName || 'Êàë';
        weiboPosts.unshift({
          id: Date.now(),
          user: userName,
          color: '#1989fa',
          time: 'ÂàöÂàö',
          content,
          likes: 0,
          comments: 0,
          reposts: 0,
          liked: false,
          isMine: true,
          avatar: settings.userAvatar || '',
        });
        storeWeiboPosts(weiboPosts);
        document.getElementById('weiboInput').value = '';
        toggleWeiboCompose();
        renderWeiboPosts();
        showToast('‚úÖ ÂèëÂ∏ÉÊàêÂäü');
      }

      // AI-generated weibo refresh
      async function refreshWeibo() {
        if (weiboRefreshing) return;
        weiboRefreshing = true;
        showToast('üîÑ Ê≠£Âú®ÁîüÊàêÊñ∞ÂæÆÂçö‚Ä¶');
        try {
          // Build character list from contacts
          const charNames = contacts.map(c => c.name);
          const npcNames = ['Êï∞Á†ÅËææ‰∫∫Â∞èK', 'ÊóÖË°åÂçö‰∏ªLuna', 'ÂÅ•Ë∫´ÊïôÁªÉÈòøÂº∫', 'ËØª‰π¶Á¨îËÆ∞Bot', 'Èü≥‰πêÂàÜ‰∫´ÂÆò'];
          const allPosters = [...charNames, ...npcNames.slice(0, 3)];
          const posterList = allPosters.join('„ÄÅ');

          // Build persona context for character-aware weibo generation
          const charContext = contacts.map(c => `${c.name}: ${(c.systemPrompt || '').slice(0, 100)}`).join('\n');

          const prompt = `‰Ω†ÊòØ‰∏Ä‰∏™ÊûÅÂÖ∑ÁΩëÊÑüÁöÑÂæÆÂçöÂÜÖÂÆπÁîüÊàêÂô®„ÄÇËØ∑‰∏∫‰ª•‰∏ãËßíËâ≤ÂêÑÁîüÊàê1Êù°ÊûÅÂÖ∑‚ÄúÊ¥ª‰∫∫Âë≥‚ÄùÁöÑÂæÆÂçöÂä®ÊÄÅÔºåËßíËâ≤ÂàóË°®Ôºö${posterList}„ÄÇ

‰ª•‰∏ãÊòØÊØè‰∏™ËßíËâ≤ÁöÑ‰∫∫ËÆæÁÆÄ‰ªãÔºåËØ∑Á°Æ‰øùÂæÆÂçöÂÜÖÂÆπÊ∑±Â∫¶Ë¥¥ÂêàËßíËâ≤ÊÄßÊ†ºÔºö
${charContext}

Ë¶ÅÊ±ÇÔºö
1. ÊûÅÂÖ∑Ê¥ª‰∫∫Âë≥Ôºö‰∏çË¶ÅÂÉèAIÁîüÊàêÁöÑÂ•óËØùÔºÅË¶ÅÂÉèÁúüÊ≠£ÁöÑÁΩëÂèãÂèëÂæÆÂçö‰∏ÄÊ†∑ÔºåÂèØ‰ª•ÊúâÁ¢éÁ¢éÂøµ„ÄÅÂêêÊßΩ„ÄÅÂèëÁñØ„ÄÅÁé©Ê¢ó„ÄÅÊÉÖÁª™ÂåñË°®Ëææ„ÄÅÁîöËá≥ÈÄÇÂΩìÁöÑÊ†áÁÇπÁ¨¶Âè∑Êª•Áî®ÔºàÂ¶Ç‚ÄúÂïäÂïäÂïäÂïä‚Äù„ÄÅ‚ÄúÊïëÂëΩ‚Äù„ÄÅ‚ÄúÁªù‰∫Ü‚ÄùÁ≠âÔºâ„ÄÇ
2. Ë¥¥ÂêàË∫´‰ªΩÔºöÊ†πÊçÆ‰∫∫ËÆæÂÜ≥ÂÆöÊòØÁ≤æËá¥ÊâìÂç°„ÄÅÊ∑±Â§úemo„ÄÅÊâìÂ∑•‰∫∫ÂêêÊßΩËøòÊòØ‰∫åÊ¨°ÂÖÉÂèëÁóÖ„ÄÇ
3. ÈïøÂ∫¶‰∏éÊ†ºÂºèÔºöÊØèÊù°ÂæÆÂçö20-100Â≠óÔºåÈÄÇÂΩì‰ΩøÁî®emojiÂíå#ËØùÈ¢òÊ†áÁ≠æ#Ôºå‰ΩÜ‰∏çË¶ÅÊØèÊù°ÈÉΩÂ∏¶Ê†áÁ≠æÔºåÊòæÂæóÂ§™ÂàªÊÑè„ÄÇ
4. ‰ª•JSONÊï∞ÁªÑÊ†ºÂºèËøîÂõûÔºåÊØè‰∏™ÂÖÉÁ¥†ÂåÖÂê´ user(ÂèëÂ∏ÉËÄÖÂêç) Âíå content(ÂÜÖÂÆπ) Â≠óÊÆµ„ÄÇ
5. Âè™ËøîÂõûJSONÊï∞ÁªÑÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ`;

          const result = await aiCall('‰Ω†ÊòØ‰∏Ä‰∏™Á§æ‰∫§Â™í‰ΩìÂÜÖÂÆπÁîüÊàêÂô®ÔºåÂè™ËøîÂõûJSONÊ†ºÂºè„ÄÇ', prompt);

          // Parse JSON from response
          let posts;
          const jsonMatch = result.match(/\[[\s\S]*\]/);
          if (jsonMatch) {
            posts = JSON.parse(jsonMatch[0]);
          } else {
            throw new Error('AIËøîÂõûÊ†ºÂºèÈîôËØØ');
          }

          const timeLabels = ['ÂàöÂàö', '1ÂàÜÈíüÂâç', '3ÂàÜÈíüÂâç', '5ÂàÜÈíüÂâç', '8ÂàÜÈíüÂâç'];
          posts.forEach((p, i) => {
            const contact = contacts.find(c => c.name === p.user);
            weiboPosts.unshift({
              id: Date.now() + i,
              user: p.user,
              color: contact ? contact.color : AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)],
              time: timeLabels[i] || 'ÂàöÂàö',
              content: p.content,
              likes: Math.floor(Math.random() * 500),
              comments: Math.floor(Math.random() * 100),
              reposts: Math.floor(Math.random() * 50),
              liked: false,
              avatar: contact ? contact.avatar || '' : '',
            });
          });
          storeWeiboPosts(weiboPosts);
          renderWeiboPosts();
          showToast(`‚úÖ Â∑≤Âà∑Êñ∞ ${posts.length} Êù°Êñ∞ÂæÆÂçö`);
        } catch (err) {
          showToast(`‚ö†Ô∏è Âà∑Êñ∞Â§±Ë¥•Ôºö${err.message}`);
        } finally {
          weiboRefreshing = false;
        }
      }

      // Notification popup
      function showNotification(contact, text) {
        const popup = document.getElementById('notifPopup');
        const avatarStyle = contact.avatar ? '' : `style="background:${contact.color}"`;
        const avatarContent = contact.avatar ? `<img src="${contact.avatar}">` : contact.name.charAt(0).toUpperCase();
        popup.innerHTML = `<div class="notif-popup" id="notifBanner" onclick="notifTap(${contact.id})"><div class="notif-avatar" ${avatarStyle}>${avatarContent}</div><div class="notif-body"><div class="notif-app">‰ø°ÊÅØ</div><div class="notif-title">${esc(contact.name)}</div><div class="notif-text">${esc(text.slice(0, 60))}</div></div></div>`;
        popup.style.display = 'block';
        // Auto dismiss after 4s
        clearTimeout(popup._timer);
        popup._timer = setTimeout(() => {
          const banner = document.getElementById('notifBanner');
          if (banner) {
            banner.classList.add('hiding');
            setTimeout(() => {
              popup.style.display = 'none';
              popup.innerHTML = '';
            }, 300);
          }
        }, 4000);
      }
      function notifTap(contactId) {
        const popup = document.getElementById('notifPopup');
        popup.style.display = 'none';
        popup.innerHTML = '';
        clearTimeout(popup._timer);
        // If not already in that chat, navigate
        if (currentContactId !== contactId) {
          if (getActiveScreen() === 'chat') closeChat();
          openChatWith(contactId);
        }
      }

      // Transfer & Red Packet
      function openTransferModal() {
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        document.getElementById('transferTo').textContent = c ? c.name : 'ÂØπÊñπ';
        document.getElementById('transferAmount').value = '';
        document.getElementById('transferNote').value = '';
        document.getElementById('transferModal').classList.add('show');
        setTimeout(() => document.getElementById('transferAmount').focus(), 100);
      }
      function closeTransferModal() {
        document.getElementById('transferModal').classList.remove('show');
      }

      function sendTransfer() {
        const amount = parseFloat(document.getElementById('transferAmount').value);
        if (!amount || amount <= 0) {
          showToast('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
          return;
        }
        const note = document.getElementById('transferNote').value.trim() || 'ËΩ¨Ë¥¶';
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        contact.messages.push({
          role: 'user',
          content: `__transfer__${JSON.stringify({ amount: amount.toFixed(2), note })}`,
        });
        contact.lastTime = getNowTimeStr();
        storeContacts(contacts);
        renderChatMessages(contact);
        closeTransferModal();
        scrollToBottom();
      }

      function openRedPacketModal() {
        if (!currentContactId) return;
        document.getElementById('rpAmount').value = '';
        document.getElementById('rpGreeting').value = '';
        document.getElementById('redPacketModal').classList.add('show');
        setTimeout(() => document.getElementById('rpAmount').focus(), 100);
      }
      function closeRedPacketModal() {
        document.getElementById('redPacketModal').classList.remove('show');
      }

      function sendRedPacket() {
        const amount = parseFloat(document.getElementById('rpAmount').value);
        if (!amount || amount <= 0) {
          showToast('ËØ∑ËæìÂÖ•ÈáëÈ¢ù');
          return;
        }
        const greeting = document.getElementById('rpGreeting').value.trim() || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©';
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact) return;
        const rpId = Date.now();
        contact.messages.push({
          role: 'user',
          content: `__redpacket__${JSON.stringify({ amount: amount.toFixed(2), greeting, id: rpId, opened: false })}`,
        });
        contact.lastTime = getNowTimeStr();
        storeContacts(contacts);
        renderChatMessages(contact);
        closeRedPacketModal();
        scrollToBottom();
      }

      function openRedPacketMsg(msgIndex) {
        const contact = contacts.find(c => c.id === currentContactId);
        if (!contact || msgIndex < 0 || msgIndex >= contact.messages.length) return;
        const msg = contact.messages[msgIndex];
        if (!msg.content.startsWith('__redpacket__')) return;
        const data = JSON.parse(msg.content.replace('__redpacket__', ''));
        if (data.opened) {
          showToast('Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂèñ');
          return;
        }
        data.opened = true;
        msg.content = `__redpacket__${JSON.stringify(data)}`;
        storeContacts(contacts);
        renderChatMessages(contact);
        showToast(`üßß È¢ÜÂèñ‰∫Ü ¬•${data.amount} Á∫¢ÂåÖ`);
      }

      // ======= WIDGETS =======
      const WIDGET_TYPES = [
        {
          type: 'clock',
          name: 'ÂèØÁà±Êó∂Èíü',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
        },
        {
          type: 'calendar',
          name: 'Â∞èÊó•ÂéÜ',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
        },
        {
          type: 'mood',
          name: 'ÂøÉÊÉÖËÆ∞ÂΩï',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',
        },
        {
          type: 'memo',
          name: '‰æøÁ≠æ',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
        },
        {
          type: 'pet',
          name: 'ÁîµÂ≠êÂÆ†Áâ©',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M12 5c.67 0 1.35.09 2 .26 1.78-2 5.03-2.84 6.42-2.45.44.12.58.58.37.91l-2.28 3.63C20.23 8.71 21 10.28 21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9c0-1.72.77-3.29 2.49-4.65L3.21 3.72c-.21-.33-.07-.79.37-.91 1.39-.39 4.64.45 6.42 2.45.65-.17 1.33-.26 2-.26z"></path><circle cx="9" cy="12" r="1"></circle><circle cx="15" cy="12" r="1"></circle><path d="M12 15c.5 0 1 .5 1 1s-.5 1-1 1-1-.5-1-1 .5-1 1-1z"></path></svg>',
        },
        {
          type: 'lovedays',
          name: 'ÊÅãÁà±Â§©Êï∞',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>',
        },
        {
          type: 'weather',
          name: 'Â§©Ê∞î',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.3-1.7-4.2-3.9-4.5-.5-3.1-3.2-5.5-6.4-5.5-2.6 0-4.9 1.6-5.9 3.9-2.2.4-3.8 2.3-3.8 4.6 0 2.5 2 4.5 4.5 4.5h11z"></path></svg>',
        },
        {
          type: 'photo',
          name: 'Áõ∏Ê°Ü',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
        },
        {
          type: 'quote',
          name: 'ÊØèÊó•‰∏ÄÂè•',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
        },
        {
          type: 'todo',
          name: 'ÂæÖÂäû‰∫ãÈ°π',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>',
        },
        {
          type: 'music',
          name: 'Èü≥‰πê',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
        },
        {
          type: 'battery',
          name: 'ÁîµÈáè',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><rect x="1" y="6" width="18" height="12" rx="2" ry="2"></rect><line x1="23" y1="13" x2="23" y2="11"></line></svg>',
        },
        {
          type: 'photowall',
          name: 'ÁÖßÁâáÂ¢ô',
          icon: '<svg viewBox="0 0 24 24" width="28" height="28" stroke="currentColor" stroke-width="2" fill="none"><rect x="2" y="2" width="9" height="9" rx="1"></rect><rect x="13" y="2" width="9" height="6" rx="1"></rect><rect x="2" y="13" width="9" height="6" rx="1"></rect><rect x="13" y="10" width="9" height="9" rx="1"></rect><circle cx="6" cy="6" r="1.5" fill="currentColor" stroke="none"></circle><path d="M2 9l3-3 4 4"></path></svg>',
        },
      ];

      function loadWidgets() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_widgets') || '[]');
        } catch {
          return [];
        }
      }
      function storeWidgets(w) {
        safeStore('ai_phone_widgets', w);
      }
      let widgets = loadWidgets();

      function openWidgetPicker() {
        const grid = document.getElementById('widgetPickerGrid');
        grid.innerHTML = WIDGET_TYPES.map(
          w =>
            `<div class="widget-picker-item" onclick="addWidget('${w.type}')"><div class="wp-icon">${w.icon}</div><div class="wp-name">${w.name}</div></div>`,
        ).join('');
        document.getElementById('widgetPickerModal').classList.add('show');
      }
      function closeWidgetPicker() {
        document.getElementById('widgetPickerModal').classList.remove('show');
      }

      function addWidget(type) {
        const id = Date.now();
        const widget = { id, type, bg: '', data: getDefaultWidgetData(type) };
        widgets.push(widget);
        storeWidgets(widgets);
        renderHomePages();
        closeWidgetPicker();
        showToast('‚úÖ Â∑≤Ê∑ªÂä†Â∞èÁªÑ‰ª∂');
      }

      function removeWidget(id) {
        widgets = widgets.filter(w => w.id !== id);
        storeWidgets(widgets);
        renderHomePages();
      }

      let widgetBgTargetId = null;
      document.getElementById('widgetBgInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file || !widgetBgTargetId) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const w = widgets.find(x => x.id === widgetBgTargetId);
          if (w) {
            w.bg = ev.target.result;
            storeWidgets(widgets);
            renderWidgets();
          }
        };
        reader.readAsDataURL(file);
        this.value = '';
      });

      function pickWidgetBg(id) {
        widgetBgTargetId = id;
        document.getElementById('widgetBgInput').click();
      }

      function getDefaultWidgetData(type) {
        switch (type) {
          case 'mood':
            return { selected: -1, text: '' };
          case 'memo':
            return { text: '' };
          case 'pet':
            return { name: 'Â∞èÂñµ', pet: 'üê±', happiness: 80, hunger: 60 };
          case 'lovedays':
            return { startDate: new Date().toISOString().slice(0, 10), title: 'Âú®‰∏ÄËµ∑' };
          case 'todo':
            return {
              items: [
                { text: 'ÂÆåÊàê‰ªäÂ§©ÁöÑ‰ªªÂä°', done: false },
                { text: 'Âñù8ÊùØÊ∞¥', done: false },
              ],
            };
          case 'photo':
            return { src: '' };
          case 'music':
            return { playing: false, song: 'Â§úÊõ≤', artist: 'Âë®Êù∞‰º¶' };
          case 'photowall':
            return { photos: [], layout: 'scattered' };
          default:
            return {};
        }
      }

      const CUTE_QUOTES = [
        { text: '‰ªäÂ§©‰πüË¶ÅÂÖÉÊ∞îÊª°Êª°Âú∞Âä†Ê≤πÈ∏≠ÔºÅ', author: 'Â∞èÁ°ÆÂπ∏' },
        { text: '‰Ω†Á¨ëËµ∑Êù•ÁúüÂ•ΩÁúãÔºåÂÉèÊò•Â§©ÁöÑËä±‰∏ÄÊ†∑üå∏', author: 'ÂøÉËØ≠' },
        { text: 'ÁîüÊ¥ª‰∏çÊ≠¢ÁúºÂâçÁöÑËãü‰∏îÔºåËøòÊúâËØóÂíåËøúÊñπÁöÑÁî∞Èáé', author: 'È´òÊôìÊùæ' },
        { text: 'ÊÑø‰Ω†ÁúºÈáåÊúâÂÖâÔºåÂøÉ‰∏≠ÊúâÁà±üíñ', author: 'Ê∏©Êöñ' },
        { text: 'ÊØè‰∏ÄÂ§©ÈÉΩÊòØÊñ∞ÁöÑÂºÄÂßãÔºåÂæÆÁ¨ëÈù¢ÂØπ‰∏ÄÂàá', author: 'Èò≥ÂÖâ' },
        { text: 'ÂÅö‰∏Ä‰∏™Ê∏©ÊöñÁöÑ‰∫∫Ôºå‰∏çÂçë‰∏ç‰∫¢ÔºåÊ∏ÖÊæàÂñÑËâØ', author: 'ËøúÊñπ' },
        { text: '‰Ω†ÊòØÊàëËßÅËøáÊúÄÂèØÁà±ÁöÑÂ∞èÊúãÂèãÂï¶~', author: 'Â§∏Â§∏' },
        { text: '‰∏ñÁïå‰∏äÊúÄÁæéÂ•ΩÁöÑ‰∫ãÊÉÖÂ∞±ÊòØÊØèÂ§©ÈÜíÊù•ÂèàÊòØÂ¥≠Êñ∞ÁöÑ‰∏ÄÂ§©', author: 'Êô®ÂÖâ' },
      ];

      const WEATHER_DATA = [
        { icon: '‚òÄÔ∏è', temp: '26¬∞', desc: 'Êô¥Êúó', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
        { icon: '‚õÖ', temp: '22¬∞', desc: 'Â§ö‰∫ë', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
        { icon: 'üåßÔ∏è', temp: '18¬∞', desc: 'Â∞èÈõ®', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
        { icon: 'üå∏', temp: '24¬∞', desc: 'Êò•ÂÖâÊòéÂ™ö', loc: 'ÂΩìÂâç‰ΩçÁΩÆ' },
      ];

      const MOOD_COLORS = ['#66bb6a', '#e91e63', '#42a5f5', '#9575cd', '#ef5350'];
      const MOOD_LABELS = ['ÂºÄÂøÉ', 'Ë∂ÖÁà±', 'Âπ≥Èùô', 'ÂøßÈÉÅ', 'ÁÉ¶Ë∫Å'];

      function renderWidgets() {
        const area = document.getElementById('widgetArea');
        if (widgets.length === 0) {
          area.innerHTML = '';
          return;
        }
        area.innerHTML = widgets
          .map(w => {
            const bgStyle = w.bg ? `<div class="widget-bg" style="background-image:url(${w.bg})"></div>` : '';
            return `<div class="widget-card" id="widget-${w.id}">${bgStyle}<div class="widget-remove" onclick="event.stopPropagation();removeWidget(${w.id})">‚úï</div><div class="widget-bg-btn" onclick="event.stopPropagation();pickWidgetBg(${w.id})">üñº</div><div class="widget-content">${renderWidgetContent(w)}</div></div>`;
          })
          .join('');
        // Start clock updates
        widgets.forEach(w => {
          if (w.type === 'clock') updateClockWidget(w.id);
        });
      }

      function renderWidgetContent(w) {
        switch (w.type) {
          case 'clock':
            return renderClockWidget(w);
          case 'calendar':
            return renderCalendarWidget(w);
          case 'mood':
            return renderMoodWidget(w);
          case 'memo':
            return renderMemoWidget(w);
          case 'pet':
            return renderPetWidget(w);
          case 'lovedays':
            return renderLoveDaysWidget(w);
          case 'weather':
            return renderWeatherWidget(w);
          case 'photo':
            return renderPhotoWidget(w);
          case 'quote':
            return renderQuoteWidget(w);
          case 'todo':
            return renderTodoWidget(w);
          case 'music':
            return renderMusicWidget(w);
          case 'battery':
            return renderBatteryWidget(w);
          case 'photowall':
            return renderPhotoWallWidget(w);
          default:
            return '';
        }
      }

      function renderClockWidget(w) {
        const now = new Date();
        const h = now.getHours(),
          m = now.getMinutes(),
          s = now.getSeconds();
        const hDeg = (h % 12) * 30 + m * 0.5,
          mDeg = m * 6,
          sDeg = s * 6;
        const days = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
        return `<div class="w-clock"><div class="clock-face"><div class="clock-center"></div><div class="clock-hand hand-hour" style="transform:rotate(${hDeg}deg)"></div><div class="clock-hand hand-minute" style="transform:rotate(${mDeg}deg)"></div><div class="clock-hand hand-second" style="transform:rotate(${sDeg}deg)"></div></div><div class="clock-info"><div class="clock-digital">${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}</div><div class="clock-label">${days[now.getDay()]} ¬∑ ${now.getMonth() + 1}Êúà${now.getDate()}Êó•</div></div></div>`;
      }

      function updateClockWidget(id) {
        const el = document.getElementById(`widget-${id}`);
        if (!el) return;
        const w = widgets.find(x => x.id === id);
        if (!w || w.type !== 'clock') return;
        const content = el.querySelector('.widget-content');
        if (content) content.innerHTML = renderClockWidget(w);
        setTimeout(() => updateClockWidget(id), 1000);
      }

      function renderCalendarWidget() {
        const now = new Date();
        const year = now.getFullYear(),
          month = now.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = now.getDate();
        const dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        let cells = dayNames.map(d => `<div class="cal-day-name">${d}</div>`).join('');
        for (let i = 0; i < firstDay; i++) cells += '<div class="cal-day empty">.</div>';
        for (let d = 1; d <= daysInMonth; d++) cells += `<div class="cal-day ${d === today ? 'today' : ''}">${d}</div>`;
        return `<div class="w-calendar"><div class="cal-month">${year}Âπ¥${month + 1}Êúà</div><div class="cal-grid">${cells}</div></div>`;
      }

      function renderMoodWidget(w) {
        const dots = MOOD_COLORS.map(
          (c, i) =>
            `<div class="mood-dot ${w.data.selected === i ? 'selected' : ''}" style="background:${c}" onclick="event.stopPropagation();selectMood(${w.id},${i})"></div>`,
        ).join('');
        const text = w.data.selected >= 0 ? MOOD_LABELS[w.data.selected] : 'ËÆ∞ÂΩï‰ªäÊó•ÂøÉÊÉÖ';
        return `<div class="w-mood"><div class="mood-title">TODAY'S MOOD</div><div class="mood-options">${dots}</div><div class="mood-result">${text}</div></div>`;
      }
      function selectMood(widgetId, idx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w) return;
        w.data.selected = idx;
        storeWidgets(widgets);
        renderWidgets();
      }

      function renderMemoWidget(w) {
        return `<div class="w-memo"><div class="memo-title">üìù ‰æøÁ≠æ</div><textarea placeholder="ÂÜôÁÇπ‰ªÄ‰πà‚Ä¶" oninput="updateMemo(${w.id},this.value)" onclick="event.stopPropagation()">${esc(w.data.text || '')}</textarea></div>`;
      }
      function updateMemo(id, text) {
        const w = widgets.find(x => x.id === id);
        if (w) {
          w.data.text = text;
          storeWidgets(widgets);
        }
      }

      function renderPetWidget(w) {
        const pets = ['üê±', 'üê∂', 'üê∞', 'üêª', 'üêº', 'ü¶ä', 'üê∏', 'üê•'];
        return `<div class="w-pet"><div class="pet-display">${w.data.pet}</div><div class="pet-name">${esc(w.data.name)}</div><div class="pet-status">ÂøÉÊÉÖ ${'üíñ'.repeat(Math.ceil(w.data.happiness / 20))} ¬∑ È•±ËÖπ ${'üçñ'.repeat(Math.ceil(w.data.hunger / 20))}</div><div class="pet-actions"><div class="pet-btn" onclick="event.stopPropagation();petAction(${w.id},'feed')">üçñ ÂñÇÈ£ü</div><div class="pet-btn" onclick="event.stopPropagation();petAction(${w.id},'play')">üéæ Áé©ËÄç</div><div class="pet-btn" onclick="event.stopPropagation();petAction(${w.id},'change')">üîÑ Êç¢ÂÆ†Áâ©</div></div></div>`;
      }
      function petAction(id, action) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        const pets = ['üê±', 'üê∂', 'üê∞', 'üêª', 'üêº', 'ü¶ä', 'üê∏', 'üê•'];
        const names = ['Â∞èÂñµ', 'Â∞èÊ±™', 'Â∞èÂÖî', 'Â∞èÁÜä', 'Âõ¢Âõ¢', 'Â∞èÁãê', 'Âë±Âë±', 'Â∞èÈ∏°'];
        if (action === 'feed') {
          w.data.hunger = Math.min(100, w.data.hunger + 20);
          showToast('üçñ ÂñÇÈ£üÊàêÂäü~');
        } else if (action === 'play') {
          w.data.happiness = Math.min(100, w.data.happiness + 15);
          w.data.hunger = Math.max(0, w.data.hunger - 10);
          showToast('üéæ Áé©ËÄç‰∏≠~');
        } else if (action === 'change') {
          const idx = (pets.indexOf(w.data.pet) + 1) % pets.length;
          w.data.pet = pets[idx];
          w.data.name = names[idx];
        }
        storeWidgets(widgets);
        renderWidgets();
      }

      function renderLoveDaysWidget(w) {
        const start = new Date(w.data.startDate);
        const now = new Date();
        const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));
        return `<div class="w-lovedays"><div class="ld-hearts">üíïüíñüíï</div><div class="ld-title">${esc(w.data.title)}</div><div class="ld-days">${days}</div><div class="ld-label">Â§©</div><div class="ld-date-info">‰ªé ${w.data.startDate} ÂºÄÂßã</div></div>`;
      }

      function renderWeatherWidget() {
        const w = WEATHER_DATA[Math.floor(Math.random() * WEATHER_DATA.length)];
        return `<div class="w-weather"><div class="weather-icon">${w.icon}</div><div class="weather-info"><div class="weather-temp">${w.temp}</div><div class="weather-desc">${w.desc}</div><div class="weather-loc">üìç ${w.loc}</div></div></div>`;
      }

      function renderPhotoWidget(w) {
        const content = w.data.src ? `<img src="${w.data.src}">` : 'üì∑';
        return `<div class="w-photo"><div class="photo-frame" onclick="event.stopPropagation();pickWidgetPhoto(${w.id})">${content}</div><div class="photo-label">ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá</div></div>`;
      }
      function pickWidgetPhoto(id) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = ev => {
            const w = widgets.find(x => x.id === id);
            if (w) {
              w.data.src = ev.target.result;
              storeWidgets(widgets);
              renderWidgets();
            }
          };
          reader.readAsDataURL(file);
        };
        input.click();
      }

      function renderQuoteWidget(w) {
        const defaultQ = CUTE_QUOTES[Math.floor(Date.now() / 86400000) % CUTE_QUOTES.length];
        const text = w.data.customText || defaultQ.text;
        const author = w.data.customAuthor || defaultQ.author;
        const editing = w.data._editing;
        let editArea = '';
        if (editing) {
          editArea = `<div class="quote-edit-area"><textarea placeholder="ËæìÂÖ•Âè•Â≠ê‚Ä¶" id="quoteText-${w.id}" onclick="event.stopPropagation()">${esc(w.data.customText || '')}</textarea><input type="text" placeholder="‰ΩúËÄÖ" id="quoteAuthor-${w.id}" value="${esc(w.data.customAuthor || '')}" onclick="event.stopPropagation()"><button class="quote-save-btn" onclick="event.stopPropagation();saveQuote(${w.id})">‰øùÂ≠ò</button></div>`;
        } else {
          editArea = `<button class="quote-edit-btn" onclick="event.stopPropagation();editQuote(${w.id})">‚úèÔ∏è Ëá™ÂÆö‰πâ</button>`;
        }
        return `<div class="w-quote"><div class="quote-icon">‚ú®</div><div class="quote-text">"${esc(text)}"</div><div class="quote-author">‚Äî‚Äî ${esc(author)}</div>${editArea}</div>`;
      }
      function editQuote(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        w.data._editing = true;
        storeWidgets(widgets);
        renderWidgets();
      }
      function saveQuote(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        const textEl = document.getElementById(`quoteText-${id}`);
        const authorEl = document.getElementById(`quoteAuthor-${id}`);
        w.data.customText = textEl ? textEl.value.trim() : '';
        w.data.customAuthor = authorEl ? authorEl.value.trim() : '';
        w.data._editing = false;
        storeWidgets(widgets);
        renderWidgets();
        showToast('‚úÖ Â∑≤‰øùÂ≠ò');
      }

      function renderTodoWidget(w) {
        const items = (w.data.items || [])
          .map(
            (item, i) =>
              `<div class="todo-item ${item.done ? 'done' : ''}" onclick="event.stopPropagation();toggleTodo(${w.id},${i})"><div class="todo-check">${item.done ? '‚úì' : ''}</div><span>${esc(item.text)}</span><span class="todo-delete" onclick="event.stopPropagation();deleteTodoItem(${w.id},${i})" title="Âà†Èô§">‚úï</span></div>`,
          )
          .join('');
        return `<div class="w-todo"><div class="todo-title">üéØ ÂæÖÂäû‰∫ãÈ°π</div><div class="todo-list">${items}</div><div class="todo-add"><input type="text" placeholder="Ê∑ªÂä†ÂæÖÂäû‚Ä¶" id="todoInput-${w.id}" onclick="event.stopPropagation()" onkeydown="if(event.key==='Enter'){event.stopPropagation();addTodoItem(${w.id})}"><button onclick="event.stopPropagation();addTodoItem(${w.id})">+</button></div></div>`;
      }
      function toggleTodo(widgetId, idx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w || !w.data.items[idx]) return;
        w.data.items[idx].done = !w.data.items[idx].done;
        storeWidgets(widgets);
        renderWidgets();
      }
      function addTodoItem(widgetId) {
        const input = document.getElementById(`todoInput-${widgetId}`);
        if (!input) return;
        const text = input.value.trim();
        if (!text) return;
        const w = widgets.find(x => x.id === widgetId);
        if (!w) return;
        w.data.items.push({ text, done: false });
        storeWidgets(widgets);
        renderWidgets();
      }
      function deleteTodoItem(widgetId, idx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w || !w.data.items[idx]) return;
        w.data.items.splice(idx, 1);
        storeWidgets(widgets);
        renderWidgets();
      }

      // Global audio element for music widget
      let musicAudio = null;
      let musicWidgetId = null;

      function renderMusicWidget(w) {
        const playClass = w.data.playing ? '' : 'paused';
        const playIcon = w.data.playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        const hasUrl = !!w.data.url;
        const urlRow = `<div class="music-url-row"><input type="text" class="music-url-input" placeholder="Á≤òË¥¥Èü≥‰πêURL‚Ä¶" id="musicUrl-${w.id}" value="${esc(w.data.url || '')}" onclick="event.stopPropagation()"><button class="music-url-btn" onclick="event.stopPropagation();setMusicUrl(${w.id})">ÂØºÂÖ•</button></div>`;
        const progressBar = hasUrl
          ? `<div class="music-progress"><div class="music-progress-fill" id="musicProgress-${w.id}" style="width:0%"></div></div>`
          : '';
        return `<div class="w-music"><div class="music-main"><div class="music-cover ${playClass}">üéµ</div><div class="music-info"><div class="music-title">${esc(w.data.song)}</div><div class="music-artist">${esc(w.data.artist)}</div><div class="music-controls"><span class="music-btn" onclick="event.stopPropagation();toggleMusic(${w.id})">${playIcon}</span></div></div></div>${progressBar}${urlRow}</div>`;
      }

      function setMusicUrl(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        const input = document.getElementById(`musicUrl-${id}`);
        if (!input) return;
        const url = input.value.trim();
        if (!url) {
          showToast('ËØ∑ËæìÂÖ•Èü≥‰πêURL');
          return;
        }
        w.data.url = url;
        w.data.playing = false;
        // Try to extract song name from URL
        try {
          const parts = url.split('/').pop().split('?')[0];
          if (parts)
            w.data.song = decodeURIComponent(parts)
              .replace(/\.[^.]+$/, '')
              .slice(0, 20);
        } catch {}
        storeWidgets(widgets);
        // Stop current audio
        if (musicAudio) {
          musicAudio.pause();
          musicAudio = null;
        }
        renderWidgets();
        showToast('‚úÖ Èü≥‰πêÂ∑≤ÂØºÂÖ•');
      }

      function toggleMusic(id) {
        const w = widgets.find(x => x.id === id);
        if (!w) return;
        if (w.data.url) {
          if (!musicAudio || musicWidgetId !== id) {
            if (musicAudio) musicAudio.pause();
            musicAudio = new Audio(w.data.url);
            musicWidgetId = id;
            musicAudio.addEventListener('timeupdate', () => {
              const fill = document.getElementById(`musicProgress-${id}`);
              if (fill && musicAudio.duration) {
                fill.style.width = (musicAudio.currentTime / musicAudio.duration) * 100 + '%';
              }
            });
            musicAudio.addEventListener('ended', () => {
              w.data.playing = false;
              storeWidgets(widgets);
              renderWidgets();
            });
            musicAudio.addEventListener('error', () => {
              showToast('‚ö†Ô∏è Èü≥‰πêÂä†ËΩΩÂ§±Ë¥•');
              w.data.playing = false;
              storeWidgets(widgets);
              renderWidgets();
            });
          }
          w.data.playing = !w.data.playing;
          if (w.data.playing)
            musicAudio.play().catch(() => {
              w.data.playing = false;
              showToast('‚ö†Ô∏è Êí≠ÊîæÂ§±Ë¥•');
            });
          else musicAudio.pause();
        } else {
          w.data.playing = !w.data.playing;
        }
        storeWidgets(widgets);
        renderWidgets();
      }

      function renderBatteryWidget() {
        const level = Math.floor(50 + Math.random() * 50);
        return `<div class="w-battery"><div class="bat-visual"><div class="bat-fill" style="width:${level}%"></div></div><div class="bat-info"><div class="bat-percent">${level}%</div><div class="bat-label">‚ö° ÂÖÖÁîµ‰∏≠</div></div></div>`;
      }

      // ======= PHOTO WALL DECORATIVE WIDGET =======
      const PW_LAYOUTS = ['scattered', 'grid', 'masonry'];
      const PW_LAYOUT_NAMES = { scattered: 'ÈöèÊÑèË¥¥', grid: 'ÁΩëÊ†º', masonry: 'ÁÄëÂ∏ÉÊµÅ' };

      function renderPhotoWallWidget(w) {
        const photos = w.data.photos || [];
        const layout = w.data.layout || 'scattered';
        const nextLayout = PW_LAYOUTS[(PW_LAYOUTS.indexOf(layout) + 1) % PW_LAYOUTS.length];

        // Toolbar
        let toolbar = `<div class="pw-deco-toolbar">
          <div class="pw-deco-title">üñºÔ∏è ÁÖßÁâáÂ¢ô</div>
          <div class="pw-deco-actions">
            <button class="pw-deco-btn" onclick="event.stopPropagation();switchPhotoWallLayout(${w.id})" title="ÂàáÊç¢Â∏ÉÂ±Ä">${PW_LAYOUT_NAMES[layout]}</button>
            <button class="pw-deco-btn" onclick="event.stopPropagation();pickPhotoWallPhotos(${w.id})">Ôºã Ê∑ªÂä†</button>
          </div>
        </div>`;

        if (photos.length === 0) {
          return `<div class="w-photowall">${toolbar}<div class="pw-deco-empty" onclick="event.stopPropagation();pickPhotoWallPhotos(${w.id})"><div class="pw-deco-empty-icon">üñºÔ∏è</div><div class="pw-deco-empty-text">ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâáË£ÖÈ•∞</div></div></div>`;
        }

        let content = '';
        if (layout === 'scattered') {
          content = renderScatteredLayout(w, photos);
        } else if (layout === 'grid') {
          content = renderGridLayout(w, photos);
        } else {
          content = renderMasonryLayout(w, photos);
        }

        // Add button at end
        content += `<div class="pw-deco-add" onclick="event.stopPropagation();pickPhotoWallPhotos(${w.id})" style="margin-top:6px;height:36px;">Ôºã</div>`;

        return `<div class="w-photowall">${toolbar}${content}</div>`;
      }

      function renderScatteredLayout(w, photos) {
        // Deterministic random positions based on photo index for consistent layout
        const positions = photos.map((_, i) => {
          const seed = w.id + i * 137;
          const rand = (n) => ((Math.sin(seed * n) * 10000) % 1 + 1) % 1;
          const cols = Math.min(photos.length, 3);
          const col = i % cols;
          const row = Math.floor(i / cols);
          const baseLeft = (col / cols) * 100;
          const baseTop = row * 90;
          return {
            left: Math.max(0, Math.min(baseLeft + (rand(1) - 0.5) * 20, 75)),
            top: baseTop + rand(2) * 15,
            rotate: (rand(3) - 0.5) * 24,
            width: 35 + rand(4) * 20,
          };
        });
        const maxTop = positions.reduce((max, p) => Math.max(max, p.top + 80), 180);
        let items = photos.map((src, i) => {
          const p = positions[i];
          return `<div class="pw-deco-item" style="left:${p.left}%;top:${p.top}px;width:${p.width}%;transform:rotate(${p.rotate}deg);"><img src="${src}" loading="lazy"><div class="pw-deco-del" onclick="event.stopPropagation();removePhotoWallPhoto(${w.id},${i})">‚úï</div></div>`;
        }).join('');
        return `<div class="pw-layout-scattered" style="min-height:${maxTop}px">${items}</div>`;
      }

      function renderGridLayout(w, photos) {
        let items = photos.map((src, i) =>
          `<div class="pw-deco-item"><img src="${src}" loading="lazy"><div class="pw-deco-del" onclick="event.stopPropagation();removePhotoWallPhoto(${w.id},${i})">‚úï</div></div>`
        ).join('');
        return `<div class="pw-layout-grid">${items}</div>`;
      }

      function renderMasonryLayout(w, photos) {
        let items = photos.map((src, i) =>
          `<div class="pw-deco-item"><img src="${src}" loading="lazy"><div class="pw-deco-del" onclick="event.stopPropagation();removePhotoWallPhoto(${w.id},${i})">‚úï</div></div>`
        ).join('');
        return `<div class="pw-layout-masonry">${items}</div>`;
      }

      function switchPhotoWallLayout(widgetId) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w) return;
        const current = w.data.layout || 'scattered';
        const nextIdx = (PW_LAYOUTS.indexOf(current) + 1) % PW_LAYOUTS.length;
        w.data.layout = PW_LAYOUTS[nextIdx];
        storeWidgets(widgets);
        renderWidgets();
        showToast('Â∏ÉÂ±Ä: ' + PW_LAYOUT_NAMES[w.data.layout]);
      }

      // File input for photo wall widget
      let pwWidgetPickTarget = null;
      const pwWidgetFileInput = document.createElement('input');
      pwWidgetFileInput.type = 'file';
      pwWidgetFileInput.accept = 'image/*';
      pwWidgetFileInput.multiple = true;
      pwWidgetFileInput.style.display = 'none';
      document.body.appendChild(pwWidgetFileInput);

      pwWidgetFileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (!files.length || !pwWidgetPickTarget) return;
        const w = widgets.find(x => x.id === pwWidgetPickTarget);
        if (!w) return;
        let loaded = 0;
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = async (ev) => {
            const compressed = await compressImage(ev.target.result, 400);
            if (!w.data.photos) w.data.photos = [];
            w.data.photos.push(compressed);
            loaded++;
            if (loaded === files.length) {
              storeWidgets(widgets);
              renderWidgets();
              showToast(`‚úÖ Â∑≤Ê∑ªÂä† ${files.length} Âº†ÁÖßÁâá`);
            }
          };
          reader.readAsDataURL(file);
        });
        this.value = '';
      });

      function pickPhotoWallPhotos(widgetId) {
        pwWidgetPickTarget = widgetId;
        pwWidgetFileInput.click();
      }

      function removePhotoWallPhoto(widgetId, photoIdx) {
        const w = widgets.find(x => x.id === widgetId);
        if (!w || !w.data.photos) return;
        w.data.photos.splice(photoIdx, 1);
        storeWidgets(widgets);
        renderWidgets();
      }

      // ======= WIDGET DRAG & DROP =======
      let dragWidgetId = null;
      let dragOverWidgetId = null;

      function initWidgetDrag() {
        const area = document.getElementById('widgetArea');
        area.addEventListener('dragstart', e => {
          const card = e.target.closest('.widget-card');
          if (!card) return;
          dragWidgetId = parseInt(card.id.replace('widget-', ''));
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', dragWidgetId);
        });
        area.addEventListener('dragover', e => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          const card = e.target.closest('.widget-card');
          if (card) {
            const id = parseInt(card.id.replace('widget-', ''));
            if (id !== dragWidgetId) {
              document.querySelectorAll('.widget-card.drag-over').forEach(c => c.classList.remove('drag-over'));
              card.classList.add('drag-over');
              dragOverWidgetId = id;
            }
          }
        });
        area.addEventListener('dragleave', e => {
          const card = e.target.closest('.widget-card');
          if (card) card.classList.remove('drag-over');
        });
        area.addEventListener('drop', e => {
          e.preventDefault();
          document.querySelectorAll('.widget-card.drag-over').forEach(c => c.classList.remove('drag-over'));
          document.querySelectorAll('.widget-card.dragging').forEach(c => c.classList.remove('dragging'));
          if (dragWidgetId !== null && dragOverWidgetId !== null && dragWidgetId !== dragOverWidgetId) {
            const fromIdx = widgets.findIndex(w => w.id === dragWidgetId);
            const toIdx = widgets.findIndex(w => w.id === dragOverWidgetId);
            if (fromIdx !== -1 && toIdx !== -1) {
              const [moved] = widgets.splice(fromIdx, 1);
              widgets.splice(toIdx, 0, moved);
              storeWidgets(widgets);
              renderWidgets();
            }
          }
          dragWidgetId = null;
          dragOverWidgetId = null;
        });
        area.addEventListener('dragend', () => {
          document.querySelectorAll('.widget-card.dragging').forEach(c => c.classList.remove('dragging'));
          document.querySelectorAll('.widget-card.drag-over').forEach(c => c.classList.remove('drag-over'));
          dragWidgetId = null;
          dragOverWidgetId = null;
        });

        // Touch drag support
        let touchDragEl = null,
          touchStartY = 0,
          touchClone = null,
          touchFromIdx = -1;
        area.addEventListener(
          'touchstart',
          e => {
            const card = e.target.closest('.widget-card');
            if (
              !card ||
              e.target.closest(
                '.widget-remove, .widget-bg-btn, .pet-btn, .mood-dot, .todo-item, .todo-add, textarea, input, button',
              )
            )
              return;
            touchDragEl = card;
            touchStartY = e.touches[0].clientY;
            touchFromIdx = widgets.findIndex(w => w.id === parseInt(card.id.replace('widget-', '')));
            card._longPress = setTimeout(() => {
              card.classList.add('dragging');
              showToast('ÊãñÂä®ÊéíÂ∫è‰∏≠‚Ä¶');
            }, 400);
          },
          { passive: true },
        );
        area.addEventListener(
          'touchmove',
          e => {
            if (!touchDragEl) return;
            clearTimeout(touchDragEl._longPress);
            if (!touchDragEl.classList.contains('dragging')) return;
            const touch = e.touches[0];
            const cards = Array.from(area.querySelectorAll('.widget-card'));
            cards.forEach(c => c.classList.remove('drag-over'));
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (el) {
              const overCard = el.closest('.widget-card');
              if (overCard && overCard !== touchDragEl) overCard.classList.add('drag-over');
            }
          },
          { passive: true },
        );
        area.addEventListener(
          'touchend',
          e => {
            if (!touchDragEl) return;
            clearTimeout(touchDragEl._longPress);
            if (touchDragEl.classList.contains('dragging')) {
              const overCard = area.querySelector('.widget-card.drag-over');
              if (overCard) {
                const toIdx = widgets.findIndex(w => w.id === parseInt(overCard.id.replace('widget-', '')));
                if (touchFromIdx !== -1 && toIdx !== -1 && touchFromIdx !== toIdx) {
                  const [moved] = widgets.splice(touchFromIdx, 1);
                  widgets.splice(toIdx, 0, moved);
                  storeWidgets(widgets);
                }
              }
              renderWidgets();
            }
            touchDragEl = null;
            touchFromIdx = -1;
          },
          { passive: true },
        );
      }

      // Override renderWidgets to add draggable
      const _origRenderWidgets = renderWidgets;
      renderWidgets = function () {
        _origRenderWidgets();
        document.querySelectorAll('.widget-card').forEach(card => card.setAttribute('draggable', 'true'));
      };

      // ======= WALLPAPER =======
      const DEFAULT_WALLPAPER = 'https://i.postimg.cc/sDbbLQXw/IMG-1715.jpg';
      function loadWallpapers() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_wallpapers') || '{}');
        } catch {
          return {};
        }
      }
      function storeWallpapers(w) {
        safeStore('ai_phone_wallpapers', w);
      }
      let wallpapers = loadWallpapers();

      function applyWallpapers() {
        const lockBg = wallpapers.lock || DEFAULT_WALLPAPER;
        const homeBg = wallpapers.home || DEFAULT_WALLPAPER;
        lockScreen.style.backgroundImage = `url('${lockBg}')`;
        homeScreen.style.backgroundImage = `url('${homeBg}')`;
        // Update previews if settings is open
        const lp = document.getElementById('lockWpPreview');
        const hp = document.getElementById('homeWpPreview');
        if (lp) lp.style.backgroundImage = `url('${lockBg}')`;
        if (hp) hp.style.backgroundImage = `url('${homeBg}')`;
      }

      let wallpaperPickTarget = null;
      function pickWallpaper(target) {
        wallpaperPickTarget = target;
        document.getElementById('wallpaperInput').click();
      }
      document.getElementById('wallpaperInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          wallpapers[wallpaperPickTarget] = ev.target.result;
          storeWallpapers(wallpapers);
          applyWallpapers();
          showToast('‚úÖ Â£ÅÁ∫∏Â∑≤Êõ¥Êç¢');
        };
        reader.readAsDataURL(file);
        this.value = '';
      });
      function resetWallpaper(target) {
        delete wallpapers[target];
        storeWallpapers(wallpapers);
        applyWallpapers();
        showToast('‚úÖ Â∑≤ÊÅ¢Â§çÈªòËÆ§Â£ÅÁ∫∏');
      }

      // Init
      applyWallpapers();

      // ======= CALENDAR APP =======
      let calViewYear, calViewMonth;
      {
        const now = new Date();
        calViewYear = now.getFullYear();
        calViewMonth = now.getMonth();
      }

      function openCalendarApp() {
        renderCalendarApp();
        pushScreen('calendarApp');
      }
      function closeCalendarApp() {
        popScreen();
      }
      function calendarPrevMonth() {
        calViewMonth--;
        if (calViewMonth < 0) {
          calViewMonth = 11;
          calViewYear--;
        }
        renderCalendarApp();
      }
      function calendarNextMonth() {
        calViewMonth++;
        if (calViewMonth > 11) {
          calViewMonth = 0;
          calViewYear++;
        }
        renderCalendarApp();
      }

      function renderCalendarApp() {
        const body = document.getElementById('calAppBody');
        const now = new Date();
        const year = calViewYear,
          month = calViewMonth;
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const isCurrentMonth = year === now.getFullYear() && month === now.getMonth();
        const today = isCurrentMonth ? now.getDate() : -1;
        const dayNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
        const annivs = loadAnniversaries();

        // Check which days have events (anniversaries)
        const eventDays = new Set();
        annivs.forEach(a => {
          const d = new Date(a.date);
          if (d.getFullYear() === year && d.getMonth() === month) eventDays.add(d.getDate());
        });

        let cells = dayNames.map(d => `<div class="cal-hd">${d}</div>`).join('');
        for (let i = 0; i < firstDay; i++) cells += '<div class="cal-cell empty">.</div>';
        for (let d = 1; d <= daysInMonth; d++) {
          const classes = ['cal-cell'];
          if (d === today) classes.push('today');
          if (eventDays.has(d)) classes.push('has-event');
          cells += `<div class="${classes.join(' ')}">${d}</div>`;
        }

        // Events this month
        const monthEvents = annivs
          .filter(a => {
            const d = new Date(a.date);
            return d.getMonth() === month; // Show anniversary month regardless of year
          })
          .map(a => {
            const d = new Date(a.date);
            const diff = Math.floor((now - d) / (1000 * 60 * 60 * 24));
            const label = diff >= 0 ? `${diff} Â§©Ââç` : `${-diff} Â§©Âêé`;
            return `<div class="cal-ev-item"><div class="cal-ev-icon">${a.icon || 'üìÖ'}</div><div class="cal-ev-info"><div class="cal-ev-name">${esc(a.title)}</div><div class="cal-ev-date">${a.date}</div></div><div class="cal-ev-days">${label}</div></div>`;
          })
          .join('');

        body.innerHTML =
          `<div class="cal-app-month">${year}Âπ¥${month + 1}Êúà</div><div class="cal-app-grid">${cells}</div>` +
          (monthEvents
            ? `<div class="cal-app-events"><div class="cal-ev-title">Êú¨ÊúàÁ∫™ÂøµÊó•</div>${monthEvents}</div>`
            : '');
      }

      // ======= ANNIVERSARY APP =======
      function loadAnniversaries() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_anniv') || '[]');
        } catch {
          return [];
        }
      }
      function storeAnniversaries(a) {
        safeStore('ai_phone_anniv', a);
      }
      let anniversaries = loadAnniversaries();
      let editingAnnivId = null;

      function openAnniversaryApp() {
        renderAnniversaries();
        pushScreen('anniversary');
      }
      function closeAnniversaryApp() {
        popScreen();
      }

      function renderAnniversaries() {
        const body = document.getElementById('annivBody');
        const annivs = loadAnniversaries();
        if (annivs.length === 0) {
          body.innerHTML =
            '<div class="anniv-empty"><div class="anniv-empty-icon">üíù</div><div>ËøòÊ≤°ÊúâÁ∫™ÂøµÊó•</div><div>ÁÇπÂáªÂè≥‰∏äËßí Ôºã Ê∑ªÂä†</div></div>';
          return;
        }
        const now = new Date();
        body.innerHTML = annivs
          .map(a => {
            const d = new Date(a.date);
            const diff = Math.abs(Math.floor((now - d) / (1000 * 60 * 60 * 24)));
            const isPast = now >= d;
            const label = isPast ? 'Â§©' : 'Â§©Âêé';
            return `<div class="anniv-card"><div class="anniv-delete" onclick="deleteAnniversary(${a.id})">‚úï</div><div class="anniv-icon">${a.icon || 'üíù'}</div><div class="anniv-title">${esc(a.title)}</div><div class="anniv-days">${diff}</div><div class="anniv-label">${label}</div><div class="anniv-date-info">üìÖ ${a.date}</div></div>`;
          })
          .join('');
      }

      function openAddAnniversary() {
        editingAnnivId = null;
        document.getElementById('annivModalTitle').textContent = 'Ê∑ªÂä†Á∫™ÂøµÊó•';
        document.getElementById('annivTitle').value = '';
        document.getElementById('annivDate').value = new Date().toISOString().slice(0, 10);
        document.getElementById('annivIcon').value = 'üíù';
        document.getElementById('annivModal').classList.add('show');
      }

      function closeAnnivModal() {
        document.getElementById('annivModal').classList.remove('show');
        editingAnnivId = null;
      }

      function saveAnniversary() {
        const title = document.getElementById('annivTitle').value.trim();
        const date = document.getElementById('annivDate').value;
        const icon = document.getElementById('annivIcon').value.trim() || 'üíù';
        if (!title) {
          showToast('‚ö†Ô∏è ËØ∑ËæìÂÖ•Ê†áÈ¢ò');
          return;
        }
        if (!date) {
          showToast('‚ö†Ô∏è ËØ∑ÈÄâÊã©Êó•Êúü');
          return;
        }
        const annivs = loadAnniversaries();
        annivs.push({ id: Date.now(), title, date, icon });
        storeAnniversaries(annivs);
        closeAnnivModal();
        renderAnniversaries();
        showToast('‚úÖ Á∫™ÂøµÊó•Â∑≤Ê∑ªÂä†');
      }

      function deleteAnniversary(id) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•Á∫™ÂøµÊó•Ôºü')) return;
        let annivs = loadAnniversaries();
        annivs = annivs.filter(a => a.id !== id);
        storeAnniversaries(annivs);
        renderAnniversaries();
        showToast('Â∑≤Âà†Èô§');
      }

      // ======= HOME PAGE PAGINATION =======
      const homePages = document.getElementById('homePages');
      const pageDots = document.getElementById('pageDots');

      function goToPage(pageIndex) {
        const pages = homePages.querySelectorAll('.home-page');
        if (pageIndex < 0 || pageIndex >= pages.length) return;
        homePages.scrollTo({ left: pageIndex * homePages.clientWidth, behavior: 'smooth' });
        updatePageDots(pageIndex);
      }

      function updatePageDots(activeIndex) {
        const dots = pageDots.querySelectorAll('.page-dot');
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === activeIndex);
        });
      }

      homePages.addEventListener('scroll', () => {
        const scrollLeft = homePages.scrollLeft;
        const pageWidth = homePages.clientWidth;
        const currentPage = Math.round(scrollLeft / pageWidth);
        updatePageDots(currentPage);
      });

      // ======= DATA-DRIVEN HOME PAGES =======
      const APP_DEFS = [
        { id: 'contacts', name: '‰ø°ÊÅØ', icon: 'https://i.postimg.cc/1fnmsLFC/IMG-1711.jpg', action: 'openContacts' },
        { id: 'weibo', name: 'ÂæÆÂçö', icon: 'https://i.postimg.cc/TpLdfZbz/IMG-1709.jpg', action: 'openWeibo' },
        {
          id: 'calendar',
          name: 'Êó•ÂéÜ',
          icon: 'https://i.postimg.cc/QH3DXzJr/wei-xin-tu-pian-20260225055225-1195-11.jpg',
          action: 'openCalendarApp',
        },
        {
          id: 'anniversary',
          name: 'Á∫™ÂøµÊó•',
          icon: 'https://i.postimg.cc/mts4bnyW/wei-xin-tu-pian-20260225055226-1196-11.jpg',
          action: 'openAnniversaryApp',
        },
        {
          id: 'musicApp',
          name: 'Èü≥‰πê',
          icon: '',
          action: 'openMusicApp',
          svgIcon:
            '<svg viewBox="0 0 24 24" width="32" height="32" stroke="white" stroke-width="2" fill="none"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
        },
        {
          id: 'shop',
          name: 'ÂïÜÂüé',
          icon: '',
          action: 'openShop',
          svgIcon:
            '<svg viewBox="0 0 24 24" width="32" height="32" stroke="white" stroke-width="2" fill="none"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>',
        },
        {
          id: 'settings',
          name: 'ËÆæÁΩÆ',
          icon: 'https://i.postimg.cc/8sWDgGWq/wei-xin-tu-pian-20260225055224-1194-11.jpg',
          action: 'openSettings',
        },
        {
          id: 'memory',
          name: 'ËÆ∞ÂøÜ',
          icon: '',
          action: 'openMemoryScreen',
          svgIcon:
            '<svg viewBox="0 0 24 24" width="32" height="32" stroke="white" stroke-width="2" fill="none"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><line x1="10" y1="22" x2="14" y2="22"/></svg>',
        },
        {
          id: 'photowall',
          name: 'Áõ∏ÂÜå',
          icon: '',
          action: 'openPhotowall',
          svgIcon:
            '<svg viewBox="0 0 24 24" width="32" height="32" stroke="white" stroke-width="2" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
        },
      ];

      function loadHomeLayout() {
        try {
          const l = localStorage.getItem('ai_phone_home_layout');
          if (l) return JSON.parse(l);
        } catch {}
        // Default layout: all apps on page 0
        return {
          pages: [{ apps: APP_DEFS.map(a => a.id) }, { apps: [] }],
        };
      }
      function storeHomeLayout(layout) {
        safeStore('ai_phone_home_layout', layout);
      }
      let homeLayout = loadHomeLayout();
      // Ensure layout has 2 pages
      if (!homeLayout.pages || homeLayout.pages.length < 2) {
        homeLayout = { pages: [{ apps: APP_DEFS.map(a => a.id) }, { apps: [] }] };
        storeHomeLayout(homeLayout);
      }

      // ======= HOME DECORATIVE ELEMENTS DATA =======
      function loadHomeDecoData() {
        try { return JSON.parse(localStorage.getItem('ai_phone_home_deco') || '{}'); } catch { return {}; }
      }
      function storeHomeDecoData(d) { safeStore('ai_phone_home_deco', d); }
      let homeDecoData = loadHomeDecoData();

      function renderProfileBanner() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2,'0');
        const m = String(now.getMinutes()).padStart(2,'0');
        const days = ['ÊòüÊúüÊó•','ÊòüÊúü‰∏Ä','ÊòüÊúü‰∫å','ÊòüÊúü‰∏â','ÊòüÊúüÂõõ','ÊòüÊúü‰∫î','ÊòüÊúüÂÖ≠'];
        const dayStr = '‰ªäÂ§©ÊòØ ' + days[now.getDay()];
        const dateStr = String(now.getMonth()+1).padStart(2,'0') + '/' + String(now.getDate()).padStart(2,'0');
        const yearStr = now.getFullYear() + 'Âπ¥';
        const avatarSrc = homeDecoData.bannerAvatar || settings.userAvatar || '';
        const name = homeDecoData.bannerName || settings.userName || 'Êàë';
        const avatarHtml = avatarSrc
          ? `<img src="${avatarSrc}">`
          : `<span style="font-size:28px;color:#e91e63;">‚ô°</span>`;
        return `<div class="home-profile-banner" id="homeProfileBanner">
          <div class="pb-time-block">
            <div class="pb-time">${h}:${m}</div>
            <div class="pb-day">${dayStr}</div>
          </div>
          <div class="pb-avatar-area">
            <div class="pb-avatar" onclick="pickHomeBannerAvatar()">${avatarHtml}</div>
            <div class="pb-name" onclick="editHomeBannerName()">${esc(name)}</div>
          </div>
          <div class="pb-date-block">
            <div class="pb-heart">‚ô•</div>
            <div class="pb-date">${dateStr}</div>
            <div class="pb-year">${yearStr}</div>
          </div>
        </div>`;
      }

      function renderHomeMusicCard() {
        const d = homeDecoData.music || {};
        const userName = d.userName || settings.userName || 'Êàë';
        const userAvatar = d.userAvatar || settings.userAvatar || '';
        const songTitle = d.songTitle || 'ÂΩìÂâçÊí≠Êîæ';
        const songArtist = d.songArtist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';
        const coverSrc = d.coverSrc || '';
        const userAvatarHtml = userAvatar
          ? `<img src="${userAvatar}">`
          : 'üë§';
        const coverHtml = coverSrc
          ? `<img src="${coverSrc}">`
          : 'üéµ';
        return `<div class="home-music-card">
          <div class="hm-header">
            <div class="hm-avatar">${userAvatarHtml}</div>
            <div class="hm-info">
              <div class="hm-user">${esc(userName)}</div>
              <div class="hm-status">Ê≠£Âú®ËæìÂÖ•...</div>
            </div>
            <span style="color:#ccc;font-size:14px;cursor:pointer;" onclick="editHomeMusicCard()">‚ãØ</span>
          </div>
          <div class="hm-now">
            <div class="hm-cover">${coverHtml}</div>
            <div class="hm-song-info">
              <div class="hm-song-title">${esc(songTitle)}</div>
              <div class="hm-song-artist">${esc(songArtist)}</div>
            </div>
          </div>
          <div class="hm-progress"><div class="hm-progress-fill" style="width:${30 + Math.random()*40}%"></div></div>
          <div class="hm-controls">
            <span class="hm-ctrl" onclick="openMusicApp()">‚èÆ</span>
            <span class="hm-ctrl" onclick="openMusicApp()">‚è∏</span>
            <span class="hm-ctrl" onclick="openMusicApp()">‚è≠</span>
          </div>
        </div>`;
      }

      let homePhotoIdx = 0;
      function renderHomePhotoWallCard() {
        const pw = homeDecoData.photoWall || [];
        if (pw.length === 0) {
          return `<div class="home-photo-wall" onclick="pickHomePhotoWall()">
            <div class="hpw-title"><span style="font-family:'CustomFont',cursive;">My Diary</span><span class="hpw-lock">üîí</span></div>
            <div class="hpw-empty"><span style="font-size:28px;">üñºÔ∏è</span><span>ÁÇπÂáªÊ∑ªÂä†ÁÖßÁâá</span></div>
            <div class="hpw-label">Miao Widgets</div>
          </div>`;
        }
        if (homePhotoIdx >= pw.length) homePhotoIdx = 0;
        if (homePhotoIdx < 0) homePhotoIdx = pw.length - 1;
        const dots = pw.slice(0,8).map((_, i) => `<div class="hpw-dot ${i === homePhotoIdx ? 'active' : ''}"></div>`).join('');
        return `<div class="home-photo-wall" onclick="pickHomePhotoWall()">
          <div class="hpw-title"><span style="font-family:'CustomFont',cursive;">My Diary</span><span class="hpw-lock">üîí</span></div>
          <div class="hpw-single">
            <img src="${pw[homePhotoIdx]}" loading="lazy">
            <div class="hpw-arrows">
              <div class="hpw-arrow" onclick="event.stopPropagation();homePhotoPrev()">‚Äπ</div>
              <div class="hpw-arrow" onclick="event.stopPropagation();homePhotoNext()">‚Ä∫</div>
            </div>
            <div class="hpw-nav">${dots}</div>
          </div>
          <div class="hpw-label">Miao Widgets ¬∑ ${homePhotoIdx+1}/${pw.length}</div>
        </div>`;
      }
      function homePhotoPrev() {
        const pw = homeDecoData.photoWall || [];
        if (pw.length === 0) return;
        homePhotoIdx = (homePhotoIdx - 1 + pw.length) % pw.length;
        renderHomePages();
      }
      function homePhotoNext() {
        const pw = homeDecoData.photoWall || [];
        if (pw.length === 0) return;
        homePhotoIdx = (homePhotoIdx + 1) % pw.length;
        renderHomePages();
      }

      // Home banner avatar picker
      function pickHomeBannerAvatar() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*';
        input.onchange = e => {
          const file = e.target.files[0]; if (!file) return;
          const reader = new FileReader();
          reader.onload = async ev => {
            homeDecoData.bannerAvatar = await compressImage(ev.target.result, 128);
            storeHomeDecoData(homeDecoData);
            renderHomePages();
          };
          reader.readAsDataURL(file);
        };
        input.click();
      }
      function editHomeBannerName() {
        const name = prompt('ËæìÂÖ•ÂêçÁß∞Ôºö', homeDecoData.bannerName || settings.userName || 'Êàë');
        if (name === null) return;
        homeDecoData.bannerName = name.trim();
        storeHomeDecoData(homeDecoData);
        renderHomePages();
      }
      function editHomeMusicCard() {
        const title = prompt('Ê≠åÊõ≤ÂêçÁß∞Ôºö', (homeDecoData.music||{}).songTitle || 'ÂΩìÂâçÊí≠Êîæ');
        if (title === null) return;
        const artist = prompt('Ëâ∫ÊúØÂÆ∂Ôºö', (homeDecoData.music||{}).songArtist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂');
        if (!homeDecoData.music) homeDecoData.music = {};
        homeDecoData.music.songTitle = title.trim();
        homeDecoData.music.songArtist = (artist||'').trim();
        storeHomeDecoData(homeDecoData);
        renderHomePages();
      }

      // Home photo wall picker
      function pickHomePhotoWall() {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = 'image/*'; input.multiple = true;
        input.onchange = e => {
          const files = Array.from(e.target.files);
          if (!files.length) return;
          if (!homeDecoData.photoWall) homeDecoData.photoWall = [];
          let loaded = 0;
          files.forEach(file => {
            const reader = new FileReader();
            reader.onload = async ev => {
              const compressed = await compressImage(ev.target.result, 300);
              homeDecoData.photoWall.push(compressed);
              loaded++;
              if (loaded === files.length) {
                storeHomeDecoData(homeDecoData);
                renderHomePages();
                showToast(`‚úÖ Â∑≤Ê∑ªÂä† ${files.length} Âº†ÁÖßÁâá`);
              }
            };
            reader.readAsDataURL(file);
          });
        };
        input.click();
      }

      // Update profile banner time every minute
      setInterval(() => {
        const banner = document.getElementById('homeProfileBanner');
        if (banner) {
          const now = new Date();
          const timeEl = banner.querySelector('.pb-time');
          if (timeEl) timeEl.textContent = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
        }
      }, 10000);

      const MAX_WIDGETS_PAGE0 = 3; // max widgets on first page before overflow

      function renderHomePages() {
        // Split widgets across pages
        const page0Widgets = widgets.slice(0, MAX_WIDGETS_PAGE0);
        const page1Widgets = widgets.slice(MAX_WIDGETS_PAGE0);

        for (let pageIdx = 0; pageIdx < 2; pageIdx++) {
          const pageEl = document.getElementById(`homePage${pageIdx}`);
          if (!pageEl) continue;
          const pageData = homeLayout.pages[pageIdx] || { apps: [] };

          let html = '';

          // Page 0: Profile banner + music/photo row + widgets + apps
          if (pageIdx === 0) {
            html += renderProfileBanner();
            html += '<div class="home-widgets-row">';
            html += renderHomeMusicCard();
            html += renderHomePhotoWallCard();
            html += '</div>';
            html += '<div class="widget-area" id="widgetArea"></div>';
            html += '<div class="add-widget-btn" onclick="openWidgetPicker()">‚ú® Ê∑ªÂä†Â∞èÁªÑ‰ª∂</div>';
          }

          // Page 1: overflow widgets + apps (always show add button)
          if (pageIdx === 1) {
            if (page1Widgets.length > 0) {
              html += '<div class="widget-area" id="widgetArea1"></div>';
            }
            html += '<div class="add-widget-btn" onclick="openWidgetPicker()">Ôºã Ê∑ªÂä†Â∞èÁªÑ‰ª∂</div>';
          }

          // App grid
          if (pageData.apps.length > 0) {
            html += '<div class="app-grid">';
            pageData.apps.forEach(appId => {
              const app = APP_DEFS.find(a => a.id === appId);
              if (!app) return;
              html += `<div class="app-icon" data-app-id="${app.id}" onclick="${app.action}()">`;
              if (app.icon) {
                html += `<div class="icon-box"><img src="${app.icon}" alt="${esc(app.name)}" /></div>`;
              } else if (app.svgIcon) {
                const bgColors = {
                  musicApp: 'linear-gradient(135deg,#e94560,#533483)',
                  shop: 'linear-gradient(135deg,#ff6b9d,#e91e63)',
                };
                html += `<div class="icon-box" style="background:${bgColors[app.id] || '#eee'};display:flex;align-items:center;justify-content:center;">${app.svgIcon}</div>`;
              } else {
                const bgColors = {
                  musicApp: 'linear-gradient(135deg,#e94560,#533483)',
                  shop: 'linear-gradient(135deg,#ff6b9d,#e91e63)',
                };
                html += `<div class="icon-box" style="background:${bgColors[app.id] || '#eee'};font-size:28px;">${app.emoji || 'üì±'}</div>`;
              }
              html += `<div class="app-name">${esc(app.name)}</div>`;
              html += '</div>';
            });
            html += '</div>';
          }

          // Empty page hint for page 1 if nothing on it
          if (pageIdx === 1 && pageData.apps.length === 0 && page1Widgets.length === 0) {
            html +=
              '<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0.5;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,0.5);gap:12px;padding:40px;">';
            html += '<div style="font-size:48px;">üì±</div>';
            html += '<div style="font-size:14px;">ÂêëÂ∑¶ÊªëÂä®Êü•ÁúãÊõ¥Â§ö</div>';
            html += '<div style="font-size:12px;opacity:0.7;">Â∞èÁªÑ‰ª∂Ë∂ÖÂá∫Êó∂‰ºöËá™Âä®Âá∫Áé∞Âú®ËøôÈáå</div>';
            html += '</div>';
          }

          pageEl.innerHTML = html;
        }

        // Render widgets into their respective areas
        renderWidgetsInto('widgetArea', page0Widgets);
        if (page1Widgets.length > 0) {
          renderWidgetsInto('widgetArea1', page1Widgets);
        }
        initWidgetDrag();
        initAppDrag();
      }

      // ======= APP ICON DRAG & DROP =======
      let appDragId = null;
      let appDragOverId = null;
      function initAppDrag() {
        document.querySelectorAll('.app-grid .app-icon').forEach(icon => {
          icon.setAttribute('draggable', 'true');
          icon.addEventListener('dragstart', e => {
            appDragId = icon.dataset.appId;
            icon.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', appDragId);
          });
          icon.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (icon.dataset.appId !== appDragId) {
              document.querySelectorAll('.app-icon.drag-over').forEach(c => c.classList.remove('drag-over'));
              icon.classList.add('drag-over');
              appDragOverId = icon.dataset.appId;
            }
          });
          icon.addEventListener('dragleave', () => icon.classList.remove('drag-over'));
          icon.addEventListener('drop', e => {
            e.preventDefault();
            document.querySelectorAll('.app-icon.drag-over').forEach(c => c.classList.remove('drag-over'));
            document.querySelectorAll('.app-icon.dragging').forEach(c => c.classList.remove('dragging'));
            if (appDragId && appDragOverId && appDragId !== appDragOverId) {
              // Find which page both belong to and swap
              for (const page of homeLayout.pages) {
                const fromIdx = page.apps.indexOf(appDragId);
                const toIdx = page.apps.indexOf(appDragOverId);
                if (fromIdx !== -1 && toIdx !== -1) {
                  [page.apps[fromIdx], page.apps[toIdx]] = [page.apps[toIdx], page.apps[fromIdx]];
                  storeHomeLayout(homeLayout);
                  renderHomePages();
                  break;
                }
              }
            }
            appDragId = null; appDragOverId = null;
          });
          icon.addEventListener('dragend', () => {
            document.querySelectorAll('.app-icon.dragging').forEach(c => c.classList.remove('dragging'));
            document.querySelectorAll('.app-icon.drag-over').forEach(c => c.classList.remove('drag-over'));
            appDragId = null; appDragOverId = null;
          });
        });
      }

      // Render widgets into a specific container element
      function renderWidgetsInto(containerId, widgetList) {
        const area = document.getElementById(containerId);
        if (!area) return;
        if (widgetList.length === 0) {
          area.innerHTML = '';
          return;
        }
        area.innerHTML = widgetList
          .map(w => {
            const bgStyle = w.bg ? `<div class="widget-bg" style="background-image:url(${w.bg})"></div>` : '';
            return `<div class="widget-card" id="widget-${w.id}" draggable="true">${bgStyle}<div class="widget-remove" onclick="event.stopPropagation();removeWidget(${w.id})">‚úï</div><div class="widget-bg-btn" onclick="event.stopPropagation();pickWidgetBg(${w.id})">üñº</div><div class="widget-content">${renderWidgetContent(w)}</div></div>`;
          })
          .join('');
        // Start clock updates
        widgetList.forEach(w => {
          if (w.type === 'clock') updateClockWidget(w.id);
        });
      }

      // Initial render
      renderHomePages();

      // ======= API LAYER =======
      const API_BASE = 'http://localhost:4000';
      async function apiFetch(path, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        const resp = await fetch(API_BASE + path, { ...options, headers });
        if (resp.status === 401) {
          // Token expired, clear and go back to auth
          authToken = null;
          localStorage.removeItem('ai_phone_token');
          serverMode = false;
          document.getElementById('authScreen').classList.remove('hidden');
          showToast('‚ö†Ô∏è ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
          throw new Error('Unauthorized');
        }
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
        return data;
      }

      // Sync data from server after login
      async function syncFromServer() {
        if (!serverMode || !authToken) return;
        try {
          // Sync contacts
          const serverContacts = await apiFetch('/api/contacts');
          if (serverContacts.length > 0) {
            // Merge: server data takes priority, but keep local-only contacts
            const serverIds = new Set(serverContacts.map(c => c.id));
            const localOnly = contacts.filter(c => !serverIds.has(c.id));
            contacts = [
              ...serverContacts.map(c => ({
                ...c,
                messages: c.messages || [],
                pinned: c.pinned || false,
                muted: c.muted || false,
                chatBg: c.chatBg || '',
              })),
              ...localOnly,
            ];
          }
          // Push local contacts to server if server had none
          if (serverContacts.length === 0 && contacts.length > 0) {
            for (const c of contacts) {
              try {
                await apiFetch('/api/contacts', { method: 'POST', body: JSON.stringify(c) });
              } catch {}
            }
          }
          storeContacts(contacts);

          // Sync settings
          try {
            const serverSettings = await apiFetch('/api/settings');
            if (serverSettings && Object.keys(serverSettings).length > 0) {
              settings = { ...defaultSettings, ...serverSettings };
              storeSettings(settings);
            }
          } catch {}

          // Sync widgets
          try {
            const serverWidgets = await apiFetch('/api/widgets');
            if (serverWidgets.length > 0) {
              widgets = serverWidgets;
              storeWidgets(widgets);
            }
          } catch {}

          // Sync weibo
          try {
            const serverWeibo = await apiFetch('/api/weibo');
            if (serverWeibo.length > 0) {
              weiboPosts = serverWeibo;
              storeWeiboPosts(weiboPosts);
            }
          } catch {}

          // Sync anniversaries
          try {
            const serverAnniv = await apiFetch('/api/anniversaries');
            if (serverAnniv.length > 0) {
              anniversaries = serverAnniv;
              storeAnniversaries(anniversaries);
            }
          } catch {}

          // Sync memories
          try {
            const serverMemories = await apiFetch('/api/memories');
            if (serverMemories.length > 0) {
              memories = serverMemories;
              storeMemories(memories);
            } else if (memories.length > 0) {
              for (const m of memories) {
                try {
                  await apiFetch('/api/memories', { method: 'POST', body: JSON.stringify(m) });
                } catch {}
              }
            }
          } catch {}

          renderHomePages();
          console.log('‚úÖ Data synced from server');
        } catch (e) {
          console.warn('Sync failed:', e.message);
        }
      }

      // Wrap store functions to also push to server
      const _origStoreContacts = storeContacts;
      storeContacts = function (c) {
        _origStoreContacts(c);
        if (serverMode && authToken) {
          // Debounced server sync
          clearTimeout(storeContacts._timer);
          storeContacts._timer = setTimeout(async () => {
            try {
              // Simple approach: replace all contacts on server
              const serverContacts = await apiFetch('/api/contacts');
              const serverIds = new Set(serverContacts.map(x => x.id));
              // Update existing, create new
              for (const contact of c) {
                if (serverIds.has(contact.id)) {
                  await apiFetch(`/api/contacts/${contact.id}`, { method: 'PUT', body: JSON.stringify(contact) });
                } else {
                  await apiFetch('/api/contacts', { method: 'POST', body: JSON.stringify(contact) });
                }
              }
              // Delete removed contacts
              const localIds = new Set(c.map(x => x.id));
              for (const sc of serverContacts) {
                if (!localIds.has(sc.id)) {
                  await apiFetch(`/api/contacts/${sc.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) {
              console.warn('Contact sync error:', e.message);
            }
          }, 1000);
        }
      };

      const _origStoreSettings = storeSettings;
      storeSettings = function (s) {
        _origStoreSettings(s);
        if (serverMode && authToken) {
          apiFetch('/api/settings', { method: 'PUT', body: JSON.stringify(s) }).catch(e =>
            console.warn('Settings sync error:', e.message),
          );
        }
      };

      const _origStoreWidgets = storeWidgets;
      storeWidgets = function (w) {
        _origStoreWidgets(w);
        if (serverMode && authToken) {
          clearTimeout(storeWidgets._timer);
          storeWidgets._timer = setTimeout(async () => {
            try {
              const serverWidgets = await apiFetch('/api/widgets');
              const serverIds = new Set(serverWidgets.map(x => x.id));
              for (const widget of w) {
                if (serverIds.has(widget.id)) {
                  await apiFetch(`/api/widgets/${widget.id}`, { method: 'PUT', body: JSON.stringify(widget) });
                } else {
                  await apiFetch('/api/widgets', { method: 'POST', body: JSON.stringify(widget) });
                }
              }
              const localIds = new Set(w.map(x => x.id));
              for (const sw of serverWidgets) {
                if (!localIds.has(sw.id)) {
                  await apiFetch(`/api/widgets/${sw.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) {
              console.warn('Widget sync error:', e.message);
            }
          }, 1000);
        }
      };

      const _origStoreWeiboPosts = storeWeiboPosts;
      storeWeiboPosts = function (w) {
        _origStoreWeiboPosts(w);
        if (serverMode && authToken) {
          clearTimeout(storeWeiboPosts._timer);
          storeWeiboPosts._timer = setTimeout(async () => {
            try {
              const serverWeibo = await apiFetch('/api/weibo');
              const serverIds = new Set(serverWeibo.map(x => x.id));
              for (const post of w) {
                if (serverIds.has(post.id)) {
                  await apiFetch(`/api/weibo/${post.id}`, { method: 'PUT', body: JSON.stringify(post) });
                } else {
                  await apiFetch('/api/weibo', { method: 'POST', body: JSON.stringify(post) });
                }
              }
              const localIds = new Set(w.map(x => x.id));
              for (const sp of serverWeibo) {
                if (!localIds.has(sp.id)) {
                  await apiFetch(`/api/weibo/${sp.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) {
              console.warn('Weibo sync error:', e.message);
            }
          }, 1000);
        }
      };

      const _origStoreMemories = storeMemories;
      storeMemories = function (m) {
        _origStoreMemories(m);
        if (serverMode && authToken) {
          clearTimeout(storeMemories._timer);
          storeMemories._timer = setTimeout(async () => {
            try {
              const serverMemories = await apiFetch('/api/memories');
              const serverIds = new Set(serverMemories.map(x => x.id));
              for (const mem of m) {
                if (serverIds.has(mem.id)) {
                  await apiFetch(`/api/memories/${mem.id}`, { method: 'PUT', body: JSON.stringify(mem) });
                } else {
                  await apiFetch('/api/memories', { method: 'POST', body: JSON.stringify(mem) });
                }
              }
              const localIds = new Set(m.map(x => x.id));
              for (const sm of serverMemories) {
                if (!localIds.has(sm.id)) {
                  await apiFetch(`/api/memories/${sm.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) {
              console.warn('Memory sync error:', e.message);
            }
          }, 1000);
        }
      };

      const _origStoreAnniversaries = storeAnniversaries;
      storeAnniversaries = function (a) {
        _origStoreAnniversaries(a);
        if (serverMode && authToken) {
          clearTimeout(storeAnniversaries._timer);
          storeAnniversaries._timer = setTimeout(async () => {
            try {
              const serverAnniv = await apiFetch('/api/anniversaries');
              const serverIds = new Set(serverAnniv.map(x => x.id));
              for (const ann of a) {
                if (serverIds.has(ann.id)) {
                  await apiFetch(`/api/anniversaries/${ann.id}`, { method: 'PUT', body: JSON.stringify(ann) });
                } else {
                  await apiFetch('/api/anniversaries', { method: 'POST', body: JSON.stringify(ann) });
                }
              }
              const localIds = new Set(a.map(x => x.id));
              for (const sa of serverAnniv) {
                if (!localIds.has(sa.id)) {
                  await apiFetch(`/api/anniversaries/${sa.id}`, { method: 'DELETE' });
                }
              }
            } catch (e) {
              console.warn('Anniversary sync error:', e.message);
            }
          }, 1000);
        }
      };

      // ======= AUTH =======
      let authMode = 'login'; // 'login' | 'register'
      let authToken = localStorage.getItem('ai_phone_token') || null;
      let serverMode = !!authToken;

      function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        document.getElementById('authTitle').textContent = authMode === 'login' ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
        document.getElementById('authBtn').textContent = authMode === 'login' ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
        document.getElementById('authToggle').textContent = authMode === 'login' ? 'Ê≤°ÊúâË¥¶Âè∑ÔºüÊ≥®ÂÜå' : 'Â∑≤ÊúâË¥¶Âè∑ÔºüÁôªÂΩï';
        document.getElementById('authError').style.display = 'none';
      }

      async function doAuth() {
        const username = document.getElementById('authUsername').value.trim();
        const password = document.getElementById('authPassword').value.trim();
        const errEl = document.getElementById('authError');
        if (!username || !password) {
          errEl.textContent = 'ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å';
          errEl.style.display = 'block';
          return;
        }
        const btn = document.getElementById('authBtn');
        btn.disabled = true;
        btn.textContent = 'ËØ∑Á®çÂÄô‚Ä¶';
        try {
          const url = API_BASE + (authMode === 'login' ? '/api/auth/login' : '/api/auth/register');
          const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password }),
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.error || 'Êìç‰ΩúÂ§±Ë¥•');
          authToken = data.token;
          localStorage.setItem('ai_phone_token', authToken);
          serverMode = true;
          errEl.style.display = 'none';
          document.getElementById('authScreen').classList.add('hidden');
          showToast('‚úÖ ' + (authMode === 'login' ? 'ÁôªÂΩïÊàêÂäü' : 'Ê≥®ÂÜåÊàêÂäü'));
          // Sync data from server after login
          syncFromServer();
        } catch (e) {
          errEl.textContent = e.message;
          errEl.style.display = 'block';
        } finally {
          btn.disabled = false;
          btn.textContent = authMode === 'login' ? 'ÁôªÂΩï' : 'Ê≥®ÂÜå';
        }
      }

      function skipAuth() {
        serverMode = false;
        document.getElementById('authScreen').classList.add('hidden');
      }

      // Auto-skip auth if token exists
      if (authToken) {
        document.getElementById('authScreen').classList.add('hidden');
        serverMode = true;
        // Sync data from server on page load
        syncFromServer();
      }

      // ======= CHAT DROPDOWN MENU =======
      let chatMenuOpen = false;
      function toggleChatMenu() {
        if (chatMenuOpen) {
          closeChatMenu();
          return;
        }
        const c = contacts.find(x => x.id === currentContactId);
        if (!c) return;
        chatMenuOpen = true;
        const menu = document.getElementById('chatDropdownMenu');
        const pinText = c.pinned ? 'üìå ÂèñÊ∂àÁΩÆÈ°∂' : 'üìå ÁΩÆÈ°∂ËÅäÂ§©';
        const muteText = c.muted ? 'üîî ÂºÄÂêØÈÄöÁü•' : 'üîï Ê∂àÊÅØÂÖçÊâìÊâ∞';
        const groupItem = c.isGroup
          ? `<div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('groupManage')">üë• Áæ§ÁÆ°ÁêÜ</div>`
          : '';
        menu.innerHTML = `
          ${groupItem}
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('edit')">‚úèÔ∏è ‰øÆÊîπÂ§áÊ≥®</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('pin')">${pinText}</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('mute')">${muteText}</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('memory')">üß† ÈïøÊúüËÆ∞ÂøÜ</div>
          <div style="padding:12px 16px;border-bottom:0.5px solid #f0f0f0;cursor:pointer;font-size:14px;color:#333;" onclick="chatMenuAction('clear')">üßπ Ê∏ÖÁ©∫ËÅäÂ§©</div>
          <div style="padding:12px 16px;cursor:pointer;font-size:14px;color:#ff3b30;" onclick="chatMenuAction('delete')">üóëÔ∏è Âà†Èô§ËÅîÁ≥ª‰∫∫</div>
        `;
        menu.style.display = 'block';
        // Close when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeChatMenuOutside, { once: true });
        }, 10);
      }
      function closeChatMenu() {
        chatMenuOpen = false;
        document.getElementById('chatDropdownMenu').style.display = 'none';
        document.removeEventListener('click', closeChatMenuOutside);
      }
      function closeChatMenuOutside(e) {
        if (!document.getElementById('chatDropdownMenu').contains(e.target) && e.target.id !== 'chatMenuBtn') {
          closeChatMenu();
        }
      }
      function chatMenuAction(action) {
        closeChatMenu();
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        if (!c) return;
        switch (action) {
          case 'edit':
            editCurrentContact();
            break;
          case 'pin':
            c.pinned = !c.pinned;
            storeContacts(contacts);
            showToast(c.pinned ? 'Â∑≤ÁΩÆÈ°∂' : 'Â∑≤ÂèñÊ∂àÁΩÆÈ°∂');
            break;
          case 'mute':
            c.muted = !c.muted;
            storeContacts(contacts);
            showToast(c.muted ? 'Â∑≤ÂºÄÂêØÂÖçÊâìÊâ∞' : 'Â∑≤ÂÖ≥Èó≠ÂÖçÊâìÊâ∞');
            break;
          case 'clear':
            if (!confirm('Á°ÆÂÆöÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºü')) return;
            c.messages = [];
            c.lastTime = '';
            storeContacts(contacts);
            renderChatMessages(c);
            updateGenerateButton();
            showToast('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
            break;
          case 'delete':
            if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•ËÅîÁ≥ª‰∫∫ÂèäÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºü')) return;
            contacts = contacts.filter(x => x.id !== currentContactId);
            storeContacts(contacts);
            closeChat();
            showToast('Â∑≤Âà†Èô§');
            break;
          case 'groupManage':
            openGroupManage();
            break;
          case 'memory':
            openMemoryForContact(currentContactId);
            break;
        }
      }

      // ======= MUSIC APP =======
      let musicPlaylist = JSON.parse(localStorage.getItem('ai_phone_music_playlist') || '[]');
      let musicCurrentIdx = -1;
      let musicPlaying = false;
      let musicAppAudio = null;

      function openMusicApp() {
        renderMusicApp();
        pushScreen('musicApp');
      }
      function closeMusicApp() {
        popScreen();
      }

      function renderMusicApp() {
        const pl = document.getElementById('musicAppPlaylist');
        if (!pl) return;
        let html = '<div class="music-app-playlist-title"><span>Library (' + musicPlaylist.length + ')</span></div>';
        musicPlaylist.forEach((s, i) => {
          const active = i === musicCurrentIdx ? ' active' : '';
          const coverHtml = s.cover
            ? `<img src="${esc(s.cover)}">`
            : '<svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>';
          html += `<div class="music-pl-item${active}" onclick="musicPlayAt(${i})"><div class="pl-index">${i + 1}</div><div class="pl-cover">${coverHtml}</div><div class="pl-info"><div class="pl-name">${esc(s.name)}</div><div class="pl-artist">${esc(s.artist || 'Unknown Artist')}</div></div><div class="pl-delete" onclick="event.stopPropagation();musicRemove(${i})"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div>`;
        });
        pl.innerHTML = html;
        // Update now playing display
        if (musicCurrentIdx >= 0 && musicPlaylist[musicCurrentIdx]) {
          const s = musicPlaylist[musicCurrentIdx];
          document.getElementById('musicAppSongTitle').textContent = s.name;
          document.getElementById('musicAppArtist').textContent = s.artist || 'Unknown Artist';
          const art = document.getElementById('musicAlbumArt');
          if (s.cover) art.innerHTML = `<img src="${esc(s.cover)}">`;
          else
            art.innerHTML =
              '<svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>';
        }
      }

      function toggleMusicAddForm() {
        const form = document.getElementById('musicAddForm');
        form.style.display = form.style.display === 'none' ? 'flex' : 'none';
      }

      function musicAddSong() {
        const url = document.getElementById('musicAddUrl').value.trim();
        const name = document.getElementById('musicAddName').value.trim() || 'Êú™ÂëΩÂêçÊ≠åÊõ≤';
        const artist = document.getElementById('musicAddArtist').value.trim();
        const cover = document.getElementById('musicAddCover').value.trim();
        if (!url) {
          showToast('ËØ∑ËæìÂÖ•Èü≥È¢ëÈìæÊé•');
          return;
        }
        musicPlaylist.push({ url, name, artist, cover });
        safeStore('ai_phone_music_playlist', JSON.stringify(musicPlaylist));
        document.getElementById('musicAddUrl').value = '';
        document.getElementById('musicAddName').value = '';
        document.getElementById('musicAddArtist').value = '';
        document.getElementById('musicAddCover').value = '';
        document.getElementById('musicAddForm').style.display = 'none';
        renderMusicApp();
        showToast('‚úÖ Â∑≤Ê∑ªÂä†Âà∞Êí≠ÊîæÂàóË°®');
      }

      function musicRemove(idx) {
        musicPlaylist.splice(idx, 1);
        safeStore('ai_phone_music_playlist', JSON.stringify(musicPlaylist));
        if (idx === musicCurrentIdx) {
          musicStop();
          musicCurrentIdx = -1;
        } else if (idx < musicCurrentIdx) musicCurrentIdx--;
        renderMusicApp();
      }

      function musicPlayAt(idx) {
        if (idx < 0 || idx >= musicPlaylist.length) return;
        musicCurrentIdx = idx;
        const s = musicPlaylist[idx];
        if (musicAppAudio) musicAppAudio.pause();
        musicAppAudio = new Audio(s.url);
        musicAppAudio.addEventListener('timeupdate', musicUpdateProgress);
        musicAppAudio.addEventListener('ended', musicNext);
        musicAppAudio.addEventListener('error', () => showToast('‚ö†Ô∏è Audio failed to load'));
        musicAppAudio.play().catch(() => showToast('‚ö†Ô∏è Playback failed'));
        musicPlaying = true;
        document.getElementById('musicAlbumArt').classList.remove('paused');
        document.getElementById('musicStylus').classList.add('playing');
        document.getElementById('musicAppPlayBtn').innerHTML =
          '<svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
        renderMusicApp();
      }

      function musicTogglePlay() {
        if (!musicAppAudio || musicCurrentIdx < 0) {
          if (musicPlaylist.length > 0) musicPlayAt(0);
          return;
        }
        if (musicPlaying) {
          musicAppAudio.pause();
          musicPlaying = false;
          document.getElementById('musicAlbumArt').classList.add('paused');
          document.getElementById('musicStylus').classList.remove('playing');
          document.getElementById('musicAppPlayBtn').innerHTML =
            '<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
        } else {
          musicAppAudio.play().catch(() => {});
          musicPlaying = true;
          document.getElementById('musicAlbumArt').classList.remove('paused');
          document.getElementById('musicStylus').classList.add('playing');
          document.getElementById('musicAppPlayBtn').innerHTML =
            '<svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
        }
      }

      function musicStop() {
        if (musicAppAudio) {
          musicAppAudio.pause();
          musicAppAudio = null;
        }
        musicPlaying = false;
        document.getElementById('musicAlbumArt').classList.add('paused');
        document.getElementById('musicStylus').classList.remove('playing');
        document.getElementById('musicAppPlayBtn').innerHTML =
          '<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
        document.getElementById('musicAppProgressFill').style.width = '0%';
        document.getElementById('musicAppCurTime').textContent = '00:00';
        document.getElementById('musicAppDurTime').textContent = '00:00';
      }

      function musicPrev() {
        if (musicPlaylist.length === 0) return;
        let idx = musicCurrentIdx - 1;
        if (idx < 0) idx = musicPlaylist.length - 1;
        musicPlayAt(idx);
      }

      function musicNext() {
        if (musicPlaylist.length === 0) return;
        let idx = musicCurrentIdx + 1;
        if (idx >= musicPlaylist.length) idx = 0;
        musicPlayAt(idx);
      }

      function musicUpdateProgress() {
        if (!musicAppAudio) return;
        const cur = musicAppAudio.currentTime;
        const dur = musicAppAudio.duration || 0;
        const pct = dur > 0 ? (cur / dur) * 100 : 0;
        document.getElementById('musicAppProgressFill').style.width = pct + '%';
        document.getElementById('musicAppCurTime').textContent = fmtTime(cur);
        document.getElementById('musicAppDurTime').textContent = fmtTime(dur);
      }

      function fmtTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return m + ':' + String(sec).padStart(2, '0');
      }

      function seekMusic(e) {
        if (!musicAppAudio || !musicAppAudio.duration) return;
        const bar = document.getElementById('musicAppProgressBar');
        const rect = bar.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        musicAppAudio.currentTime = pct * musicAppAudio.duration;
      }

      // ======= SHOPPING MALL =======
      let shopBalance = parseFloat(localStorage.getItem('ai_phone_shop_balance') || '1000');
      let shopGiftMode = false; // true when opened from chat gift button

      const SHOP_ITEMS = [
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>',
          name: 'Áé´Áë∞Ëä±',
          price: 10,
          category: 'È≤úËä±',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
          name: 'Ëä±Êùü',
          price: 50,
          category: 'È≤úËä±',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><circle cx="12" cy="10" r="3"/><path d="M7 20c0-3.3 2.7-6 6-6s6 2.7 6 6"/><circle cx="12" cy="12" r="10"/></svg>',
          name: 'Ê≥∞Ëø™ÁÜä',
          price: 80,
          category: 'Áé©ÂÅ∂',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M12 12m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0"/><path d="M12 12c-2-4-6-4-6 0s4 4 6 0c2 4 6 4 6 0s-4-4-6 0"/></svg>',
          name: 'Ëù¥Ëù∂Áªì',
          price: 15,
          category: 'È•∞ÂìÅ',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><circle cx="12" cy="12" r="6"/><path d="M12 6V2"/></svg>',
          name: 'ÊàíÊåá',
          price: 520,
          category: 'È¶ñÈ•∞',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M5 15l-2-8 5 3 4-7 4 7 5-3-2 8H5z"/></svg>',
          name: 'ÁöáÂÜ†',
          price: 999,
          category: 'È¶ñÈ•∞',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 13l8-8 8 8"/><path d="M12 5v16"/></svg>',
          name: 'ËõãÁ≥ï',
          price: 66,
          category: 'ÁæéÈ£ü',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="4" y1="10" x2="20" y2="10"/><line x1="10" y1="4" x2="10" y2="20"/></svg>',
          name: 'Â∑ßÂÖãÂäõ',
          price: 30,
          category: 'ÁæéÈ£ü',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M17 8l1 12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2l1-12"/><line x1="6" y1="8" x2="18" y2="8"/><line x1="12" y1="8" x2="14" y2="2"/></svg>',
          name: 'Â•∂Ëå∂',
          price: 20,
          category: 'ÁæéÈ£ü',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>',
          name: 'ÊâãÊú∫',
          price: 888,
          category: 'Êï∞Á†Å',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="6" cy="12" r="2"/><path d="M15 9l3 3-3 3"/></svg>',
          name: 'Ê∏∏ÊàèÊú∫',
          price: 299,
          category: 'Êï∞Á†Å',
        },
        {
          icon: '<svg viewBox="0 0 24 24" width="32" height="32" stroke="#e91e63" stroke-width="2" fill="none"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.3c.4-.2.6-.6.5-1.1z"/></svg>',
          name: 'Êú∫Á•®',
          price: 1500,
          category: 'ÊóÖË°å',
        },
      ];

      function openShop() {
        shopGiftMode = false;
        renderShop();
        pushScreen('shop');
      }
      function openShopForGift() {
        if (!currentContactId) return;
        shopGiftMode = true;
        renderShop();
        pushScreen('shop');
      }
      function closeShop() {
        shopGiftMode = false;
        popScreen();
      }

      function renderShop() {
        document.getElementById('shopBalanceAmount').textContent = '¬•' + shopBalance.toFixed(0);
        const body = document.getElementById('shopBody');
        const categories = [...new Set(SHOP_ITEMS.map(i => i.category))];
        let html = '';
        categories.forEach(cat => {
          html += `<div class="shop-section-title">${cat}</div><div class="shop-grid">`;
          SHOP_ITEMS.filter(i => i.category === cat).forEach(item => {
            html += `<div class="shop-item" onclick="buyShopItem('${esc(item.icon)}','${esc(item.name)}',${item.price})"><div class="shop-icon">${item.icon}</div><div class="shop-name">${esc(item.name)}</div><div class="shop-price">¬•${item.price}</div></div>`;
          });
          html += '</div>';
        });
        body.innerHTML = html;
      }

      function buyShopItem(icon, name, price) {
        if (shopBalance < price) {
          showToast('‚ö†Ô∏è ‰ΩôÈ¢ù‰∏çË∂≥');
          return;
        }
        if (!confirm(`Á°ÆÂÆöË¥≠‰π∞ ${icon} ${name}Ôºà¬•${price}ÔºâÔºü`)) return;
        shopBalance -= price;
        safeStore('ai_phone_shop_balance', shopBalance);
        renderShop();
        showToast(`‚úÖ Â∑≤Ë¥≠‰π∞ ${icon} ${name}`);
        if (shopGiftMode && currentContactId) {
          const contact = contacts.find(c => c.id === currentContactId);
          if (contact) {
            contact.messages.push({ role: 'user', content: `__gift__${JSON.stringify({ icon, name })}` });
            contact.lastTime = getNowTimeStr();
            storeContacts(contacts);
            closeShop();
            renderChatMessages(contact);
            scrollToBottom();
          }
        }
      }

      function shopRecharge() {
        const amount = prompt('ËæìÂÖ•ÂÖÖÂÄºÈáëÈ¢ùÔºö', '500');
        if (!amount) return;
        const val = parseFloat(amount);
        if (isNaN(val) || val <= 0) {
          showToast('‚ö†Ô∏è ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ¢ù');
          return;
        }
        shopBalance += val;
        safeStore('ai_phone_shop_balance', shopBalance);
        renderShop();
        showToast(`‚úÖ Â∑≤ÂÖÖÂÄº ¬•${val.toFixed(0)}`);
      }

      // ======= CHAT IMAGE SEND =======
      function pickChatImage() {
        document.getElementById('chatImageInput').click();
      }
      document.getElementById('chatImageInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file || !currentContactId) return;
        const reader = new FileReader();
        reader.onload = async function (ev) {
          const dataUrl = await compressImage(ev.target.result, 300);
          const contact = contacts.find(c => c.id === currentContactId);
          if (!contact) return;
          contact.messages.push({ role: 'user', content: '__image__' + dataUrl });
          contact.lastTime = getNowTimeStr();
          storeContacts(contacts);
          renderChatMessages(contact);
          scrollToBottom();
        };
        reader.readAsDataURL(file);
        this.value = '';
      });

      // ======= GROUP MANAGEMENT =======
      let groupManageId = null;
      let groupManageAvatarData = null;

      function openGroupManage() {
        if (!currentContactId) return;
        const c = contacts.find(x => x.id === currentContactId);
        if (!c || !c.isGroup) return;
        groupManageId = currentContactId;
        groupManageAvatarData = c.avatar || null;
        document.getElementById('groupManageName').value = c.name;
        // Render avatar
        const preview = document.getElementById('groupAvatarPreview');
        if (c.avatar) {
          preview.innerHTML = `<img src="${c.avatar}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
          preview.style.background = 'transparent';
        } else {
          preview.style.background = c.color || '#5856d6';
          preview.innerHTML = 'üë•<div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>';
        }
        // Render members
        renderGroupMembers(c);
        pushScreen('groupManage');
      }

      function closeGroupManage() {
        groupManageId = null;
        popScreen();
      }

      function renderGroupMembers(group) {
        const list = document.getElementById('groupMemberList');
        const memberIds = group.members || [];
        document.getElementById('groupMemberTitle').textContent = `Áæ§ÊàêÂëò (${memberIds.length})`;
        list.innerHTML = memberIds
          .map(id => {
            const m = contacts.find(c => c.id === id);
            if (!m) return '';
            const avatarStyle = m.avatar ? '' : `style="background:${m.color}"`;
            const avatarContent = m.avatar ? `<img src="${m.avatar}">` : m.name.charAt(0).toUpperCase();
            return `<div class="form-item" style="flex-direction:row;align-items:center;gap:10px;">
            <div class="contact-avatar" style="width:36px;height:36px;font-size:14px;${m.avatar ? '' : 'background:' + m.color}">${avatarContent}</div>
            <div style="flex:1;font-size:15px;">${esc(m.name)}</div>
            <span style="color:#ff3b30;cursor:pointer;font-size:20px;" onclick="removeMemberFromGroup(${id})" title="ÁßªÈô§">‚úï</span>
          </div>`;
          })
          .join('');
      }

      function saveGroupManage() {
        if (!groupManageId) return;
        const c = contacts.find(x => x.id === groupManageId);
        if (!c) return;
        const newName = document.getElementById('groupManageName').value.trim();
        if (newName) c.name = newName;
        if (groupManageAvatarData) c.avatar = groupManageAvatarData;
        storeContacts(contacts);
        if (currentContactId === groupManageId) {
          document.getElementById('chatTitle').textContent = c.name + ` (${(c.members || []).length})`;
        }
        showToast('‚úÖ Áæ§ËÅä‰ø°ÊÅØÂ∑≤‰øùÂ≠ò');
      }

      function addMemberToGroup() {
        if (!groupManageId) return;
        const group = contacts.find(x => x.id === groupManageId);
        if (!group) return;
        const existingIds = new Set(group.members || []);
        const available = contacts.filter(c => !c.isGroup && c.systemPrompt && !existingIds.has(c.id));
        if (available.length === 0) {
          showToast('Ê≤°ÊúâÂèØÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫');
          return;
        }
        const names = available.map(c => c.name);
        const choice = prompt('ÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑÊàêÂëòÔºàËæìÂÖ•Â∫èÂè∑ÔºâÔºö\n' + names.map((n, i) => `${i + 1}. ${n}`).join('\n'));
        if (!choice) return;
        const idx = parseInt(choice) - 1;
        if (idx < 0 || idx >= available.length) {
          showToast('‚ö†Ô∏è Êó†ÊïàÈÄâÊã©');
          return;
        }
        group.members.push(available[idx].id);
        storeContacts(contacts);
        renderGroupMembers(group);
        showToast(`‚úÖ Â∑≤Ê∑ªÂä† ${available[idx].name}`);
      }

      function removeMemberFromGroup(memberId) {
        if (!groupManageId) return;
        const group = contacts.find(x => x.id === groupManageId);
        if (!group) return;
        const member = contacts.find(c => c.id === memberId);
        if (!confirm(`Á°ÆÂÆöÁßªÈô§ ${member ? member.name : 'ËØ•ÊàêÂëò'}Ôºü`)) return;
        group.members = (group.members || []).filter(id => id !== memberId);
        storeContacts(contacts);
        renderGroupMembers(group);
        showToast('Â∑≤ÁßªÈô§');
      }

      function dissolveGroup() {
        if (!groupManageId) return;
        if (!confirm('Á°ÆÂÆöËß£Êï£ËØ•Áæ§ËÅäÔºüÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂ∞ÜË¢´Âà†Èô§„ÄÇ')) return;
        contacts = contacts.filter(c => c.id !== groupManageId);
        storeContacts(contacts);
        closeGroupManage();
        if (currentContactId === groupManageId) {
          currentContactId = null;
          popScreen(); // close chat
        }
        renderContacts();
        showToast('Áæ§ËÅäÂ∑≤Ëß£Êï£');
      }

      // Override pickAvatar to also handle group management avatar
      const _origPickAvatar = pickAvatar;
      pickAvatar = function (target) {
        if (target === 'group') {
          avatarPickTarget = 'group';
          document.getElementById('avatarFileInput').click();
          return;
        }
        _origPickAvatar(target);
      };

      // Extend avatar file input handler for group
      const origAvatarHandler = document.getElementById('avatarFileInput').onchange;
      document.getElementById('avatarFileInput').addEventListener('change', function (e) {
        if (avatarPickTarget === 'group') {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = async function (ev) {
            const dataUrl = await compressImage(ev.target.result, 128);
            groupManageAvatarData = dataUrl;
            const p = document.getElementById('groupAvatarPreview');
            p.innerHTML = `<img src="${dataUrl}"><div class="avatar-overlay">Êç¢Â§¥ÂÉè</div>`;
            p.style.background = 'transparent';
          };
          reader.readAsDataURL(file);
        }
      });

      // ======= LONG-TERM MEMORY =======
      const MEMORY_CATEGORIES = ['ÂÅèÂ•Ω', '‰∫ãÂÆû', 'ÂÖ≥Á≥ª', 'ÁªèÂéÜ', 'ÊÄßÊ†º', 'ÂÖ∂‰ªñ'];
      const MEMORY_CAT_COLORS = {
        ÂÅèÂ•Ω: '#e91e63',
        ‰∫ãÂÆû: '#2196f3',
        ÂÖ≥Á≥ª: '#ff9800',
        ÁªèÂéÜ: '#4caf50',
        ÊÄßÊ†º: '#9c27b0',
        ÂÖ∂‰ªñ: '#607d8b',
      };

      function loadMemories() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_memories') || '[]');
        } catch {
          return [];
        }
      }
      function storeMemories(m) {
        safeStore('ai_phone_memories', m);
      }
      let memories = loadMemories();

      let memoryFilter = null; // null = all, or a category string

      let memoryContactId = null; // null = global view, or a contact id

      function openMemoryScreen() {
        memoryFilter = null;
        memoryContactId = null;
        renderMemoryScreen();
        pushScreen('memory');
      }

      function openMemoryForContact(contactId) {
        memoryFilter = null;
        memoryContactId = contactId || null;
        renderMemoryScreen();
        pushScreen('memory');
      }
      function closeMemoryScreen() {
        popScreen();
      }

      function toggleMemoryAdd() {
        const card = document.getElementById('memoryAddCard');
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
        if (card.style.display === 'block') {
          document.getElementById('memoryAddContent').value = '';
          document.getElementById('memoryAddContent').focus();
        }
      }

      function renderMemoryScreen() {
        // Stats chips
        const statsEl = document.getElementById('memoryStats');
        const counts = {};
        MEMORY_CATEGORIES.forEach(c => (counts[c] = 0));
        memories.forEach(m => {
          if (counts[m.category] !== undefined) counts[m.category]++;
          else counts['ÂÖ∂‰ªñ']++;
        });
        const total = memories.length;
        let chipsHtml = `<div class="memory-stat-chip ${memoryFilter === null ? 'active' : ''}" style="background:#333" onclick="filterMemory(null)">ÂÖ®ÈÉ® ${total}</div>`;
        MEMORY_CATEGORIES.forEach(cat => {
          if (counts[cat] > 0) {
            chipsHtml += `<div class="memory-stat-chip ${memoryFilter === cat ? 'active' : ''}" style="background:${MEMORY_CAT_COLORS[cat]}" onclick="filterMemory('${cat}')">${cat} ${counts[cat]}</div>`;
          }
        });
        statsEl.innerHTML = chipsHtml;

        // List
        const listEl = document.getElementById('memoryList');
        const titleEl = document.getElementById('memoryListTitle');
        let filtered = memories;
        if (memoryContactId) {
          const mc = contacts.find(x => x.id === memoryContactId);
          const cname = mc ? mc.name : '';
          filtered = filtered.filter(m => m.contactName === cname);
        }
        if (memoryFilter) filtered = filtered.filter(m => m.category === memoryFilter);
        const scopeLabel = memoryContactId
          ? (contacts.find(x => x.id === memoryContactId)?.name || '') + ' ÁöÑËÆ∞ÂøÜ'
          : 'ÊâÄÊúâËÆ∞ÂøÜ';
        titleEl.textContent = memoryFilter
          ? `${memoryFilter} (${filtered.length})`
          : `${scopeLabel} (${filtered.length})`;

        if (filtered.length === 0) {
          listEl.innerHTML =
            '<div class="memory-empty"><div class="mem-empty-icon">üß†</div><div>ËøòÊ≤°ÊúâËÆ∞ÂøÜ</div><div style="margin-top:6px;font-size:12px;color:#ccc;">ÁÇπÂáª‰∏äÊñπ Ôºã ÊâãÂä®Ê∑ªÂä†ÔºåÊàñ‰ΩøÁî® AI Ëá™Âä®ÊèêÂèñ</div></div>';
          return;
        }

        listEl.innerHTML = filtered
          .map((m, i) => {
            const realIdx = memories.indexOf(m);
            const catClass = `cat-${m.category}`;
            const sourceTag =
              m.source === 'ai' ? '<span class="mem-source">AIÊèêÂèñ</span>' : '<span class="mem-source">ÊâãÂä®</span>';
            return `<div class="memory-item">
            <div class="mem-actions">
              <span onclick="editMemory(${realIdx})" title="ÁºñËæë">‚úèÔ∏è</span>
              <span onclick="deleteMemory(${realIdx})" title="Âà†Èô§">üóëÔ∏è</span>
            </div>
            <div class="mem-category ${catClass}">${esc(m.category)}</div>
            <div class="mem-content">${esc(m.content)}</div>
            <div class="mem-time">${m.time || ''} ${sourceTag} ${m.contactName ? '¬∑ ' + esc(m.contactName) : ''}</div>
          </div>`;
          })
          .join('');
      }

      function filterMemory(cat) {
        memoryFilter = cat;
        renderMemoryScreen();
      }

      function addMemoryManual() {
        const category = document.getElementById('memoryAddCategory').value;
        const content = document.getElementById('memoryAddContent').value.trim();
        if (!content) {
          showToast('ËØ∑ËæìÂÖ•ËÆ∞ÂøÜÂÜÖÂÆπ');
          return;
        }
        const cname = memoryContactId ? contacts.find(x => x.id === memoryContactId)?.name || '' : '';
        memories.unshift({
          id: Date.now(),
          category,
          content,
          time: new Date().toLocaleDateString('zh-CN'),
          source: 'manual',
          contactName: cname,
        });
        storeMemories(memories);
        document.getElementById('memoryAddContent').value = '';
        document.getElementById('memoryAddCard').style.display = 'none';
        renderMemoryScreen();
        showToast('‚úÖ ËÆ∞ÂøÜÂ∑≤Ê∑ªÂä†');
      }

      function deleteMemory(idx) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§ËøôÊù°ËÆ∞ÂøÜÔºü')) return;
        memories.splice(idx, 1);
        storeMemories(memories);
        renderMemoryScreen();
        showToast('Â∑≤Âà†Èô§');
      }

      function editMemory(idx) {
        const m = memories[idx];
        if (!m) return;
        const newContent = prompt('ÁºñËæëËÆ∞ÂøÜÂÜÖÂÆπÔºö', m.content);
        if (newContent === null) return;
        const trimmed = newContent.trim();
        if (!trimmed) {
          showToast('ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫');
          return;
        }
        m.content = trimmed;
        storeMemories(memories);
        renderMemoryScreen();
        showToast('‚úÖ Â∑≤Êõ¥Êñ∞');
      }

      async function autoExtractMemory() {
        const btn = document.getElementById('memoryAutoBtn');
        if (btn.disabled) return;
        // Gather recent chat messages - scoped to contact if viewing per-contact
        let allMsgs = [];
        let extractContactName = '';
        if (memoryContactId) {
          const mc = contacts.find(x => x.id === memoryContactId);
          if (mc && mc.messages && mc.messages.length > 0) {
            extractContactName = mc.name;
            mc.messages.slice(-30).forEach(m => {
              if (m.content.startsWith('__')) return;
              allMsgs.push({ role: m.role === 'user' ? 'Áî®Êà∑' : mc.name, content: m.content.slice(0, 200) });
            });
          }
        } else {
          contacts.forEach(c => {
            if (!c.messages || c.messages.length === 0) return;
            const recent = c.messages.slice(-20);
            recent.forEach(m => {
              if (m.content.startsWith('__')) return;
              allMsgs.push({ role: m.role === 'user' ? 'Áî®Êà∑' : c.name, content: m.content.slice(0, 200) });
            });
          });
        }
        if (allMsgs.length < 3) {
          showToast('‚ö†Ô∏è ËÅäÂ§©ËÆ∞ÂΩïÂ§™Â∞ëÔºåÊó†Ê≥ïÊèêÂèñ');
          return;
        }
        btn.disabled = true;
        btn.textContent = '‚è≥ AI ÊèêÂèñ‰∏≠‚Ä¶';
        try {
          const existingMemStr = memories
            .slice(0, 20)
            .map(m => `[${m.category}] ${m.content}`)
            .join('\n');
          const chatStr = allMsgs
            .slice(-30)
            .map(m => `${m.role}: ${m.content}`)
            .join('\n');
          const prompt = `Ê†πÊçÆ‰ª•‰∏ãËÅäÂ§©ËÆ∞ÂΩïÔºåÊèêÂèñÂÖ≥‰∫éÁî®Êà∑ÁöÑÈïøÊúüËÆ∞ÂøÜ‰ø°ÊÅØ„ÄÇËÆ∞ÂøÜÂ∫îËØ•ÊòØÂÖ≥‰∫éÁî®Êà∑ÁöÑÂÅèÂ•Ω„ÄÅ‰∫ãÂÆû„ÄÅÂÖ≥Á≥ª„ÄÅÁªèÂéÜ„ÄÅÊÄßÊ†ºÁ≠âÊñπÈù¢ÁöÑÊåÅ‰πÖÊÄß‰ø°ÊÅØ„ÄÇ

Â∑≤ÊúâËÆ∞ÂøÜÔºàÈÅøÂÖçÈáçÂ§çÔºâÔºö
${existingMemStr || 'ÔºàÊöÇÊó†Ôºâ'}

ÊúÄËøëËÅäÂ§©ËÆ∞ÂΩïÔºö
${chatStr}

ËØ∑ÊèêÂèñ3-8Êù°Êñ∞ÁöÑËÆ∞ÂøÜ„ÄÇÊØèÊù°ËÆ∞ÂøÜÊ†ºÂºè‰∏∫JSONÂØπË±°ÔºåÂåÖÂê´ categoryÔºà‰ªé ÂÅèÂ•Ω/‰∫ãÂÆû/ÂÖ≥Á≥ª/ÁªèÂéÜ/ÊÄßÊ†º/ÂÖ∂‰ªñ ‰∏≠ÈÄâÊã©ÔºâÂíå contentÔºàÁÆÄÊ¥ÅÊèèËø∞Ôºå15-50Â≠óÔºâ„ÄÇ
Âè™ËøîÂõûJSONÊï∞ÁªÑÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ‰æãÂ¶ÇÔºö
[{"category":"ÂÅèÂ•Ω","content":"ÂñúÊ¨¢Âú®Ê∑±Â§úÂê¨Èü≥‰πêÊîæÊùæ"},{"category":"ÊÄßÊ†º","content":"ÈÅáÂà∞Âõ∞ÈöæÊó∂ÂÄæÂêë‰∫éÁã¨Ëá™ÊÄùËÄÉ"}]`;

          const result = await aiCall('‰Ω†ÊòØ‰∏Ä‰∏™ËÆ∞ÂøÜÊèêÂèñÂä©ÊâãÔºåÂè™ËøîÂõûJSONÊ†ºÂºèÁöÑËÆ∞ÂøÜÊï∞ÁªÑ„ÄÇ', prompt);
          const jsonMatch = result.match(/\[[\s\S]*\]/);
          if (!jsonMatch) throw new Error('AIËøîÂõûÊ†ºÂºèÈîôËØØ');
          const extracted = JSON.parse(jsonMatch[0]);
          if (!Array.isArray(extracted) || extracted.length === 0) throw new Error('Êú™ÊèêÂèñÂà∞ÊúâÊïàËÆ∞ÂøÜ');

          let added = 0;
          extracted.forEach(item => {
            if (!item.content || !item.category) return;
            // Check for duplicates
            const isDuplicate = memories.some(
              m =>
                m.content === item.content ||
                (m.content.length > 10 && item.content.length > 10 && m.content.includes(item.content.slice(0, 10))),
            );
            if (isDuplicate) return;
            if (!MEMORY_CATEGORIES.includes(item.category)) item.category = 'ÂÖ∂‰ªñ';
            memories.unshift({
              id: Date.now() + added,
              category: item.category,
              content: item.content.slice(0, 100),
              time: new Date().toLocaleDateString('zh-CN'),
              source: 'ai',
              contactName: extractContactName,
            });
            added++;
          });
          storeMemories(memories);
          renderMemoryScreen();
          showToast(`‚úÖ Â∑≤ÊèêÂèñ ${added} Êù°Êñ∞ËÆ∞ÂøÜ`);
        } catch (err) {
          showToast(`‚ö†Ô∏è ÊèêÂèñÂ§±Ë¥•Ôºö${err.message}`);
        } finally {
          btn.disabled = false;
          btn.textContent = '‚ú® AI Ëá™Âä®ÊèêÂèñËÆ∞ÂøÜ';
        }
      }

      // Build memory context string for AI prompts (filtered by current contact if applicable)
      function getMemoryContext() {
        if (memories.length === 0) return '';
        // Include global memories (no contactName) + memories for current contact
        const contactName = currentContactId ? contacts.find(x => x.id === currentContactId)?.name || '' : '';
        const relevant = memories.filter(m => !m.contactName || m.contactName === contactName).slice(0, 30);
        if (relevant.length === 0) return '';
        const grouped = {};
        relevant.forEach(m => {
          if (!grouped[m.category]) grouped[m.category] = [];
          grouped[m.category].push(m.content);
        });
        let ctx = '[Áî®Êà∑ÈïøÊúüËÆ∞ÂøÜ]\n';
        for (const cat of MEMORY_CATEGORIES) {
          if (grouped[cat] && grouped[cat].length > 0) {
            ctx += `„Äê${cat}„Äë${grouped[cat].join('Ôºõ')}\n`;
          }
        }
        return ctx;
      }

      // Register memory screen in allScreens and navigation
      const memoryScreenEl = document.getElementById('memoryScreen');
      allScreens['memory'] = memoryScreenEl;

      // Register photowall screen
      const photowallScreenEl = document.getElementById('photowallScreen');
      allScreens['photowall'] = photowallScreenEl;

      // ======= PHOTO WALL =======
      function loadPhotos() {
        try {
          return JSON.parse(localStorage.getItem('ai_phone_photos') || '[]');
        } catch {
          return [];
        }
      }
      function storePhotos(p) {
        safeStore('ai_phone_photos', p);
      }
      let photos = loadPhotos();

      function openPhotowall() {
        renderPhotowall();
        pushScreen('photowall');
      }
      function closePhotowall() {
        popScreen();
      }

      function renderPhotowall() {
        const body = document.getElementById('pwBody');
        const counter = document.getElementById('pwCounter');
        if (photos.length === 0) {
          body.innerHTML =
            '<div class="pw-empty"><div class="pw-empty-icon">üì∑</div><div class="pw-empty-text">No Photos Yet</div><div class="pw-empty-hint">Tap + to add your first photo</div></div>';
          counter.textContent = '';
          return;
        }
        counter.textContent = photos.length + ' photos';
        body.innerHTML =
          '<div class="pw-grid">' +
          photos
            .map(
              (src, i) =>
                `<div class="pw-item" onclick="openPwLightbox(${i})"><img src="${src}" loading="lazy"><div class="pw-delete" onclick="event.stopPropagation();deletePhoto(${i})">‚úï</div></div>`,
            )
            .join('') +
          '</div>';
      }

      function pickPhotoWall() {
        document.getElementById('pwFileInput').click();
      }
      document.getElementById('pwFileInput').addEventListener('change', function (e) {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        let loaded = 0;
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = async ev => {
            const compressed = await compressImage(ev.target.result, 600);
            photos.unshift(compressed);
            loaded++;
            if (loaded === files.length) {
              storePhotos(photos);
              renderPhotowall();
              showToast(`‚úÖ Added ${files.length} photo(s)`);
            }
          };
          reader.readAsDataURL(file);
        });
        this.value = '';
      });

      function deletePhoto(idx) {
        photos.splice(idx, 1);
        storePhotos(photos);
        renderPhotowall();
      }

      function clearAllPhotos() {
        if (photos.length === 0) return;
        if (!confirm('Clear all photos?')) return;
        photos = [];
        storePhotos(photos);
        renderPhotowall();
        showToast('All photos cleared');
      }

      function openPwLightbox(idx) {
        const lb = document.getElementById('pwLightbox');
        document.getElementById('pwLightboxImg').src = photos[idx];
        lb.classList.add('show');
      }
      function closePwLightbox() {
        document.getElementById('pwLightbox').classList.remove('show');
      }

      // Add photowall to swipe-back list
      const _origGetSwipeScreen = getSwipeScreen;
      getSwipeScreen = function () {
        const s = getActiveScreen();
        if (s === 'photowall') return allScreens['photowall'];
        return _origGetSwipeScreen();
      };

      // ======= FULLSCREEN MODE =======
      let isFullscreen = localStorage.getItem('ai_phone_fullscreen') === 'true';

      function applyFullscreen() {
        const phone = document.getElementById('phone');
        phone.classList.toggle('fullscreen-mode', isFullscreen);
        const track = document.getElementById('fullscreenTrack');
        const thumb = document.getElementById('fullscreenThumb');
        if (track && thumb) {
          track.style.background = isFullscreen ? '#34c759' : '#e9e9ea';
          thumb.style.transform = isFullscreen ? 'translateX(20px)' : 'translateX(0)';
        }
      }

      function toggleFullscreen() {
        isFullscreen = !isFullscreen;
        localStorage.setItem('ai_phone_fullscreen', isFullscreen);
        applyFullscreen();
        showToast(isFullscreen ? 'Â∑≤ÂºÄÂêØÂÖ®Â±èÊ®°Âºè' : 'Â∑≤ÂÖ≥Èó≠ÂÖ®Â±èÊ®°Âºè');
      }

      applyFullscreen();

      // Init
      renderColorOptions();
    </script>
  </body>
</html>
